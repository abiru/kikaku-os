name: Deploy to Production

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]
  workflow_dispatch:  # Allow manual deployment

jobs:
  validate-config:
    name: Validate deployment config
    runs-on: ubuntu-latest
    if: >-
      (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')
    steps:
      - name: Show deployment URLs
        env:
          PROD_API_BASE_URL: ${{ vars.PROD_API_BASE_URL || 'https://kikaku-os-api.workers.dev' }}
          PROD_STOREFRONT_URL: ${{ vars.PROD_STOREFRONT_URL || 'https://kikaku-storefront.pages.dev' }}
        run: |
          echo "API URL: $PROD_API_BASE_URL"
          echo "Storefront URL: $PROD_STOREFRONT_URL"
          if [ -z "${{ vars.PROD_API_BASE_URL }}" ]; then
            echo "::warning::PROD_API_BASE_URL not set — using default workers.dev URL"
          fi
          if [ -z "${{ vars.PROD_STOREFRONT_URL }}" ]; then
            echo "::warning::PROD_STOREFRONT_URL not set — using default pages.dev URL"
          fi

  build-api:
    name: Build API
    runs-on: ubuntu-latest
    needs: [validate-config]
    if: >-
      (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build API
        run: pnpm -C apps/api build

  build-storefront:
    name: Build Storefront
    runs-on: ubuntu-latest
    needs: [validate-config]
    if: >-
      (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build storefront
        run: pnpm -C apps/storefront build
        env:
          PUBLIC_API_BASE: ${{ vars.PROD_API_BASE_URL || 'https://kikaku-os-api.workers.dev' }}
          PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.PUBLIC_CLERK_PUBLISHABLE_KEY }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}

  deploy-api:
    name: Deploy API to Cloudflare Workers
    runs-on: ubuntu-latest
    needs: [build-api]
    if: >-
      (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Apply D1 migrations
        run: pnpm -C apps/api exec wrangler d1 migrations apply ledkikaku-os --remote --config ../../wrangler.toml
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy API to Cloudflare Workers
        run: pnpm -C apps/api exec wrangler deploy --config ../../wrangler.toml
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Configure secrets
        run: |
          echo "$ADMIN_API_KEY" | pnpm -C apps/api exec wrangler secret put ADMIN_API_KEY --config ../../wrangler.toml
          echo "$STRIPE_PUBLISHABLE_KEY" | pnpm -C apps/api exec wrangler secret put STRIPE_PUBLISHABLE_KEY --config ../../wrangler.toml
          echo "$STRIPE_SECRET_KEY" | pnpm -C apps/api exec wrangler secret put STRIPE_SECRET_KEY --config ../../wrangler.toml
          echo "$STRIPE_WEBHOOK_SECRET" | pnpm -C apps/api exec wrangler secret put STRIPE_WEBHOOK_SECRET --config ../../wrangler.toml
          echo "$CLERK_SECRET_KEY" | pnpm -C apps/api exec wrangler secret put CLERK_SECRET_KEY --config ../../wrangler.toml
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            echo "$SLACK_WEBHOOK_URL" | pnpm -C apps/api exec wrangler secret put SLACK_WEBHOOK_URL --config ../../wrangler.toml
          fi
          if [ -n "$RESEND_API_KEY" ]; then
            echo "$RESEND_API_KEY" | pnpm -C apps/api exec wrangler secret put RESEND_API_KEY --config ../../wrangler.toml
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          ADMIN_API_KEY: ${{ secrets.ADMIN_API_KEY }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}

      - name: Wait for deployment
        run: sleep 10

      - name: Verify API deployment
        run: |
          API_URL="${PROD_API_BASE_URL}"
          echo "Testing health endpoint: $API_URL/health"
          curl -sf "$API_URL/health" | jq -e '.database == "ok"'
        env:
          PROD_API_BASE_URL: ${{ vars.PROD_API_BASE_URL || 'https://kikaku-os-api.workers.dev' }}

  deploy-storefront:
    name: Deploy Storefront to Cloudflare Pages
    runs-on: ubuntu-latest
    needs: [build-storefront, deploy-api]
    if: >-
      (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build storefront
        run: pnpm -C apps/storefront build
        env:
          PUBLIC_API_BASE: ${{ vars.PROD_API_BASE_URL || 'https://kikaku-os-api.workers.dev' }}
          PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.PUBLIC_CLERK_PUBLISHABLE_KEY }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}

      - name: Deploy to Cloudflare Pages
        run: pnpm -C apps/storefront exec wrangler pages deploy dist --project-name=kikaku-storefront
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Verify storefront deployment
        run: |
          sleep 10
          STOREFRONT_URL="${PROD_STOREFRONT_URL}"
          echo "Testing storefront: $STOREFRONT_URL"
          curl -sf "$STOREFRONT_URL/" | grep -q "Led Kikaku" || echo "Warning: Could not verify storefront content"
        env:
          PROD_STOREFRONT_URL: ${{ vars.PROD_STOREFRONT_URL || 'https://kikaku-storefront.pages.dev' }}

  smoke-test:
    name: Production Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-api, deploy-storefront]
    if: >-
      (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Run smoke tests
        env:
          PROD_API_BASE_URL: ${{ vars.PROD_API_BASE_URL || 'https://kikaku-os-api.workers.dev' }}
          PROD_STOREFRONT_URL: ${{ vars.PROD_STOREFRONT_URL || 'https://kikaku-storefront.pages.dev' }}
        run: |
          export API_URL="${PROD_API_BASE_URL}"
          export STOREFRONT_URL="${PROD_STOREFRONT_URL}"
          bash scripts/smoke-test-prod.sh

          # Auth protection (should return 401)
          echo "✓ Testing auth protection"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/admin/products")
          if [ "$STATUS" != "401" ]; then
            echo "Error: Expected 401, got $STATUS"
            exit 1
          fi

          echo "✅ All smoke tests passed!"

