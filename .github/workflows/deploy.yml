name: Deploy to Production

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]
  workflow_dispatch:  # Allow manual deployment

permissions:
  contents: read
  actions: read

jobs:
  validate-config:
    name: Validate deployment config
    runs-on: ubuntu-latest
    if: >-
      (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')
    steps:
      - name: Show deployment URLs
        env:
          PROD_API_BASE_URL: ${{ vars.PROD_API_BASE_URL || 'https://kikaku-os-api.workers.dev' }}
          PROD_STOREFRONT_URL: ${{ vars.PROD_STOREFRONT_URL || 'https://kikaku-storefront.pages.dev' }}
        run: |
          echo "API URL: $PROD_API_BASE_URL"
          echo "Storefront URL: $PROD_STOREFRONT_URL"
          if [ -z "${{ vars.PROD_API_BASE_URL }}" ]; then
            echo "::warning::PROD_API_BASE_URL not set — using default workers.dev URL"
          fi
          if [ -z "${{ vars.PROD_STOREFRONT_URL }}" ]; then
            echo "::warning::PROD_STOREFRONT_URL not set — using default pages.dev URL"
          fi

  build-api:
    name: Build API
    runs-on: ubuntu-latest
    needs: [validate-config]
    if: >-
      (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build API
        run: pnpm -C apps/api build

  build-storefront:
    name: Build Storefront
    runs-on: ubuntu-latest
    needs: [validate-config]
    if: >-
      (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build storefront
        run: pnpm -C apps/storefront build
        env:
          PUBLIC_API_BASE: ${{ vars.PROD_API_BASE_URL || 'https://kikaku-os-api.workers.dev' }}
          PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.PUBLIC_CLERK_PUBLISHABLE_KEY }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}

  deploy-api:
    name: Deploy API to Cloudflare Workers
    runs-on: ubuntu-latest
    needs: [build-api]
    if: >-
      (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Apply D1 migrations
        run: pnpm -C apps/api exec wrangler d1 migrations apply ledkikaku-os --remote --config ../../wrangler.toml
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy API to Cloudflare Workers
        run: pnpm -C apps/api exec wrangler deploy --config ../../wrangler.toml
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Configure secrets
        run: |
          echo "$ADMIN_API_KEY" | pnpm -C apps/api exec wrangler secret put ADMIN_API_KEY --config ../../wrangler.toml
          echo "$STRIPE_PUBLISHABLE_KEY" | pnpm -C apps/api exec wrangler secret put STRIPE_PUBLISHABLE_KEY --config ../../wrangler.toml
          echo "$STRIPE_SECRET_KEY" | pnpm -C apps/api exec wrangler secret put STRIPE_SECRET_KEY --config ../../wrangler.toml
          echo "$STRIPE_WEBHOOK_SECRET" | pnpm -C apps/api exec wrangler secret put STRIPE_WEBHOOK_SECRET --config ../../wrangler.toml
          echo "$CLERK_SECRET_KEY" | pnpm -C apps/api exec wrangler secret put CLERK_SECRET_KEY --config ../../wrangler.toml
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            echo "$SLACK_WEBHOOK_URL" | pnpm -C apps/api exec wrangler secret put SLACK_WEBHOOK_URL --config ../../wrangler.toml
          fi
          if [ -n "$RESEND_API_KEY" ]; then
            echo "$RESEND_API_KEY" | pnpm -C apps/api exec wrangler secret put RESEND_API_KEY --config ../../wrangler.toml
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          ADMIN_API_KEY: ${{ secrets.ADMIN_API_KEY }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}

      - name: Wait for deployment
        run: sleep 10

      - name: Verify API deployment
        run: |
          API_URL="${PROD_API_BASE_URL}"
          echo "Testing health endpoint: $API_URL/health"
          curl -sf "$API_URL/health" | jq -e '.database == "ok"'
        env:
          PROD_API_BASE_URL: ${{ vars.PROD_API_BASE_URL || 'https://kikaku-os-api.workers.dev' }}

  deploy-storefront:
    name: Deploy Storefront to Cloudflare Pages
    runs-on: ubuntu-latest
    needs: [build-storefront, deploy-api]
    if: >-
      (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build storefront
        run: pnpm -C apps/storefront build
        env:
          PUBLIC_API_BASE: ${{ vars.PROD_API_BASE_URL || 'https://kikaku-os-api.workers.dev' }}
          PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.PUBLIC_CLERK_PUBLISHABLE_KEY }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}

      - name: Deploy to Cloudflare Pages
        run: pnpm -C apps/storefront exec wrangler pages deploy dist --project-name=kikaku-storefront
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Verify storefront deployment
        run: |
          sleep 10
          STOREFRONT_URL="${PROD_STOREFRONT_URL}"
          echo "Testing storefront: $STOREFRONT_URL"
          curl -sf "$STOREFRONT_URL/" | grep -q "Led Kikaku" || echo "Warning: Could not verify storefront content"
        env:
          PROD_STOREFRONT_URL: ${{ vars.PROD_STOREFRONT_URL || 'https://kikaku-storefront.pages.dev' }}

  smoke-test:
    name: Production Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-api, deploy-storefront]
    if: >-
      (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Run smoke tests
        env:
          PROD_API_BASE_URL: ${{ vars.PROD_API_BASE_URL || 'https://kikaku-os-api.workers.dev' }}
          PROD_STOREFRONT_URL: ${{ vars.PROD_STOREFRONT_URL || 'https://kikaku-storefront.pages.dev' }}
        run: |
          export API_URL="${PROD_API_BASE_URL}"
          export STOREFRONT_URL="${PROD_STOREFRONT_URL}"
          bash scripts/smoke-test-prod.sh

          # Auth protection (should return 401)
          echo "Testing auth protection"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/admin/products")
          if [ "$STATUS" != "401" ]; then
            echo "Error: Expected 401, got $STATUS"
            exit 1
          fi

          echo "All smoke tests passed!"

  rollback:
    name: Auto-Rollback on Smoke Test Failure
    runs-on: ubuntu-latest
    needs: [smoke-test]
    if: failure()

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Rollback API (Cloudflare Workers)
        id: rollback-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Fetching deployment history..."
          DEPLOYMENTS=$(pnpm -C apps/api exec wrangler deployments list --name kikaku-os-api 2>&1) || true
          echo "$DEPLOYMENTS"

          echo "Attempting rollback to previous version..."
          # wrangler rollback rolls back to the previous deployment
          pnpm -C apps/api exec wrangler rollback --name kikaku-os-api --message "Auto-rollback: smoke tests failed in run ${{ github.run_id }}" 2>&1 || {
            echo "::warning::API rollback via wrangler rollback failed. Manual intervention may be required."
            echo "api_status=failed" >> $GITHUB_OUTPUT
            exit 0
          }
          echo "api_status=success" >> $GITHUB_OUTPUT

      - name: Verify API rollback
        env:
          PROD_API_BASE_URL: ${{ vars.PROD_API_BASE_URL || 'https://kikaku-os-api.workers.dev' }}
        run: |
          sleep 10
          echo "Verifying API health after rollback..."
          curl -sf "${PROD_API_BASE_URL}/health" | jq -e '.database == "ok"' || {
            echo "::error::API health check failed after rollback"
            exit 1
          }
          echo "API rollback verified successfully."

      - name: Rollback Storefront (Cloudflare Pages)
        id: rollback-storefront
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Fetching Pages deployment history..."
          DEPLOYMENTS=$(pnpm -C apps/storefront exec wrangler pages deployment list --project-name=kikaku-storefront 2>&1) || true
          echo "$DEPLOYMENTS"

          # Pages does not have a direct rollback command.
          # The recommended approach is to re-deploy the previous production commit.
          echo "::warning::Cloudflare Pages does not support direct rollback via CLI."
          echo "::warning::To rollback storefront, use Cloudflare Dashboard -> Pages -> kikaku-storefront -> Deployments -> Rollback."
          echo "storefront_status=manual_required" >> $GITHUB_OUTPUT

      - name: Notify via Slack
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          API_STATUS: ${{ steps.rollback-api.outputs.api_status || 'unknown' }}
          STOREFRONT_STATUS: ${{ steps.rollback-storefront.outputs.storefront_status || 'unknown' }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL not configured, skipping Slack notification."
            exit 0
          fi

          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"DEPLOY ROLLBACK TRIGGERED\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"Deploy Rollback Triggered\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {\"type\": \"mrkdwn\", \"text\": \"*Reason:*\nSmoke tests failed\"},
                    {\"type\": \"mrkdwn\", \"text\": \"*Commit:*\n\`${GITHUB_SHA:0:7}\`\"},
                    {\"type\": \"mrkdwn\", \"text\": \"*API Rollback:*\n${API_STATUS}\"},
                    {\"type\": \"mrkdwn\", \"text\": \"*Storefront:*\n${STOREFRONT_STATUS}\"}
                  ]
                },
                {
                  \"type\": \"actions\",
                  \"elements\": [
                    {
                      \"type\": \"button\",
                      \"text\": {\"type\": \"plain_text\", \"text\": \"View Run\"},
                      \"url\": \"${RUN_URL}\"
                    }
                  ]
                }
              ]
            }" "$SLACK_WEBHOOK_URL"

      - name: Notify via GitHub (fallback)
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          API_STATUS: ${{ steps.rollback-api.outputs.api_status || 'unknown' }}
          STOREFRONT_STATUS: ${{ steps.rollback-storefront.outputs.storefront_status || 'unknown' }}
        run: |
          COMMIT_SHA="${{ github.event.workflow_run.head_sha || github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          gh api repos/${{ github.repository }}/commits/${COMMIT_SHA}/comments \
            --method POST \
            -f "body=## Auto-Rollback Triggered

          Smoke tests failed after deployment. Automatic rollback was initiated.

          | Component | Status |
          |-----------|--------|
          | API (Workers) | \`${API_STATUS}\` |
          | Storefront (Pages) | \`${STOREFRONT_STATUS}\` |

          **Action Required**: Investigate the failure and fix before re-deploying.

          [View workflow run](${RUN_URL})"

