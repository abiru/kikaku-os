name: Weekly Security Audit

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9:00 UTC (18:00 JST)
  workflow_dispatch:  # Allow manual trigger

permissions:
  issues: write

jobs:
  weekly-audit:
    name: Vulnerability Report
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run full audit
        id: audit
        run: |
          set +e
          AUDIT_OUTPUT=$(pnpm audit 2>&1)
          AUDIT_EXIT_CODE=$?
          set -e

          echo "exit_code=$AUDIT_EXIT_CODE" >> $GITHUB_OUTPUT

          # Save full output for the issue body
          {
            echo 'report<<AUDIT_EOF'
            echo "$AUDIT_OUTPUT"
            echo 'AUDIT_EOF'
          } >> $GITHUB_OUTPUT

          # Check for high/critical specifically
          set +e
          pnpm audit --audit-level=high 2>&1
          HIGH_EXIT_CODE=$?
          set -e

          echo "has_high=$HIGH_EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Create or update GitHub issue
        if: steps.audit.outputs.exit_code != '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AUDIT_REPORT: ${{ steps.audit.outputs.report }}
          HAS_HIGH: ${{ steps.audit.outputs.has_high }}
        run: |
          DATE=$(date -u +"%Y-%m-%d")

          if [ "$HAS_HIGH" != "0" ]; then
            SEVERITY_LABEL="priority: high"
            SEVERITY_NOTE="**High/Critical vulnerabilities detected.** Immediate action required."
          else
            SEVERITY_LABEL="priority: low"
            SEVERITY_NOTE="Only low/moderate vulnerabilities found. Review at next convenience."
          fi

          ISSUE_TITLE="security: Weekly Vulnerability Report - $DATE"

          ISSUE_BODY=$(cat <<BODY_EOF
          ## Weekly Dependency Vulnerability Report

          **Date**: $DATE
          **Status**: $SEVERITY_NOTE

          ### Audit Results

          \`\`\`
          $AUDIT_REPORT
          \`\`\`

          ### Recommended Actions

          1. Review each vulnerability and assess impact
          2. Update affected packages: \`pnpm update <package>\`
          3. If no fix available, evaluate workarounds or overrides
          4. Re-run audit to confirm resolution: \`pnpm audit\`

          ---
          *Generated by [Weekly Security Audit](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
          BODY_EOF
          )

          # Close previous weekly audit issues
          gh issue list \
            --label "security" \
            --state open \
            --search "Weekly Vulnerability Report" \
            --json number \
            --jq '.[].number' | while read -r issue_number; do
            gh issue close "$issue_number" --comment "Superseded by new weekly report."
          done

          # Create new issue
          gh issue create \
            --title "$ISSUE_TITLE" \
            --body "$ISSUE_BODY" \
            --label "security"

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.audit.outputs.exit_code }}" = "0" ]; then
            echo "### Security Audit: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "No vulnerabilities found." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.audit.outputs.has_high }}" != "0" ]; then
            echo "### Security Audit: HIGH/CRITICAL VULNERABILITIES" >> $GITHUB_STEP_SUMMARY
            echo "Immediate action required. See created GitHub issue." >> $GITHUB_STEP_SUMMARY
          else
            echo "### Security Audit: LOW/MODERATE VULNERABILITIES" >> $GITHUB_STEP_SUMMARY
            echo "Review at next convenience. See created GitHub issue." >> $GITHUB_STEP_SUMMARY
          fi
