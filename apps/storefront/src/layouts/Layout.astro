---
import { ViewTransitions } from 'astro:transitions';
import BackToTop from '../components/BackToTop.astro';
import PageTransitionProgress from '../components/PageTransitionProgress.astro';
import SiteHeader from '../components/SiteHeader.astro';
import SiteFooter from '../components/SiteFooter.astro';
import SearchModal from '../components/SearchModal';
import CookieConsent from '../components/CookieConsent';
import { t } from '../i18n';
import '@fontsource/inter/400.css';
import '@fontsource/inter/500.css';
import '@fontsource/inter/600.css';
import '@fontsource/inter/700.css';
import '@fontsource/noto-sans-jp/400.css';
import '@fontsource/noto-sans-jp/500.css';
import '@fontsource/noto-sans-jp/600.css';
import '@fontsource/noto-sans-jp/700.css';
import '../styles/global.css';

interface Props {
	title?: string;
	description?: string;
	image?: string;
	url?: string;
	disableViewTransitions?: boolean;
}

const {
	title = 'Led Kikaku Store',
	description = 'Led Kikaku - LED照明製品のオンラインストア',
	image,
	url,
	disableViewTransitions = false,
} = Astro.props;
const siteUrl = Astro.site ?? 'https://led-kikaku.com';
const canonicalURL = url ? new URL(url, siteUrl) : new URL(Astro.url.pathname, siteUrl);
const ogImage = image ? new URL(image, siteUrl).href : null;
const gtmId = import.meta.env.PUBLIC_GTM_ID || '';
---

<!doctype html>
<html lang="ja">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="description" content={description} />
		<meta name="theme-color" content="#ffffff" />
		<meta name="format-detection" content="telephone=no" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<link rel="canonical" href={canonicalURL.href} />
		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>

		<!-- Open Graph -->
		<meta property="og:title" content={title} />
		<meta property="og:description" content={description} />
		{ogImage && <meta property="og:image" content={ogImage} />}
		<meta property="og:url" content={canonicalURL.href} />
		<meta property="og:type" content="website" />
		<meta property="og:site_name" content={t('seo.siteName')} />

		<!-- Twitter Card -->
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:title" content={title} />
		<meta name="twitter:description" content={description} />
		{ogImage && <meta name="twitter:image" content={ogImage} />}

		{/* Google Tag Manager */}
		{gtmId && (
			<script set:html={`(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','${gtmId}');`} />
		)}

		{!disableViewTransitions && <ViewTransitions />}
		<slot name="head" />
	</head>
	<body class="font-sans text-primary antialiased bg-subtle">
		{!disableViewTransitions && <PageTransitionProgress />}
		{/* Google Tag Manager (noscript) */}
		{gtmId && (
			<noscript><iframe src={`https://www.googletagmanager.com/ns.html?id=${gtmId}`} height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
		)}
		<a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-brand focus:text-white focus:rounded-lg focus:text-sm focus:font-medium">
			{t('accessibility.skipToContent')}
		</a>
		<div class="min-h-screen flex flex-col">
			<SiteHeader currentPath={Astro.url.pathname} />

			<main id="main-content" class="flex-1">
				<slot />
			</main>

			<SiteFooter />
		</div>

		{/* Re-initialize GTM dataLayer on SPA navigation */}
		{gtmId && (
			<script is:inline>
				document.addEventListener('astro:page-load', () => {
					window.dataLayer = window.dataLayer || [];
					window.dataLayer.push({
						'event': 'page_view',
						'page_location': window.location.href,
						'page_title': document.title,
					});
				});
			</script>
		)}

		{/* Search Modal */}
		<SearchModal client:idle />

		{/* Cookie Consent Banner */}
		<CookieConsent client:idle />

		{/* Back to Top Button */}
		<BackToTop />

		<script>
			import '../scripts/scrollReveal';
		</script>
	</body>
</html>
