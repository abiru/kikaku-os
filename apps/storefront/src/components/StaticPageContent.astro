---
import Container from './Container.astro';
import Layout from '../layouts/Layout.astro';
import { getApiBase } from '../lib/api';
import { parseMarkdown } from '../utils/markdown';
import { formatDate } from '../lib/format';
import { t } from '../i18n';
import { logError } from '../lib/logger';
import type { StaticPage } from '../lib/types';

interface Props {
	slug: string;
	defaultTitle: string;
	defaultMetaTitle: string;
}

const { slug, defaultTitle, defaultMetaTitle } = Astro.props;

let page: StaticPage | null = null;
let error: string | null = null;

try {
	const apiBase = getApiBase();
	const res = await fetch(`${apiBase}/store/pages/${slug}`);
	if (res.ok) {
		const data = await res.json();
		page = data.page;
	}
} catch (e) {
	logError('Failed to fetch page', e, { page: 'StaticPageContent', action: 'fetchPage', resourceId: slug });
	error = t('cms.loadError');
}

const metaTitle = page?.meta_title || defaultMetaTitle;
const metaDescription = page?.meta_description || '';

const fallbackText = t(`cms.fallback.${slug}` as Parameters<typeof t>[0]);
const isLegalSlug = slug === 'legal';

const legalNoticeRows = isLegalSlug ? [
	{ label: t('pages.legalNotice.seller'), value: t('pages.legalNotice.sellerValue') },
	{ label: t('pages.legalNotice.representative'), value: t('pages.legalNotice.representativeValue') },
	{ label: t('pages.legalNotice.addressPhone'), value: t('pages.legalNotice.addressPhoneValue') },
	{ label: t('pages.legalNotice.email'), value: t('pages.legalNotice.emailValue'), href: '/contact' },
	{ label: t('pages.legalNotice.price'), value: t('pages.legalNotice.priceValue') },
	{ label: t('pages.legalNotice.additionalFees'), value: t('pages.legalNotice.additionalFeesValue') },
	{ label: t('pages.legalNotice.paymentMethod'), value: t('pages.legalNotice.paymentMethodValue') },
	{ label: t('pages.legalNotice.deliveryTime'), value: t('pages.legalNotice.deliveryTimeValue') },
	{ label: t('pages.legalNotice.returnPolicy'), value: t('pages.legalNotice.returnPolicyValue', { link: '' }), linkText: t('pages.legalNotice.returnPolicyLink'), href: '/refund' },
] : [];
---

<Layout title={metaTitle}>
	{metaDescription && (
		<meta slot="head" name="description" content={metaDescription} />
	)}
	<div class="bg-white min-h-screen">
		<section class="pt-24 pb-16 md:pt-32 md:pb-24">
			<Container>
				<h1 class="text-4xl md:text-5xl font-bold tracking-tight text-center text-primary">
					{page?.title || defaultTitle}
				</h1>
				{page && (
					<p class="mt-6 text-center text-secondary text-lg font-medium">
						{t('cms.lastUpdated', { date: formatDate(page.updated_at, { year: 'numeric', month: 'long', day: 'numeric' }) })}
					</p>
				)}
			</Container>
		</section>

		<section class="pb-24">
			<Container class="max-w-3xl">
				{page && page.body ? (
					<div class="prose prose-lg max-w-none" set:html={parseMarkdown(page.body)} />
				) : error ? (
					<div class="text-center py-12">
						<p class="text-secondary">{error}</p>
					</div>
				) : isLegalSlug && legalNoticeRows.length > 0 ? (
					<div>
						<table class="w-full border-collapse">
							<tbody>
								{legalNoticeRows.map((row) => (
									<tr class="border-b border-gray-200">
										<th class="py-4 pr-6 text-left align-top font-semibold text-primary whitespace-nowrap w-1/3">
											{row.label}
										</th>
										<td class="py-4 text-secondary">
											{row.href && row.linkText ? (
												<>
													{row.value}<a href={row.href} class="text-accent hover:underline">{row.linkText}</a>
												</>
											) : row.href ? (
												<a href={row.href} class="text-accent hover:underline">{row.value}</a>
											) : (
												row.value
											)}
										</td>
									</tr>
								))}
							</tbody>
						</table>
						<p class="mt-8 text-sm text-secondary">
							ご不明な点がございましたら、<a href="/contact" class="text-accent hover:underline">お問い合わせページ</a>よりご連絡ください。
						</p>
					</div>
				) : fallbackText ? (
					<div>
						<p class="text-lg leading-relaxed text-secondary">{fallbackText}</p>
						<p class="mt-8 text-sm text-secondary">
							ご不明な点がございましたら、<a href="/contact" class="text-accent hover:underline">お問い合わせページ</a>よりご連絡ください。
						</p>
					</div>
				) : (
					<div class="text-center py-12">
						<p class="text-secondary">{t('cms.preparing')}</p>
					</div>
				)}
			</Container>
		</section>
	</div>
</Layout>
