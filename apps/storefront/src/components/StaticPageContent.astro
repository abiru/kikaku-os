---
import Container from './Container.astro';
import Layout from '../layouts/Layout.astro';
import { getApiBase } from '../lib/api';
import { parseMarkdown } from '../utils/markdown';
import { formatDate } from '../lib/format';
import { t } from '../i18n';
import { logError } from '../lib/logger';
import type { StaticPage } from '../lib/types';

interface Props {
	slug: string;
	defaultTitle: string;
	defaultMetaTitle: string;
}

const { slug, defaultTitle, defaultMetaTitle } = Astro.props;

let page: StaticPage | null = null;
let error: string | null = null;

try {
	const apiBase = getApiBase();
	const res = await fetch(`${apiBase}/store/pages/${slug}`);
	if (res.ok) {
		const data = await res.json();
		page = data.page;
	}
} catch (e) {
	logError('Failed to fetch page', e, { page: 'StaticPageContent', action: 'fetchPage', resourceId: slug });
	error = t('cms.loadError');
}

const metaTitle = page?.meta_title || defaultMetaTitle;
const metaDescription = page?.meta_description || '';
---

<Layout title={metaTitle}>
	{metaDescription && (
		<meta slot="head" name="description" content={metaDescription} />
	)}
	<div class="bg-white min-h-screen">
		<section class="pt-24 pb-16 md:pt-32 md:pb-24">
			<Container>
				<h1 class="text-4xl md:text-5xl font-bold tracking-tight text-center text-primary">
					{page?.title || defaultTitle}
				</h1>
				{page && (
					<p class="mt-6 text-center text-secondary text-lg font-medium">
						{t('cms.lastUpdated', { date: formatDate(page.updated_at, { year: 'numeric', month: 'long', day: 'numeric' }) })}
					</p>
				)}
			</Container>
		</section>

		<section class="pb-24">
			<Container class="max-w-3xl">
				{page && page.body ? (
					<div class="prose prose-lg max-w-none" set:html={parseMarkdown(page.body)} />
				) : error ? (
					<div class="text-center py-12">
						<p class="text-secondary">{error}</p>
					</div>
				) : (
					<div class="text-center py-12">
						<p class="text-secondary">{t('cms.preparing')}</p>
					</div>
				)}
			</Container>
		</section>
	</div>
</Layout>
