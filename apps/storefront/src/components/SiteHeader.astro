---
import Container from './Container.astro';
import LanguageSwitcher from './LanguageSwitcher.astro';
import { SignedIn, SignedOut, UserButton } from '@clerk/astro/components';
import { t } from '../i18n';

interface Props {
	currentPath: string;
	showWishlist?: boolean;
	showMobileMenu?: boolean;
	showAuthToggle?: boolean;
	showLanguageSwitcher?: boolean;
}

const {
	currentPath,
	showWishlist = true,
	showMobileMenu = true,
	showAuthToggle = true,
	showLanguageSwitcher = true,
} = Astro.props;
---

<header class="sticky top-0 z-50 w-full bg-white/70 backdrop-blur-xl shadow-[var(--shadow-subtle)]" role="banner">
	<Container class="flex h-[48px] items-center justify-between">
		{/* Logo Area */}
		<a href="/" class="flex items-center gap-2 group transition-opacity hover:opacity-80">
			<span class="sr-only">LED Kikaku</span>
			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 444 133" class="h-6 w-auto">
				<rect width="444" height="133" fill="#141414" />
				<path d="M144,31L144,108L179,108L192,103L201,94L206,80L206,59L201,45L191,35L180,31Z" fill="white" />
				<path d="M161,45L177,45L182,47L188,54L189,57L189,82L187,87L182,92L176,94L161,94L160,93L160,46Z" fill="#141414" />
				<path d="M76,31L76,108L128,108L128,94L92,93L93,76L123,76L123,62L93,62L92,46L128,45L128,31Z" fill="white" />
				<path d="M17,31L17,108L62,108L62,94L33,93L33,31Z" fill="white" />
				<path d="M225,16L225,115L426,115L426,16Z" fill="white" />
				<path d="M234,92L246,91L248,60L264,62L264,91L271,91L271,48L287,46L289,62L312,63L312,78L289,79L289,91L321,91L322,107L235,108Z" fill="#141414" />
				<path d="M332,43L348,43L348,92L399,92L399,44L415,42L416,106L334,108Z" fill="#141414" />
				<path d="M330,23L417,22L417,37L383,37L383,40L397,41L397,88L395,90L352,90L351,41L365,40L365,37L331,37Z" fill="#141414" />
				<path d="M380,70L379,71L379,76L384,76L384,70Z" fill="#141414" />
				<path d="M364,70L364,76L368,76L368,70Z" fill="#141414" />
				<path d="M380,53L379,54L379,59L384,59L384,53Z" fill="#141414" />
				<path d="M364,53L364,59L368,59L368,53Z" fill="#141414" />
				<path d="M231,46L255,33L269,20L287,20L306,36L325,45L318,63L295,51L278,36L262,51L240,63L237,62Z" fill="#141414" />
			</svg>
		</a>

		{/* Desktop Nav - Centered & Subtle */}
		<nav class="hidden lg:flex items-center gap-4 text-[12px] font-normal text-primary overflow-x-auto whitespace-nowrap nav-overflow-hint">
			<a href="/" class={`transition-colors hover:text-primary ${currentPath === '/' ? 'text-primary font-medium' : ''}`}>{t('nav.store')}</a>
			<a href="/products" class={`transition-colors hover:text-primary ${currentPath.startsWith('/products') ? 'text-primary font-medium' : ''}`}>{t('nav.products')}</a>
			<a href="/categories" class={`transition-colors hover:text-primary ${currentPath.startsWith('/categories') ? 'text-primary font-medium' : ''}`}>{t('nav.categories')}</a>
			<a href="/faq" class={`transition-colors hover:text-primary ${currentPath === '/faq' ? 'text-primary font-medium' : ''}`}>{t('nav.faq')}</a>
			<a href="/contact" class={`transition-colors hover:text-primary ${currentPath === '/contact' ? 'text-primary font-medium' : ''}`}>{t('nav.support')}</a>
			<a href="/quotations/new" class={`transition-colors hover:text-primary ${currentPath.startsWith('/quotations') ? 'text-primary font-medium' : ''}`}>{t('nav.quotation')}</a>
			<a href="/about" class={`transition-colors hover:text-primary ${currentPath === '/about' ? 'text-primary font-medium' : ''}`}>{t('nav.about')}</a>
		</nav>

		{/* Utilities: Language, Search, Wishlist, Cart & Account */}
		<div class="flex items-center gap-2">
			{showLanguageSwitcher && <LanguageSwitcher />}
			<button id="search-btn" type="button" class="min-h-[44px] min-w-[44px] flex items-center justify-center text-primary/80 hover:text-primary transition-colors">
				<span class="sr-only">{t('common.search')}</span>
				<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
			</button>
			{showWishlist && (
				<a href="/wishlist" id="wishlist-link" class="relative min-h-[44px] min-w-[44px] flex items-center justify-center text-primary/80 hover:text-primary transition-colors">
					<span class="sr-only">{t('wishlist.openWishlist')}</span>
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
					<span id="wishlist-badge" class="hidden absolute -top-1 -right-1 h-4 w-4 rounded-full bg-red-500 text-[10px] font-medium text-white flex items-center justify-center">0</span>
				</a>
			)}
			<a href="/cart" id="cart-link" class="relative min-h-[44px] min-w-[44px] flex items-center justify-center text-primary/80 hover:text-primary transition-colors">
				<span id="cart-sr-label" class="sr-only" data-cart-label={t('nav.openCart')} data-cart-label-with-count={t('cart.cartWithCount')}>{t('nav.openCart')}</span>
				<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
				<span id="cart-badge" class="hidden absolute -top-1 -right-1 h-4 w-4 rounded-full bg-brand text-[10px] font-medium text-white flex items-center justify-center" aria-hidden="true">0</span>
			</a>
			{/* Reserve auth area space to prevent header shift while Clerk loads */}
			<div id="clerk-auth" class="relative min-w-[56px] min-h-[28px] flex items-center justify-end">
				<div
					id="clerk-skeleton"
					class="absolute right-0 top-1/2 -translate-y-1/2 h-7 w-7 rounded-full bg-neutral-200/60 animate-pulse pointer-events-none"
					aria-hidden="true"
				></div>
				{showAuthToggle ? (
					<>
						<SignedOut>
							<a href="/sign-in" class="text-[12px] font-medium text-brand hover:underline whitespace-nowrap">
								{t('nav.signIn')}
							</a>
						</SignedOut>
						<SignedIn>
							<UserButton />
						</SignedIn>
					</>
				) : (
					<UserButton />
				)}
			</div>
			{showMobileMenu && (
				<button
					id="mobile-menu-btn"
					type="button"
					class="lg:hidden min-h-[44px] min-w-[44px] flex items-center justify-center text-primary/80 hover:text-primary transition-colors"
					aria-label={t('nav.menu')}
					aria-expanded="false"
				>
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
				</button>
			)}
		</div>
	</Container>
</header>

{showMobileMenu && (
	<>
		{/* Mobile slide-out menu */}
		<div id="mobile-menu-overlay" class="fixed inset-0 z-[60] bg-black/40 backdrop-blur-sm hidden" aria-hidden="true"></div>
		<nav id="mobile-menu" class="fixed top-0 right-0 z-[70] h-full w-[280px] bg-white shadow-[var(--shadow-overlay)] transform translate-x-full transition-transform duration-300 ease-in-out" aria-label={t('nav.mobileMenu')}>
			<div class="flex items-center justify-between h-[48px] px-6 border-b border-neutral-100">
				<span class="text-[15px] font-semibold">{t('nav.menu')}</span>
				<button
					id="mobile-menu-close"
					type="button"
					class="min-h-[44px] min-w-[44px] flex items-center justify-center text-primary/60 hover:text-primary transition-colors"
					aria-label={t('common.close')}
				>
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
				</button>
			</div>
			<div class="px-6 py-4 space-y-1">
				<a href="/" class={`block py-3 text-[15px] border-b border-neutral-100 transition-colors hover:text-brand ${currentPath === '/' ? 'text-brand font-medium' : 'text-primary'}`}>{t('nav.store')}</a>
				<a href="/products" class={`block py-3 text-[15px] border-b border-neutral-100 transition-colors hover:text-brand ${currentPath.startsWith('/products') ? 'text-brand font-medium' : 'text-primary'}`}>{t('nav.products')}</a>
				<a href="/categories" class={`block py-3 text-[15px] border-b border-neutral-100 transition-colors hover:text-brand ${currentPath.startsWith('/categories') ? 'text-brand font-medium' : 'text-primary'}`}>{t('nav.categories')}</a>
				<a href="/faq" class={`block py-3 text-[15px] border-b border-neutral-100 transition-colors hover:text-brand ${currentPath === '/faq' ? 'text-brand font-medium' : 'text-primary'}`}>{t('nav.faq')}</a>
				<a href="/contact" class={`block py-3 text-[15px] border-b border-neutral-100 transition-colors hover:text-brand ${currentPath === '/contact' ? 'text-brand font-medium' : 'text-primary'}`}>{t('nav.support')}</a>
				<a href="/quotations/new" class={`block py-3 text-[15px] border-b border-neutral-100 transition-colors hover:text-brand ${currentPath.startsWith('/quotations') ? 'text-brand font-medium' : 'text-primary'}`}>{t('nav.quotation')}</a>
				<a href="/about" class={`block py-3 text-[15px] border-b border-neutral-100 transition-colors hover:text-brand ${currentPath === '/about' ? 'text-brand font-medium' : 'text-primary'}`}>{t('nav.about')}</a>
				<a href="/wishlist" class="block py-3 text-[15px] border-b border-neutral-100 text-primary transition-colors hover:text-brand">{t('wishlist.openWishlist')}</a>
				<a href="/cart" class="block py-3 text-[15px] border-b border-neutral-100 text-primary transition-colors hover:text-brand">{t('nav.openCart')}</a>
			</div>
		</nav>
	</>
)}

<script>
	import { $cartCount } from '../lib/cart';
	import { $wishlistCount } from '../lib/wishlist';

	const updateCartBadge = () => {
		const badge = document.getElementById('cart-badge');
		const srLabel = document.getElementById('cart-sr-label');
		if (!badge) return;

		const count = $cartCount.get();
		if (count > 0) {
			badge.textContent = String(count > 99 ? '99+' : count);
			badge.classList.remove('hidden');
			const withCountTemplate = srLabel?.dataset.cartLabelWithCount || 'カート（{count}点）';
			if (srLabel) srLabel.textContent = withCountTemplate.replace('{count}', String(count));
		} else {
			badge.classList.add('hidden');
			if (srLabel) srLabel.textContent = srLabel?.dataset.cartLabel || 'カートを開く';
		}
	};

	const updateWishlistBadge = () => {
		const badge = document.getElementById('wishlist-badge');
		if (!badge) return;

		const count = $wishlistCount.get();
		if (count > 0) {
			badge.textContent = String(count > 99 ? '99+' : count);
			badge.classList.remove('hidden');
		} else {
			badge.classList.add('hidden');
		}
	};

	// Subscribe to store changes (persists across SPA navigations)
	$cartCount.subscribe(updateCartBadge);
	$wishlistCount.subscribe(updateWishlistBadge);

	// Cmd+K / Ctrl+K shortcut (registered once, persists across navigations)
	document.addEventListener('keydown', (e) => {
		if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
			e.preventDefault();
			window.dispatchEvent(new CustomEvent('open-search'));
		}
	});

	// Re-bind DOM elements on each page load (initial + SPA navigations)
	function initSiteHeader() {
		// Update badges for current DOM
		updateCartBadge();
		updateWishlistBadge();

		// Search functionality
		const searchBtn = document.getElementById('search-btn');
		searchBtn?.addEventListener('click', () => {
			window.dispatchEvent(new CustomEvent('open-search'));
		});

		// Mobile menu
		const mobileMenuBtn = document.getElementById('mobile-menu-btn');
		const mobileMenu = document.getElementById('mobile-menu');
		const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
		const mobileMenuClose = document.getElementById('mobile-menu-close');

		if (mobileMenuBtn && mobileMenu) {
			let menuOpen = false;

			const getFocusableElements = (): HTMLElement[] => {
				const selector = 'a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])';
				return Array.from(mobileMenu.querySelectorAll<HTMLElement>(selector));
			};

			const handleMenuKeydown = (e: KeyboardEvent) => {
				if (e.key === 'Escape') {
					closeMobileMenu();
					return;
				}
				if (e.key !== 'Tab') return;
				const focusable = getFocusableElements();
				if (focusable.length === 0) {
					e.preventDefault();
					return;
				}
				const first = focusable[0]!;
				const last = focusable[focusable.length - 1]!;
				if (e.shiftKey) {
					if (document.activeElement === first) {
						e.preventDefault();
						last.focus();
					}
				} else {
					if (document.activeElement === last) {
						e.preventDefault();
						first.focus();
					}
				}
			};

			const openMobileMenu = () => {
				menuOpen = true;
				mobileMenu.classList.remove('translate-x-full');
				mobileMenuOverlay?.classList.remove('hidden');
				mobileMenuBtn.setAttribute('aria-expanded', 'true');
				document.body.style.overflow = 'hidden';
				document.addEventListener('keydown', handleMenuKeydown);
				mobileMenuClose?.focus();
			};

			const closeMobileMenu = () => {
				menuOpen = false;
				mobileMenu.classList.add('translate-x-full');
				mobileMenuOverlay?.classList.add('hidden');
				mobileMenuBtn.setAttribute('aria-expanded', 'false');
				document.body.style.overflow = '';
				document.removeEventListener('keydown', handleMenuKeydown);
				mobileMenuBtn.focus();
			};

			mobileMenuBtn.addEventListener('click', openMobileMenu);
			mobileMenuClose?.addEventListener('click', closeMobileMenu);
			mobileMenuOverlay?.addEventListener('click', closeMobileMenu);

			// Close menu when navigation links are tapped
			mobileMenu.addEventListener('click', (e) => {
				const anchor = (e.target as HTMLElement).closest('a[href]');
				if (anchor) {
					closeMobileMenu();
				}
			});

			// Reset menu state after View Transitions page swap
			document.addEventListener('astro:after-swap', () => {
				if (menuOpen) {
					document.removeEventListener('keydown', handleMenuKeydown);
				}
				menuOpen = false;
				mobileMenu.classList.add('translate-x-full');
				mobileMenuOverlay?.classList.add('hidden');
				mobileMenuBtn.setAttribute('aria-expanded', 'false');
				document.body.style.overflow = '';
			});
		}

		// Remove clerk skeleton placeholder when Clerk initializes
		const clerkSkeleton = document.getElementById('clerk-skeleton');
		if (clerkSkeleton) {
			const container = clerkSkeleton.parentElement;
			if (container) {
				const removeSkeleton = () => {
					if (clerkSkeleton.parentElement) clerkSkeleton.remove();
				};
				const observer = new MutationObserver(() => {
					if (container.querySelector('[class*="cl-"], a[href="/sign-in"]')) {
						removeSkeleton();
						observer.disconnect();
					}
				});
				observer.observe(container, { childList: true, subtree: true });
				// Fallback: remove skeleton if Clerk fails to load
				setTimeout(removeSkeleton, 2500);
			}
		}
	}

	// Run on initial load and on every SPA navigation
	document.addEventListener('astro:page-load', initSiteHeader);
</script>

<style>
	.nav-overflow-hint {
		mask-image: linear-gradient(to right, transparent, black 8px, black calc(100% - 8px), transparent);
		-webkit-mask-image: linear-gradient(to right, transparent, black 8px, black calc(100% - 8px), transparent);
	}
</style>
