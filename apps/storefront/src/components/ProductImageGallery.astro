---
import { t } from '../i18n';
import { buildSrcSet } from '../lib/responsiveImage';

interface Props {
	productId: number | string;
	images: Array<{ id: number; src: string; alt: string; primary: boolean }>;
}

const { productId, images } = Astro.props;
const primaryImage = images.find((img) => img.primary) ?? images[0] ?? null;
---

<div class="mt-8 lg:col-span-7 lg:col-start-1 lg:row-span-3 lg:row-start-1 lg:mt-0">
	<h2 class="sr-only">{t('product.images')}</h2>

	<div class="grid grid-cols-1 lg:grid-cols-2 lg:grid-rows-3 lg:gap-8">
		{images.length > 0 ? (
			images.map((image) => (
				image.primary ? (
					<div
						id="image-zoom-container"
						class="relative lg:col-span-2 lg:row-span-2 cursor-zoom-in overflow-hidden rounded-lg group"
						role="button"
						tabindex="0"
						aria-label={t('product.lightboxOpen')}
					>
						<img
							id="main-image"
							alt={image.alt}
							src={image.src}
							srcset={buildSrcSet(image.src, 'galleryMain')}
							sizes="(max-width: 1024px) 100vw, 58vw"
							loading="eager"
							decoding="sync"
							fetchpriority="high"
							style={`view-transition-name: product-image-${productId}`}
							class="rounded-lg object-cover w-full aspect-square"
						/>
						{/* Zoom overlay for desktop hover */}
						<div
							id="zoom-overlay"
							class="absolute inset-0 opacity-0 pointer-events-none transition-opacity duration-200 rounded-lg hidden lg:block"
							aria-hidden="true"
						/>
						{/* Zoom hint badge */}
						<div class="absolute bottom-3 right-3 bg-black/60 text-white text-xs px-2.5 py-1.5 rounded-full flex items-center gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none" aria-hidden="true">
							<svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
								<path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM10.5 7.5v6m3-3h-6" />
							</svg>
							<span>{t('product.zoomHint')}</span>
						</div>
					</div>
				) : (
					<img
						alt={image.alt}
						src={image.src}
						srcset={buildSrcSet(image.src, 'galleryMain')}
						sizes="(max-width: 1024px) 100vw, 29vw"
						loading="lazy"
						decoding="async"
						class="hidden lg:block aspect-square rounded-lg object-cover w-full"
					/>
				)
			))
		) : (
			<div class="lg:col-span-2 lg:row-span-2 aspect-square rounded-lg bg-neutral-100 flex items-center justify-center">
				<svg class="h-24 w-24 text-neutral-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
					<path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
				</svg>
			</div>
		)}
	</div>

	{/* Thumbnail navigation for mobile */}
	{images.length > 1 && (
		<div class="mt-4 flex gap-4 overflow-x-auto lg:hidden">
			{images.map((image, index) => (
				<button
					type="button"
					data-index={index}
					data-url={image.src}
					class:list={[
						'thumbnail shrink-0 w-24 h-24 rounded-xl overflow-hidden ring-2 ring-offset-2 transition-all',
						index === 0 ? 'ring-brand' : 'ring-transparent hover:ring-neutral-300',
					]}
				>
					<img
						src={image.src}
						srcset={buildSrcSet(image.src, 'galleryThumb')}
						sizes="96px"
						alt={image.alt}
						width="96"
						height="96"
						loading="lazy"
						decoding="async"
						class="w-full h-full object-cover"
					/>
				</button>
			))}
		</div>
	)}
</div>

{/* Lightbox Dialog */}
{images.length > 0 && (
	<dialog
		id="image-lightbox"
		class="lightbox-dialog fixed inset-0 z-50 w-full h-full max-w-none max-h-none m-0 p-0 bg-black/90 backdrop:bg-transparent"
		aria-label={t('product.lightboxOpen')}
	>
		<div class="relative flex items-center justify-center w-full h-full">
			{/* Close button */}
			<button
				type="button"
				id="lightbox-close"
				class="absolute top-4 right-4 z-10 w-10 h-10 flex items-center justify-center rounded-full bg-white/10 hover:bg-white/20 text-white transition-colors"
				aria-label={t('product.lightboxClose')}
			>
				<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
					<path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
				</svg>
			</button>

			{/* Prev button */}
			<button
				type="button"
				id="lightbox-prev"
				class="absolute left-4 z-10 w-10 h-10 flex items-center justify-center rounded-full bg-white/10 hover:bg-white/20 text-white transition-colors"
				aria-label={t('product.lightboxPrev')}
			>
				<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
					<path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
				</svg>
			</button>

			{/* Lightbox image */}
			<img
				id="lightbox-image"
				src=""
				alt=""
				class="max-w-[90vw] max-h-[85vh] object-contain select-none"
				style="touch-action: pinch-zoom;"
				draggable="false"
			/>

			{/* Next button */}
			<button
				type="button"
				id="lightbox-next"
				class="absolute right-4 z-10 w-10 h-10 flex items-center justify-center rounded-full bg-white/10 hover:bg-white/20 text-white transition-colors"
				aria-label={t('product.lightboxNext')}
			>
				<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
					<path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
				</svg>
			</button>

			{/* Counter */}
			{images.length > 1 && (
				<div class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-black/60 text-white text-sm px-3 py-1.5 rounded-full" aria-live="polite">
					<span id="lightbox-counter">1 / {images.length}</span>
				</div>
			)}
		</div>
	</dialog>
)}

<style>
	.lightbox-dialog::backdrop {
		background: transparent;
	}

	.lightbox-dialog[open] {
		animation: lightbox-fade-in 0.2s ease-out;
	}

	@keyframes lightbox-fade-in {
		from { opacity: 0; }
		to { opacity: 1; }
	}
</style>

<script>
	import '../scripts/imageZoom';
</script>
