---
/**
 * PageTransitionProgress — thin progress bar shown during slow page transitions.
 *
 * Hooks into Astro ViewTransitions lifecycle events:
 *   - astro:before-preparation  → start (after 300 ms delay)
 *   - astro:page-load           → finish & hide
 *
 * Uses CSS custom property `--color-brand` so it stays in sync with the theme.
 * Respects `prefers-reduced-motion: reduce` (no animation, instant hide).
 */
---

<div id="page-progress" class="page-progress" aria-hidden="true"></div>

<style>
  .page-progress {
    position: fixed;
    top: 0;
    left: 0;
    width: 0;
    height: 3px;
    background: var(--color-brand);
    z-index: 9999;
    pointer-events: none;
    opacity: 0;
    transition: opacity var(--duration-fast) var(--ease-default);
  }

  .page-progress[data-active] {
    opacity: 1;
    animation: progress-grow 8s var(--ease-default) forwards;
  }

  .page-progress[data-done] {
    width: 100%;
    opacity: 0;
    animation: none;
    transition: opacity var(--duration-normal) var(--ease-default);
  }

  @keyframes progress-grow {
    0%   { width: 0; }
    10%  { width: 30%; }
    50%  { width: 60%; }
    80%  { width: 80%; }
    100% { width: 95%; }
  }

  @media (prefers-reduced-motion: reduce) {
    .page-progress,
    .page-progress[data-active],
    .page-progress[data-done] {
      animation: none;
      transition: none;
    }
  }
</style>

<script is:inline>
  (function initPageProgress() {
    const DELAY_MS = 300;
    let delayTimer = null;
    let bar = document.getElementById('page-progress');

    function start() {
      if (!bar) return;
      delayTimer = setTimeout(function () {
        bar.removeAttribute('data-done');
        bar.setAttribute('data-active', '');
      }, DELAY_MS);
    }

    function finish() {
      if (!bar) return;
      if (delayTimer !== null) {
        clearTimeout(delayTimer);
        delayTimer = null;
      }
      if (bar.hasAttribute('data-active')) {
        bar.removeAttribute('data-active');
        bar.setAttribute('data-done', '');
        setTimeout(function () {
          bar.removeAttribute('data-done');
          bar.style.width = '0';
        }, 300);
      }
    }

    function rebind() {
      bar = document.getElementById('page-progress');
    }

    document.addEventListener('astro:before-preparation', start);
    document.addEventListener('astro:page-load', function () {
      rebind();
      finish();
    });
  })();
</script>
