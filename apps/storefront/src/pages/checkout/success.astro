---
import Button from '../../components/Button.astro';
import Container from '../../components/Container.astro';
import Layout from '../../layouts/Layout.astro';
import { getOrderBySession } from '../../lib/api';

const sessionId = Astro.url.searchParams.get('session_id');
let order = null;

if (sessionId) {
	try {
		order = await getOrderBySession(sessionId);
	} catch (e) {
		console.error('Failed to fetch order:', e);
	}
}

const formatPrice = (amount: number, currency: string) => {
	return new Intl.NumberFormat('ja-JP', {
		style: 'currency',
		currency: currency || 'JPY'
	}).format(amount);
};
---

<Layout title="Order Confirmed - Led Kikaku">
	<div class="min-h-screen bg-[#f5f5f7] flex items-center">
		<Container class="py-16">
			<div class="mx-auto w-full max-w-xl text-center">
				{/* Success Icon with Animation */}
				<div class="mx-auto flex h-20 w-20 items-center justify-center rounded-full bg-green-100 animate-scale-in">
					<svg class="h-10 w-10 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
						<path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
					</svg>
				</div>

				<h1 class="mt-8 text-4xl font-semibold tracking-tight text-[#1d1d1f] md:text-5xl">
					Thank you.
				</h1>
				<p class="mt-4 text-xl text-[#86868b]">
					Your order is confirmed.
				</p>

				{/* Order Details Card */}
				{order ? (
					<div class="mt-10 rounded-3xl bg-white p-8 text-left shadow-sm">
						<div class="flex items-center justify-between mb-6">
							<p class="text-sm text-[#86868b]">Order #{order.id}</p>
							<span class="inline-flex items-center rounded-full bg-green-100 px-3 py-1 text-sm font-medium text-green-800">
								{order.status === 'paid' ? 'Confirmed' : order.status}
							</span>
						</div>

						{/* Order Items */}
						<div class="space-y-4 border-t border-gray-100 pt-6">
							{order.items.map((item) => (
								<div class="flex justify-between">
									<div>
										<p class="font-medium text-[#1d1d1f]">{item.title}</p>
										<p class="text-sm text-[#86868b]">Qty: {item.quantity}</p>
									</div>
									<p class="font-medium text-[#1d1d1f]">
										{formatPrice(item.unit_price * item.quantity, order.currency)}
									</p>
								</div>
							))}
						</div>

						{/* Total */}
						<div class="mt-6 border-t border-gray-100 pt-6">
							<div class="flex justify-between text-lg font-semibold">
								<span>Total</span>
								<span>{formatPrice(order.total_net, order.currency)}</span>
							</div>
						</div>

						{/* Email */}
						{order.customer_email && (
							<div class="mt-6 border-t border-gray-100 pt-6">
								<p class="text-sm text-[#86868b]">
									Confirmation sent to: <span class="text-[#1d1d1f]">{order.customer_email}</span>
								</p>
							</div>
						)}
					</div>
				) : (
					<div class="mt-10 rounded-3xl bg-white p-8 text-left shadow-sm">
						<p class="mb-2 text-sm text-[#86868b]">Order confirmation</p>
						<p class="text-lg text-[#1d1d1f]">
							A confirmation email has been sent to your inbox with shipping details and tracking information.
						</p>
					</div>
				)}

				{/* Next Actions */}
				<div class="mt-10 flex flex-col items-center justify-center gap-4 sm:flex-row">
					<Button href="/products" size="lg">
						Continue shopping
					</Button>
					<Button href="/" variant="link" size="lg">
						Return to home
					</Button>
				</div>
			</div>
		</Container>
	</div>
</Layout>
