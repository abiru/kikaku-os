---
export const prerender = false;

import AccountLayout from '../../layouts/AccountLayout.astro';
import Container from '../../components/Container.astro';
import { t } from '../../i18n';
import { getCsrfToken, validateCsrfToken, CSRF_FIELD_NAME } from '../../lib/csrf';
import { getApiBase } from '../../lib/api';

const API_BASE = getApiBase();

const authHeader = Astro.request.headers.get('authorization');

type ShippingAddress = {
  postal_code?: string;
  prefecture?: string;
  city?: string;
  address1?: string;
  address2?: string;
  phone?: string;
};

type Account = {
  id: number;
  name: string;
  email: string | null;
  shipping_address: ShippingAddress | null;
};

let account: Account | null = null;
let error = null;
let success = false;

// Handle form submission
if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();

    if (!validateCsrfToken(Astro.request, formData)) {
      error = 'Invalid CSRF token. Please reload the page and try again.';
    } else {
      const name = formData.get('name') as string;
      const postal_code = formData.get('postal_code') as string;
      const prefecture = formData.get('prefecture') as string;
      const city = formData.get('city') as string;
      const address1 = formData.get('address1') as string;
      const address2 = formData.get('address2') as string;
      const phone = formData.get('phone') as string;

      const response = await fetch(`${API_BASE}/store/account/profile`, {
        method: 'PUT',
        headers: {
          'Authorization': authHeader || '',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          name,
          shipping_address: {
            postal_code: postal_code || undefined,
            prefecture: prefecture || undefined,
            city: city || undefined,
            address1: address1 || undefined,
            address2: address2 || undefined,
            phone: phone || undefined,
          },
        }),
      });

      if (response.ok) {
        const data = await response.json();
        if (data.ok) {
          success = true;
        }
      } else {
        error = t('account.saveFailed');
      }
    }
  } catch (e) {
    error = t('account.saveFailed');
  }
}

// Load current account data
try {
  const response = await fetch(`${API_BASE}/store/account`, {
    headers: {
      'Authorization': authHeader || '',
    },
  });

  if (response.ok) {
    const data = await response.json();
    if (data.ok) {
      account = data.account;
    }
  }
} catch (e) {
  error = t('account.loadError');
}

const { token: csrfToken, cookieHeader: csrfCookieHeader } = getCsrfToken(Astro.request);
if (csrfCookieHeader) {
  Astro.response.headers.append('Set-Cookie', csrfCookieHeader);
}
---

<AccountLayout title={t('account.profilePageTitle')} activeTab="profile">
  <Container class="py-8">
    <div class="max-w-2xl mx-auto">
      <h1 class="typo-h2 text-primary mb-6">
        {t('account.editProfile')}
      </h1>

      {success && (
        <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-xl text-green-700 text-sm">
          {t('account.saved')}
        </div>
      )}

      {error && (
        <div id="profile-error" role="alert" class="mb-6 p-4 bg-red-50 border border-red-200 rounded-xl text-red-700 text-sm">
          {error}
        </div>
      )}

      <form method="POST" class="space-y-6">
        <input type="hidden" name={CSRF_FIELD_NAME} value={csrfToken} />
        {/* Basic Info */}
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          <div class="p-4 border-b border-gray-200">
            <h2 class="font-semibold text-primary">{t('account.basicInfo')}</h2>
          </div>
          <div class="p-4 space-y-4">
            <div>
              <label for="name" class="block text-sm font-medium text-primary mb-1">
                {t('account.name')} <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="name"
                name="name"
                required
                aria-required="true"
                value={account?.name || ''}
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand focus:border-transparent outline-none transition-shadow"
              />
            </div>

            <div>
              <label for="email" class="block text-sm font-medium text-primary mb-1">
                {t('account.email')}
              </label>
              <input
                type="email"
                id="email"
                value={account?.email || ''}
                disabled
                class="w-full px-4 py-2.5 border border-gray-200 rounded-lg bg-gray-50 text-secondary cursor-not-allowed"
              />
              <p class="text-xs text-secondary mt-1">
                {t('account.emailManagedByClerk')}
              </p>
            </div>
          </div>
        </div>

        {/* Shipping Address */}
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          <div class="p-4 border-b border-gray-200">
            <h2 class="font-semibold text-primary">{t('account.shippingAddress')}</h2>
          </div>
          <div class="p-4 space-y-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label for="postal_code" class="block text-sm font-medium text-primary mb-1">
                  {t('account.postalCode')}
                </label>
                <input
                  type="text"
                  id="postal_code"
                  name="postal_code"
                  value={account?.shipping_address?.postal_code || ''}
                  placeholder="123-4567"
                  class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand focus:border-transparent outline-none transition-shadow"
                />
              </div>

              <div>
                <label for="prefecture" class="block text-sm font-medium text-primary mb-1">
                  {t('account.prefecture')}
                </label>
                <input
                  type="text"
                  id="prefecture"
                  name="prefecture"
                  value={account?.shipping_address?.prefecture || ''}
                  placeholder="東京都"
                  class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand focus:border-transparent outline-none transition-shadow"
                />
              </div>
            </div>

            <div>
              <label for="city" class="block text-sm font-medium text-primary mb-1">
                {t('account.city')}
              </label>
              <input
                type="text"
                id="city"
                name="city"
                value={account?.shipping_address?.city || ''}
                placeholder="渋谷区"
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand focus:border-transparent outline-none transition-shadow"
              />
            </div>

            <div>
              <label for="address1" class="block text-sm font-medium text-primary mb-1">
                {t('account.address1')}
              </label>
              <input
                type="text"
                id="address1"
                name="address1"
                value={account?.shipping_address?.address1 || ''}
                placeholder="渋谷1-2-3"
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand focus:border-transparent outline-none transition-shadow"
              />
            </div>

            <div>
              <label for="address2" class="block text-sm font-medium text-primary mb-1">
                {t('account.address2')}
              </label>
              <input
                type="text"
                id="address2"
                name="address2"
                value={account?.shipping_address?.address2 || ''}
                placeholder="○○ビル 101号室"
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand focus:border-transparent outline-none transition-shadow"
              />
            </div>

            <div>
              <label for="phone" class="block text-sm font-medium text-primary mb-1">
                {t('account.phone')}
              </label>
              <input
                type="tel"
                id="phone"
                name="phone"
                value={account?.shipping_address?.phone || ''}
                placeholder="090-1234-5678"
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand focus:border-transparent outline-none transition-shadow"
              />
            </div>
          </div>
        </div>

        {/* Submit Button */}
        <div class="flex justify-end">
          <button
            type="submit"
            class="h-12 px-8 py-3 bg-brand text-white rounded-lg text-base font-semibold hover:bg-brand-hover transition-colors focus-visible:outline-none focus-visible:ring-3 focus-visible:ring-brand/30 motion-safe:active:scale-[0.98]"
          >
            {t('account.saveChanges')}
          </button>
        </div>
      </form>
    </div>
  </Container>
</AccountLayout>
