---
export const prerender = false;

import AccountLayout from '../../layouts/AccountLayout.astro';
import Container from '../../components/Container.astro';
import { t } from '../../i18n';
import { formatDate } from '../../lib/format';
import { getApiBase } from '../../lib/api';

const API_BASE = getApiBase();

// Get auth token from request
const authHeader = Astro.request.headers.get('authorization');

let account = null;
let stats = null;
let recentOrders: Array<{
  id: number;
  status: string;
  total_amount: number;
  currency: string;
  created_at: string;
}> = [];
let error = null;

const headers = { 'Authorization': authHeader || '' };

const [accountResult, ordersResult] = await Promise.all([
  fetch(`${API_BASE}/store/account`, { headers })
    .then(async (res) => {
      if (res.ok) {
        const data = await res.json();
        if (data.ok) return { account: data.account, stats: data.stats };
      }
      return null;
    })
    .catch(() => null),
  fetch(`${API_BASE}/store/account/orders?perPage=5`, { headers })
    .then(async (res) => {
      if (res.ok) {
        const data = await res.json();
        if (data.ok) return data.orders || [];
      }
      return [];
    })
    .catch(() => []),
]);

if (accountResult) {
  account = accountResult.account;
  stats = accountResult.stats;
} else {
  error = t('account.loadError');
}

recentOrders = ordersResult;

const formatCurrency = (amount: number, currency = 'JPY') => {
  return new Intl.NumberFormat('ja-JP', {
    style: 'currency',
    currency,
  }).format(amount);
};

const statusLabels: Record<string, string> = {
  completed: t('account.completed'),
  paid: t('account.paid'),
  pending: t('account.pending'),
};
---

<AccountLayout title={t('account.pageTitle')} activeTab="dashboard">
  <Container class="py-8">
    <div class="max-w-4xl mx-auto">
      {error && (
        <div class="mb-6 rounded-xl bg-red-50 border border-red-200 p-4">
          <div class="flex items-center gap-3">
            <svg class="h-5 w-5 text-red-500 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" />
            </svg>
            <p class="text-sm text-red-700">{t('account.loadError')}</p>
          </div>
        </div>
      )}

      {/* Welcome Section */}
      <div class="mb-8">
        <h1 class="typo-h2 text-primary">
          {t('account.welcome')}、{account?.name || 'お客様'}
        </h1>
        <p class="text-secondary mt-1">
          {account?.email}
        </p>
      </div>

      {/* Stats Cards */}
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
          <div class="text-secondary text-sm font-medium mb-1">
            {t('account.totalOrders')}
          </div>
          <div class="typo-h1 text-primary">
            {stats?.total_orders || 0}
          </div>
        </div>
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
          <div class="text-secondary text-sm font-medium mb-1">
            {t('account.totalSpent')}
          </div>
          <div class="typo-h1 text-primary">
            {formatCurrency(stats?.total_spent || 0)}
          </div>
        </div>
      </div>

      {/* Recent Orders */}
      <div class="bg-white rounded-xl shadow-sm border border-gray-200">
        <div class="p-6 border-b border-gray-200 flex justify-between items-center">
          <h2 class="typo-h3 text-primary">
            {t('account.recentOrders')}
          </h2>
          {recentOrders.length > 0 && (
            <a href="/account/orders" class="text-sm text-brand hover:underline">
              {t('account.viewAllOrders')}
            </a>
          )}
        </div>

        {recentOrders.length === 0 ? (
          <div class="p-8 text-center">
            <div class="text-secondary mb-4">{t('account.noOrders')}</div>
            <a
              href="/products"
              class="inline-flex items-center justify-center px-6 py-2.5 bg-brand text-white rounded-full text-sm font-medium hover:bg-brand-hover transition-colors"
            >
              {t('account.startShopping')}
            </a>
          </div>
        ) : (
          <div class="divide-y divide-gray-200">
            {recentOrders.map((order) => (
              <a
                href={`/account/orders/${order.id}`}
                class="flex items-center justify-between p-6 hover:bg-gray-50 transition-colors"
              >
                <div>
                  <div class="font-medium text-primary">
                    {t('account.orderNumber')} #{order.id}
                  </div>
                  <div class="text-sm text-secondary mt-1">
                    {formatDate(order.created_at, 'DATE_LONG')}
                  </div>
                </div>
                <div class="text-right">
                  <div class="font-medium text-primary">
                    {formatCurrency(order.total_amount, order.currency)}
                  </div>
                  <div class={`text-sm mt-1 ${
                    order.status === 'completed' || order.status === 'paid'
                      ? 'text-green-600'
                      : 'text-yellow-600'
                  }`}>
                    {statusLabels[order.status] || order.status}
                  </div>
                </div>
              </a>
            ))}
          </div>
        )}
      </div>
    </div>
  </Container>
</AccountLayout>
