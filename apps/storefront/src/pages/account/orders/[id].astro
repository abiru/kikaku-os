---
export const prerender = false;

import AccountLayout from '../../../layouts/AccountLayout.astro';
import Container from '../../../components/Container.astro';
import { t } from '../../../i18n';
import { formatDate } from '../../../lib/format';
import { DATE_FORMATS } from '../../../lib/constants';
import { getApiBase } from '../../../lib/api';

const API_BASE = getApiBase();

const { id } = Astro.params;
const authHeader = Astro.request.headers.get('authorization');

type OrderItem = {
  title: string;
  quantity: number;
  unit_price: number;
  tax_amount: number;
};

type Order = {
  id: number;
  status: string;
  subtotal: number;
  tax_amount: number;
  shipping_fee: number;
  total_discount: number;
  total_amount: number;
  currency: string;
  created_at: string;
  paid_at: string | null;
  shipping: {
    name?: string;
    address?: {
      line1?: string;
      line2?: string;
      city?: string;
      postal_code?: string;
    };
  } | null;
  items: OrderItem[];
};

let order: Order | null = null;
let error = null;

try {
  const response = await fetch(`${API_BASE}/store/account/orders/${id}`, {
    headers: {
      'Authorization': authHeader || '',
    },
  });

  if (response.ok) {
    const data = await response.json();
    if (data.ok) {
      order = data.order;
    }
  } else if (response.status === 404) {
    return Astro.redirect('/account/orders');
  }
} catch (e) {
  error = t('account.loadError');
}

if (!order) {
  return Astro.redirect('/account/orders');
}

const formatCurrency = (amount: number, currency = 'JPY') => {
  return new Intl.NumberFormat('ja-JP', {
    style: 'currency',
    currency,
  }).format(amount);
};

const dateTimeLongOpts = DATE_FORMATS.DATETIME_LONG;

const statusLabels: Record<string, string> = {
  completed: t('account.completed'),
  paid: t('account.paid'),
  pending: t('account.pending'),
};
---

<AccountLayout title={t('account.orderDetailPageTitle', { id: order.id })} activeTab="orders">
  <Container class="py-8">
    <div class="max-w-4xl mx-auto">
      {/* Back Link */}
      <a
        href="/account/orders"
        class="inline-flex items-center gap-1 text-sm text-brand hover:underline mb-6"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
        {t('account.backToOrders')}
      </a>

      {/* Order Header */}
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
        <div>
          <h1 class="typo-h2 text-primary">
            {t('account.orderNumber')} #{order.id}
          </h1>
          <p class="text-secondary mt-1">
            {formatDate(order.created_at, dateTimeLongOpts)}
          </p>
        </div>
        <div class="flex items-center gap-3">
          <button
            type="button"
            id="print-order-btn"
            class="print-hidden inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-primary border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>
            {t('account.printOrder')}
          </button>
          <div class={`inline-flex px-3 py-1 rounded-full text-sm font-medium ${
            order.status === 'completed' || order.status === 'paid'
              ? 'bg-green-100 text-green-700'
              : 'bg-yellow-100 text-yellow-700'
          }`}>
            {statusLabels[order.status] || order.status}
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Order Items */}
        <div class="lg:col-span-2">
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="p-4 border-b border-gray-200">
              <h2 class="font-semibold text-primary">{t('account.items')}</h2>
            </div>
            <div class="divide-y divide-gray-200">
              {order.items.map((item) => (
                <div class="p-4 flex justify-between items-start">
                  <div>
                    <div class="font-medium text-primary">{item.title}</div>
                    <div class="text-sm text-secondary mt-1">
                      {t('account.quantity')}: {item.quantity} x {formatCurrency(item.unit_price, order.currency)}
                    </div>
                  </div>
                  <div class="font-medium text-primary">
                    {formatCurrency(item.unit_price * item.quantity, order.currency)}
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Shipping Address */}
          {order.shipping && (
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mt-6">
              <div class="p-4 border-b border-gray-200">
                <h2 class="font-semibold text-primary">{t('account.shippingAddress')}</h2>
              </div>
              <div class="p-4 text-primary">
                {order.shipping.name && (
                  <div class="font-medium mb-2">{order.shipping.name}</div>
                )}
                {order.shipping.address && (
                  <div class="text-sm text-secondary space-y-1">
                    {order.shipping.address.postal_code && (
                      <div>{order.shipping.address.postal_code}</div>
                    )}
                    {order.shipping.address.city && (
                      <div>{order.shipping.address.city}</div>
                    )}
                    {order.shipping.address.line1 && (
                      <div>{order.shipping.address.line1}</div>
                    )}
                    {order.shipping.address.line2 && (
                      <div>{order.shipping.address.line2}</div>
                    )}
                  </div>
                )}
              </div>
            </div>
          )}
        </div>

        {/* Order Summary */}
        <div class="lg:col-span-1">
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden sticky top-20">
            <div class="p-4 border-b border-gray-200">
              <h2 class="font-semibold text-primary">{t('checkout.orderSummary')}</h2>
            </div>
            <div class="p-4 space-y-3">
              <div class="flex justify-between text-sm">
                <span class="text-secondary">{t('account.subtotal')}</span>
                <span class="text-primary">{formatCurrency(order.subtotal, order.currency)}</span>
              </div>

              <div class="flex justify-between text-sm">
                <span class="text-secondary">{t('account.tax')}</span>
                <span class="text-primary">{formatCurrency(order.tax_amount, order.currency)}</span>
              </div>

              {order.shipping_fee > 0 && (
                <div class="flex justify-between text-sm">
                  <span class="text-secondary">{t('account.shipping')}</span>
                  <span class="text-primary">{formatCurrency(order.shipping_fee, order.currency)}</span>
                </div>
              )}

              {order.total_discount > 0 && (
                <div class="flex justify-between text-sm">
                  <span class="text-secondary">{t('account.discount')}</span>
                  <span class="text-green-600">-{formatCurrency(order.total_discount, order.currency)}</span>
                </div>
              )}

              <div class="pt-3 border-t border-gray-200">
                <div class="flex justify-between">
                  <span class="font-semibold text-primary">{t('account.total')}</span>
                  <span class="font-semibold text-primary">{formatCurrency(order.total_amount, order.currency)}</span>
                </div>
              </div>

              {order.paid_at && (
                <div class="pt-3 border-t border-gray-200 text-sm">
                  <span class="text-secondary">{t('account.paymentStatus')}: </span>
                  <span class="text-green-600">{t('account.paid')}</span>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  </Container>
</AccountLayout>

<script>
  const printBtn = document.getElementById('print-order-btn');
  if (printBtn) {
    printBtn.addEventListener('click', () => {
      window.print();
    });
  }
</script>

<style>
  /* Print button: hidden when printing */
  @media print {
    @page {
      size: A4;
      margin: 15mm;
    }

    /* Force white background and black text globally */
    :global(html),
    :global(body) {
      background: white !important;
      color: black !important;
      font-size: 12pt !important;
      line-height: 1.4 !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    /* Hide navigation, footer, interactive elements, and non-essential UI */
    :global(header[role="banner"]),
    :global(footer),
    :global(nav),
    :global(#mobile-menu),
    :global(#mobile-menu-overlay),
    :global(.cookie-consent),
    :global(#search-btn),
    :global(#cart-link),
    :global(#wishlist-link),
    :global(#clerk-auth),
    :global(#mobile-menu-btn),
    :global([data-back-to-top]) {
      display: none !important;
    }

    /* Hide the account tab navigation */
    :global(.bg-white.border-b.border-gray-200) {
      display: none !important;
    }

    /* Hide back link and print button */
    .print-hidden,
    :global(a[href="/account/orders"]) {
      display: none !important;
    }

    /* Remove min-height constraint */
    :global(.min-h-screen) {
      min-height: auto !important;
    }

    /* Remove sticky positioning */
    :global(.sticky) {
      position: static !important;
    }

    /* Reset backgrounds and shadows */
    :global(.bg-subtle) {
      background: white !important;
    }

    :global(.bg-white) {
      background: white !important;
    }

    :global(.shadow-sm),
    :global(.shadow-\[var\(--shadow-subtle\)\]),
    :global(.backdrop-blur-xl) {
      box-shadow: none !important;
      backdrop-filter: none !important;
    }

    /* Ensure all text is black */
    :global(.text-primary),
    :global(.text-secondary),
    :global(.text-brand),
    :global(.font-semibold),
    :global(.font-medium) {
      color: black !important;
    }

    /* Keep green for paid/completed status */
    :global(.text-green-600),
    :global(.text-green-700) {
      color: #15803d !important;
    }

    /* Ensure borders print */
    :global(.border-gray-200) {
      border-color: #e5e7eb !important;
    }

    :global(.divide-gray-200) > * + * {
      border-color: #e5e7eb !important;
    }

    /* Status badge: ensure visibility */
    :global(.rounded-full.bg-green-100) {
      background: #dcfce7 !important;
      color: #15803d !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    :global(.rounded-full.bg-yellow-100) {
      background: #fef9c3 !important;
      color: #a16207 !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    /* Ensure border on cards for print */
    :global(.rounded-xl) {
      border: 1px solid #d1d5db !important;
      border-radius: 4px !important;
      overflow: visible !important;
    }

    /* Force single column layout for print */
    :global(.grid.grid-cols-1.lg\:grid-cols-3) {
      display: block !important;
    }

    :global(.lg\:col-span-2),
    :global(.lg\:col-span-1) {
      width: 100% !important;
      max-width: 100% !important;
      margin-bottom: 16pt !important;
    }

    /* Container: full width for print */
    :global(.max-w-4xl) {
      max-width: 100% !important;
    }

    /* Avoid page breaks inside items */
    :global(.divide-y > div) {
      page-break-inside: avoid;
      break-inside: avoid;
    }

    :global(.rounded-xl) {
      page-break-inside: avoid;
      break-inside: avoid;
    }

    /* Remove unnecessary padding */
    :global(.py-8) {
      padding-top: 0 !important;
      padding-bottom: 0 !important;
    }

    /* Links: show as plain text */
    :global(a) {
      text-decoration: none !important;
      color: black !important;
    }
  }
</style>
