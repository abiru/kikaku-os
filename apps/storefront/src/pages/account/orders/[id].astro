---
export const prerender = false;

import AccountLayout from '../../../layouts/AccountLayout.astro';
import Container from '../../../components/Container.astro';
import { t } from '../../../i18n';
import { formatDate } from '../../../lib/format';

const API_BASE = import.meta.env.PUBLIC_API_BASE || 'http://localhost:8787';

const { id } = Astro.params;
const authHeader = Astro.request.headers.get('authorization');

type OrderItem = {
  title: string;
  quantity: number;
  unit_price: number;
  tax_amount: number;
};

type Order = {
  id: number;
  status: string;
  subtotal: number;
  tax_amount: number;
  shipping_fee: number;
  total_discount: number;
  total_amount: number;
  currency: string;
  created_at: string;
  paid_at: string | null;
  shipping: {
    name?: string;
    address?: {
      line1?: string;
      line2?: string;
      city?: string;
      postal_code?: string;
    };
  } | null;
  items: OrderItem[];
};

let order: Order | null = null;
let error = null;

try {
  const response = await fetch(`${API_BASE}/store/account/orders/${id}`, {
    headers: {
      'Authorization': authHeader || '',
    },
  });

  if (response.ok) {
    const data = await response.json();
    if (data.ok) {
      order = data.order;
    }
  } else if (response.status === 404) {
    return Astro.redirect('/account/orders');
  }
} catch (e) {
  error = 'Failed to load order';
}

if (!order) {
  return Astro.redirect('/account/orders');
}

const formatCurrency = (amount: number, currency = 'JPY') => {
  return new Intl.NumberFormat('ja-JP', {
    style: 'currency',
    currency,
  }).format(amount);
};

const dateTimeLongOpts: Intl.DateTimeFormatOptions = {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
  hour: '2-digit',
  minute: '2-digit',
};

const statusLabels: Record<string, string> = {
  completed: t('account.completed'),
  paid: t('account.paid'),
  pending: t('account.pending'),
};
---

<AccountLayout title={`注文 #${order.id} - Led Kikaku Store`} activeTab="orders">
  <Container class="py-8">
    <div class="max-w-4xl mx-auto">
      {/* Back Link */}
      <a
        href="/account/orders"
        class="inline-flex items-center gap-1 text-sm text-[#0071e3] hover:underline mb-6"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
        {t('account.backToOrders')}
      </a>

      {/* Order Header */}
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
        <div>
          <h1 class="text-2xl font-semibold text-[#1d1d1f]">
            {t('account.orderNumber')} #{order.id}
          </h1>
          <p class="text-[#6e6e73] mt-1">
            {formatDate(order.created_at, dateTimeLongOpts)}
          </p>
        </div>
        <div class={`inline-flex px-3 py-1 rounded-full text-sm font-medium ${
          order.status === 'completed' || order.status === 'paid'
            ? 'bg-green-100 text-green-700'
            : 'bg-yellow-100 text-yellow-700'
        }`}>
          {statusLabels[order.status] || order.status}
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Order Items */}
        <div class="lg:col-span-2">
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="p-4 border-b border-gray-200">
              <h2 class="font-semibold text-[#1d1d1f]">{t('account.items')}</h2>
            </div>
            <div class="divide-y divide-gray-200">
              {order.items.map((item) => (
                <div class="p-4 flex justify-between items-start">
                  <div>
                    <div class="font-medium text-[#1d1d1f]">{item.title}</div>
                    <div class="text-sm text-[#6e6e73] mt-1">
                      {t('account.quantity')}: {item.quantity} x {formatCurrency(item.unit_price, order.currency)}
                    </div>
                  </div>
                  <div class="font-medium text-[#1d1d1f]">
                    {formatCurrency(item.unit_price * item.quantity, order.currency)}
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Shipping Address */}
          {order.shipping && (
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mt-6">
              <div class="p-4 border-b border-gray-200">
                <h2 class="font-semibold text-[#1d1d1f]">{t('account.shippingAddress')}</h2>
              </div>
              <div class="p-4 text-[#1d1d1f]">
                {order.shipping.name && (
                  <div class="font-medium mb-2">{order.shipping.name}</div>
                )}
                {order.shipping.address && (
                  <div class="text-sm text-[#6e6e73] space-y-1">
                    {order.shipping.address.postal_code && (
                      <div>{order.shipping.address.postal_code}</div>
                    )}
                    {order.shipping.address.city && (
                      <div>{order.shipping.address.city}</div>
                    )}
                    {order.shipping.address.line1 && (
                      <div>{order.shipping.address.line1}</div>
                    )}
                    {order.shipping.address.line2 && (
                      <div>{order.shipping.address.line2}</div>
                    )}
                  </div>
                )}
              </div>
            </div>
          )}
        </div>

        {/* Order Summary */}
        <div class="lg:col-span-1">
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden sticky top-20">
            <div class="p-4 border-b border-gray-200">
              <h2 class="font-semibold text-[#1d1d1f]">{t('checkout.orderSummary')}</h2>
            </div>
            <div class="p-4 space-y-3">
              <div class="flex justify-between text-sm">
                <span class="text-[#6e6e73]">{t('account.subtotal')}</span>
                <span class="text-[#1d1d1f]">{formatCurrency(order.subtotal, order.currency)}</span>
              </div>

              <div class="flex justify-between text-sm">
                <span class="text-[#6e6e73]">{t('account.tax')}</span>
                <span class="text-[#1d1d1f]">{formatCurrency(order.tax_amount, order.currency)}</span>
              </div>

              {order.shipping_fee > 0 && (
                <div class="flex justify-between text-sm">
                  <span class="text-[#6e6e73]">{t('account.shipping')}</span>
                  <span class="text-[#1d1d1f]">{formatCurrency(order.shipping_fee, order.currency)}</span>
                </div>
              )}

              {order.total_discount > 0 && (
                <div class="flex justify-between text-sm">
                  <span class="text-[#6e6e73]">{t('account.discount')}</span>
                  <span class="text-green-600">-{formatCurrency(order.total_discount, order.currency)}</span>
                </div>
              )}

              <div class="pt-3 border-t border-gray-200">
                <div class="flex justify-between">
                  <span class="font-semibold text-[#1d1d1f]">{t('account.total')}</span>
                  <span class="font-semibold text-[#1d1d1f]">{formatCurrency(order.total_amount, order.currency)}</span>
                </div>
              </div>

              {order.paid_at && (
                <div class="pt-3 border-t border-gray-200 text-sm">
                  <span class="text-[#6e6e73]">{t('account.paymentStatus')}: </span>
                  <span class="text-green-600">{t('account.paid')}</span>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  </Container>
</AccountLayout>
