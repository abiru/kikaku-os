---
export const prerender = false;

import { Alert } from '../../components/catalyst/alert-banner';
import AdminLayout from '../../layouts/AdminLayout.astro';
import { Heading } from '../../components/catalyst/heading';
import { Pagination, PaginationPrevious, PaginationNext } from '../../components/catalyst/pagination';
import { adminFetchList } from '../../lib/admin/fetchAdmin';
import ReportsTable from '../../components/admin/ReportsTable';
import { ErrorBoundary } from '../../components/ErrorBoundary';
import { t } from '../../i18n';

type Report = {
	id: number;
	date: string;
	created_at: string;
	downloadUrl?: string;
};

const page = Number(Astro.url.searchParams.get('page') || '1');
const dateFrom = Astro.url.searchParams.get('from') || '';
const dateTo = Astro.url.searchParams.get('to') || '';
const perPage = 20;

const query = new URLSearchParams({
	page: page.toString(),
	perPage: perPage.toString()
});
if (dateFrom) query.set('from', dateFrom);
if (dateTo) query.set('to', dateTo);

const { data, error: fetchError } = await adminFetchList<{ reports: Report[]; meta: { totalCount: number; totalPages: number } }>('/admin/reports', query);
const reports = data?.reports || [];
const meta = data?.meta || { totalCount: 0, totalPages: 1 };
const error = fetchError ? t('errors.failedToLoadReports') : null;

const hasNext = page < meta.totalPages;
const hasPrev = page > 1;
const getReportLink = (id: number) => {
	return `/api/admin/documents/${id}/download`;
};

// Add downloadUrl to each report
const reportsWithUrls = reports.map(r => ({
	...r,
	downloadUrl: getReportLink(r.id)
}));
---

<AdminLayout title={`${t('admin.reports')} - Admin`}>
	<div class="space-y-6">
		<div class="flex items-center gap-4">
			<Heading>{t('admin.reports')}</Heading>
			<span class="text-xs text-zinc-500 bg-zinc-100 px-2 py-1 rounded-full">{meta.totalCount} {t('admin.reports')}</span>
		</div>

		{/* Date Range Filter */}
		<form method="get" class="flex flex-wrap items-end gap-4">
			<div>
				<label for="report-from" class="block text-xs font-medium text-zinc-600 mb-1">{t('admin.exportDateFrom')}</label>
				<input type="date" id="report-from" name="from" value={dateFrom} class="rounded-md border-zinc-200 text-sm py-1.5" />
			</div>
			<div>
				<label for="report-to" class="block text-xs font-medium text-zinc-600 mb-1">{t('admin.exportDateTo')}</label>
				<input type="date" id="report-to" name="to" value={dateTo} class="rounded-md border-zinc-200 text-sm py-1.5" />
			</div>
			<button type="submit" class="px-4 py-1.5 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700">
				{t('common.apply')}
			</button>
			{(dateFrom || dateTo) && (
				<a href="/admin/reports" class="px-4 py-1.5 text-sm font-medium text-zinc-600 bg-zinc-100 rounded-lg hover:bg-zinc-200">
					{t('common.clear')}
				</a>
			)}
		</form>

		{error && (
			<Alert color="red" client:load>
				{error}
			</Alert>
		)}

		<ErrorBoundary client:only="react">
			<ReportsTable reports={reportsWithUrls} />
		</ErrorBoundary>

		{/* Pagination */}
		<div class="flex items-center justify-between">
			<div class="text-xs text-zinc-500">
				{t('admin.pageOf', { page, totalPages: meta.totalPages })}
			</div>
			<Pagination client:load>
				<PaginationPrevious href={hasPrev ? `?page=${page - 1}${dateFrom ? `&from=${dateFrom}` : ''}${dateTo ? `&to=${dateTo}` : ''}` : null} />
				<PaginationNext href={hasNext ? `?page=${page + 1}${dateFrom ? `&from=${dateFrom}` : ''}${dateTo ? `&to=${dateTo}` : ''}` : null} />
			</Pagination>
		</div>
	</div>
</AdminLayout>
