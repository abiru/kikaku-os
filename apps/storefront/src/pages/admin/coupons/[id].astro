---
export const prerender = false;

import { Alert } from '../../../components/catalyst/alert-banner';
import { Badge } from '../../../components/catalyst/badge';
import { Input } from '../../../components/catalyst/input';
import { Select } from '../../../components/catalyst/select';
import { Fieldset, Field, Label } from '../../../components/catalyst/fieldset';
import { Button } from '../../../components/catalyst/button';
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getApiBase } from '../../../lib/api';
import { formatDate } from '../../../lib/format';

const { id } = Astro.params;
const apiBase = getApiBase();
const apiKey = import.meta.env.ADMIN_API_KEY;

type Coupon = {
	id: number;
	code: string;
	type: string;
	value: number;
	currency: string;
	min_order_amount: number;
	max_uses: number | null;
	uses_per_customer: number;
	current_uses: number;
	status: string;
	starts_at: string | null;
	expires_at: string | null;
	created_at: string;
	updated_at: string;
};

type Stats = {
	totalUsages: number;
	totalDiscount: number;
};

let coupon: Coupon | null = null;
let stats: Stats = { totalUsages: 0, totalDiscount: 0 };
let error: string | null = null;
let successMessage: string | null = null;

// Handle POST - Update coupon
if (Astro.request.method === 'POST' && apiKey) {
	try {
		const formData = await Astro.request.formData();
		const code = formData.get('code')?.toString().trim().toUpperCase() || '';
		const type = formData.get('type')?.toString() || 'percentage';
		const valueStr = formData.get('value')?.toString() || '';
		const minOrderStr = formData.get('min_order_amount')?.toString() || '0';
		const maxUsesStr = formData.get('max_uses')?.toString() || '';
		const usesPerCustomerStr = formData.get('uses_per_customer')?.toString() || '1';
		const status = formData.get('status')?.toString() || 'active';
		const starts_at = formData.get('starts_at')?.toString() || '';
		const expires_at = formData.get('expires_at')?.toString() || '';

		const value = parseInt(valueStr, 10);
		const min_order_amount = parseInt(minOrderStr, 10) || 0;
		const max_uses = maxUsesStr ? parseInt(maxUsesStr, 10) : null;
		const uses_per_customer = parseInt(usesPerCustomerStr, 10) || 1;

		if (!code) {
			error = 'Code is required';
		} else if (isNaN(value) || value <= 0) {
			error = 'Value must be a positive number';
		} else if (type === 'percentage' && value > 100) {
			error = 'Percentage value cannot exceed 100';
		} else {
			const res = await fetch(`${apiBase}/admin/coupons/${id}`, {
				method: 'PUT',
				headers: {
					'Content-Type': 'application/json',
					'x-admin-key': apiKey
				},
				body: JSON.stringify({
					code,
					type,
					value,
					currency: 'JPY',
					min_order_amount,
					max_uses,
					uses_per_customer,
					status,
					starts_at: starts_at || null,
					expires_at: expires_at || null
				})
			});

			const data = await res.json();

			if (!res.ok) {
				error = data.message || 'Failed to update coupon';
			} else {
				coupon = data.coupon;
				successMessage = 'Coupon updated successfully';
			}
		}
	} catch (e) {
		console.error(e);
		error = 'Failed to update coupon. Please check your connection.';
	}
}

// Fetch coupon data
if (!coupon && apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/coupons/${id}`, {
			headers: { 'x-admin-key': apiKey }
		});

		if (!res.ok) {
			if (res.status === 404) {
				error = 'Coupon not found';
			} else {
				const data = await res.json();
				error = data.message || `API Error: ${res.status}`;
			}
		} else {
			const data = await res.json();
			coupon = data.coupon;
			stats = data.stats || stats;
		}
	} catch (e) {
		console.error(e);
		error = error || 'Failed to load coupon. Please check your connection.';
	}
} else if (!apiKey) {
	error = 'ADMIN_API_KEY is missing in server environment';
}

// Fetch stats again after update
if (coupon && apiKey && successMessage) {
	try {
		const res = await fetch(`${apiBase}/admin/coupons/${id}`, {
			headers: { 'x-admin-key': apiKey }
		});
		if (res.ok) {
			const data = await res.json();
			stats = data.stats || stats;
		}
	} catch (e) {
		console.error('Failed to fetch stats:', e);
	}
}

const dateTimeOpts: Intl.DateTimeFormatOptions = {
	year: 'numeric',
	month: '2-digit',
	day: '2-digit',
	hour: '2-digit',
	minute: '2-digit'
};

const formatDateForInput = (dateStr: string | null) => {
	if (!dateStr) return '';
	const date = new Date(dateStr);
	return date.toISOString().slice(0, 16);
};

const formatCurrency = (amount: number, currency: string = 'JPY') => {
	return new Intl.NumberFormat('ja-JP', {
		style: 'currency',
		currency: currency,
		minimumFractionDigits: 0
	}).format(amount);
};

const isExpired = (c: Coupon) => {
	if (!c.expires_at) return false;
	return new Date(c.expires_at) < new Date();
};

const canDelete = coupon && coupon.current_uses === 0;
---

<AdminLayout title={coupon ? `${coupon.code} - Admin` : 'Coupon - Admin'}>
	<div class="space-y-6 max-w-2xl">
		<div class="flex items-center gap-4">
			<a href="/admin/coupons" class="text-indigo-600 hover:text-indigo-500 text-sm flex items-center gap-1">
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
				</svg>
				Coupons
			</a>
			<h1 class="text-2xl font-semibold text-gray-900">
				{coupon ? `Edit: ${coupon.code}` : 'Coupon'}
			</h1>
		</div>
		{successMessage && (
			<div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-6 text-sm">
				{successMessage}
			</div>
		)}

		{error && !coupon && (
			<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-8 text-center">
				<div class="text-red-600 mb-4">{error}</div>
				<Button href="/admin/coupons" color="zinc" client:load>
					Back to Coupons
				</Button>
			</div>
		)}

		{error && coupon && (
			<div role="alert" class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg mb-6 text-sm">
				{error}
			</div>
		)}

		{coupon && (
			<>
				{/* Stats Card */}
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 mb-6">
					<h2 class="text-sm font-medium text-secondary mb-4">Usage Statistics</h2>
					<div class="grid grid-cols-3 gap-6">
						<div>
							<div class="text-2xl font-semibold text-zinc-950 tabular-nums">{stats.totalUsages}</div>
							<div class="text-xs text-secondary">Total Uses</div>
						</div>
						<div>
							<div class="text-2xl font-semibold text-zinc-950 tabular-nums">{formatCurrency(stats.totalDiscount, coupon.currency)}</div>
							<div class="text-xs text-secondary">Total Discount</div>
						</div>
						<div>
							<div class="flex items-center gap-2">
								{isExpired(coupon) ? (
									<Badge color="amber" client:load>Expired</Badge>
								) : coupon.status === 'active' ? (
									<Badge color="blue" client:load>Active</Badge>
								) : (
									<Badge color="zinc" client:load>Inactive</Badge>
								)}
							</div>
							<div class="text-xs text-secondary mt-1">Current Status</div>
						</div>
					</div>
				</div>

				{/* Edit Form */}
				<form method="POST" class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6">
					<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
						<div class="md:col-span-2">
				<Fieldset client:load>
							<Field>
								<Label>
									Coupon Code <span class="text-red-500">*</span>
								</Label>
								<Input
									type="text"
									id="code"
									name="code"
									required
									value={coupon.code}
									className="font-mono uppercase"
									client:load
								/>
							</Field>
						</div>

						<Field>
							<Label>
								Discount Type <span class="text-red-500">*</span>
							</Label>
							<Select
								id="type"
								name="type"
								client:load
							>
								<option value="percentage" selected={coupon.type === 'percentage'}>Percentage (%)</option>
								<option value="fixed" selected={coupon.type === 'fixed'}>Fixed Amount (JPY)</option>
							</Select>
						</Field>

						<Field>
							<Label>
								Value <span class="text-red-500">*</span>
							</Label>
							<Input
								type="number"
								id="value"
								name="value"
								required
								min="1"
								value={coupon.value}
								className="tabular-nums"
								client:load
							/>
						</Field>

						<Field>
							<Label>Minimum Order Amount (JPY)</Label>
							<Input
								type="number"
								id="min_order_amount"
								name="min_order_amount"
								min="0"
								value={coupon.min_order_amount}
								className="tabular-nums"
								client:load
							/>
						</Field>

						<Field>
							<Label>Max Total Uses</Label>
							<Input
								type="number"
								id="max_uses"
								name="max_uses"
								min="1"
								value={coupon.max_uses || ''}
								className="tabular-nums"
								placeholder="Unlimited"
								client:load
							/>
						</Field>

						<Field>
							<Label>Uses Per Customer</Label>
							<Input
								type="number"
								id="uses_per_customer"
								name="uses_per_customer"
								min="1"
								value={coupon.uses_per_customer}
								className="tabular-nums"
								client:load
							/>
						</Field>

						<Field>
							<Label>Status</Label>
							<Select
								id="status"
								name="status"
								client:load
							>
								<option value="active" selected={coupon.status === 'active'}>Active</option>
								<option value="inactive" selected={coupon.status === 'inactive'}>Inactive</option>
							</Select>
						</Field>

						<Field>
							<Label>Start Date</Label>
							<Input
								type="datetime-local"
								id="starts_at"
								name="starts_at"
								value={formatDateForInput(coupon.starts_at)}
								client:load
							/>
						</Field>

						<Field>
							<Label>Expiration Date</Label>
							<Input
								type="datetime-local"
								id="expires_at"
								name="expires_at"
								value={formatDateForInput(coupon.expires_at)}
								client:load
							/>
						</Field>
				</Fieldset>
					</div>

					<div class="pt-4 border-t border-gray-100">
						<dl class="grid grid-cols-2 gap-4 text-sm">
							<div>
								<dt class="text-secondary">Created</dt>
								<dd class="text-zinc-950 tabular-nums">{formatDate(coupon.created_at, dateTimeOpts)}</dd>
							</div>
							<div>
								<dt class="text-secondary">Updated</dt>
								<dd class="text-zinc-950 tabular-nums">{formatDate(coupon.updated_at, dateTimeOpts)}</dd>
							</div>
						</dl>
					</div>

					<div class="flex justify-between items-center gap-3 pt-4 border-t border-gray-100">
						<div>
							{canDelete ? (
								<button
									type="button"
									id="delete-btn"
									class="text-sm text-red-500 hover:underline"
								>
									Delete Coupon
								</button>
							) : (
								<span class="text-sm text-secondary">Cannot delete used coupons</span>
							)}
						</div>
						<div class="flex gap-3">
							<Button href="/admin/coupons" color="zinc" client:load>
								Back
							</Button>
							<button
								type="button"
								id="toggle-btn"
								class={`px-4 py-2 text-sm font-medium rounded-lg transition-colors ${coupon.status === 'active' ? 'bg-yellow-100 text-yellow-700 hover:bg-yellow-200' : 'bg-green-100 text-green-700 hover:bg-green-200'}`}
							>
								{coupon.status === 'active' ? 'Deactivate' : 'Activate'}
							</button>
							<Button type="submit" color="indigo" client:load>
								Save Changes
							</Button>
						</div>
					</div>
				</form>
			</>
		)}
	</div>
</AdminLayout>

<script define:vars={{ couponId: id, canDelete }}>
	const deleteBtn = document.getElementById('delete-btn');
	const toggleBtn = document.getElementById('toggle-btn');

	if (deleteBtn && canDelete) {
		deleteBtn.addEventListener('click', async () => {
			if (!confirm('Are you sure you want to delete this coupon? This action cannot be undone.')) {
				return;
			}

			try {
				const res = await fetch(`/api/admin/coupons/${couponId}`, {
					method: 'DELETE',
				});

				if (res.ok) {
					window.location.href = '/admin/coupons';
				} else {
					const data = await res.json();
					alert(data.message || 'Failed to delete coupon');
				}
			} catch (e) {
				alert('Failed to delete coupon. Please try again.');
			}
		});
	}

	if (toggleBtn) {
		toggleBtn.addEventListener('click', async () => {
			try {
				const res = await fetch(`/api/admin/coupons/${couponId}/toggle`, {
					method: 'POST',
				});

				if (res.ok) {
					window.location.reload();
				} else {
					const data = await res.json();
					alert(data.message || 'Failed to toggle coupon status');
				}
			} catch (e) {
				alert('Failed to toggle coupon status. Please try again.');
			}
		});
	}
</script>
