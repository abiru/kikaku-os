---
export const prerender = false;

import { Alert } from '../../../components/catalyst/alert-banner';
import { Badge } from '../../../components/catalyst/badge';
import { Input } from '../../../components/catalyst/input';
import { Select } from '../../../components/catalyst/select';
import { Fieldset, Field, Label } from '../../../components/catalyst/fieldset';
import { Button } from '../../../components/catalyst/button';
import AdminLayout from '../../../layouts/AdminLayout.astro';
import ConfirmDialog from '../../../components/admin/ConfirmDialog.astro';
import { getApiBase } from '../../../lib/api';
import { formatDate } from '../../../lib/format';
import { DATE_FORMATS } from '../../../lib/constants';
import { getCsrfToken, validateCsrfToken, CSRF_FIELD_NAME } from '../../../lib/csrf';
import { t } from '../../../i18n';
import { handleCouponPost } from '../../../lib/admin/coupon-actions';
import { logError } from '../../../lib/logger';

const { id } = Astro.params;
const apiBase = getApiBase();
const apiKey = import.meta.env.ADMIN_API_KEY;

type Coupon = {
	id: number;
	code: string;
	type: string;
	value: number;
	currency: string;
	min_order_amount: number;
	max_uses: number | null;
	uses_per_customer: number;
	current_uses: number;
	status: string;
	starts_at: string | null;
	expires_at: string | null;
	created_at: string;
	updated_at: string;
};

type Stats = {
	totalUsages: number;
	totalDiscount: number;
};

let coupon: Coupon | null = null;
let stats: Stats = { totalUsages: 0, totalDiscount: 0 };
let error: string | null = null;
let successMessage: string | null = null;

// Handle POST actions (update, delete, toggle)
if (Astro.request.method === 'POST' && apiKey) {
	try {
		const formData = await Astro.request.formData();

		if (!validateCsrfToken(Astro.request, formData)) {
			error = 'Invalid CSRF token. Please reload and try again.';
		} else {
			const result = await handleCouponPost(formData, apiBase, apiKey, id!, t);
			if (result.redirect) {
				return Astro.redirect(result.redirect);
			}
			coupon = result.coupon as Coupon | null;
			error = result.error;
			successMessage = result.successMessage;
		}
	} catch (e) {
		logError('Failed to update coupon', e, { page: 'admin/coupons/[id]', action: 'postAction', resourceId: id });
		error = t('errors.failedToUpdateCoupon');
	}
}

// Fetch coupon data
if (!coupon && apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/coupons/${id}`, {
			headers: { 'x-admin-key': apiKey }
		});

		if (!res.ok) {
			if (res.status === 404) {
				error = t('errors.couponNotFound');
			} else {
				const data = await res.json();
				error = data.message || `API Error: ${res.status}`;
			}
		} else {
			const data = await res.json();
			coupon = data.coupon;
			stats = data.stats || stats;
		}
	} catch (e) {
		logError('Failed to load coupon', e, { page: 'admin/coupons/[id]', action: 'fetchCoupon', resourceId: id });
		error = error || t('errors.failedToLoadCoupons');
	}
} else if (!apiKey) {
	error = t('errors.adminKeyMissing');
}

// Fetch stats again after update
if (coupon && apiKey && successMessage) {
	try {
		const res = await fetch(`${apiBase}/admin/coupons/${id}`, {
			headers: { 'x-admin-key': apiKey }
		});
		if (res.ok) {
			const data = await res.json();
			stats = data.stats || stats;
		}
	} catch (e) {
		logError('Failed to fetch coupon stats', e, { page: 'admin/coupons/[id]', action: 'fetchStats', resourceId: id });
	}
}

const dateTimeOpts = DATE_FORMATS.DATETIME;

const formatDateForInput = (dateStr: string | null) => {
	if (!dateStr) return '';
	const date = new Date(dateStr);
	return date.toISOString().slice(0, 16);
};

const formatCurrency = (amount: number, currency: string = 'JPY') => {
	return new Intl.NumberFormat('ja-JP', {
		style: 'currency',
		currency: currency,
		minimumFractionDigits: 0
	}).format(amount);
};

const isExpired = (c: Coupon) => {
	if (!c.expires_at) return false;
	return new Date(c.expires_at) < new Date();
};

const canDelete = coupon && coupon.current_uses === 0;

const { token: csrfToken, cookieHeader: csrfCookieHeader } = getCsrfToken(Astro.request);
if (csrfCookieHeader) {
	Astro.response.headers.append('Set-Cookie', csrfCookieHeader);
}
---

<AdminLayout title={coupon ? `${coupon.code} - Admin` : 'Coupon - Admin'}>
	<div class="space-y-6 max-w-2xl">
		<div class="flex items-center gap-4">
			<a href="/admin/coupons" class="text-indigo-600 hover:text-indigo-500 text-sm flex items-center gap-1">
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
				</svg>
				{t('admin.coupons')}
			</a>
			<h1 class="typo-h2 text-gray-900">
				{coupon ? `${t('common.edit')}: ${coupon.code}` : t('admin.coupons')}
			</h1>
		</div>
		{successMessage && (
			<div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-6 text-sm">
				{successMessage}
			</div>
		)}

		{error && !coupon && (
			<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-8 text-center">
				<div class="text-red-600 mb-4">{error}</div>
				<Button href="/admin/coupons" color="zinc" client:load>
					{t('admin.backToCoupons')}
				</Button>
			</div>
		)}

		{error && coupon && (
			<div role="alert" class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg mb-6 text-sm">
				{error}
			</div>
		)}

		{coupon && (
			<>
				{/* Stats Card */}
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 mb-6">
					<h2 class="text-sm font-medium text-secondary mb-4">{t('admin.usageStatistics')}</h2>
					<div class="grid grid-cols-3 gap-6">
						<div>
							<div class="text-2xl font-semibold text-zinc-950 tabular-nums">{stats.totalUsages}</div>
							<div class="text-xs text-secondary">{t('admin.totalUses')}</div>
						</div>
						<div>
							<div class="text-2xl font-semibold text-zinc-950 tabular-nums">{formatCurrency(stats.totalDiscount, coupon.currency)}</div>
							<div class="text-xs text-secondary">{t('admin.totalDiscount')}</div>
						</div>
						<div>
							<div class="flex items-center gap-2">
								{isExpired(coupon) ? (
									<Badge color="amber" client:load>{t('admin.expired')}</Badge>
								) : coupon.status === 'active' ? (
									<Badge color="blue" client:load>{t('admin.active')}</Badge>
								) : (
									<Badge color="zinc" client:load>{t('admin.inactive')}</Badge>
								)}
							</div>
							<div class="text-xs text-secondary mt-1">{t('admin.currentStatus')}</div>
						</div>
					</div>
				</div>

				{/* Edit Form */}
				<form method="POST" class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6">
					<input type="hidden" name={CSRF_FIELD_NAME} value={csrfToken} />
					<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
						<div class="md:col-span-2">
				<Fieldset client:load>
							<Field>
								<Label>
									{t('admin.couponCode')} <span class="text-red-500">*</span>
								</Label>
								<Input
									type="text"
									id="code"
									name="code"
									required
									value={coupon.code}
									className="font-mono uppercase"
									client:load
								/>
							</Field>
						</div>

						<Field>
							<Label>
								{t('admin.discountType')} <span class="text-red-500">*</span>
							</Label>
							<Select
								id="type"
								name="type"
								client:load
							>
								<option value="percentage" selected={coupon.type === 'percentage'}>{t('admin.percentage')}</option>
								<option value="fixed" selected={coupon.type === 'fixed'}>{t('admin.fixedAmount')}</option>
							</Select>
						</Field>

						<Field>
							<Label>
								{t('admin.valueLabel')} <span class="text-red-500">*</span>
							</Label>
							<Input
								type="number"
								id="value"
								name="value"
								required
								min="1"
								value={coupon.value}
								className="tabular-nums"
								client:load
							/>
						</Field>

						<Field>
							<Label>{t('admin.minOrderAmount')}</Label>
							<Input
								type="number"
								id="min_order_amount"
								name="min_order_amount"
								min="0"
								value={coupon.min_order_amount}
								className="tabular-nums"
								client:load
							/>
						</Field>

						<Field>
							<Label>{t('admin.maxTotalUses')}</Label>
							<Input
								type="number"
								id="max_uses"
								name="max_uses"
								min="1"
								value={coupon.max_uses || ''}
								className="tabular-nums"
								placeholder={t('admin.unlimited')}
								client:load
							/>
						</Field>

						<Field>
							<Label>{t('admin.usesPerCustomer')}</Label>
							<Input
								type="number"
								id="uses_per_customer"
								name="uses_per_customer"
								min="1"
								value={coupon.uses_per_customer}
								className="tabular-nums"
								client:load
							/>
						</Field>

						<Field>
							<Label>{t('admin.status')}</Label>
							<Select
								id="status"
								name="status"
								client:load
							>
								<option value="active" selected={coupon.status === 'active'}>{t('admin.active')}</option>
								<option value="inactive" selected={coupon.status === 'inactive'}>{t('admin.inactive')}</option>
							</Select>
						</Field>

						<Field>
							<Label>{t('admin.startDate')}</Label>
							<Input
								type="datetime-local"
								id="starts_at"
								name="starts_at"
								value={formatDateForInput(coupon.starts_at)}
								client:load
							/>
						</Field>

						<Field>
							<Label>{t('admin.expirationDate')}</Label>
							<Input
								type="datetime-local"
								id="expires_at"
								name="expires_at"
								value={formatDateForInput(coupon.expires_at)}
								client:load
							/>
						</Field>
				</Fieldset>
					</div>

					<div class="pt-4 border-t border-gray-100">
						<dl class="grid grid-cols-2 gap-4 text-sm">
							<div>
								<dt class="text-secondary">{t('admin.created')}</dt>
								<dd class="text-zinc-950 tabular-nums">{formatDate(coupon.created_at, dateTimeOpts)}</dd>
							</div>
							<div>
								<dt class="text-secondary">{t('admin.updated')}</dt>
								<dd class="text-zinc-950 tabular-nums">{formatDate(coupon.updated_at, dateTimeOpts)}</dd>
							</div>
						</dl>
					</div>

					<div class="flex justify-between items-center gap-3 pt-4 border-t border-gray-100">
						<div>
							{canDelete ? (
								<span class="text-sm text-red-500 hover:underline cursor-pointer" id="delete-trigger">
									Delete Coupon
								</span>
							) : (
								<span class="text-sm text-secondary">	{t('admin.cannotDeleteUsed')}</span>
							)}
						</div>
						<div class="flex gap-3">
							<Button href="/admin/coupons" color="zinc" client:load>
								Back
							</Button>
							<button
								type="submit"
								name="_action"
								value="toggle"
								class={`px-4 py-2 text-sm font-medium rounded-lg transition-colors ${coupon.status === 'active' ? 'bg-yellow-100 text-yellow-700 hover:bg-yellow-200' : 'bg-green-100 text-green-700 hover:bg-green-200'}`}
							>
								{coupon.status === 'active' ? t('admin.deactivateLabel') : t('admin.activateLabel')}
							</button>
							<Button type="submit" color="indigo" client:load>
								Save Changes
							</Button>
						</div>
					</div>
				</form>

				{/* Delete form (separate to avoid mixing with edit form) */}
				{canDelete && (
					<form method="POST" id="delete-form" class="hidden">
						<input type="hidden" name={CSRF_FIELD_NAME} value={csrfToken} />
						<input type="hidden" name="_action" value="delete" />
					</form>
				)}
			</>
		)}
	</div>
	<ConfirmDialog />
</AdminLayout>

<script>
	const deleteTrigger = document.getElementById('delete-trigger');
	const deleteForm = document.getElementById('delete-form') as HTMLFormElement | null;

	if (deleteTrigger && deleteForm) {
		deleteTrigger.addEventListener('click', async () => {
			const confirmDialog = (window as any).__confirmDialog;
			const confirmed = confirmDialog
				? await confirmDialog({
						title: 'Delete Coupon',
						message: 'Are you sure you want to delete this coupon? This action cannot be undone.',
						confirmLabel: 'Delete',
						danger: true,
					})
				: confirm('Are you sure you want to delete this coupon? This action cannot be undone.');
			if (confirmed) {
				deleteForm.submit();
			}
		});
	}
</script>
