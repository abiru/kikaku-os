---
export const prerender = false;

import Badge from '../../../components/Badge.astro';
import Button from '../../../components/Button.astro';
import Container from '../../../components/Container.astro';
import Layout from '../../../layouts/Layout.astro';
import { getApiBase } from '../../../lib/api';

const { id } = Astro.params;
const apiBase = getApiBase();
const apiKey = import.meta.env.ADMIN_API_KEY;

type Coupon = {
	id: number;
	code: string;
	type: string;
	value: number;
	currency: string;
	min_order_amount: number;
	max_uses: number | null;
	uses_per_customer: number;
	current_uses: number;
	status: string;
	starts_at: string | null;
	expires_at: string | null;
	created_at: string;
	updated_at: string;
};

type Stats = {
	totalUsages: number;
	totalDiscount: number;
};

let coupon: Coupon | null = null;
let stats: Stats = { totalUsages: 0, totalDiscount: 0 };
let error: string | null = null;
let successMessage: string | null = null;

// Handle POST - Update coupon
if (Astro.request.method === 'POST' && apiKey) {
	try {
		const formData = await Astro.request.formData();
		const code = formData.get('code')?.toString().trim().toUpperCase() || '';
		const type = formData.get('type')?.toString() || 'percentage';
		const valueStr = formData.get('value')?.toString() || '';
		const minOrderStr = formData.get('min_order_amount')?.toString() || '0';
		const maxUsesStr = formData.get('max_uses')?.toString() || '';
		const usesPerCustomerStr = formData.get('uses_per_customer')?.toString() || '1';
		const status = formData.get('status')?.toString() || 'active';
		const starts_at = formData.get('starts_at')?.toString() || '';
		const expires_at = formData.get('expires_at')?.toString() || '';

		const value = parseInt(valueStr, 10);
		const min_order_amount = parseInt(minOrderStr, 10) || 0;
		const max_uses = maxUsesStr ? parseInt(maxUsesStr, 10) : null;
		const uses_per_customer = parseInt(usesPerCustomerStr, 10) || 1;

		if (!code) {
			error = 'Code is required';
		} else if (isNaN(value) || value <= 0) {
			error = 'Value must be a positive number';
		} else if (type === 'percentage' && value > 100) {
			error = 'Percentage value cannot exceed 100';
		} else {
			const res = await fetch(`${apiBase}/admin/coupons/${id}`, {
				method: 'PUT',
				headers: {
					'Content-Type': 'application/json',
					'x-admin-key': apiKey
				},
				body: JSON.stringify({
					code,
					type,
					value,
					currency: 'JPY',
					min_order_amount,
					max_uses,
					uses_per_customer,
					status,
					starts_at: starts_at || null,
					expires_at: expires_at || null
				})
			});

			const data = await res.json();

			if (!res.ok) {
				error = data.message || 'Failed to update coupon';
			} else {
				coupon = data.coupon;
				successMessage = 'Coupon updated successfully';
			}
		}
	} catch (e) {
		console.error(e);
		error = 'Failed to update coupon. Please check your connection.';
	}
}

// Fetch coupon data
if (!coupon && apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/coupons/${id}`, {
			headers: { 'x-admin-key': apiKey }
		});

		if (!res.ok) {
			if (res.status === 404) {
				error = 'Coupon not found';
			} else {
				const data = await res.json();
				error = data.message || `API Error: ${res.status}`;
			}
		} else {
			const data = await res.json();
			coupon = data.coupon;
			stats = data.stats || stats;
		}
	} catch (e) {
		console.error(e);
		error = error || 'Failed to load coupon. Please check your connection.';
	}
} else if (!apiKey) {
	error = 'ADMIN_API_KEY is missing in server environment';
}

// Fetch stats again after update
if (coupon && apiKey && successMessage) {
	try {
		const res = await fetch(`${apiBase}/admin/coupons/${id}`, {
			headers: { 'x-admin-key': apiKey }
		});
		if (res.ok) {
			const data = await res.json();
			stats = data.stats || stats;
		}
	} catch (e) {
		console.error('Failed to fetch stats:', e);
	}
}

const formatDate = (dateStr: string | null) => {
	if (!dateStr) return '-';
	return new Date(dateStr).toLocaleString('ja-JP', {
		year: 'numeric',
		month: '2-digit',
		day: '2-digit',
		hour: '2-digit',
		minute: '2-digit'
	});
};

const formatDateForInput = (dateStr: string | null) => {
	if (!dateStr) return '';
	const date = new Date(dateStr);
	return date.toISOString().slice(0, 16);
};

const formatCurrency = (amount: number, currency: string = 'JPY') => {
	return new Intl.NumberFormat('ja-JP', {
		style: 'currency',
		currency: currency,
		minimumFractionDigits: 0
	}).format(amount);
};

const isExpired = (c: Coupon) => {
	if (!c.expires_at) return false;
	return new Date(c.expires_at) < new Date();
};

const canDelete = coupon && coupon.current_uses === 0;
---

<Layout title={coupon ? `${coupon.code} - Admin` : 'Coupon - Admin'}>
	<div class="bg-[#f5f5f7] min-h-screen pb-20">
		<header class="bg-white border-b border-gray-200 sticky top-0 z-30">
			<Container class="h-16 flex items-center gap-4">
				<a href="/admin/coupons" class="text-[#0071e3] hover:underline text-sm flex items-center gap-1">
					<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
					</svg>
					Coupons
				</a>
				<h1 class="text-lg font-semibold text-[#1d1d1f]">
					{coupon ? `Edit: ${coupon.code}` : 'Coupon'}
				</h1>
			</Container>
		</header>

		<Container class="mt-8 max-w-2xl mx-auto">
			{successMessage && (
				<div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-6 text-sm">
					{successMessage}
				</div>
			)}

			{error && !coupon && (
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-8 text-center">
					<div class="text-red-600 mb-4">{error}</div>
					<Button href="/admin/coupons" variant="secondary" size="sm">
						Back to Coupons
					</Button>
				</div>
			)}

			{error && coupon && (
				<div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg mb-6 text-sm">
					{error}
				</div>
			)}

			{coupon && (
				<>
					{/* Stats Card */}
					<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 mb-6">
						<h2 class="text-sm font-medium text-[#86868b] mb-4">Usage Statistics</h2>
						<div class="grid grid-cols-3 gap-6">
							<div>
								<div class="text-2xl font-semibold text-[#1d1d1f] tabular-nums">{stats.totalUsages}</div>
								<div class="text-xs text-[#86868b]">Total Uses</div>
							</div>
							<div>
								<div class="text-2xl font-semibold text-[#1d1d1f] tabular-nums">{formatCurrency(stats.totalDiscount, coupon.currency)}</div>
								<div class="text-xs text-[#86868b]">Total Discount</div>
							</div>
							<div>
								<div class="flex items-center gap-2">
									{isExpired(coupon) ? (
										<Badge severity="warning">Expired</Badge>
									) : coupon.status === 'active' ? (
										<Badge severity="info">Active</Badge>
									) : (
										<Badge severity="secondary">Inactive</Badge>
									)}
								</div>
								<div class="text-xs text-[#86868b] mt-1">Current Status</div>
							</div>
						</div>
					</div>

					{/* Edit Form */}
					<form method="POST" class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6">
						<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
							<div class="md:col-span-2">
								<label for="code" class="block text-sm font-medium text-[#1d1d1f] mb-2">
									Coupon Code <span class="text-red-500">*</span>
								</label>
								<input
									type="text"
									id="code"
									name="code"
									required
									value={coupon.code}
									class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm text-[#1d1d1f] font-mono uppercase focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20 focus:border-[#0071e3] transition-all"
								/>
							</div>

							<div>
								<label for="type" class="block text-sm font-medium text-[#1d1d1f] mb-2">
									Discount Type <span class="text-red-500">*</span>
								</label>
								<select
									id="type"
									name="type"
									class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm text-[#1d1d1f] focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20 focus:border-[#0071e3] transition-all bg-white"
								>
									<option value="percentage" selected={coupon.type === 'percentage'}>Percentage (%)</option>
									<option value="fixed" selected={coupon.type === 'fixed'}>Fixed Amount (JPY)</option>
								</select>
							</div>

							<div>
								<label for="value" class="block text-sm font-medium text-[#1d1d1f] mb-2">
									Value <span class="text-red-500">*</span>
								</label>
								<input
									type="number"
									id="value"
									name="value"
									required
									min="1"
									value={coupon.value}
									class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm text-[#1d1d1f] tabular-nums focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20 focus:border-[#0071e3] transition-all"
								/>
							</div>

							<div>
								<label for="min_order_amount" class="block text-sm font-medium text-[#1d1d1f] mb-2">
									Minimum Order Amount (JPY)
								</label>
								<input
									type="number"
									id="min_order_amount"
									name="min_order_amount"
									min="0"
									value={coupon.min_order_amount}
									class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm text-[#1d1d1f] tabular-nums focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20 focus:border-[#0071e3] transition-all"
								/>
							</div>

							<div>
								<label for="max_uses" class="block text-sm font-medium text-[#1d1d1f] mb-2">
									Max Total Uses
								</label>
								<input
									type="number"
									id="max_uses"
									name="max_uses"
									min="1"
									value={coupon.max_uses || ''}
									class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm text-[#1d1d1f] tabular-nums focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20 focus:border-[#0071e3] transition-all"
									placeholder="Unlimited"
								/>
							</div>

							<div>
								<label for="uses_per_customer" class="block text-sm font-medium text-[#1d1d1f] mb-2">
									Uses Per Customer
								</label>
								<input
									type="number"
									id="uses_per_customer"
									name="uses_per_customer"
									min="1"
									value={coupon.uses_per_customer}
									class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm text-[#1d1d1f] tabular-nums focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20 focus:border-[#0071e3] transition-all"
								/>
							</div>

							<div>
								<label for="status" class="block text-sm font-medium text-[#1d1d1f] mb-2">
									Status
								</label>
								<select
									id="status"
									name="status"
									class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm text-[#1d1d1f] focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20 focus:border-[#0071e3] transition-all bg-white"
								>
									<option value="active" selected={coupon.status === 'active'}>Active</option>
									<option value="inactive" selected={coupon.status === 'inactive'}>Inactive</option>
								</select>
							</div>

							<div>
								<label for="starts_at" class="block text-sm font-medium text-[#1d1d1f] mb-2">
									Start Date
								</label>
								<input
									type="datetime-local"
									id="starts_at"
									name="starts_at"
									value={formatDateForInput(coupon.starts_at)}
									class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm text-[#1d1d1f] focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20 focus:border-[#0071e3] transition-all"
								/>
							</div>

							<div>
								<label for="expires_at" class="block text-sm font-medium text-[#1d1d1f] mb-2">
									Expiration Date
								</label>
								<input
									type="datetime-local"
									id="expires_at"
									name="expires_at"
									value={formatDateForInput(coupon.expires_at)}
									class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm text-[#1d1d1f] focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20 focus:border-[#0071e3] transition-all"
								/>
							</div>
						</div>

						<div class="pt-4 border-t border-gray-100">
							<dl class="grid grid-cols-2 gap-4 text-sm">
								<div>
									<dt class="text-[#86868b]">Created</dt>
									<dd class="text-[#1d1d1f] tabular-nums">{formatDate(coupon.created_at)}</dd>
								</div>
								<div>
									<dt class="text-[#86868b]">Updated</dt>
									<dd class="text-[#1d1d1f] tabular-nums">{formatDate(coupon.updated_at)}</dd>
								</div>
							</dl>
						</div>

						<div class="flex justify-between items-center gap-3 pt-4 border-t border-gray-100">
							<div>
								{canDelete ? (
									<button
										type="button"
										id="delete-btn"
										class="text-sm text-red-500 hover:underline"
									>
										Delete Coupon
									</button>
								) : (
									<span class="text-sm text-[#86868b]">Cannot delete used coupons</span>
								)}
							</div>
							<div class="flex gap-3">
								<Button href="/admin/coupons" variant="secondary" size="sm">
									Back
								</Button>
								<button
									type="button"
									id="toggle-btn"
									class={`px-4 py-2 text-sm font-medium rounded-lg transition-colors ${coupon.status === 'active' ? 'bg-yellow-100 text-yellow-700 hover:bg-yellow-200' : 'bg-green-100 text-green-700 hover:bg-green-200'}`}
								>
									{coupon.status === 'active' ? 'Deactivate' : 'Activate'}
								</button>
								<Button type="submit" variant="primary" size="sm">
									Save Changes
								</Button>
							</div>
						</div>
					</form>
				</>
			)}
		</Container>
	</div>
</Layout>

<script define:vars={{ apiBase, apiKey, couponId: id, canDelete }}>
	const deleteBtn = document.getElementById('delete-btn');
	const toggleBtn = document.getElementById('toggle-btn');

	if (deleteBtn && canDelete) {
		deleteBtn.addEventListener('click', async () => {
			if (!confirm('Are you sure you want to delete this coupon? This action cannot be undone.')) {
				return;
			}

			try {
				const res = await fetch(`${apiBase}/admin/coupons/${couponId}`, {
					method: 'DELETE',
					headers: { 'x-admin-key': apiKey }
				});

				if (res.ok) {
					window.location.href = '/admin/coupons';
				} else {
					const data = await res.json();
					alert(data.message || 'Failed to delete coupon');
				}
			} catch (e) {
				alert('Failed to delete coupon. Please try again.');
			}
		});
	}

	if (toggleBtn) {
		toggleBtn.addEventListener('click', async () => {
			try {
				const res = await fetch(`${apiBase}/admin/coupons/${couponId}/toggle`, {
					method: 'POST',
					headers: { 'x-admin-key': apiKey }
				});

				if (res.ok) {
					window.location.reload();
				} else {
					const data = await res.json();
					alert(data.message || 'Failed to toggle coupon status');
				}
			} catch (e) {
				alert('Failed to toggle coupon status. Please try again.');
			}
		});
	}
</script>
