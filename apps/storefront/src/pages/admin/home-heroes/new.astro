---
export const prerender = false;

import AdminLayout from'../../../layouts/AdminLayout.astro';
import Button from'../../../components/Button.astro';
import { getApiBase } from'../../../lib/api';

const apiBase = getApiBase();

let success = false;
let error = null;
let createdId: number | null = null;

if (Astro.request.method ==='POST') {
	try {
		const formData = await Astro.request.formData();
		const title = formData.get('title') as string;
		const subtitle = formData.get('subtitle') as string;
		const ctaPrimaryText = formData.get('cta_primary_text') as string;
		const ctaPrimaryUrl = formData.get('cta_primary_url') as string;
		const ctaSecondaryText = formData.get('cta_secondary_text') as string;
		const ctaSecondaryUrl = formData.get('cta_secondary_url') as string;
		const position = Number(formData.get('position') ||'0');
		const status = formData.get('status') as string;

		const body: any = {
			title,
			position,
			status: status ||'draft'
		};

		if (subtitle) body.subtitle = subtitle;
		if (ctaPrimaryText) body.cta_primary_text = ctaPrimaryText;
		if (ctaPrimaryUrl) body.cta_primary_url = ctaPrimaryUrl;
		if (ctaSecondaryText) body.cta_secondary_text = ctaSecondaryText;
		if (ctaSecondaryUrl) body.cta_secondary_url = ctaSecondaryUrl;

		const res = await fetch(`${apiBase}/admin/home/heroes`, {
			method:'POST',
			headers: {
				'Content-Type':'application/json',
				'x-admin-key': import.meta.env.ADMIN_API_KEY
			},
			body: JSON.stringify(body)
		});

		if (!res.ok) {
			const data = await res.json();
			throw new Error(data.message ||'Failed to create hero section');
		}

		const data = await res.json();
		createdId = data.id;
		success = true;

		// Redirect to edit page after creation
		if (createdId) {
			return Astro.redirect(`/admin/home-heroes/${createdId}`);
		}
	} catch (e: any) {
		console.error(e);
		error = e.message ||'Failed to create hero section';
	}
}
---

<AdminLayout title="New Hero Section - Admin">
	<div class="max-w-3xl space-y-6">
		<div class="flex items-center gap-4">
			<a href="/admin/home-heroes" class="text-[#0071e3] hover:underline text-sm">
				← Back to Hero Sections
			</a>
		</div>

		<h1 class="text-2xl font-semibold text-gray-900">Create New Hero Section</h1>

		{error && (
			<div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm">
				{error}
			</div>
		)}

		<form method="POST" class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6">
			{/* Title */}
			<div>
				<label for="title" class="block text-sm font-medium text-gray-900 mb-2">
					Title <span class="text-red-500">*</span>
				</label>
				<input
					type="text"
					id="title"
					name="title"
					required
					maxlength="255"
					class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20 focus:border-[#0071e3]"
					placeholder="スペシャルなギフト。お急ぎください。"
				/>
			</div>

			{/* Subtitle */}
			<div>
				<label for="subtitle" class="block text-sm font-medium text-gray-900 mb-2">
					Subtitle
				</label>
				<input
					type="text"
					id="subtitle"
					name="subtitle"
					maxlength="500"
					class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20 focus:border-[#0071e3]"
					placeholder="魔法みたいな瞬間をあの人に届けましょう。"
				/>
			</div>

			{/* Primary CTA */}
			<div class="grid grid-cols-2 gap-4">
				<div>
					<label for="cta_primary_text" class="block text-sm font-medium text-gray-900 mb-2">
						Primary Button Text
					</label>
					<input
						type="text"
						id="cta_primary_text"
						name="cta_primary_text"
						maxlength="100"
						class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20 focus:border-[#0071e3]"
						placeholder="商品を見る"
					/>
				</div>
				<div>
					<label for="cta_primary_url" class="block text-sm font-medium text-gray-900 mb-2">
						Primary Button URL
					</label>
					<input
						type="text"
						id="cta_primary_url"
						name="cta_primary_url"
						maxlength="500"
						class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20 focus:border-[#0071e3]"
						placeholder="/products"
					/>
				</div>
			</div>

			{/* Secondary CTA */}
			<div class="grid grid-cols-2 gap-4">
				<div>
					<label for="cta_secondary_text" class="block text-sm font-medium text-gray-900 mb-2">
						Secondary Button Text
					</label>
					<input
						type="text"
						id="cta_secondary_text"
						name="cta_secondary_text"
						maxlength="100"
						class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20 focus:border-[#0071e3]"
						placeholder="カートに追加"
					/>
				</div>
				<div>
					<label for="cta_secondary_url" class="block text-sm font-medium text-gray-900 mb-2">
						Secondary Button URL
					</label>
					<input
						type="text"
						id="cta_secondary_url"
						name="cta_secondary_url"
						maxlength="500"
						class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20 focus:border-[#0071e3]"
						placeholder="/cart"
					/>
				</div>
			</div>

			{/* Position */}
			<div>
				<label for="position" class="block text-sm font-medium text-gray-900 mb-2">
					Position (Display Order)
				</label>
				<input
					type="number"
					id="position"
					name="position"
					min="0"
					value="0"
					class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20 focus:border-[#0071e3]"
				/>
				<p class="mt-1 text-xs text-gray-500">Lower numbers appear first on the homepage</p>
			</div>

			{/* Status */}
			<div>
				<label for="status" class="block text-sm font-medium text-gray-900 mb-2">
					Status
				</label>
				<select
					id="status"
					name="status"
					class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20 focus:border-[#0071e3]"
				>
					<option value="draft">Draft</option>
					<option value="active">Active</option>
				</select>
			</div>

			{/* Submit Button */}
			<div class="flex gap-3 pt-4">
				<Button type="submit" variant="primary">
					Create Hero Section
				</Button>
				<Button href="/admin/home-heroes" variant="secondary">
					Cancel
				</Button>
			</div>
		</form>

		<div class="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded-lg text-sm">
			<p class="font-medium mb-1">Note:</p>
			<p>Images can be uploaded after creating the hero section on the edit page.</p>
		</div>
	</div>
</AdminLayout>
