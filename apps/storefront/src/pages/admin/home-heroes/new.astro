---
export const prerender = false;

import { Input } from '../../../components/catalyst/input';
import { Select } from '../../../components/catalyst/select';
import { Fieldset, Field } from '../../../components/catalyst/fieldset';
import { Button } from '../../../components/catalyst/button';
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getApiBase } from '../../../lib/api';
import { logError } from '../../../lib/logger';

const apiBase = getApiBase();

let success = false;
let error = null;
let createdId: number | null = null;

if (Astro.request.method === 'POST') {
	try {
		const formData = await Astro.request.formData();
		const title = formData.get('title') as string;
		const subtitle = formData.get('subtitle') as string;
		const ctaPrimaryText = formData.get('cta_primary_text') as string;
		const ctaPrimaryUrl = formData.get('cta_primary_url') as string;
		const ctaSecondaryText = formData.get('cta_secondary_text') as string;
		const ctaSecondaryUrl = formData.get('cta_secondary_url') as string;
		const position = Number(formData.get('position') || '0');
		const status = formData.get('status') as string;

		const body: any = {
			title,
			position,
			status: status || 'draft'
		};

		if (subtitle) body.subtitle = subtitle;
		if (ctaPrimaryText) body.cta_primary_text = ctaPrimaryText;
		if (ctaPrimaryUrl) body.cta_primary_url = ctaPrimaryUrl;
		if (ctaSecondaryText) body.cta_secondary_text = ctaSecondaryText;
		if (ctaSecondaryUrl) body.cta_secondary_url = ctaSecondaryUrl;

		const res = await fetch(`${apiBase}/admin/home/heroes`, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'x-admin-key': import.meta.env.ADMIN_API_KEY
			},
			body: JSON.stringify(body)
		});

		if (!res.ok) {
			const data = await res.json();
			throw new Error(data.message || 'Failed to create hero section');
		}

		const data = await res.json();
		createdId = data.id;
		success = true;

		// Redirect to edit page after creation
		if (createdId) {
			return Astro.redirect(`/admin/home-heroes/${createdId}`);
		}
	} catch (e: unknown) {
		logError('Failed to create hero section', e, { page: 'admin/home-heroes/new', action: 'createHero' });
		error = e instanceof Error ? e.message : 'Failed to create hero section';
	}
}
---

<AdminLayout title="New Hero Section - Admin">
	<div class="max-w-3xl space-y-6">
		<div class="flex items-center gap-4">
			<a href="/admin/home-heroes" class="text-brand hover:underline text-sm">
				← Back to Hero Sections
			</a>
		</div>

		<h1 class="text-2xl font-semibold text-gray-900">Create New Hero Section</h1>

		{error && (
			<div role="alert" class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm">
				{error}
			</div>
		)}

		<form method="POST" class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6">
			{/* Title */}
				<Fieldset client:load>
			<Field>
				<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">
					Title <span class="text-red-500">*</span>
				</label>
				<Input
					type="text"
					id="title"
					name="title"
					required
					maxLength={255}
					placeholder="スペシャルなギフト。お急ぎください。"
					client:load
				/>
			</Field>

			{/* Subtitle */}
			<Field>
				<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">Subtitle</label>
				<Input
					type="text"
					id="subtitle"
					name="subtitle"
					maxLength={500}
					placeholder="魔法みたいな瞬間をあの人に届けましょう。"
					client:load
				/>
			</Field>

			{/* Primary CTA */}
			<div class="grid grid-cols-2 gap-4">
				<Field>
					<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">Primary Button Text</label>
					<Input
						type="text"
						id="cta_primary_text"
						name="cta_primary_text"
						maxLength={100}
						placeholder="商品を見る"
						client:load
					/>
				</Field>
				<Field>
					<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">Primary Button URL</label>
					<Input
						type="text"
						id="cta_primary_url"
						name="cta_primary_url"
						maxLength={500}
						placeholder="/products"
						client:load
					/>
				</Field>
			</div>

			{/* Secondary CTA */}
			<div class="grid grid-cols-2 gap-4">
				<Field>
					<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">Secondary Button Text</label>
					<Input
						type="text"
						id="cta_secondary_text"
						name="cta_secondary_text"
						maxLength={100}
						placeholder="カートに追加"
						client:load
					/>
				</Field>
				<Field>
					<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">Secondary Button URL</label>
					<Input
						type="text"
						id="cta_secondary_url"
						name="cta_secondary_url"
						maxLength={500}
						placeholder="/cart"
						client:load
					/>
				</Field>
			</div>

			{/* Position */}
			<Field>
				<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">Position (Display Order)</label>
				<Input
					type="number"
					id="position"
					name="position"
					min="0"
					value="0"
					client:load
				/>
				<p data-slot="description" class="text-base/6 text-zinc-500 sm:text-sm/6">Lower numbers appear first on the homepage</p>
			</Field>

			{/* Status */}
			<Field>
				<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">Status</label>
				<Select
					id="status"
					name="status"
					client:load
				>
					<option value="draft">Draft</option>
					<option value="active">Active</option>
				</Select>
			</Field>
				</Fieldset>

			{/* Submit Button */}
			<div class="flex gap-3 pt-4">
				<Button type="submit" color="indigo" client:load>
					Create Hero Section
				</Button>
				<Button href="/admin/home-heroes" color="zinc" client:load>
					Cancel
				</Button>
			</div>
		</form>

		<div class="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded-lg text-sm">
			<p class="font-medium mb-1">Note:</p>
			<p>Images can be uploaded after creating the hero section on the edit page.</p>
		</div>
	</div>
</AdminLayout>
