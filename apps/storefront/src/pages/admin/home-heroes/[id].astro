---
export const prerender = false;

import { Input } from '../../../components/catalyst/input';
import { Select } from '../../../components/catalyst/select';
import { Fieldset, Field } from '../../../components/catalyst/fieldset';
import { Button } from '../../../components/catalyst/button';
import { Badge } from '../../../components/catalyst/badge';
import AdminLayout from '../../../layouts/AdminLayout.astro';
import ConfirmDialog from '../../../components/admin/ConfirmDialog.astro';
import { getApiBase } from '../../../lib/api';
import { handleHeroPost, type HeroDetail } from '../../../lib/admin/hero-actions';
import { logError } from '../../../lib/logger';

const { id } = Astro.params;
const apiBase = getApiBase();
const apiKey = import.meta.env.ADMIN_API_KEY;

let hero: HeroDetail | null = null;
let error: string | null = null;
let success = false;
let imageUploadSuccess = false;
let imageUploadError: string | null = null;

// Fetch hero section data
try {
	const res = await fetch(`${apiBase}/admin/home/heroes/${id}`, {
		headers: { 'x-admin-key': apiKey },
	});

	if (!res.ok) {
		throw new Error('Hero section not found');
	}

	const data = await res.json();
	hero = data.hero;
} catch (e: unknown) {
	logError('Failed to load hero section', e, { page: 'admin/home-heroes/[id]', action: 'fetchHero', resourceId: id });
	error = e instanceof Error ? e.message : 'Failed to load hero section';
}

// Handle form submission
if (Astro.request.method === 'POST' && hero) {
	const formData = await Astro.request.formData();
	const result = await handleHeroPost(formData, hero, apiBase, apiKey, id!);
	hero = result.hero ?? hero;
	error = result.error;
	success = result.success;
	imageUploadSuccess = result.imageUploadSuccess;
	imageUploadError = result.imageUploadError;
}
---

<AdminLayout title={hero ? `Edit Hero: ${hero.title}` : 'Edit Hero Section'}>
	<div class="max-w-3xl space-y-6">
		<div class="flex items-center gap-4">
			<a href="/admin/home-heroes" class="text-brand hover:underline text-sm">
				← Back to Hero Sections
			</a>
		</div>

		{hero && (
			<div class="flex items-center justify-between">
				<h1 class="text-2xl font-semibold text-gray-900">Edit Hero Section</h1>
				<div class="flex items-center gap-2">
					{hero.status === 'draft' ? (
						<Badge color="zinc" client:load>Draft</Badge>
					) : hero.status === 'archived' ? (
						<Badge color="red" client:load>Archived</Badge>
					) : (
						<Badge color="blue" client:load>Active</Badge>
					)}
				</div>
			</div>
		)}

		{error && (
			<div role="alert" class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm">
				{error}
			</div>
		)}

		{success && (
			<div class="bg-green-50 border border-green-200 text-green-600 px-4 py-3 rounded-lg text-sm">
				✓ Hero section updated successfully!
			</div>
		)}

		{imageUploadSuccess && (
			<div class="bg-green-50 border border-green-200 text-green-600 px-4 py-3 rounded-lg text-sm">
				✓ Image uploaded successfully!
			</div>
		)}

		{imageUploadError && (
			<div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm">
				<strong>Image Upload Error:</strong> {imageUploadError}
			</div>
		)}

		{hero ? (
			<form method="POST" class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6">
				<Fieldset client:load>
				{/* Title */}
				<Field>
					<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">
						Title <span class="text-red-500">*</span>
					</label>
					<Input
						type="text"
						id="title"
						name="title"
						value={hero.title}
						required
						maxLength={255}

					/>
				</Field>

				{/* Subtitle */}
				<Field>
					<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">Subtitle</label>
					<Input
						type="text"
						id="subtitle"
						name="subtitle"
						value={hero.subtitle || ''}
						maxLength={500}

					/>
				</Field>

				{/* Primary CTA */}
				<div class="grid grid-cols-2 gap-4">
					<Field>
						<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">Primary Button Text</label>
						<Input
							type="text"
							id="cta_primary_text"
							name="cta_primary_text"
							value={hero.cta_primary_text || ''}
							maxLength={100}

						/>
					</Field>
					<Field>
						<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">Primary Button URL</label>
						<Input
							type="text"
							id="cta_primary_url"
							name="cta_primary_url"
							value={hero.cta_primary_url || ''}
							maxLength={500}

						/>
					</Field>
				</div>

				{/* Secondary CTA */}
				<div class="grid grid-cols-2 gap-4">
					<Field>
						<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">Secondary Button Text</label>
						<Input
							type="text"
							id="cta_secondary_text"
							name="cta_secondary_text"
							value={hero.cta_secondary_text || ''}
							maxLength={100}

						/>
					</Field>
					<Field>
						<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">Secondary Button URL</label>
						<Input
							type="text"
							id="cta_secondary_url"
							name="cta_secondary_url"
							value={hero.cta_secondary_url || ''}
							maxLength={500}

						/>
					</Field>
				</div>

				{/* Position */}
				<Field>
					<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">Position (Display Order)</label>
					<Input
						type="number"
						id="position"
						name="position"
						value={hero.position}
						min="0"

					/>
					<p data-slot="description" class="text-base/6 text-zinc-500 sm:text-sm/6">Lower numbers appear first on the homepage</p>
				</Field>

				{/* Status */}
				<Field>
					<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">Status</label>
					<Select
						id="status"
						name="status"
						defaultValue={hero.status}
						client:load
					>
						<option value="draft">Draft</option>
						<option value="active">Active</option>
						<option value="archived">Archived</option>
					</Select>
				</Field>

				{/* Submit Button */}
				<div class="flex gap-3 pt-4">
					<Button type="submit" color="indigo">
						Save Changes
					</Button>
					<Button href="/admin/home-heroes" color="zinc">
						Cancel
					</Button>
				</div>
				</Fieldset>
			</form>
		) : (
			<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-12 text-center">
				<p class="text-gray-500">Hero section not found</p>
			</div>
		)}

		{hero && (
			<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6">
				<h2 class="text-lg font-semibold text-gray-900">Hero Images</h2>

				<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
					{/* Main Image */}
					<div>
						<h3 class="text-sm font-medium text-gray-900 mb-3">Main Image (Desktop)</h3>
						{hero.image_r2_key ? (
							<div class="space-y-3">
								<div class="border border-gray-200 rounded-lg p-2 bg-gray-50">
									<img
										src={`${apiBase}/r2?key=${encodeURIComponent(hero.image_r2_key)}`}
										alt="Hero main image"
										class="w-full h-auto rounded"
									/>
								</div>
								<form method="POST" class="delete-hero-image-form" data-image-label="main">
									<input type="hidden" name="delete_image_type" value="main" />
									<button
										type="button"
										class="delete-hero-image-btn text-sm text-red-600 hover:text-red-700"
									>
										Delete Main Image
									</button>
								</form>
							</div>
						) : (
							<div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center text-gray-500 text-sm">
								No main image uploaded
							</div>
						)}

						<form method="POST" enctype="multipart/form-data" class="mt-3">
							<input type="hidden" name="image_type" value="main" />
							<label class="block">
								<span class="sr-only">Choose main image</span>
								<input
									type="file"
									name="image_upload"
									accept="image/jpeg,image/png,image/webp,image/gif"
									class="block w-full text-sm text-gray-500
										file:mr-3 file:py-2 file:px-4
										file:rounded-lg file:border-0
										file:text-sm file:font-medium
										file:bg-brand file:text-white
										hover:file:bg-brand-hover
										file:cursor-pointer"
								/>
							</label>
							<p class="mt-1 text-xs text-gray-500">
								JPG, PNG, WebP, GIF up to 5MB
							</p>
							<Button type="submit" outline className="mt-2" client:load>
								Upload Main Image
							</Button>
						</form>
					</div>

					{/* Small Image */}
					<div>
						<h3 class="text-sm font-medium text-gray-900 mb-3">Small Image (Mobile)</h3>
						{hero.image_r2_key_small ? (
							<div class="space-y-3">
								<div class="border border-gray-200 rounded-lg p-2 bg-gray-50">
									<img
										src={`${apiBase}/r2?key=${encodeURIComponent(hero.image_r2_key_small)}`}
										alt="Hero small image"
										class="w-full h-auto rounded"
									/>
								</div>
								<form method="POST" class="delete-hero-image-form" data-image-label="small">
									<input type="hidden" name="delete_image_type" value="small" />
									<button
										type="button"
										class="delete-hero-image-btn text-sm text-red-600 hover:text-red-700"
									>
										Delete Small Image
									</button>
								</form>
							</div>
						) : (
							<div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center text-gray-500 text-sm">
								No small image uploaded
							</div>
						)}

						<form method="POST" enctype="multipart/form-data" class="mt-3">
							<input type="hidden" name="image_type" value="small" />
							<label class="block">
								<span class="sr-only">Choose small image</span>
								<input
									type="file"
									name="image_upload"
									accept="image/jpeg,image/png,image/webp,image/gif"
									class="block w-full text-sm text-gray-500
										file:mr-3 file:py-2 file:px-4
										file:rounded-lg file:border-0
										file:text-sm file:font-medium
										file:bg-brand file:text-white
										hover:file:bg-brand-hover
										file:cursor-pointer"
								/>
							</label>
							<p class="mt-1 text-xs text-gray-500">
								JPG, PNG, WebP, GIF up to 5MB
							</p>
							<Button type="submit" outline className="mt-2" client:load>
								Upload Small Image
							</Button>
						</form>
					</div>
				</div>
			</div>
		)}
	</div>
	<ConfirmDialog />
</AdminLayout>

<script>
	document.querySelectorAll('.delete-hero-image-btn').forEach((btn) => {
		btn.addEventListener('click', async () => {
			const form = btn.closest<HTMLFormElement>('.delete-hero-image-form');
			if (!form) return;
			const label = form.dataset.imageLabel || 'this';
			const confirmed = await (window as any).__confirmDialog({
				title: 'Delete Image',
				message: `Are you sure you want to delete the ${label} image? This action cannot be undone.`,
				confirmLabel: 'Delete',
				danger: true,
			});
			if (confirmed) {
				form.submit();
			}
		});
	});
</script>
