---
export const prerender = false;

import Badge from '../../../components/Badge.astro';
import { Alert } from '../../../components/catalyst/alert-banner';
import Button from '../../../components/Button.astro';
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getApiBase } from '../../../lib/api';
import { Input } from '../../../components/catalyst/input';
import { Textarea } from '../../../components/catalyst/textarea';
import { Field, Label, Description } from '../../../components/catalyst/fieldset';
import { CatalystButton } from '../../../components/catalyst/button';

const { slug } = Astro.params;
const apiBase = getApiBase();
const apiKey = import.meta.env.ADMIN_API_KEY;

type EmailTemplate = {
	id: number;
	slug: string;
	name: string;
	subject: string;
	body_html: string;
	body_text: string;
	variables: string[];
	created_at: string;
	updated_at: string;
};

let template: EmailTemplate | null = null;
let error: string | null = null;
let successMessage: string | null = null;

// Handle POST - Update template
if (Astro.request.method === 'POST' && apiKey) {
	try {
		const formData = await Astro.request.formData();
		const subject = formData.get('subject')?.toString().trim() || '';
		const body_html = formData.get('body_html')?.toString() || '';
		const body_text = formData.get('body_text')?.toString() || '';

		if (!subject) {
			error = 'Subject is required';
		} else {
			const res = await fetch(`${apiBase}/admin/email-templates/${slug}`, {
				method: 'PUT',
				headers: {
					'Content-Type': 'application/json',
					'x-admin-key': apiKey
				},
				body: JSON.stringify({
					subject,
					body_html,
					body_text
				})
			});

			const data = await res.json();

			if (!res.ok) {
				error = data.message || 'Failed to update template';
			} else {
				template = data.template;
				successMessage = 'Template updated successfully';
			}
		}
	} catch (e) {
		console.error(e);
		error = 'Failed to update template. Please check your connection.';
	}
}

// Fetch template data
if (!template && apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/email-templates/${slug}`, {
			headers: { 'x-admin-key': apiKey }
		});

		if (!res.ok) {
			if (res.status === 404) {
				error = 'Template not found';
			} else {
				const data = await res.json();
				error = data.message || `API Error: ${res.status}`;
			}
		} else {
			const data = await res.json();
			template = data.template;
		}
	} catch (e) {
		console.error(e);
		error = error || 'Failed to load template. Please check your connection.';
	}
} else if (!apiKey) {
	error = 'ADMIN_API_KEY is missing in server environment';
}

const formatDate = (dateStr: string) => {
	return new Date(dateStr).toLocaleString('ja-JP', {
		year: 'numeric',
		month: '2-digit',
		day: '2-digit',
		hour: '2-digit',
		minute: '2-digit'
	});
};
---

<AdminLayout title={template ? `${template.name} - Admin` : 'Email Template - Admin'}>
	<div class="space-y-6 max-w-5xl">
		<div class="flex items-center gap-4">
			<a href="/admin/email-templates" class="text-[#0071e3] hover:underline text-sm flex items-center gap-1">
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
				</svg>
				Email Templates
			</a>
			<h1 class="text-2xl font-semibold text-gray-900">
				{template ? template.name : 'Email Template'}
			</h1>
		</Alert>

		{successMessage && (
			<div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-6 text-sm">
				{successMessage}
			</Alert>
		)}

		{error && !template && (
			<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-8 text-center">
				<div class="text-red-600 mb-4">{error}</div>
				<Button href="/admin/email-templates" variant="secondary" size="sm">
					Back to Templates
				</Button>
			</Alert>
		)}

		{error && template && (
			<Alert color="red" client:load>
				{error}
			</Alert>
		)}

		{template && (
			<form method="POST" class="space-y-6">
				{/* Variables Info */}
				<div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
					<h3 class="text-sm font-medium text-blue-900 mb-2">Available Variables</h3>
					<div class="flex flex-wrap gap-2">
						{template.variables && template.variables.length > 0 ? (
							template.variables.map((variable) => (
								<code class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">{`{{${variable}}}`}</code>
							))
						) : (
							<span class="text-sm text-blue-700">No variables defined</span>
						)}
					</Alert>
				</Alert>

				{/* Subject */}
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-4">
					<h2 class="text-sm font-medium text-[#86868b]">Email Subject</h2>
					<Field>
						<Input client:load
							type="text"
							id="subject"
							name="subject"
							required
							value={template.subject}
						/>
						<Description>Supports variables like {`{{customer_name}}`}</Description>
					</Field>
				</div>

				{/* HTML Body */}
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-4">
					<div class="flex items-center justify-between">
						<h2 class="text-sm font-medium text-[#86868b]">HTML Content</h2>
						<div class="flex gap-2">
							<button
								type="button"
								id="preview-html-btn"
								class="text-sm text-[#0071e3] hover:underline"
							>
								Preview
							</button>
						</Alert>
					</Alert>

					<div id="html-editor-container">
						<Textarea client:load
							id="body_html"
							name="body_html"
							rows={20}
						>{template.body_html}</Textarea>
					</div>

					<div id="html-preview-container" class="hidden">
						<div id="html-preview-content" class="min-h-[300px] border border-gray-200 rounded-lg bg-white overflow-auto">
						</Alert>
					</Alert>
				</Alert>

				{/* Text Body */}
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-4">
					<h2 class="text-sm font-medium text-[#86868b]">Plain Text Content (Fallback)</h2>
					<Field>
						<Textarea client:load
							id="body_text"
							name="body_text"
							rows={10}
						>{template.body_text}</Textarea>
						<Description>Used when HTML email cannot be displayed</Description>
					</Field>
				</div>

				{/* Preview Email */}
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-4">
					<h2 class="text-sm font-medium text-[#86868b]">Send Test Email</h2>
					<div class="flex gap-4">
						<Input client:load
							type="email"
							id="preview-email"
							placeholder="Enter email address..."
							className="flex-1"
						/>
						<CatalystButton client:load
							type="button"
							id="send-preview-btn"
							color="zinc"
						>
							Send Preview
						</CatalystButton>
					</div>
					<p class="text-xs text-[#86868b]">A test email will be sent with sample data</p>
					<div id="preview-result" class="hidden"></div>
				</Alert>

				{/* Meta Info */}
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
					<dl class="grid grid-cols-2 gap-4 text-sm">
						<div>
							<dt class="text-[#86868b]">Created</dt>
							<dd class="text-zinc-950 tabular-nums">{formatDate(template.created_at)}</dd>
						</Alert>
						<div>
							<dt class="text-[#86868b]">Updated</dt>
							<dd class="text-zinc-950 tabular-nums">{formatDate(template.updated_at)}</dd>
						</Alert>
					</dl>
				</Alert>

				{/* Actions */}
				<div class="flex justify-end gap-3">
					<Button href="/admin/email-templates" variant="secondary" size="sm">
						Back
					</Button>
					<Button type="submit" variant="primary" size="sm">
						Save Changes
					</Button>
				</Alert>
			</form>
		)}
	</Alert>
</AdminLayout>

<script define:vars={{ apiBase, apiKey, templateSlug: slug }}>
	const previewHtmlBtn = document.getElementById('preview-html-btn');
	const htmlEditorContainer = document.getElementById('html-editor-container');
	const htmlPreviewContainer = document.getElementById('html-preview-container');
	const htmlPreviewContent = document.getElementById('html-preview-content');
	const bodyHtmlTextarea = document.getElementById('body_html');
	const sendPreviewBtn = document.getElementById('send-preview-btn');
	const previewEmailInput = document.getElementById('preview-email');
	const previewResult = document.getElementById('preview-result');

	let showHtmlPreview = false;

	// HTML Preview toggle
	previewHtmlBtn?.addEventListener('click', () => {
		showHtmlPreview = !showHtmlPreview;

		if (showHtmlPreview) {
			htmlEditorContainer?.classList.add('hidden');
			htmlPreviewContainer?.classList.remove('hidden');
			if (htmlPreviewContent && bodyHtmlTextarea) {
				// Create iframe for safe HTML preview
				const iframe = document.createElement('iframe');
				iframe.style.width = '100%';
				iframe.style.minHeight = '400px';
				iframe.style.border = 'none';
				htmlPreviewContent.innerHTML = '';
				htmlPreviewContent.appendChild(iframe);

				const doc = iframe.contentDocument || iframe.contentWindow?.document;
				if (doc) {
					doc.open();
					doc.write(bodyHtmlTextarea.value);
					doc.close();
				}
			}
			previewHtmlBtn.textContent = 'Edit';
		} else {
			htmlEditorContainer?.classList.remove('hidden');
			htmlPreviewContainer?.classList.add('hidden');
			previewHtmlBtn.textContent = 'Preview';
		}
	});

	// Send preview email
	sendPreviewBtn?.addEventListener('click', async () => {
		const email = previewEmailInput?.value?.trim();

		if (!email) {
			showPreviewResult('error', 'Please enter an email address');
			return;
		}

		sendPreviewBtn.disabled = true;
		sendPreviewBtn.textContent = 'Sending...';

		try {
			const res = await fetch(`${apiBase}/admin/email-templates/${templateSlug}/preview`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'x-admin-key': apiKey
				},
				body: JSON.stringify({ to: email })
			});

			const data = await res.json();

			if (!res.ok) {
				showPreviewResult('error', data.message || 'Failed to send preview email');
			} else {
				showPreviewResult('success', `Preview email sent to ${email}`);
			}
		} catch (e) {
			showPreviewResult('error', 'Failed to send preview email. Please try again.');
		} finally {
			sendPreviewBtn.disabled = false;
			sendPreviewBtn.textContent = 'Send Preview';
		}
	});

	function showPreviewResult(type, message) {
		if (!previewResult) return;

		previewResult.classList.remove('hidden');
		previewResult.className = `mt-4 px-4 py-3 rounded-lg text-sm ${
			type === 'success'
				? 'bg-green-50 border border-green-200 text-green-700'
				: 'bg-red-50 border border-red-200 text-red-600'
		}`;
		previewResult.textContent = message;

		setTimeout(() => {
			previewResult.classList.add('hidden');
		}, 5000);
	}
</script>
