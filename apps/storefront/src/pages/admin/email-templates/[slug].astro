---
export const prerender = false;

import { Badge } from '../../../components/catalyst/badge';
import { Alert } from '../../../components/catalyst/alert-banner';
import { Button } from '../../../components/catalyst/button';
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getApiBase } from '../../../lib/api';
import { formatDate } from '../../../lib/format';
import { DATE_FORMATS } from '../../../lib/constants';
import { Input } from '../../../components/catalyst/input';
import { Textarea } from '../../../components/catalyst/textarea';
import { Field, Label } from '../../../components/catalyst/fieldset';
import { Button as CatalystButton } from '../../../components/catalyst/button';
import { getCsrfToken, validateCsrfToken, CSRF_FIELD_NAME } from '../../../lib/csrf';
import { t } from '../../../i18n';
import { logError } from '../../../lib/logger';

const { slug } = Astro.params;
const apiBase = getApiBase();
const apiKey = import.meta.env.ADMIN_API_KEY;

type EmailTemplate = {
	id: number;
	slug: string;
	name: string;
	subject: string;
	body_html: string;
	body_text: string;
	variables: string[];
	created_at: string;
	updated_at: string;
};

let template: EmailTemplate | null = null;
let error: string | null = null;
let successMessage: string | null = null;

// Handle POST - Update template
if (Astro.request.method === 'POST' && apiKey) {
	try {
		const formData = await Astro.request.formData();

		if (!validateCsrfToken(Astro.request, formData)) {
			error = 'Invalid CSRF token. Please reload and try again.';
		} else {
			const subject = formData.get('subject')?.toString().trim() || '';
			const body_html = formData.get('body_html')?.toString() || '';
			const body_text = formData.get('body_text')?.toString() || '';

			if (!subject) {
				error = t('errors.subjectRequired');
			} else {
				const res = await fetch(`${apiBase}/admin/email-templates/${slug}`, {
					method: 'PUT',
					headers: {
						'Content-Type': 'application/json',
						'x-admin-key': apiKey
					},
					body: JSON.stringify({
						subject,
						body_html,
						body_text
					})
				});

				const data = await res.json();

				if (!res.ok) {
					error = data.message || t('errors.failedToUpdateTemplate');
				} else {
					template = data.template;
					successMessage = t('admin.templateUpdated');
				}
			}
		}
	} catch (e) {
		logError('Failed to update template', e, { page: 'admin/email-templates/[slug]', action: 'updateTemplate' });
		error = t('errors.failedToUpdateTemplate');
	}
}

// Fetch template data
if (!template && apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/email-templates/${slug}`, {
			headers: { 'x-admin-key': apiKey }
		});

		if (!res.ok) {
			if (res.status === 404) {
				error = t('errors.templateNotFound');
			} else {
				const data = await res.json();
				error = data.message || `API Error: ${res.status}`;
			}
		} else {
			const data = await res.json();
			template = data.template;
		}
	} catch (e) {
		logError('Failed to load template', e, { page: 'admin/email-templates/[slug]', action: 'fetchTemplate' });
		error = error || t('errors.failedToLoadTemplate');
	}
} else if (!apiKey) {
	error = t('errors.adminKeyMissing');
}

const dateTimeOpts = DATE_FORMATS.DATETIME;

const { token: csrfToken, cookieHeader: csrfCookieHeader } = getCsrfToken(Astro.request);
if (csrfCookieHeader) {
	Astro.response.headers.append('Set-Cookie', csrfCookieHeader);
}
---

<AdminLayout title={template ? `${template.name} - Admin` : 'Email Template - Admin'}>
	<div class="space-y-6 max-w-5xl">
		<div class="flex items-center gap-4">
			<a href="/admin/email-templates" class="text-brand hover:underline text-sm flex items-center gap-1">
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
				</svg>
				{t('admin.emailTemplates')}
			</a>
			<h1 class="text-2xl font-semibold text-gray-900">
				{template ? template.name : 'Email Template'}
			</h1>
		</div>

		{successMessage && (
			<div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-6 text-sm">
				{successMessage}
			</div>
		)}

		{error && !template && (
			<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-8 text-center">
				<div class="text-red-600 mb-4">{error}</div>
				<Button href="/admin/email-templates" outline client:load >
					{t('admin.backToTemplates')}
				</Button>
			</div>
		)}

		{error && template && (
			<Alert color="red" client:load>
				{error}
			</Alert>
		)}

		{template && (
			<form method="POST" class="space-y-6">
				<input type="hidden" name={CSRF_FIELD_NAME} value={csrfToken} />
				{/* Variables Info */}
				<div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
					<h3 class="text-sm font-medium text-blue-900 mb-2">	{t('admin.availableVariables')}</h3>
					<div class="flex flex-wrap gap-2">
						{template.variables && template.variables.length > 0 ? (
							template.variables.map((variable) => (
								<code class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">{`{{${variable}}}`}</code>
							))
						) : (
							<span class="text-sm text-blue-700">	{t('admin.noVariables')}</span>
						)}
					</div>
				</div>

				{/* Subject */}
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-4">
					<h2 class="text-sm font-medium text-secondary">	{t('admin.emailSubject')}</h2>
					<Field>
						<Input client:load
							type="text"
							id="subject"
							name="subject"
							required
							value={template.subject}
						/>
						<p data-slot="description" class="text-base/6 text-zinc-500 sm:text-sm/6">{t('admin.supportsVariables')}</p>
					</Field>
				</div>

				{/* HTML Body */}
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-4">
					<div class="flex items-center justify-between">
						<h2 class="text-sm font-medium text-secondary">{t('admin.htmlContent')}</h2>
						<div class="flex gap-2">
							<button
								type="button"
								id="preview-html-btn"
								class="text-sm text-brand hover:underline"
							>
								{t('admin.previewLabel')}
							</button>
						</div>
					</div>

					<div id="html-editor-container">
						<Textarea client:load
							id="body_html"
							name="body_html"
							rows={20}
						>{template.body_html}</Textarea>
					</div>

					<div id="html-preview-container" class="hidden">
						<div id="html-preview-content" class="min-h-[300px] border border-gray-200 rounded-lg bg-white overflow-auto">
						</div>
					</div>
				</div>

				{/* Text Body */}
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-4">
					<h2 class="text-sm font-medium text-secondary">{t('admin.plainTextContent')}</h2>
					<Field>
						<Textarea client:load
							id="body_text"
							name="body_text"
							rows={10}
						>{template.body_text}</Textarea>
						<p data-slot="description" class="text-base/6 text-zinc-500 sm:text-sm/6">{t('admin.usedWhenHtmlUnavailable')}</p>
					</Field>
				</div>

				{/* Preview Email */}
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-4">
					<h2 class="text-sm font-medium text-secondary">{t('admin.sendTestEmail')}</h2>
					<div class="flex gap-4">
						<Input client:load
							type="email"
							id="preview-email"
							placeholder="Enter email address..."
							className="flex-1"
						/>
						<CatalystButton client:load
							type="button"
							id="send-preview-btn"
							color="zinc"
						>
							{t('admin.sendPreview')}
						</CatalystButton>
					</div>
					<p class="text-xs text-secondary">{t('admin.testEmailNote')}</p>
					<div id="preview-result" class="hidden"></div>
				</div>

				{/* Meta Info */}
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
					<dl class="grid grid-cols-2 gap-4 text-sm">
						<div>
							<dt class="text-secondary">{t('admin.created')}</dt>
							<dd class="text-zinc-950 tabular-nums">{formatDate(template.created_at, dateTimeOpts)}</dd>
						</div>
						<div>
							<dt class="text-secondary">{t('admin.updated')}</dt>
							<dd class="text-zinc-950 tabular-nums">{formatDate(template.updated_at, dateTimeOpts)}</dd>
						</div>
					</dl>
				</div>

				{/* Actions */}
				<div class="flex justify-end gap-3">
					<Button href="/admin/email-templates" outline client:load >
						{t('admin.back')}
					</Button>
					<Button type="submit" color="indigo" client:load >
						{t('admin.saveChanges')}
					</Button>
				</div>
			</form>
		)}
	</div>
</AdminLayout>

<script define:vars={{ templateSlug: slug }}>
	const previewHtmlBtn = document.getElementById('preview-html-btn');
	const htmlEditorContainer = document.getElementById('html-editor-container');
	const htmlPreviewContainer = document.getElementById('html-preview-container');
	const htmlPreviewContent = document.getElementById('html-preview-content');
	const bodyHtmlTextarea = document.getElementById('body_html');
	const sendPreviewBtn = document.getElementById('send-preview-btn');
	const previewEmailInput = document.getElementById('preview-email');
	const previewResult = document.getElementById('preview-result');

	let showHtmlPreview = false;

	// HTML Preview toggle
	previewHtmlBtn?.addEventListener('click', () => {
		showHtmlPreview = !showHtmlPreview;

		if (showHtmlPreview) {
			htmlEditorContainer?.classList.add('hidden');
			htmlPreviewContainer?.classList.remove('hidden');
			if (htmlPreviewContent && bodyHtmlTextarea) {
				// Create iframe for safe HTML preview
				const iframe = document.createElement('iframe');
				iframe.style.width = '100%';
				iframe.style.minHeight = '400px';
				iframe.style.border = 'none';
				iframe.setAttribute('sandbox', '');
				htmlPreviewContent.innerHTML = '';
				htmlPreviewContent.appendChild(iframe);

				const doc = iframe.contentDocument || iframe.contentWindow?.document;
				if (doc) {
					doc.open();
					doc.write(bodyHtmlTextarea.value);
					doc.close();
				}
			}
			previewHtmlBtn.textContent = 'Edit';
		} else {
			htmlEditorContainer?.classList.remove('hidden');
			htmlPreviewContainer?.classList.add('hidden');
			previewHtmlBtn.textContent = 'Preview';
		}
	});

	// Send preview email
	sendPreviewBtn?.addEventListener('click', async () => {
		const email = previewEmailInput?.value?.trim();

		if (!email) {
			showPreviewResult('error', 'Please enter an email address');
			return;
		}

		sendPreviewBtn.disabled = true;
		sendPreviewBtn.textContent = 'Sending...';

		try {
			const res = await fetch(`/api/admin/email-templates/${templateSlug}/preview`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({ to: email })
			});

			const data = await res.json();

			if (!res.ok) {
				showPreviewResult('error', data.message || 'Failed to send preview email');
			} else {
				showPreviewResult('success', `Preview email sent to ${email}`);
			}
		} catch (e) {
			showPreviewResult('error', 'Failed to send preview email. Please try again.');
		} finally {
			sendPreviewBtn.disabled = false;
			sendPreviewBtn.textContent = 'Send Preview';
		}
	});

	function showPreviewResult(type, message) {
		if (!previewResult) return;

		previewResult.classList.remove('hidden');
		previewResult.className = `mt-4 px-4 py-3 rounded-lg text-sm ${
			type === 'success'
				? 'bg-green-50 border border-green-200 text-green-700'
				: 'bg-red-50 border border-red-200 text-red-600'
		}`;
		previewResult.textContent = message;

		setTimeout(() => {
			previewResult.classList.add('hidden');
		}, 5000);
	}
</script>
