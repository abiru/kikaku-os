---
export const prerender = false;

import { Alert } from '../../../components/catalyst/alert-banner';
import { Button } from '../../../components/catalyst/button';
import { Checkbox } from '../../../components/catalyst/checkbox';
import { Fieldset, Field, Label } from '../../../components/catalyst/fieldset';
import { Heading, Subheading } from '../../../components/catalyst/heading';
import { Input } from '../../../components/catalyst/input';
import { Select } from '../../../components/catalyst/select';
import { Textarea } from '../../../components/catalyst/textarea';
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getApiBase } from '../../../lib/api';
import { formatPrice, formatDate } from '../../../lib/format';
import MarkdownPreview from '../../../components/MarkdownPreview';

const { id } = Astro.params;
const apiBase = getApiBase();
const apiKey = import.meta.env.ADMIN_API_KEY;

type Price = {
	id: number;
	variant_id: number;
	currency: string;
	amount: number;
	provider_price_id: string | null;
};

type Variant = {
	id: number;
	product_id: number;
	title: string;
	sku: string | null;
	options: string | null;
	metadata: string | null;
	created_at: string;
	updated_at: string;
	prices: Price[];
};

type Product = {
	id: number;
	title: string;
	description: string | null;
	category: string | null;
	metadata: string | null;
	status: string | null;
	tax_rate_id: number | null;
	featured?: number;
	created_at: string;
	updated_at: string;
};

type TaxRate = {
	id: number;
	name: string;
	rate: number;
	is_active: number;
};

type ProductImage = {
	id: number;
	product_id: number;
	r2_key: string;
	filename: string;
	content_type: string;
	size_bytes: number;
	position: number;
	created_at: string;
	updated_at: string;
};

type Category = {
	category: string;
	product_count: number;
};

let product: Product | null = null;
let variants: Variant[] = [];
let images: ProductImage[] = [];
let categories: Category[] = [];
let taxRates: TaxRate[] = [];
let error: string | null = null;
let successMessage: string | null = null;

// Handle POST - Update product
if (Astro.request.method === 'POST' && apiKey) {
	try {
		const formData = await Astro.request.formData();
		const title = formData.get('title')?.toString().trim() || '';
		const description = formData.get('description')?.toString().trim() || '';
		const status = formData.get('status')?.toString() || 'active';
		const category = formData.get('category')?.toString().trim() || null;
		const tax_rate_id_str = formData.get('tax_rate_id')?.toString() || null;
		const tax_rate_id = tax_rate_id_str ? parseInt(tax_rate_id_str, 10) : null;
		const featured = formData.get('featured') === 'on' ? 1 : 0;

		if (!title) {
			error = 'Title is required';
		} else {
			const res = await fetch(`${apiBase}/admin/products/${id}`, {
				method: 'PUT',
				headers: {
					'Content-Type': 'application/json',
					'x-admin-key': apiKey
				},
				body: JSON.stringify({ title, description, status, category, tax_rate_id, featured })
			});

			const data = await res.json();

			if (!res.ok) {
				error = data.message || 'Failed to update product';
			} else {
				product = data.product;
				successMessage = 'Product updated successfully';
			}
		}
	} catch (e) {
		console.error(e);
		error = 'Failed to update product. Please check your connection.';
	}
}

// Fetch product data (if not already set from POST)
if (!product && apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/products/${id}`, {
			headers: { 'x-admin-key': apiKey }
		});

		if (!res.ok) {
			if (res.status === 404) {
				error = 'Product not found';
			} else {
				const data = await res.json();
				error = data.message || `API Error: ${res.status}`;
			}
		} else {
			const data = await res.json();
			product = data.product;
		}
	} catch (e) {
		console.error(e);
		error = error || 'Failed to load product. Please check your connection.';
	}
} else if (!apiKey) {
	error = 'ADMIN_API_KEY is missing in server environment';
}

// Fetch variants if product is loaded
if (product && apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/products/${id}/variants`, {
			headers: { 'x-admin-key': apiKey }
		});
		if (res.ok) {
			const data = await res.json();
			variants = data.variants || [];
		}
	} catch (e) {
		console.error('Failed to fetch variants:', e);
	}
}

// Fetch images if product is loaded
if (product && apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/products/${id}/images`, {
			headers: { 'x-admin-key': apiKey }
		});
		if (res.ok) {
			const data = await res.json();
			images = data.images || [];
		}
	} catch (e) {
		console.error('Failed to fetch images:', e);
	}
}

// Fetch categories for dropdown
if (apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/categories`, {
			headers: { 'x-admin-key': apiKey }
		});
		if (res.ok) {
			const data = await res.json();
			categories = data.categories || [];
		}
	} catch (e) {
		console.error('Failed to fetch categories:', e);
	}
}

// Fetch tax rates for dropdown
if (apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/tax-rates`, {
			headers: { 'x-admin-key': apiKey }
		});
		if (res.ok) {
			const data = await res.json();
			taxRates = data.filter((tr: TaxRate) => tr.is_active) || [];
		}
	} catch (e) {
		console.error('Failed to fetch tax rates:', e);
	}
}

const dateTimeOpts: Intl.DateTimeFormatOptions = {
	year: 'numeric',
	month: '2-digit',
	day: '2-digit',
	hour: '2-digit',
	minute: '2-digit'
};

const getExternalImageUrl = (metadata: string | null): string | null => {
	if (!metadata) return null;
	try {
		const parsed = JSON.parse(metadata);
		return parsed.image_url || null;
	} catch {
		return null;
	}
};

const externalImageUrl = product ? getExternalImageUrl(product.metadata) : null;
---

<AdminLayout title={product ? `${product.title} - Admin` : 'Product - Admin'}>
	<div class="space-y-6 max-w-2xl">
		<div class="flex items-center gap-4">
			<a href="/admin/products" class="text-indigo-600 hover:underline text-sm flex items-center gap-1">
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
				</svg>
				Products
			</a>
			<Heading>
				{product ? `Edit: ${product.title}` : 'Product'}
			</Heading>
		</div>
			{successMessage && (
				<Alert color="green" client:load>
					{successMessage}
				</Alert>
			)}

			{error && !product && (
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-8 text-center">
					<Alert color="red" client:load>
						{error}
					</Alert>
					<div class="mt-4">
						<Button href="/admin/products" outline client:load>
							Back to Products
						</Button>
					</div>
				</div>
			)}

			{error && product && (
				<Alert color="red" client:load>
					{error}
				</Alert>
			)}

			{product && (
				<form method="POST" class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6">
					<Fieldset client:load>
						<Field>
							<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">Title *</label>
							<Input client:load type="text" name="title" required value={product.title} />
						</Field>

						<Field>
							<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">Description（Markdown形式）</label>
							<MarkdownPreview
								client:load
								value={product.description || ''}
								onChange={(val: string) => {
									const input = document.getElementById('description-hidden') as HTMLInputElement;
									if (input) input.value = val;
								}}
							/>
							<input type="hidden" id="description-hidden" name="description" value={product.description || ''} />
						</Field>

						<Field>
							<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">Status</label>
							<Select client:load name="status">
								<option value="active" selected={product.status === 'active'}>Active</option>
								<option value="draft" selected={product.status === 'draft'}>Draft</option>
								<option value="archived" selected={product.status === 'archived'}>Archived</option>
							</Select>
						</Field>

						<Field>
							<div class="flex items-center gap-2">
								<Checkbox client:load
									id="featured"
									name="featured"
									checked={product.featured === 1}
								/>
								<label for="featured" class="text-base/6 text-zinc-950 select-none sm:text-sm/6">
									ホームページに表示（Featured）
								</label>
							</div>
							<p class="text-xs text-[#86868b] mt-1">チェックするとホームページのカテゴリグリッドに表示されます</p>
						</Field>

						<Field>
							<Label>Category</Label>
							<Input client:load
								type="text"
								name="category"
								list="category-list"
								value={product.category || ''}
								placeholder="Select or enter a category"
							/>
							<datalist id="category-list">
								{categories.map((cat) => (
									<option value={cat.category} />
								))}
							</datalist>
							<p class="text-xs text-[#86868b] mt-1">Type to create a new category or select from existing ones.</p>
						</Field>

						<Field>
							<Label>Tax Rate</Label>
							<Select client:load name="tax_rate_id">
								<option value="">Select tax rate...</option>
								{taxRates.map((rate) => (
									<option value={rate.id} selected={product.tax_rate_id === rate.id}>
										{rate.name} ({(rate.rate * 100).toFixed(1)}%)
									</option>
								))}
							</Select>
							<p class="text-xs text-[#86868b] mt-1">All prices are tax-inclusive (税込)</p>
						</Field>
					</Fieldset>

					<div class="pt-4 border-t border-gray-100">
						<dl class="grid grid-cols-2 gap-4 text-sm">
							<div>
								<dt class="text-[#86868b]">Created</dt>
								<dd class="text-zinc-950 tabular-nums">{formatDate(product.created_at, dateTimeOpts)}</dd>
							</div>
							<div>
								<dt class="text-[#86868b]">Updated</dt>
								<dd class="text-zinc-950 tabular-nums">{formatDate(product.updated_at, dateTimeOpts)}</dd>
							</div>
						</dl>
					</div>

				<div class="flex justify-between gap-3 pt-4 border-t border-gray-100">
					<div>
						{product.status !== 'archived' && (
							<button
								type="button"
								id="archive-product-btn"
								class="px-4 py-2 text-sm font-medium text-white bg-red-500 rounded-lg hover:bg-red-600 transition-colors"
							>
								Archive Product
							</button>
						)}
						{product.status === 'archived' && (
							<button
								type="button"
								id="restore-product-btn"
								class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 transition-colors"
							>
								Restore Product
							</button>
						)}
					</div>
					<div class="flex gap-3">
						<Button href="/admin/products" outline client:load>
							Back
						</Button>
						<Button type="submit" color="indigo" client:load>
							Save Changes
						</Button>
					</div>
				</div>
				</form>

				<!-- Web Update Section -->
				<div class="mt-8">
					<div class="flex items-center justify-between mb-4">
						<Subheading>Web更新</Subheading>
					</div>
					<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4 space-y-4">
						<Fieldset client:load>
							<Field>
								<Label>商品ページURL</Label>
								<div class="flex gap-2">
									<Input
										type="url"
										id="fetch-url"
										placeholder="https://www.spider-farmer.com/products/..."
										className="flex-1"
									/>
								<button
									type="button"
									id="fetch-btn"
									class="px-4 py-2 text-sm font-medium text-white bg-[#0071e3] rounded-lg hover:bg-[#0077ED] transition-colors flex items-center gap-2"
								>
									<svg id="fetch-spinner" class="hidden animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
										<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
										<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
									</svg>
									<span id="fetch-label">取得</span>
								</button>
								</div>
								<p class="text-xs text-[#86868b] mt-1">メーカーの公式サイトURLを入力して情報を取得します</p>
							</Field>
						</Fieldset>

						<div id="fetch-error" class="hidden">
							<div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm"></div>
						</div>

						<div id="fetch-warning" class="hidden">
							<div class="bg-amber-50 border border-amber-200 text-amber-700 px-4 py-3 rounded-lg text-sm"></div>
						</div>

						<div id="fetch-preview" class="hidden border-t border-gray-100 pt-4 space-y-4">
							<h3 class="text-sm font-semibold text-zinc-950">取得結果</h3>

							<!-- Image -->
							<div class="flex gap-4">
								<div class="flex-shrink-0">
									<p class="text-xs text-[#86868b] mb-1">画像</p>
									<img id="preview-image" src="" alt="Preview" class="w-32 h-32 object-contain rounded-lg bg-gray-50" />
								</div>
								<div class="flex-1 space-y-2">
									<div>
										<p class="text-xs text-[#86868b]">取得元タイトル</p>
										<p id="preview-original-title" class="text-sm text-zinc-950"></p>
									</div>
									<div>
										<p class="text-xs text-[#86868b]">スペック</p>
										<p id="preview-specs" class="text-xs text-zinc-950 font-mono"></p>
									</div>
									<div>
										<p class="text-xs text-[#86868b]">ソース</p>
										<p id="preview-source" class="text-sm text-zinc-950 font-mono"></p>
									</div>
								</div>
							</div>

							<!-- Generated Title -->
							<div class="p-3 bg-blue-50 rounded-lg">
								<p class="text-xs text-blue-600 mb-1">生成されたタイトル</p>
								<p id="preview-generated-title" class="text-sm font-medium text-zinc-950"></p>
							</div>

							<!-- Generated Description -->
							<div>
								<p class="text-xs text-[#86868b] mb-1">生成された説明文</p>
								<div id="preview-generated-description" class="p-4 bg-gray-50 rounded-lg text-sm prose prose-sm max-w-none max-h-64 overflow-y-auto"></div>
							</div>

							<div class="flex flex-wrap gap-2 pt-2">
								<button
									type="button"
									id="apply-all-btn"
									class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 transition-colors"
								>
									すべて適用
								</button>
								<button
									type="button"
									id="apply-title-only-btn"
									class="px-4 py-2 text-sm font-medium text-green-700 bg-green-100 rounded-lg hover:bg-green-200 transition-colors"
								>
									タイトルのみ
								</button>
								<button
									type="button"
									id="apply-desc-only-btn"
									class="px-4 py-2 text-sm font-medium text-green-700 bg-green-100 rounded-lg hover:bg-green-200 transition-colors"
								>
									説明文のみ
								</button>
								<button
									type="button"
									id="send-inbox-btn"
									class="px-4 py-2 text-sm font-medium text-white bg-purple-600 rounded-lg hover:bg-purple-700 transition-colors"
								>
									Inboxに送信
								</button>
								<button
									type="button"
									id="cancel-preview-btn"
									class="px-4 py-2 text-sm font-medium text-zinc-950 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
								>
									キャンセル
								</button>
							</div>
						</div>

						<div id="apply-success" class="hidden">
							<div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg text-sm">
								Inboxに送信しました。<a href="/admin/inbox" class="underline">Inbox</a>で承認してください。
							</div>
						</div>
					</div>
				</div>

				<!-- External Image URL (from metadata) -->
				{externalImageUrl && (
					<div class="mt-8">
						<Subheading>External Image</Subheading>
						<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
							<div class="flex gap-4">
								<img
									src={externalImageUrl}
									alt={product.title}
									class="w-32 h-32 object-contain rounded-lg bg-gray-50"
								/>
								<div class="flex-1 min-w-0">
									<p class="text-xs text-[#86868b] mb-1">Image URL (from web search)</p>
									<p class="text-sm text-zinc-950 break-all font-mono">{externalImageUrl}</p>
								</div>
							</div>
						</div>
					</div>
				)}

				<!-- Images Section -->
				<div class="mt-8">
					<div class="flex items-center justify-between mb-4">
						<Subheading>Images (R2 Storage)</Subheading>
						<label
							class="text-sm text-[#0071e3] hover:underline flex items-center gap-1 cursor-pointer"
						>
							<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
							</svg>
							Add Images
							<input
								type="file"
								id="image-upload"
								accept="image/jpeg,image/png,image/gif,image/webp"
								multiple
								class="hidden"
							/>
						</label>
					</div>

					<div id="upload-progress" class="hidden mb-4">
						<div class="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded-lg text-sm flex items-center gap-2">
							<svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
								<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
								<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
							</svg>
							<span>Uploading...</span>
						</div>
					</div>

					<div id="image-error" class="hidden mb-4">
						<div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm"></div>
					</div>

					{images.length === 0 ? (
						<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-8 text-center">
							<p class="text-[#86868b] text-sm">No images yet. Add product images to showcase your products.</p>
						</div>
					) : (
						<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
							<div id="images-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
								{images.map((image, index) => (
									<div
										class="relative group aspect-square bg-gray-100 rounded-lg overflow-hidden"
										data-image-id={image.id}
									>
										<img
											src={`/api/r2?key=${encodeURIComponent(image.r2_key)}`}
											alt={image.filename}
											class="w-full h-full object-cover"
											loading="lazy"
										/>
										{index === 0 && (
											<span class="absolute top-2 left-2 bg-[#0071e3] text-white text-xs px-2 py-0.5 rounded-full">
												Main
											</span>
										)}
										<button
											type="button"
											class="delete-image-btn absolute top-2 right-2 bg-red-500 text-white p-1.5 rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600"
											data-image-id={image.id}
											data-image-filename={image.filename}
										>
											<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
											</svg>
										</button>
										<div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 opacity-0 group-hover:opacity-100 transition-opacity">
											<p class="text-white text-xs truncate">{image.filename}</p>
										</div>
									</div>
								))}
							</div>
						</div>
					)}
				</div>

				<!-- Variants Section -->
				<div class="mt-8">
					<div class="flex items-center justify-between mb-4">
						<Subheading>Variants</Subheading>
						<button
							type="button"
							id="add-variant-btn"
							class="text-sm text-[#0071e3] hover:underline flex items-center gap-1"
						>
							<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
							</svg>
							Add Variant
						</button>
					</div>

					{variants.length === 0 ? (
						<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-8 text-center">
							<p class="text-[#86868b] text-sm">No variants yet. Add one to set prices.</p>
						</div>
					) : (
						<div class="bg-white rounded-xl border border-gray-200 shadow-sm divide-y divide-gray-100">
							{variants.map((variant) => {
								const price = variant.prices?.[0];
								return (
									<div class="p-4 flex items-center justify-between" data-variant-id={variant.id}>
										<div class="flex-1">
											<div class="font-medium text-zinc-950">{variant.title}</div>
											<div class="text-sm text-[#86868b] mt-1 flex flex-wrap gap-x-4 gap-y-1">
												<span>SKU: {variant.sku || '-'}</span>
												<span class="tabular-nums">
													{price ? formatPrice(price.amount, price.currency) : 'No price set'}
												</span>
												<span class="font-mono text-xs">
													Stripe: {price?.provider_price_id || '-'}
												</span>
											</div>
										</div>
										<div class="flex items-center gap-2 ml-4">
											<button
												type="button"
												class="edit-variant-btn text-sm text-[#0071e3] hover:underline"
												data-variant={JSON.stringify(variant)}
											>
												Edit
											</button>
											<button
												type="button"
												class="delete-variant-btn text-sm text-red-500 hover:underline"
												data-variant-id={variant.id}
												data-variant-title={variant.title}
											>
												Delete
											</button>
										</div>
									</div>
								);
							})}
						</div>
					)}
				</div>

				<!-- Variant Modal -->
				<div id="variant-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
					<div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
						<div class="p-6 border-b border-gray-100">
							<h3 id="modal-title" class="text-lg font-semibold text-zinc-950">Add Variant</h3>
						</div>
						<form id="variant-form" class="p-6 space-y-4">
							<input type="hidden" id="variant-id" name="variantId" value="" />

							<Fieldset client:load>
								<Field>
									<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">Title *</label>
									<Input
										type="text"
										id="variant-title"
										name="title"
										required
										placeholder="e.g., Default, Size M, Color Red"
									/>
								</Field>

								<Field>
									<Label>SKU</Label>
									<Input
										type="text"
										id="variant-sku"
										name="sku"
										placeholder="Optional SKU code"
									/>
								</Field>

								<Field>
									<Label>Price (JPY) *</Label>
									<Input
										type="number"
										id="price-amount"
										name="amount"
										required
										min="0"
										step="1"
										className="tabular-nums"
										placeholder="1000"
									/>
								</Field>

								<Field>
									<Label>Stripe Price ID</Label>
									<Input
										type="text"
										id="stripe-price-id"
										name="provider_price_id"
										className="font-mono"
										placeholder="price_xxxxxxxx"
									/>
									<p class="text-xs text-[#86868b] mt-1">Required for checkout. Get this from your Stripe Dashboard.</p>
								</Field>
							</Fieldset>

							<div id="modal-error" class="hidden">
								<div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm"></div>
							</div>

							<div class="flex justify-end gap-3 pt-4 border-t border-gray-100">
								<button
									type="button"
									id="cancel-modal-btn"
									class="px-4 py-2 text-sm font-medium text-zinc-950 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
								>
									Cancel
								</button>
								<button
									type="submit"
									class="px-4 py-2 text-sm font-medium text-white bg-[#0071e3] rounded-lg hover:bg-[#0077ED] transition-colors"
								>
									Save
								</button>
							</div>
						</form>
					</div>
				</div>
			)}
	</div>
</AdminLayout>

<script>
	import { initProductPage } from '../../../lib/admin/product-detail';

	const productId = document.currentScript?.closest('[data-product-id]')?.getAttribute('data-product-id')
		|| new URL(window.location.href).pathname.split('/').pop()
		|| '';

	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', () => initProductPage(productId));
	} else {
		initProductPage(productId);
	}
</script>
