---
export const prerender = false;

import Button from '../../../components/Button.astro';
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getApiBase } from '../../../lib/api';

const { id } = Astro.params;
const apiBase = getApiBase();
const apiKey = import.meta.env.ADMIN_API_KEY;

type Price = {
	id: number;
	variant_id: number;
	currency: string;
	amount: number;
	provider_price_id: string | null;
};

type Variant = {
	id: number;
	product_id: number;
	title: string;
	sku: string | null;
	options: string | null;
	metadata: string | null;
	created_at: string;
	updated_at: string;
	prices: Price[];
};

type Product = {
	id: number;
	title: string;
	description: string | null;
	category: string | null;
	metadata: string | null;
	status: string | null;
	created_at: string;
	updated_at: string;
};

type ProductImage = {
	id: number;
	product_id: number;
	r2_key: string;
	filename: string;
	content_type: string;
	size_bytes: number;
	position: number;
	created_at: string;
	updated_at: string;
};

type Category = {
	category: string;
	product_count: number;
};

let product: Product | null = null;
let variants: Variant[] = [];
let images: ProductImage[] = [];
let categories: Category[] = [];
let error: string | null = null;
let successMessage: string | null = null;

// Handle POST - Update product
if (Astro.request.method === 'POST' && apiKey) {
	try {
		const formData = await Astro.request.formData();
		const title = formData.get('title')?.toString().trim() || '';
		const description = formData.get('description')?.toString().trim() || '';
		const status = formData.get('status')?.toString() || 'active';
		const category = formData.get('category')?.toString().trim() || null;

		if (!title) {
			error = 'Title is required';
		} else {
			const res = await fetch(`${apiBase}/admin/products/${id}`, {
				method: 'PUT',
				headers: {
					'Content-Type': 'application/json',
					'x-admin-key': apiKey
				},
				body: JSON.stringify({ title, description, status, category })
			});

			const data = await res.json();

			if (!res.ok) {
				error = data.message || 'Failed to update product';
			} else {
				product = data.product;
				successMessage = 'Product updated successfully';
			}
		}
	} catch (e) {
		console.error(e);
		error = 'Failed to update product. Please check your connection.';
	}
}

// Fetch product data (if not already set from POST)
if (!product && apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/products/${id}`, {
			headers: { 'x-admin-key': apiKey }
		});

		if (!res.ok) {
			if (res.status === 404) {
				error = 'Product not found';
			} else {
				const data = await res.json();
				error = data.message || `API Error: ${res.status}`;
			}
		} else {
			const data = await res.json();
			product = data.product;
		}
	} catch (e) {
		console.error(e);
		error = error || 'Failed to load product. Please check your connection.';
	}
} else if (!apiKey) {
	error = 'ADMIN_API_KEY is missing in server environment';
}

// Fetch variants if product is loaded
if (product && apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/products/${id}/variants`, {
			headers: { 'x-admin-key': apiKey }
		});
		if (res.ok) {
			const data = await res.json();
			variants = data.variants || [];
		}
	} catch (e) {
		console.error('Failed to fetch variants:', e);
	}
}

// Fetch images if product is loaded
if (product && apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/products/${id}/images`, {
			headers: { 'x-admin-key': apiKey }
		});
		if (res.ok) {
			const data = await res.json();
			images = data.images || [];
		}
	} catch (e) {
		console.error('Failed to fetch images:', e);
	}
}

// Fetch categories for dropdown
if (apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/categories`, {
			headers: { 'x-admin-key': apiKey }
		});
		if (res.ok) {
			const data = await res.json();
			categories = data.categories || [];
		}
	} catch (e) {
		console.error('Failed to fetch categories:', e);
	}
}

const formatDate = (dateStr: string | null) => {
	if (!dateStr) return '-';
	return new Date(dateStr).toLocaleString('ja-JP', {
		year: 'numeric',
		month: '2-digit',
		day: '2-digit',
		hour: '2-digit',
		minute: '2-digit'
	});
};

const formatPrice = (amount: number, currency: string = 'JPY') => {
	return new Intl.NumberFormat('ja-JP', {
		style: 'currency',
		currency: currency,
		minimumFractionDigits: 0,
	}).format(amount);
};

const getExternalImageUrl = (metadata: string | null): string | null => {
	if (!metadata) return null;
	try {
		const parsed = JSON.parse(metadata);
		return parsed.image_url || null;
	} catch {
		return null;
	}
};

const externalImageUrl = product ? getExternalImageUrl(product.metadata) : null;
---

<AdminLayout title={product ? `${product.title} - Admin` : 'Product - Admin'}>
	<div class="max-w-4xl">
		<!-- Header -->
		<div class="mb-8">
			<a href="/admin/products" class="text-indigo-600 hover:text-indigo-500 text-sm font-medium flex items-center gap-1 mb-4">
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
				</svg>
				Back to Products
			</a>
			<h1 class="text-2xl font-semibold text-gray-900">
				{product ? product.title : 'Product'}
			</h1>
			<p class="mt-1 text-sm text-gray-600">
				Manage product details, variants, and images.
			</p>
		</div>

		{successMessage && (
			<div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-6 text-sm">
				{successMessage}
			</div>
		)}

		{error && !product && (
			<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-8 text-center">
				<div class="text-red-600 mb-4">{error}</div>
				<Button href="/admin/products" variant="secondary" size="sm">
					Back to Products
				</Button>
			</div>
		)}

		{error && product && (
			<div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg mb-6 text-sm">
				{error}
			</div>
		)}

		{product && (
			<form method="POST">
				<div class="space-y-12">
					<!-- Basic Information Section -->
					<div>
						<h2 class="text-base font-semibold text-gray-900">Basic Information</h2>
						<p class="mt-1 text-sm text-gray-600">
							Core product details that appear in your store.
						</p>

						<div class="mt-10 space-y-8 border-b border-gray-900/10 pb-12 sm:space-y-0 sm:divide-y sm:divide-gray-900/10 sm:border-t sm:pb-0">
							<!-- Title -->
							<div class="sm:grid sm:grid-cols-3 sm:items-start sm:gap-4 sm:py-6">
								<label for="title" class="block text-sm font-medium text-gray-900 sm:pt-1.5">
									Title <span class="text-red-500">*</span>
								</label>
								<div class="mt-2 sm:col-span-2 sm:mt-0">
									<input
										type="text"
										id="title"
										name="title"
										required
										value={product.title}
										class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:max-w-xl sm:text-sm"
									/>
								</div>
							</div>

							<!-- Description -->
							<div class="sm:grid sm:grid-cols-3 sm:items-start sm:gap-4 sm:py-6">
								<label for="description" class="block text-sm font-medium text-gray-900 sm:pt-1.5">
									Description
								</label>
								<div class="mt-2 sm:col-span-2 sm:mt-0">
									<textarea
										id="description"
										name="description"
										rows={4}
										class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:max-w-2xl sm:text-sm"
									>{product.description || ''}</textarea>
									<p class="mt-3 text-sm text-gray-600">Write a detailed description for your product.</p>
								</div>
							</div>

							<!-- Status -->
							<div class="sm:grid sm:grid-cols-3 sm:items-start sm:gap-4 sm:py-6">
								<label for="status" class="block text-sm font-medium text-gray-900 sm:pt-1.5">
									Status
								</label>
								<div class="mt-2 sm:col-span-2 sm:mt-0">
									<div class="grid grid-cols-1 sm:max-w-xs">
										<select
											id="status"
											name="status"
											class="col-start-1 row-start-1 w-full appearance-none rounded-md bg-white py-1.5 pr-8 pl-3 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm"
										>
											<option value="active" selected={product.status === 'active'}>Active</option>
											<option value="draft" selected={product.status === 'draft'}>Draft</option>
										</select>
										<svg class="pointer-events-none col-start-1 row-start-1 mr-2 size-5 self-center justify-self-end text-gray-500 sm:size-4" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
											<path fill-rule="evenodd" d="M4.22 6.22a.75.75 0 0 1 1.06 0L8 8.94l2.72-2.72a.75.75 0 1 1 1.06 1.06l-3.25 3.25a.75.75 0 0 1-1.06 0L4.22 7.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
										</svg>
									</div>
								</div>
							</div>

							<!-- Category -->
							<div class="sm:grid sm:grid-cols-3 sm:items-start sm:gap-4 sm:py-6">
								<label for="category" class="block text-sm font-medium text-gray-900 sm:pt-1.5">
									Category
								</label>
								<div class="mt-2 sm:col-span-2 sm:mt-0">
									<input
										type="text"
										id="category"
										name="category"
										list="category-list"
										value={product.category || ''}
										placeholder="Select or enter a category"
										class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:max-w-md sm:text-sm"
									/>
									<datalist id="category-list">
										{categories.map((cat) => (
											<option value={cat.category} />
										))}
									</datalist>
									<p class="mt-3 text-sm text-gray-600">Type to create a new category or select from existing ones.</p>
								</div>
							</div>

							<!-- Timestamps -->
							<div class="sm:grid sm:grid-cols-3 sm:items-start sm:gap-4 sm:py-6">
								<div class="text-sm font-medium text-gray-900 sm:pt-1.5">
									Timestamps
								</div>
								<div class="mt-2 sm:col-span-2 sm:mt-0">
									<dl class="grid grid-cols-2 gap-4 text-sm sm:max-w-md">
										<div>
											<dt class="text-gray-500">Created</dt>
											<dd class="text-gray-900 tabular-nums mt-1">{formatDate(product.created_at)}</dd>
										</div>
										<div>
											<dt class="text-gray-500">Updated</dt>
											<dd class="text-gray-900 tabular-nums mt-1">{formatDate(product.updated_at)}</dd>
										</div>
									</dl>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Form Actions -->
				<div class="mt-6 flex items-center justify-end gap-x-6">
					<a href="/admin/products" class="text-sm font-semibold text-gray-900 hover:text-gray-700">
						Cancel
					</a>
					<button
						type="submit"
						class="inline-flex justify-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600"
					>
						Save Changes
					</button>
				</div>
			</form>

				<!-- Web Update Section -->
				<div class="mt-12">
					<h2 class="text-base font-semibold text-gray-900">Web Data Import</h2>
					<p class="mt-1 text-sm text-gray-600">
						Fetch product information from manufacturer websites.
					</p>

					<div class="mt-10 space-y-8 border-b border-gray-900/10 pb-12 sm:space-y-0 sm:divide-y sm:divide-gray-900/10 sm:border-t sm:pb-0">
						<!-- URL Fetch -->
						<div class="sm:grid sm:grid-cols-3 sm:items-start sm:gap-4 sm:py-6">
							<label for="fetch-url" class="block text-sm font-medium text-gray-900 sm:pt-1.5">
								Product Page URL
							</label>
							<div class="mt-2 sm:col-span-2 sm:mt-0">
								<div class="flex gap-2 sm:max-w-xl">
									<input
										type="url"
										id="fetch-url"
										placeholder="https://www.spider-farmer.com/products/..."
										class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm"
									/>
									<button
										type="button"
										id="fetch-btn"
										class="inline-flex shrink-0 items-center gap-x-1.5 rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600"
									>
										<svg id="fetch-spinner" class="hidden animate-spin -ml-0.5 size-4" fill="none" viewBox="0 0 24 24">
											<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
											<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
										</svg>
										<span id="fetch-label">Fetch</span>
									</button>
								</div>
								<p class="mt-2 text-sm text-gray-600">Enter the manufacturer's official product page URL to import information.</p>

								<div id="fetch-error" class="hidden mt-4">
									<div class="rounded-md bg-red-50 p-4">
										<div class="flex">
											<div class="shrink-0">
												<svg class="size-5 text-red-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
													<path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16ZM8.28 7.22a.75.75 0 0 0-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 1 0 1.06 1.06L10 11.06l1.72 1.72a.75.75 0 1 0 1.06-1.06L11.06 10l1.72-1.72a.75.75 0 0 0-1.06-1.06L10 8.94 8.28 7.22Z" clip-rule="evenodd" />
												</svg>
											</div>
											<div class="ml-3">
												<p class="text-sm text-red-700"></p>
											</div>
										</div>
									</div>
								</div>

								<div id="fetch-warning" class="hidden mt-4">
									<div class="rounded-md bg-yellow-50 p-4">
										<div class="flex">
											<div class="shrink-0">
												<svg class="size-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
													<path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495ZM10 5a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 10 5Zm0 9a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" clip-rule="evenodd" />
												</svg>
											</div>
											<div class="ml-3">
												<p class="text-sm text-yellow-700"></p>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>

						<!-- Manual Input Fallback -->
						<div class="sm:grid sm:grid-cols-3 sm:items-start sm:gap-4 sm:py-6">
							<div class="text-sm font-medium text-gray-900 sm:pt-1.5">
								Manual Input
							</div>
							<div class="mt-2 sm:col-span-2 sm:mt-0">
								<details class="group">
									<summary class="flex cursor-pointer items-center text-sm text-indigo-600 hover:text-indigo-500">
										<svg class="mr-1.5 size-4 transition-transform group-open:rotate-90" viewBox="0 0 20 20" fill="currentColor">
											<path fill-rule="evenodd" d="M8.22 5.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L11.94 10 8.22 6.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
										</svg>
										Use manual input if URL fetch doesn't work
									</summary>
									<div class="mt-4 space-y-4 sm:max-w-xl">
										<div>
											<label for="manual-image" class="block text-sm font-medium text-gray-700 mb-1">Image URL</label>
											<input
												type="url"
												id="manual-image"
												placeholder="https://example.com/image.jpg"
												class="block w-full rounded-md bg-white px-3 py-1.5 text-sm text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600"
											/>
										</div>
										<div>
											<label for="manual-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
											<textarea
												id="manual-description"
												rows={3}
												placeholder="Enter product description..."
												class="block w-full rounded-md bg-white px-3 py-1.5 text-sm text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600"
											></textarea>
										</div>
										<button
											type="button"
											id="manual-apply-btn"
											class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50"
										>
											Preview Manual Data
										</button>
									</div>
								</details>
							</div>
						</div>

						<!-- Fetch Preview -->
						<div id="fetch-preview" class="hidden sm:py-6">
							<div class="rounded-lg bg-gray-50 p-6 sm:ml-auto sm:max-w-2xl">
								<h3 class="text-sm font-semibold text-gray-900 mb-4">Fetched Result</h3>

								<div class="flex gap-4 mb-4">
									<div class="shrink-0">
										<img id="preview-image" src="" alt="Preview" class="size-24 object-contain rounded-lg bg-white ring-1 ring-gray-200" />
									</div>
									<div class="flex-1 min-w-0 space-y-1.5 text-sm">
										<div>
											<span class="text-gray-500">Original Title:</span>
											<p id="preview-original-title" class="text-gray-900 truncate"></p>
										</div>
										<div>
											<span class="text-gray-500">Specs:</span>
											<p id="preview-specs" class="text-xs text-gray-700 font-mono truncate"></p>
										</div>
										<div>
											<span class="text-gray-500">Source:</span>
											<p id="preview-source" class="text-xs text-gray-700 font-mono truncate"></p>
										</div>
									</div>
								</div>

								<div class="rounded-md bg-indigo-50 p-3 mb-4">
									<p class="text-xs font-medium text-indigo-700 mb-1">Generated Title</p>
									<p id="preview-generated-title" class="text-sm font-medium text-gray-900"></p>
								</div>

								<div class="mb-4">
									<p class="text-xs font-medium text-gray-500 mb-1">Generated Description</p>
									<div id="preview-generated-description" class="p-3 bg-white rounded-md ring-1 ring-gray-200 text-sm prose prose-sm max-w-none max-h-48 overflow-y-auto"></div>
								</div>

								<div class="flex flex-wrap gap-2 pt-4 border-t border-gray-200">
									<button
										type="button"
										id="apply-all-btn"
										class="rounded-md bg-green-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500"
									>
										Apply All
									</button>
									<button
										type="button"
										id="apply-title-only-btn"
										class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50"
									>
										Title Only
									</button>
									<button
										type="button"
										id="apply-desc-only-btn"
										class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50"
									>
										Description Only
									</button>
									<button
										type="button"
										id="send-inbox-btn"
										class="rounded-md bg-purple-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-purple-500"
									>
										Send to Inbox
									</button>
									<button
										type="button"
										id="cancel-preview-btn"
										class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50"
									>
										Cancel
									</button>
								</div>
							</div>
						</div>

						<div id="apply-success" class="hidden sm:py-6">
							<div class="rounded-md bg-green-50 p-4 sm:ml-auto sm:max-w-2xl">
								<div class="flex">
									<div class="shrink-0">
										<svg class="size-5 text-green-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
											<path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 1 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.137-.089l4-5.5Z" clip-rule="evenodd" />
										</svg>
									</div>
									<div class="ml-3">
										<p class="text-sm text-green-700">
											Sent to Inbox. <a href="/admin/inbox" class="font-medium text-green-700 underline hover:text-green-600">Review and approve</a> the changes.
										</p>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Images Section -->
				<div class="mt-12">
					<h2 class="text-base font-semibold text-gray-900">Product Images</h2>
					<p class="mt-1 text-sm text-gray-600">
						Upload images to showcase your product in the store.
					</p>

					<div class="mt-10 space-y-8 border-b border-gray-900/10 pb-12 sm:space-y-0 sm:divide-y sm:divide-gray-900/10 sm:border-t sm:pb-0">
						<!-- External Image (from metadata) -->
						{externalImageUrl && (
							<div class="sm:grid sm:grid-cols-3 sm:items-center sm:gap-4 sm:py-6">
								<div class="text-sm font-medium text-gray-900">
									External Image
								</div>
								<div class="mt-2 sm:col-span-2 sm:mt-0">
									<div class="flex items-center gap-x-4">
										<img
											src={externalImageUrl}
											alt={product.title}
											class="size-16 rounded-lg object-cover bg-gray-100"
										/>
										<div class="flex-1 min-w-0">
											<p class="text-xs text-gray-500 mb-1">Image URL (from web search)</p>
											<p class="text-xs text-gray-900 break-all font-mono truncate">{externalImageUrl}</p>
										</div>
									</div>
								</div>
							</div>
						)}

						<!-- R2 Images Upload -->
						<div class="sm:grid sm:grid-cols-3 sm:items-start sm:gap-4 sm:py-6">
							<div class="text-sm font-medium text-gray-900 sm:pt-1.5">
								R2 Storage Images
							</div>
							<div class="mt-2 sm:col-span-2 sm:mt-0">
								<div id="upload-progress" class="hidden mb-4">
									<div class="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded-lg text-sm flex items-center gap-2">
										<svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
											<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
											<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
										</svg>
										<span>Uploading...</span>
									</div>
								</div>

								<div id="image-error" class="hidden mb-4">
									<div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm"></div>
								</div>

								{/* Image upload dropzone */}
								<div class="flex max-w-2xl justify-center rounded-lg border border-dashed border-gray-900/25 px-6 py-10 hover:border-gray-400 transition-colors">
									<div class="text-center">
										<svg class="mx-auto size-12 text-gray-300" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
											<path fill-rule="evenodd" d="M1.5 6a2.25 2.25 0 0 1 2.25-2.25h16.5A2.25 2.25 0 0 1 22.5 6v12a2.25 2.25 0 0 1-2.25 2.25H3.75A2.25 2.25 0 0 1 1.5 18V6ZM3 16.06V18c0 .414.336.75.75.75h16.5A.75.75 0 0 0 21 18v-1.94l-2.69-2.689a1.5 1.5 0 0 0-2.12 0l-.88.879.97.97a.75.75 0 1 1-1.06 1.06l-5.16-5.159a1.5 1.5 0 0 0-2.12 0L3 16.061Zm10.125-7.81a1.125 1.125 0 1 1 2.25 0 1.125 1.125 0 0 1-2.25 0Z" clip-rule="evenodd" />
										</svg>
										<div class="mt-4 flex text-sm text-gray-600">
											<label
												for="image-upload"
												class="relative cursor-pointer rounded-md bg-white font-semibold text-indigo-600 focus-within:outline-none focus-within:ring-2 focus-within:ring-indigo-600 focus-within:ring-offset-2 hover:text-indigo-500"
											>
												<span>Upload files</span>
												<input
													id="image-upload"
													type="file"
													accept="image/jpeg,image/png,image/gif,image/webp"
													multiple
													class="sr-only"
												/>
											</label>
											<p class="pl-1">or drag and drop</p>
										</div>
										<p class="text-xs text-gray-600 mt-2">PNG, JPG, GIF, WEBP up to 10MB</p>
									</div>
								</div>

								{/* Image grid */}
								{images.length > 0 && (
									<div class="mt-6">
										<div id="images-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
											{images.map((image, index) => (
												<div
													class="relative group aspect-square bg-gray-100 rounded-lg overflow-hidden ring-1 ring-gray-200"
													data-image-id={image.id}
												>
													<img
														src={`${apiBase}/r2?key=${encodeURIComponent(image.r2_key)}&x-admin-key=${encodeURIComponent(apiKey || '')}`}
														alt={image.filename}
														class="w-full h-full object-cover"
														loading="lazy"
													/>
													{index === 0 && (
														<span class="absolute top-2 left-2 bg-indigo-600 text-white text-xs px-2 py-0.5 rounded-full font-medium">
															Main
														</span>
													)}
													<button
														type="button"
														class="delete-image-btn absolute top-2 right-2 bg-white/90 text-gray-700 p-1.5 rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-500 hover:text-white shadow-sm"
														data-image-id={image.id}
														data-image-filename={image.filename}
													>
														<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
															<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
														</svg>
													</button>
													<div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 opacity-0 group-hover:opacity-100 transition-opacity">
														<p class="text-white text-xs truncate">{image.filename}</p>
													</div>
												</div>
											))}
										</div>
									</div>
								)}
							</div>
						</div>
					</div>
				</div>

				<!-- Variants Section -->
				<div class="mt-12">
					<div class="flex items-center justify-between">
						<div>
							<h2 class="text-base font-semibold text-gray-900">Variants & Pricing</h2>
							<p class="mt-1 text-sm text-gray-600">
								Manage product variants and their prices.
							</p>
						</div>
						<button
							type="button"
							id="add-variant-btn"
							class="inline-flex items-center gap-x-1.5 rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600"
						>
							<svg class="-ml-0.5 size-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
								<path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" />
							</svg>
							Add Variant
						</button>
					</div>

					<div class="mt-8">
						{variants.length === 0 ? (
							<div class="rounded-lg border border-dashed border-gray-300 p-12 text-center">
								<svg class="mx-auto size-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
								</svg>
								<h3 class="mt-2 text-sm font-semibold text-gray-900">No variants</h3>
								<p class="mt-1 text-sm text-gray-500">Get started by adding a variant with pricing.</p>
							</div>
						) : (
							<div class="overflow-hidden rounded-lg border border-gray-200 bg-white">
								<table class="min-w-full divide-y divide-gray-200">
									<thead class="bg-gray-50">
										<tr>
											<th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-6">Variant</th>
											<th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">SKU</th>
											<th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Price</th>
											<th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Stripe Price ID</th>
											<th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-6">
												<span class="sr-only">Actions</span>
											</th>
										</tr>
									</thead>
									<tbody class="divide-y divide-gray-200 bg-white">
										{variants.map((variant) => {
											const price = variant.prices?.[0];
											return (
												<tr data-variant-id={variant.id}>
													<td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6">
														{variant.title}
													</td>
													<td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 font-mono">
														{variant.sku || '-'}
													</td>
													<td class="whitespace-nowrap px-3 py-4 text-sm text-gray-900 tabular-nums font-medium">
														{price ? formatPrice(price.amount, price.currency) : <span class="text-gray-400">Not set</span>}
													</td>
													<td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 font-mono text-xs">
														{price?.provider_price_id || <span class="text-gray-400">-</span>}
													</td>
													<td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6">
														<button
															type="button"
															class="edit-variant-btn text-indigo-600 hover:text-indigo-900 mr-4"
															data-variant={JSON.stringify(variant)}
														>
															Edit
														</button>
														<button
															type="button"
															class="delete-variant-btn text-red-600 hover:text-red-900"
															data-variant-id={variant.id}
															data-variant-title={variant.title}
														>
															Delete
														</button>
													</td>
												</tr>
											);
										})}
									</tbody>
								</table>
							</div>
						)}
					</div>
				</div>

				<!-- Variant Modal -->
				<div id="variant-modal" class="hidden fixed inset-0 bg-gray-500/75 z-50 flex items-center justify-center p-4 transition-opacity">
					<div class="bg-white rounded-lg shadow-xl w-full max-w-md transform transition-all">
						<div class="px-6 py-4 border-b border-gray-200">
							<h3 id="modal-title" class="text-lg font-semibold text-gray-900">Add Variant</h3>
							<p class="mt-1 text-sm text-gray-500">Add pricing and SKU information for this variant.</p>
						</div>
						<form id="variant-form" class="px-6 py-4 space-y-5">
							<input type="hidden" id="variant-id" name="variantId" value="" />

							<div>
								<label for="variant-title" class="block text-sm font-medium text-gray-900 mb-1.5">
									Variant Title <span class="text-red-500">*</span>
								</label>
								<input
									type="text"
									id="variant-title"
									name="title"
									required
									class="block w-full rounded-md bg-white px-3 py-2 text-sm text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600"
									placeholder="e.g., Default, Size M, Color Red"
								/>
							</div>

							<div>
								<label for="variant-sku" class="block text-sm font-medium text-gray-900 mb-1.5">
									SKU
								</label>
								<input
									type="text"
									id="variant-sku"
									name="sku"
									class="block w-full rounded-md bg-white px-3 py-2 text-sm text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 font-mono"
									placeholder="Optional SKU code"
								/>
							</div>

							<div>
								<label for="price-amount" class="block text-sm font-medium text-gray-900 mb-1.5">
									Price (JPY) <span class="text-red-500">*</span>
								</label>
								<div class="flex items-center rounded-md bg-white outline outline-1 -outline-offset-1 outline-gray-300 focus-within:outline-2 focus-within:-outline-offset-2 focus-within:outline-indigo-600">
									<span class="shrink-0 text-sm text-gray-500 px-3">¥</span>
									<input
										type="number"
										id="price-amount"
										name="amount"
										required
										min="0"
										step="1"
										class="block min-w-0 grow bg-transparent py-2 pr-3 text-sm text-gray-900 placeholder:text-gray-400 focus:outline-none tabular-nums"
										placeholder="1000"
									/>
								</div>
							</div>

							<div>
								<label for="stripe-price-id" class="block text-sm font-medium text-gray-900 mb-1.5">
									Stripe Price ID
								</label>
								<input
									type="text"
									id="stripe-price-id"
									name="provider_price_id"
									class="block w-full rounded-md bg-white px-3 py-2 text-sm text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 font-mono"
									placeholder="price_xxxxxxxx"
								/>
								<p class="text-xs text-gray-500 mt-1.5">Required for checkout. Get this from your Stripe Dashboard.</p>
							</div>

							<div id="modal-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md text-sm"></div>
						</form>
						<div class="px-6 py-4 border-t border-gray-200 bg-gray-50 rounded-b-lg flex justify-end gap-3">
							<button
								type="button"
								id="cancel-modal-btn"
								class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50"
							>
								Cancel
							</button>
							<button
								type="submit"
								form="variant-form"
								class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600"
							>
								Save Variant
							</button>
						</div>
					</div>
				</div>
			)}
	</div>
</AdminLayout>

<script define:vars={{ apiBase, apiKey, productId: id }}>
	function initProductPage() {
		// Image handling
		const imageUpload = document.getElementById('image-upload');
		const uploadProgress = document.getElementById('upload-progress');
		const imageError = document.getElementById('image-error');

		// If elements don't exist yet (React still loading), retry
		if (!imageUpload && !document.getElementById('variant-modal')) {
			setTimeout(initProductPage, 100);
			return;
		}

		function showImageError(message) {
			if (!imageError) return;
			const errorDiv = imageError.querySelector('div');
			if (errorDiv) {
				errorDiv.textContent = message;
				imageError.classList.remove('hidden');
				setTimeout(() => imageError.classList.add('hidden'), 5000);
			}
		}

		imageUpload?.addEventListener('change', async (e) => {
			const files = e.target.files;
			if (!files || files.length === 0) return;

			uploadProgress?.classList.remove('hidden');
			imageError?.classList.add('hidden');

			const formData = new FormData();
			for (const file of files) {
				formData.append('file', file);
			}

			try {
				const res = await fetch(`${apiBase}/admin/products/${productId}/images`, {
					method: 'POST',
					headers: { 'x-admin-key': apiKey },
					body: formData
				});

				if (!res.ok) {
					const data = await res.json();
					showImageError(data.message || 'Failed to upload images');
				} else {
					location.reload();
				}
			} catch (err) {
				showImageError('Failed to upload images. Please try again.');
			} finally {
				uploadProgress?.classList.add('hidden');
				if (imageUpload) imageUpload.value = '';
			}
		});

		// Use event delegation for delete image buttons
		document.addEventListener('click', async (e) => {
			const btn = e.target.closest('.delete-image-btn');
			if (!btn) return;

			const imageId = btn.dataset.imageId;
			const filename = btn.dataset.imageFilename;
			if (!confirm(`Delete image "${filename}"?`)) return;

			try {
				const res = await fetch(`${apiBase}/admin/products/${productId}/images/${imageId}`, {
					method: 'DELETE',
					headers: { 'x-admin-key': apiKey }
				});
				if (res.ok) {
					location.reload();
				} else {
					const data = await res.json();
					showImageError(data.message || 'Failed to delete image');
				}
			} catch (err) {
				showImageError('Failed to delete image. Please try again.');
			}
		});

		// Variant handling
		const modal = document.getElementById('variant-modal');
		const modalTitle = document.getElementById('modal-title');
		const variantForm = document.getElementById('variant-form');
		const variantIdInput = document.getElementById('variant-id');
		const variantTitleInput = document.getElementById('variant-title');
		const variantSkuInput = document.getElementById('variant-sku');
		const priceAmountInput = document.getElementById('price-amount');
		const stripePriceIdInput = document.getElementById('stripe-price-id');
		const modalError = document.getElementById('modal-error');
		const addVariantBtn = document.getElementById('add-variant-btn');
		const cancelModalBtn = document.getElementById('cancel-modal-btn');

		function showModal(isEdit = false, variant = null) {
			if (!modal || !modalTitle || !variantIdInput || !variantTitleInput || !variantSkuInput || !priceAmountInput || !stripePriceIdInput || !modalError) return;
			modalTitle.textContent = isEdit ? 'Edit Variant' : 'Add Variant';
			variantIdInput.value = variant?.id || '';
			variantTitleInput.value = variant?.title || '';
			variantSkuInput.value = variant?.sku || '';
			const price = variant?.prices?.[0];
			priceAmountInput.value = price?.amount || '';
			stripePriceIdInput.value = price?.provider_price_id || '';
			modalError.classList.add('hidden');
			modal.classList.remove('hidden');
		}

		function hideModal() {
			if (!modal || !variantForm) return;
			modal.classList.add('hidden');
			variantForm.reset();
		}

		function showError(message) {
			if (!modalError) return;
			modalError.textContent = message;
			modalError.classList.remove('hidden');
		}

		addVariantBtn?.addEventListener('click', () => showModal(false));
		cancelModalBtn?.addEventListener('click', hideModal);
		modal?.addEventListener('click', (e) => {
			if (e.target === modal) hideModal();
		});

		// Use event delegation for edit/delete variant buttons
		document.addEventListener('click', async (e) => {
			const editBtn = e.target.closest('.edit-variant-btn');
			if (editBtn) {
				const variant = JSON.parse(editBtn.dataset.variant);
				showModal(true, variant);
				return;
			}

			const deleteBtn = e.target.closest('.delete-variant-btn');
			if (deleteBtn) {
				const variantId = deleteBtn.dataset.variantId;
				const variantTitle = deleteBtn.dataset.variantTitle;
				if (!confirm(`Delete variant "${variantTitle}"? This will also delete its prices.`)) return;

				try {
					const res = await fetch(`${apiBase}/admin/products/${productId}/variants/${variantId}`, {
						method: 'DELETE',
						headers: { 'x-admin-key': apiKey }
					});
					if (res.ok) {
						location.reload();
					} else {
						const data = await res.json();
						alert(data.message || 'Failed to delete variant');
					}
				} catch (err) {
					alert('Failed to delete variant. Please try again.');
				}
			}
		});

		variantForm?.addEventListener('submit', async (e) => {
			e.preventDefault();
			if (!variantIdInput || !variantTitleInput || !variantSkuInput || !priceAmountInput || !stripePriceIdInput) return;

			const variantId = variantIdInput.value;
			const isEdit = !!variantId;

			const title = variantTitleInput.value.trim();
			const sku = variantSkuInput.value.trim() || null;
			const amount = parseInt(priceAmountInput.value, 10);
			const provider_price_id = stripePriceIdInput.value.trim() || null;

			if (!title) {
				showError('Title is required');
				return;
			}
			if (isNaN(amount) || amount < 0) {
				showError('Price must be a valid positive number');
				return;
			}

			try {
				// Create or update variant
				const variantUrl = isEdit
					? `${apiBase}/admin/products/${productId}/variants/${variantId}`
					: `${apiBase}/admin/products/${productId}/variants`;

				const variantRes = await fetch(variantUrl, {
					method: isEdit ? 'PUT' : 'POST',
					headers: {
						'Content-Type': 'application/json',
						'x-admin-key': apiKey
					},
					body: JSON.stringify({ title, sku })
				});

				if (!variantRes.ok) {
					const data = await variantRes.json();
					showError(data.message || 'Failed to save variant');
					return;
				}

				const variantData = await variantRes.json();
				const savedVariantId = variantData.variant?.id || variantId;

				// Update prices
				const priceRes = await fetch(`${apiBase}/admin/variants/${savedVariantId}/prices`, {
					method: 'PUT',
					headers: {
						'Content-Type': 'application/json',
						'x-admin-key': apiKey
					},
					body: JSON.stringify({
						prices: [{ currency: 'JPY', amount, provider_price_id }]
					})
				});

				if (!priceRes.ok) {
					const data = await priceRes.json();
					showError(data.message || 'Failed to save price');
					return;
				}

				location.reload();
			} catch (err) {
				showError('An error occurred. Please try again.');
			}
		});

		// Web fetch functionality
		const fetchUrlInput = document.getElementById('fetch-url');
		const fetchBtn = document.getElementById('fetch-btn');
		const fetchSpinner = document.getElementById('fetch-spinner');
		const fetchLabel = document.getElementById('fetch-label');
		const fetchError = document.getElementById('fetch-error');
		const fetchPreview = document.getElementById('fetch-preview');
		const previewImage = document.getElementById('preview-image');
		const previewOriginalTitle = document.getElementById('preview-original-title');
		const previewSpecs = document.getElementById('preview-specs');
		const previewSource = document.getElementById('preview-source');
		const previewGeneratedTitle = document.getElementById('preview-generated-title');
		const previewGeneratedDescription = document.getElementById('preview-generated-description');
		const applyAllBtn = document.getElementById('apply-all-btn');
		const applyTitleOnlyBtn = document.getElementById('apply-title-only-btn');
		const applyDescOnlyBtn = document.getElementById('apply-desc-only-btn');
		const sendInboxBtn = document.getElementById('send-inbox-btn');
		const cancelPreviewBtn = document.getElementById('cancel-preview-btn');
		const applySuccess = document.getElementById('apply-success');

		const fetchWarning = document.getElementById('fetch-warning');

		let fetchedData = null;

		function showFetchError(message) {
			if (!fetchError) return;
			const errorP = fetchError.querySelector('p');
			if (errorP) {
				errorP.textContent = message;
				fetchError.classList.remove('hidden');
			}
		}

		function hideFetchError() {
			if (fetchError) fetchError.classList.add('hidden');
		}

		function showFetchWarning(message) {
			if (!fetchWarning) return;
			const warningP = fetchWarning.querySelector('p');
			if (warningP) {
				warningP.textContent = message;
				fetchWarning.classList.remove('hidden');
			}
		}

		function hideFetchWarning() {
			if (fetchWarning) fetchWarning.classList.add('hidden');
		}

		function showPreview(data) {
			if (!fetchPreview) return;
			fetchedData = data;

			// Show image
			if (previewImage && data.image_url) {
				previewImage.src = data.image_url;
				previewImage.parentElement?.classList.remove('hidden');
			} else if (previewImage) {
				previewImage.parentElement?.classList.add('hidden');
			}

			// Show original title
			if (previewOriginalTitle) {
				previewOriginalTitle.textContent = data.original_title || '-';
			}

			// Show specs
			if (previewSpecs && data.specs) {
				const specsText = Object.entries(data.specs)
					.map(([key, value]) => `${key}: ${value}`)
					.join(' | ');
				previewSpecs.textContent = specsText || '-';
			} else if (previewSpecs) {
				previewSpecs.textContent = '-';
			}

			// Show source
			if (previewSource) {
				previewSource.textContent = data.source || '-';
			}

			// Show generated title
			if (previewGeneratedTitle) {
				previewGeneratedTitle.textContent = data.generated_title || '-';
			}

			// Show generated description (as HTML)
			if (previewGeneratedDescription) {
				previewGeneratedDescription.innerHTML = data.generated_description || '-';
			}

			fetchPreview.classList.remove('hidden');
		}

		function hidePreview() {
			if (fetchPreview) fetchPreview.classList.add('hidden');
			fetchedData = null;
		}

		fetchBtn?.addEventListener('click', async () => {
			const url = fetchUrlInput?.value?.trim();
			if (!url) {
				showFetchError('URLを入力してください');
				return;
			}

			hideFetchError();
			hideFetchWarning();
			hidePreview();
			if (applySuccess) applySuccess.classList.add('hidden');

			// Show loading state
			if (fetchSpinner) fetchSpinner.classList.remove('hidden');
			if (fetchLabel) fetchLabel.textContent = '取得中...';
			if (fetchBtn) fetchBtn.disabled = true;

			try {
				const productName = document.querySelector('input[name="title"]')?.value?.trim() || '';
				const res = await fetch('/api/admin/products/fetch-url', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ url, product_name: productName })
				});

				const data = await res.json();

				if (!data.success) {
					showFetchError(data.error || '取得に失敗しました');
				} else {
					// Show warning if URL fetch failed but content was generated
					if (data.warning) {
						showFetchWarning(data.warning);
					}
					showPreview(data);
				}
			} catch (err) {
				showFetchError('通信エラーが発生しました');
			} finally {
				if (fetchSpinner) fetchSpinner.classList.add('hidden');
				if (fetchLabel) fetchLabel.textContent = '取得';
				if (fetchBtn) fetchBtn.disabled = false;
			}
		});

		cancelPreviewBtn?.addEventListener('click', hidePreview);

		// Manual input handler
		const manualImageInput = document.getElementById('manual-image');
		const manualDescInput = document.getElementById('manual-description');
		const manualApplyBtn = document.getElementById('manual-apply-btn');

		manualApplyBtn?.addEventListener('click', async () => {
			const imageUrl = manualImageInput?.value?.trim();
			const description = manualDescInput?.value?.trim();

			if (!imageUrl && !description) {
				showFetchError('画像URLまたは説明文を入力してください');
				return;
			}

			hideFetchError();
			if (applySuccess) applySuccess.classList.add('hidden');

			const productTitle = document.querySelector('input[name="title"]')?.value?.trim() || 'Product';

			try {
				const res = await fetch('/api/admin/products/fetch-url', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						image_url: imageUrl,
						description,
						product_name: productTitle
					})
				});

				const data = await res.json();
				if (data.success) {
					showPreview(data);
				}
			} catch (err) {
				showFetchError('エラーが発生しました');
			}
		});

		// Apply all (title + description) directly to form
		applyAllBtn?.addEventListener('click', () => {
			if (!fetchedData) return;

			const titleInput = document.getElementById('title');
			const descTextarea = document.getElementById('description');

			if (titleInput && fetchedData.generated_title) {
				titleInput.value = fetchedData.generated_title;
			}
			if (descTextarea && fetchedData.generated_description) {
				descTextarea.value = fetchedData.generated_description;
			}

			hidePreview();
			titleInput?.scrollIntoView({ behavior: 'smooth', block: 'center' });
			titleInput?.focus();
		});

		// Apply title only
		applyTitleOnlyBtn?.addEventListener('click', () => {
			if (!fetchedData) return;

			const titleInput = document.getElementById('title');
			if (titleInput && fetchedData.generated_title) {
				titleInput.value = fetchedData.generated_title;
			}

			titleInput?.scrollIntoView({ behavior: 'smooth', block: 'center' });
			titleInput?.focus();
		});

		// Apply description only
		applyDescOnlyBtn?.addEventListener('click', () => {
			if (!fetchedData) return;

			const descTextarea = document.getElementById('description');
			if (descTextarea && fetchedData.generated_description) {
				descTextarea.value = fetchedData.generated_description;
			}

			descTextarea?.scrollIntoView({ behavior: 'smooth', block: 'center' });
			descTextarea?.focus();
		});

		// Send to inbox for approval
		sendInboxBtn?.addEventListener('click', async () => {
			if (!fetchedData) return;

			sendInboxBtn.disabled = true;
			sendInboxBtn.textContent = '送信中...';

			try {
				// Create inbox item via API
				const res = await fetch(`${apiBase}/inbox`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'x-admin-key': apiKey
					},
					body: JSON.stringify({
						title: `Product Update: ${document.querySelector('input[name="title"]')?.value || 'Unknown'}`,
						body: `Web取得による商品情報更新の提案\n\n画像: ${fetchedData.image_url || 'なし'}\n元タイトル: ${fetchedData.original_title || 'なし'}\n生成タイトル: ${fetchedData.generated_title || 'なし'}\nソース: ${fetchedData.source || 'なし'}`,
						severity: 'info',
						kind: 'product_update',
						metadata: JSON.stringify({
							product_id: parseInt(productId),
							image_url: fetchedData.image_url,
							title: fetchedData.generated_title,
							description: fetchedData.generated_description,
							original_title: fetchedData.original_title,
							specs: fetchedData.specs,
							source: fetchedData.source
						})
					})
				});

				if (!res.ok) {
					const data = await res.json();
					showFetchError(data.message || 'Inbox送信に失敗しました');
				} else {
					hidePreview();
					if (applySuccess) applySuccess.classList.remove('hidden');
				}
			} catch (err) {
				showFetchError('通信エラーが発生しました');
			} finally {
				sendInboxBtn.disabled = false;
				sendInboxBtn.textContent = 'Inboxに送信';
			}
		});

	}

	// Start initialization
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initProductPage);
	} else {
		initProductPage();
	}
</script>
