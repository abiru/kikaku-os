---
export const prerender = false;

import Button from '../../../components/Button.astro';
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getApiBase } from '../../../lib/api';

const { id } = Astro.params;
const apiBase = getApiBase();
const apiKey = import.meta.env.ADMIN_API_KEY;

type Price = {
	id: number;
	variant_id: number;
	currency: string;
	amount: number;
	provider_price_id: string | null;
};

type Variant = {
	id: number;
	product_id: number;
	title: string;
	sku: string | null;
	options: string | null;
	metadata: string | null;
	created_at: string;
	updated_at: string;
	prices: Price[];
};

type Product = {
	id: number;
	title: string;
	description: string | null;
	category: string | null;
	metadata: string | null;
	status: string | null;
	tax_rate_id: number | null;
	created_at: string;
	updated_at: string;
};

type TaxRate = {
	id: number;
	name: string;
	rate: number;
	is_active: number;
};

type ProductImage = {
	id: number;
	product_id: number;
	r2_key: string;
	filename: string;
	content_type: string;
	size_bytes: number;
	position: number;
	created_at: string;
	updated_at: string;
};

type Category = {
	category: string;
	product_count: number;
};

let product: Product | null = null;
let variants: Variant[] = [];
let images: ProductImage[] = [];
let categories: Category[] = [];
let taxRates: TaxRate[] = [];
let error: string | null = null;
let successMessage: string | null = null;

// Handle POST - Update product
if (Astro.request.method === 'POST' && apiKey) {
	try {
		const formData = await Astro.request.formData();
		const title = formData.get('title')?.toString().trim() || '';
		const description = formData.get('description')?.toString().trim() || '';
		const status = formData.get('status')?.toString() || 'active';
		const category = formData.get('category')?.toString().trim() || null;
		const tax_rate_id_str = formData.get('tax_rate_id')?.toString() || null;
		const tax_rate_id = tax_rate_id_str ? parseInt(tax_rate_id_str, 10) : null;

		if (!title) {
			error = 'Title is required';
		} else {
			const res = await fetch(`${apiBase}/admin/products/${id}`, {
				method: 'PUT',
				headers: {
					'Content-Type': 'application/json',
					'x-admin-key': apiKey
				},
				body: JSON.stringify({ title, description, status, category, tax_rate_id })
			});

			const data = await res.json();

			if (!res.ok) {
				error = data.message || 'Failed to update product';
			} else {
				product = data.product;
				successMessage = 'Product updated successfully';
			}
		}
	} catch (e) {
		console.error(e);
		error = 'Failed to update product. Please check your connection.';
	}
}

// Fetch product data (if not already set from POST)
if (!product && apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/products/${id}`, {
			headers: { 'x-admin-key': apiKey }
		});

		if (!res.ok) {
			if (res.status === 404) {
				error = 'Product not found';
			} else {
				const data = await res.json();
				error = data.message || `API Error: ${res.status}`;
			}
		} else {
			const data = await res.json();
			product = data.product;
		}
	} catch (e) {
		console.error(e);
		error = error || 'Failed to load product. Please check your connection.';
	}
} else if (!apiKey) {
	error = 'ADMIN_API_KEY is missing in server environment';
}

// Fetch variants if product is loaded
if (product && apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/products/${id}/variants`, {
			headers: { 'x-admin-key': apiKey }
		});
		if (res.ok) {
			const data = await res.json();
			variants = data.variants || [];
		}
	} catch (e) {
		console.error('Failed to fetch variants:', e);
	}
}

// Fetch images if product is loaded
if (product && apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/products/${id}/images`, {
			headers: { 'x-admin-key': apiKey }
		});
		if (res.ok) {
			const data = await res.json();
			images = data.images || [];
		}
	} catch (e) {
		console.error('Failed to fetch images:', e);
	}
}

// Fetch categories for dropdown
if (apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/categories`, {
			headers: { 'x-admin-key': apiKey }
		});
		if (res.ok) {
			const data = await res.json();
			categories = data.categories || [];
		}
	} catch (e) {
		console.error('Failed to fetch categories:', e);
	}
}

// Fetch tax rates for dropdown
if (apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/tax-rates`, {
			headers: { 'x-admin-key': apiKey }
		});
		if (res.ok) {
			const data = await res.json();
			taxRates = data.filter((tr: TaxRate) => tr.is_active) || [];
		}
	} catch (e) {
		console.error('Failed to fetch tax rates:', e);
	}
}

const formatDate = (dateStr: string | null) => {
	if (!dateStr) return '-';
	return new Date(dateStr).toLocaleString('ja-JP', {
		year: 'numeric',
		month: '2-digit',
		day: '2-digit',
		hour: '2-digit',
		minute: '2-digit'
	});
};

const formatPrice = (amount: number, currency: string = 'JPY') => {
	return new Intl.NumberFormat('ja-JP', {
		style: 'currency',
		currency: currency,
		minimumFractionDigits: 0,
	}).format(amount);
};

const getExternalImageUrl = (metadata: string | null): string | null => {
	if (!metadata) return null;
	try {
		const parsed = JSON.parse(metadata);
		return parsed.image_url || null;
	} catch {
		return null;
	}
};

const externalImageUrl = product ? getExternalImageUrl(product.metadata) : null;
---

<AdminLayout title={product ? `${product.title} - Admin` : 'Product - Admin'}>
	<div class="space-y-6 max-w-2xl">
		<div class="flex items-center gap-4">
			<a href="/admin/products" class="text-indigo-600 hover:underline text-sm flex items-center gap-1">
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
				</svg>
				Products
			</a>
			<h1 class="text-2xl font-semibold text-gray-900">
				{product ? `Edit: ${product.title}` : 'Product'}
			</h1>
		</div>
			{successMessage && (
				<div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-6 text-sm">
					{successMessage}
				</div>
			)}

			{error && !product && (
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-8 text-center">
					<div class="text-red-600 mb-4">{error}</div>
					<Button href="/admin/products" variant="secondary" size="sm">
						Back to Products
					</Button>
				</div>
			)}

			{error && product && (
				<div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg mb-6 text-sm">
					{error}
				</div>
			)}

			{product && (
				<form method="POST" class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6">
					<div>
						<label for="title" class="block text-sm font-medium text-[#1d1d1f] mb-2">
							Title <span class="text-red-500">*</span>
						</label>
						<input
							type="text"
							id="title"
							name="title"
							required
							value={product.title}
							class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm text-[#1d1d1f] focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20 focus:border-[#0071e3] transition-all"
						/>
					</div>

					<div>
						<label for="description" class="block text-sm font-medium text-[#1d1d1f] mb-2">
							Description
						</label>
						<textarea
							id="description"
							name="description"
							rows="4"
							class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm text-[#1d1d1f] focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20 focus:border-[#0071e3] transition-all resize-none"
						>{product.description || ''}</textarea>
					</div>

					<div>
						<label for="status" class="block text-sm font-medium text-[#1d1d1f] mb-2">
							Status
						</label>
						<select
							id="status"
							name="status"
							class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm text-[#1d1d1f] focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20 focus:border-[#0071e3] transition-all bg-white"
						>
							<option value="active" selected={product.status === 'active'}>Active</option>
							<option value="draft" selected={product.status === 'draft'}>Draft</option>
							<option value="archived" selected={product.status === 'archived'}>Archived</option>
						</select>
					</div>

					<div>
						<label for="category" class="block text-sm font-medium text-[#1d1d1f] mb-2">
							Category
						</label>
						<input
							type="text"
							id="category"
							name="category"
							list="category-list"
							value={product.category || ''}
							placeholder="Select or enter a category"
							class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm text-[#1d1d1f] focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20 focus:border-[#0071e3] transition-all"
						/>
						<datalist id="category-list">
							{categories.map((cat) => (
								<option value={cat.category} />
							))}
						</datalist>
						<p class="text-xs text-[#86868b] mt-1">Type to create a new category or select from existing ones.</p>
					</div>

					<div>
						<label for="tax_rate_id" class="block text-sm font-medium text-[#1d1d1f] mb-2">
							Tax Rate
						</label>
						<select
							id="tax_rate_id"
							name="tax_rate_id"
							class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm text-[#1d1d1f] focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20 focus:border-[#0071e3] transition-all bg-white"
						>
							<option value="">Select tax rate...</option>
							{taxRates.map((rate) => (
								<option value={rate.id} selected={product.tax_rate_id === rate.id}>
									{rate.name} ({(rate.rate * 100).toFixed(1)}%)
								</option>
							))}
						</select>
						<p class="text-xs text-[#86868b] mt-1">All prices are tax-inclusive (税込)</p>
					</div>

					<div class="pt-4 border-t border-gray-100">
						<dl class="grid grid-cols-2 gap-4 text-sm">
							<div>
								<dt class="text-[#86868b]">Created</dt>
								<dd class="text-[#1d1d1f] tabular-nums">{formatDate(product.created_at)}</dd>
							</div>
							<div>
								<dt class="text-[#86868b]">Updated</dt>
								<dd class="text-[#1d1d1f] tabular-nums">{formatDate(product.updated_at)}</dd>
							</div>
						</dl>
					</div>

				<div class="flex justify-between gap-3 pt-4 border-t border-gray-100">
					<div>
						{product.status !== 'archived' && (
							<button
								type="button"
								id="archive-product-btn"
								class="px-4 py-2 text-sm font-medium text-white bg-red-500 rounded-lg hover:bg-red-600 transition-colors"
							>
								Archive Product
							</button>
						)}
						{product.status === 'archived' && (
							<button
								type="button"
								id="restore-product-btn"
								class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 transition-colors"
							>
								Restore Product
							</button>
						)}
					</div>
					<div class="flex gap-3">
						<Button href="/admin/products" variant="secondary" size="sm">
							Back
						</Button>
						<Button type="submit" variant="primary" size="sm">
							Save Changes
						</Button>
					</div>
				</div>
				</form>

				<!-- Web Update Section -->
				<div class="mt-8">
					<div class="flex items-center justify-between mb-4">
						<h2 class="text-lg font-semibold text-[#1d1d1f]">Web更新</h2>
					</div>
					<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4 space-y-4">
						<div>
							<label for="fetch-url" class="block text-sm font-medium text-[#1d1d1f] mb-2">
								商品ページURL
							</label>
							<div class="flex gap-2">
								<input
									type="url"
									id="fetch-url"
									placeholder="https://www.spider-farmer.com/products/..."
									class="flex-1 px-4 py-2 border border-gray-200 rounded-lg text-sm text-[#1d1d1f] focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20 focus:border-[#0071e3] transition-all"
								/>
								<button
									type="button"
									id="fetch-btn"
									class="px-4 py-2 text-sm font-medium text-white bg-[#0071e3] rounded-lg hover:bg-[#0077ED] transition-colors flex items-center gap-2"
								>
									<svg id="fetch-spinner" class="hidden animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
										<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
										<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
									</svg>
									<span id="fetch-label">取得</span>
								</button>
							</div>
							<p class="text-xs text-[#86868b] mt-1">メーカーの公式サイトURLを入力して情報を取得します</p>
						</div>

						<div id="fetch-error" class="hidden">
							<div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm"></div>
						</div>

						<div id="fetch-warning" class="hidden">
							<div class="bg-amber-50 border border-amber-200 text-amber-700 px-4 py-3 rounded-lg text-sm"></div>
						</div>

						<!-- Manual input fallback -->
						<details class="text-sm">
							<summary class="text-[#86868b] cursor-pointer hover:text-[#1d1d1f]">
								URLで取得できない場合は手動入力
							</summary>
							<div class="mt-3 space-y-3 pl-4 border-l-2 border-gray-200">
								<div>
									<label for="manual-image" class="block text-xs text-[#86868b] mb-1">画像URL</label>
									<input
										type="url"
										id="manual-image"
										placeholder="https://example.com/image.jpg"
										class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"
									/>
								</div>
								<div>
									<label for="manual-description" class="block text-xs text-[#86868b] mb-1">説明文</label>
									<textarea
										id="manual-description"
										rows="3"
										placeholder="商品の説明..."
										class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm resize-none"
									></textarea>
								</div>
								<button
									type="button"
									id="manual-apply-btn"
									class="px-3 py-1.5 text-sm font-medium text-white bg-[#0071e3] rounded-lg hover:bg-[#0077ED] transition-colors"
								>
									手動データでプレビュー
								</button>
							</div>
						</details>

						<div id="fetch-preview" class="hidden border-t border-gray-100 pt-4 space-y-4">
							<h3 class="text-sm font-semibold text-[#1d1d1f]">取得結果</h3>

							<!-- Image -->
							<div class="flex gap-4">
								<div class="flex-shrink-0">
									<p class="text-xs text-[#86868b] mb-1">画像</p>
									<img id="preview-image" src="" alt="Preview" class="w-32 h-32 object-contain rounded-lg bg-gray-50" />
								</div>
								<div class="flex-1 space-y-2">
									<div>
										<p class="text-xs text-[#86868b]">取得元タイトル</p>
										<p id="preview-original-title" class="text-sm text-[#1d1d1f]"></p>
									</div>
									<div>
										<p class="text-xs text-[#86868b]">スペック</p>
										<p id="preview-specs" class="text-xs text-[#1d1d1f] font-mono"></p>
									</div>
									<div>
										<p class="text-xs text-[#86868b]">ソース</p>
										<p id="preview-source" class="text-sm text-[#1d1d1f] font-mono"></p>
									</div>
								</div>
							</div>

							<!-- Generated Title -->
							<div class="p-3 bg-blue-50 rounded-lg">
								<p class="text-xs text-blue-600 mb-1">生成されたタイトル</p>
								<p id="preview-generated-title" class="text-sm font-medium text-[#1d1d1f]"></p>
							</div>

							<!-- Generated Description -->
							<div>
								<p class="text-xs text-[#86868b] mb-1">生成された説明文</p>
								<div id="preview-generated-description" class="p-4 bg-gray-50 rounded-lg text-sm prose prose-sm max-w-none max-h-64 overflow-y-auto"></div>
							</div>

							<div class="flex flex-wrap gap-2 pt-2">
								<button
									type="button"
									id="apply-all-btn"
									class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 transition-colors"
								>
									すべて適用
								</button>
								<button
									type="button"
									id="apply-title-only-btn"
									class="px-4 py-2 text-sm font-medium text-green-700 bg-green-100 rounded-lg hover:bg-green-200 transition-colors"
								>
									タイトルのみ
								</button>
								<button
									type="button"
									id="apply-desc-only-btn"
									class="px-4 py-2 text-sm font-medium text-green-700 bg-green-100 rounded-lg hover:bg-green-200 transition-colors"
								>
									説明文のみ
								</button>
								<button
									type="button"
									id="send-inbox-btn"
									class="px-4 py-2 text-sm font-medium text-white bg-purple-600 rounded-lg hover:bg-purple-700 transition-colors"
								>
									Inboxに送信
								</button>
								<button
									type="button"
									id="cancel-preview-btn"
									class="px-4 py-2 text-sm font-medium text-[#1d1d1f] bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
								>
									キャンセル
								</button>
							</div>
						</div>

						<div id="apply-success" class="hidden">
							<div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg text-sm">
								Inboxに送信しました。<a href="/admin/inbox" class="underline">Inbox</a>で承認してください。
							</div>
						</div>
					</div>
				</div>

				<!-- External Image URL (from metadata) -->
				{externalImageUrl && (
					<div class="mt-8">
						<h2 class="text-lg font-semibold text-[#1d1d1f] mb-4">External Image</h2>
						<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
							<div class="flex gap-4">
								<img
									src={externalImageUrl}
									alt={product.title}
									class="w-32 h-32 object-contain rounded-lg bg-gray-50"
								/>
								<div class="flex-1 min-w-0">
									<p class="text-xs text-[#86868b] mb-1">Image URL (from web search)</p>
									<p class="text-sm text-[#1d1d1f] break-all font-mono">{externalImageUrl}</p>
								</div>
							</div>
						</div>
					</div>
				)}

				<!-- Images Section -->
				<div class="mt-8">
					<div class="flex items-center justify-between mb-4">
						<h2 class="text-lg font-semibold text-[#1d1d1f]">Images (R2 Storage)</h2>
						<label
							class="text-sm text-[#0071e3] hover:underline flex items-center gap-1 cursor-pointer"
						>
							<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
							</svg>
							Add Images
							<input
								type="file"
								id="image-upload"
								accept="image/jpeg,image/png,image/gif,image/webp"
								multiple
								class="hidden"
							/>
						</label>
					</div>

					<div id="upload-progress" class="hidden mb-4">
						<div class="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded-lg text-sm flex items-center gap-2">
							<svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
								<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
								<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
							</svg>
							<span>Uploading...</span>
						</div>
					</div>

					<div id="image-error" class="hidden mb-4">
						<div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm"></div>
					</div>

					{images.length === 0 ? (
						<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-8 text-center">
							<p class="text-[#86868b] text-sm">No images yet. Add product images to showcase your products.</p>
						</div>
					) : (
						<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
							<div id="images-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
								{images.map((image, index) => (
									<div
										class="relative group aspect-square bg-gray-100 rounded-lg overflow-hidden"
										data-image-id={image.id}
									>
										<img
											src={`${apiBase}/r2?key=${encodeURIComponent(image.r2_key)}&x-admin-key=${encodeURIComponent(apiKey || '')}`}
											alt={image.filename}
											class="w-full h-full object-cover"
											loading="lazy"
										/>
										{index === 0 && (
											<span class="absolute top-2 left-2 bg-[#0071e3] text-white text-xs px-2 py-0.5 rounded-full">
												Main
											</span>
										)}
										<button
											type="button"
											class="delete-image-btn absolute top-2 right-2 bg-red-500 text-white p-1.5 rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600"
											data-image-id={image.id}
											data-image-filename={image.filename}
										>
											<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
											</svg>
										</button>
										<div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 opacity-0 group-hover:opacity-100 transition-opacity">
											<p class="text-white text-xs truncate">{image.filename}</p>
										</div>
									</div>
								))}
							</div>
						</div>
					)}
				</div>

				<!-- Variants Section -->
				<div class="mt-8">
					<div class="flex items-center justify-between mb-4">
						<h2 class="text-lg font-semibold text-[#1d1d1f]">Variants</h2>
						<button
							type="button"
							id="add-variant-btn"
							class="text-sm text-[#0071e3] hover:underline flex items-center gap-1"
						>
							<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
							</svg>
							Add Variant
						</button>
					</div>

					{variants.length === 0 ? (
						<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-8 text-center">
							<p class="text-[#86868b] text-sm">No variants yet. Add one to set prices.</p>
						</div>
					) : (
						<div class="bg-white rounded-xl border border-gray-200 shadow-sm divide-y divide-gray-100">
							{variants.map((variant) => {
								const price = variant.prices?.[0];
								return (
									<div class="p-4 flex items-center justify-between" data-variant-id={variant.id}>
										<div class="flex-1">
											<div class="font-medium text-[#1d1d1f]">{variant.title}</div>
											<div class="text-sm text-[#86868b] mt-1 flex flex-wrap gap-x-4 gap-y-1">
												<span>SKU: {variant.sku || '-'}</span>
												<span class="tabular-nums">
													{price ? formatPrice(price.amount, price.currency) : 'No price set'}
												</span>
												<span class="font-mono text-xs">
													Stripe: {price?.provider_price_id || '-'}
												</span>
											</div>
										</div>
										<div class="flex items-center gap-2 ml-4">
											<button
												type="button"
												class="edit-variant-btn text-sm text-[#0071e3] hover:underline"
												data-variant={JSON.stringify(variant)}
											>
												Edit
											</button>
											<button
												type="button"
												class="delete-variant-btn text-sm text-red-500 hover:underline"
												data-variant-id={variant.id}
												data-variant-title={variant.title}
											>
												Delete
											</button>
										</div>
									</div>
								);
							})}
						</div>
					)}
				</div>

				<!-- Variant Modal -->
				<div id="variant-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
					<div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
						<div class="p-6 border-b border-gray-100">
							<h3 id="modal-title" class="text-lg font-semibold text-[#1d1d1f]">Add Variant</h3>
						</div>
						<form id="variant-form" class="p-6 space-y-4">
							<input type="hidden" id="variant-id" name="variantId" value="" />

							<div>
								<label for="variant-title" class="block text-sm font-medium text-[#1d1d1f] mb-2">
									Title <span class="text-red-500">*</span>
								</label>
								<input
									type="text"
									id="variant-title"
									name="title"
									required
									class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm text-[#1d1d1f] focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20 focus:border-[#0071e3] transition-all"
									placeholder="e.g., Default, Size M, Color Red"
								/>
							</div>

							<div>
								<label for="variant-sku" class="block text-sm font-medium text-[#1d1d1f] mb-2">
									SKU
								</label>
								<input
									type="text"
									id="variant-sku"
									name="sku"
									class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm text-[#1d1d1f] focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20 focus:border-[#0071e3] transition-all"
									placeholder="Optional SKU code"
								/>
							</div>

							<div>
								<label for="price-amount" class="block text-sm font-medium text-[#1d1d1f] mb-2">
									Price (JPY) <span class="text-red-500">*</span>
								</label>
								<input
									type="number"
									id="price-amount"
									name="amount"
									required
									min="0"
									step="1"
									class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm text-[#1d1d1f] focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20 focus:border-[#0071e3] transition-all tabular-nums"
									placeholder="1000"
								/>
							</div>

							<div>
								<label for="stripe-price-id" class="block text-sm font-medium text-[#1d1d1f] mb-2">
									Stripe Price ID
								</label>
								<input
									type="text"
									id="stripe-price-id"
									name="provider_price_id"
									class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm text-[#1d1d1f] font-mono focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20 focus:border-[#0071e3] transition-all"
									placeholder="price_xxxxxxxx"
								/>
								<p class="text-xs text-[#86868b] mt-1">Required for checkout. Get this from your Stripe Dashboard.</p>
							</div>

							<div id="modal-error" class="hidden bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm"></div>

							<div class="flex justify-end gap-3 pt-4 border-t border-gray-100">
								<button
									type="button"
									id="cancel-modal-btn"
									class="px-4 py-2 text-sm font-medium text-[#1d1d1f] bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
								>
									Cancel
								</button>
								<button
									type="submit"
									class="px-4 py-2 text-sm font-medium text-white bg-[#0071e3] rounded-lg hover:bg-[#0077ED] transition-colors"
								>
									Save
								</button>
							</div>
						</form>
					</div>
				</div>
			)}
	</div>
</AdminLayout>

<script define:vars={{ apiBase, apiKey, productId: id }}>
	function initProductPage() {
		// Image handling
		const imageUpload = document.getElementById('image-upload');
		const uploadProgress = document.getElementById('upload-progress');
		const imageError = document.getElementById('image-error');

		// If elements don't exist yet (React still loading), retry
		if (!imageUpload && !document.getElementById('variant-modal')) {
			setTimeout(initProductPage, 100);
			return;
		}

		function showImageError(message) {
			if (!imageError) return;
			const errorDiv = imageError.querySelector('div');
			if (errorDiv) {
				errorDiv.textContent = message;
				imageError.classList.remove('hidden');
				setTimeout(() => imageError.classList.add('hidden'), 5000);
			}
		}

		imageUpload?.addEventListener('change', async (e) => {
			const files = e.target.files;
			if (!files || files.length === 0) return;

			uploadProgress?.classList.remove('hidden');
			imageError?.classList.add('hidden');

			const formData = new FormData();
			for (const file of files) {
				formData.append('file', file);
			}

			try {
				const res = await fetch(`${apiBase}/admin/products/${productId}/images`, {
					method: 'POST',
					headers: { 'x-admin-key': apiKey },
					body: formData
				});

				if (!res.ok) {
					const data = await res.json();
					showImageError(data.message || 'Failed to upload images');
				} else {
					location.reload();
				}
			} catch (err) {
				showImageError('Failed to upload images. Please try again.');
			} finally {
				uploadProgress?.classList.add('hidden');
				if (imageUpload) imageUpload.value = '';
			}
		});

		// Use event delegation for delete image buttons
		document.addEventListener('click', async (e) => {
			const btn = e.target.closest('.delete-image-btn');
			if (!btn) return;

			const imageId = btn.dataset.imageId;
			const filename = btn.dataset.imageFilename;
			if (!confirm(`Delete image "${filename}"?`)) return;

			try {
				const res = await fetch(`${apiBase}/admin/products/${productId}/images/${imageId}`, {
					method: 'DELETE',
					headers: { 'x-admin-key': apiKey }
				});
				if (res.ok) {
					location.reload();
				} else {
					const data = await res.json();
					showImageError(data.message || 'Failed to delete image');
				}
			} catch (err) {
				showImageError('Failed to delete image. Please try again.');
			}
		});

		// Variant handling
		const modal = document.getElementById('variant-modal');
		const modalTitle = document.getElementById('modal-title');
		const variantForm = document.getElementById('variant-form');
		const variantIdInput = document.getElementById('variant-id');
		const variantTitleInput = document.getElementById('variant-title');
		const variantSkuInput = document.getElementById('variant-sku');
		const priceAmountInput = document.getElementById('price-amount');
		const stripePriceIdInput = document.getElementById('stripe-price-id');
		const modalError = document.getElementById('modal-error');
		const addVariantBtn = document.getElementById('add-variant-btn');
		const cancelModalBtn = document.getElementById('cancel-modal-btn');

		function showModal(isEdit = false, variant = null) {
			if (!modal || !modalTitle || !variantIdInput || !variantTitleInput || !variantSkuInput || !priceAmountInput || !stripePriceIdInput || !modalError) return;
			modalTitle.textContent = isEdit ? 'Edit Variant' : 'Add Variant';
			variantIdInput.value = variant?.id || '';
			variantTitleInput.value = variant?.title || '';
			variantSkuInput.value = variant?.sku || '';
			const price = variant?.prices?.[0];
			priceAmountInput.value = price?.amount || '';
			stripePriceIdInput.value = price?.provider_price_id || '';
			modalError.classList.add('hidden');
			modal.classList.remove('hidden');
		}

		function hideModal() {
			if (!modal || !variantForm) return;
			modal.classList.add('hidden');
			variantForm.reset();
		}

		function showError(message) {
			if (!modalError) return;
			modalError.textContent = message;
			modalError.classList.remove('hidden');
		}

		addVariantBtn?.addEventListener('click', () => showModal(false));
		cancelModalBtn?.addEventListener('click', hideModal);
		modal?.addEventListener('click', (e) => {
			if (e.target === modal) hideModal();
		});

		// Use event delegation for edit/delete variant buttons
		document.addEventListener('click', async (e) => {
			const editBtn = e.target.closest('.edit-variant-btn');
			if (editBtn) {
				const variant = JSON.parse(editBtn.dataset.variant);
				showModal(true, variant);
				return;
			}

			const deleteBtn = e.target.closest('.delete-variant-btn');
			if (deleteBtn) {
				const variantId = deleteBtn.dataset.variantId;
				const variantTitle = deleteBtn.dataset.variantTitle;
				if (!confirm(`Delete variant "${variantTitle}"? This will also delete its prices.`)) return;

				try {
					const res = await fetch(`${apiBase}/admin/products/${productId}/variants/${variantId}`, {
						method: 'DELETE',
						headers: { 'x-admin-key': apiKey }
					});
					if (res.ok) {
						location.reload();
					} else {
						const data = await res.json();
						alert(data.message || 'Failed to delete variant');
					}
				} catch (err) {
					alert('Failed to delete variant. Please try again.');
				}
			}
		});

		variantForm?.addEventListener('submit', async (e) => {
			e.preventDefault();
			if (!variantIdInput || !variantTitleInput || !variantSkuInput || !priceAmountInput || !stripePriceIdInput) return;

			const variantId = variantIdInput.value;
			const isEdit = !!variantId;

			const title = variantTitleInput.value.trim();
			const sku = variantSkuInput.value.trim() || null;
			const amount = parseInt(priceAmountInput.value, 10);
			const provider_price_id = stripePriceIdInput.value.trim() || null;

			if (!title) {
				showError('Title is required');
				return;
			}
			if (isNaN(amount) || amount < 0) {
				showError('Price must be a valid positive number');
				return;
			}

			try {
				// Create or update variant
				const variantUrl = isEdit
					? `${apiBase}/admin/products/${productId}/variants/${variantId}`
					: `${apiBase}/admin/products/${productId}/variants`;

				const variantRes = await fetch(variantUrl, {
					method: isEdit ? 'PUT' : 'POST',
					headers: {
						'Content-Type': 'application/json',
						'x-admin-key': apiKey
					},
					body: JSON.stringify({ title, sku })
				});

				if (!variantRes.ok) {
					const data = await variantRes.json();
					showError(data.message || 'Failed to save variant');
					return;
				}

				const variantData = await variantRes.json();
				const savedVariantId = variantData.variant?.id || variantId;

				// Update prices
				const priceRes = await fetch(`${apiBase}/admin/variants/${savedVariantId}/prices`, {
					method: 'PUT',
					headers: {
						'Content-Type': 'application/json',
						'x-admin-key': apiKey
					},
					body: JSON.stringify({
						prices: [{ currency: 'JPY', amount, provider_price_id }]
					})
				});

				if (!priceRes.ok) {
					const data = await priceRes.json();
					showError(data.message || 'Failed to save price');
					return;
				}

				location.reload();
			} catch (err) {
				showError('An error occurred. Please try again.');
			}
		});

		// Web fetch functionality
		const fetchUrlInput = document.getElementById('fetch-url');
		const fetchBtn = document.getElementById('fetch-btn');
		const fetchSpinner = document.getElementById('fetch-spinner');
		const fetchLabel = document.getElementById('fetch-label');
		const fetchError = document.getElementById('fetch-error');
		const fetchPreview = document.getElementById('fetch-preview');
		const previewImage = document.getElementById('preview-image');
		const previewOriginalTitle = document.getElementById('preview-original-title');
		const previewSpecs = document.getElementById('preview-specs');
		const previewSource = document.getElementById('preview-source');
		const previewGeneratedTitle = document.getElementById('preview-generated-title');
		const previewGeneratedDescription = document.getElementById('preview-generated-description');
		const applyAllBtn = document.getElementById('apply-all-btn');
		const applyTitleOnlyBtn = document.getElementById('apply-title-only-btn');
		const applyDescOnlyBtn = document.getElementById('apply-desc-only-btn');
		const sendInboxBtn = document.getElementById('send-inbox-btn');
		const cancelPreviewBtn = document.getElementById('cancel-preview-btn');
		const applySuccess = document.getElementById('apply-success');

		const fetchWarning = document.getElementById('fetch-warning');

		let fetchedData = null;

		function showFetchError(message) {
			if (!fetchError) return;
			const errorDiv = fetchError.querySelector('div');
			if (errorDiv) {
				errorDiv.textContent = message;
				fetchError.classList.remove('hidden');
			}
		}

		function hideFetchError() {
			if (fetchError) fetchError.classList.add('hidden');
		}

		function showFetchWarning(message) {
			if (!fetchWarning) return;
			const warningDiv = fetchWarning.querySelector('div');
			if (warningDiv) {
				warningDiv.textContent = message;
				fetchWarning.classList.remove('hidden');
			}
		}

		function hideFetchWarning() {
			if (fetchWarning) fetchWarning.classList.add('hidden');
		}

		function showPreview(data) {
			if (!fetchPreview) return;
			fetchedData = data;

			// Show image
			if (previewImage && data.image_url) {
				previewImage.src = data.image_url;
				previewImage.parentElement?.classList.remove('hidden');
			} else if (previewImage) {
				previewImage.parentElement?.classList.add('hidden');
			}

			// Show original title
			if (previewOriginalTitle) {
				previewOriginalTitle.textContent = data.original_title || '-';
			}

			// Show specs
			if (previewSpecs && data.specs) {
				const specsText = Object.entries(data.specs)
					.map(([key, value]) => `${key}: ${value}`)
					.join(' | ');
				previewSpecs.textContent = specsText || '-';
			} else if (previewSpecs) {
				previewSpecs.textContent = '-';
			}

			// Show source
			if (previewSource) {
				previewSource.textContent = data.source || '-';
			}

			// Show generated title
			if (previewGeneratedTitle) {
				previewGeneratedTitle.textContent = data.generated_title || '-';
			}

			// Show generated description (as HTML)
			if (previewGeneratedDescription) {
				previewGeneratedDescription.innerHTML = data.generated_description || '-';
			}

			fetchPreview.classList.remove('hidden');
		}

		function hidePreview() {
			if (fetchPreview) fetchPreview.classList.add('hidden');
			fetchedData = null;
		}

		fetchBtn?.addEventListener('click', async () => {
			const url = fetchUrlInput?.value?.trim();
			if (!url) {
				showFetchError('URLを入力してください');
				return;
			}

			hideFetchError();
			hideFetchWarning();
			hidePreview();
			if (applySuccess) applySuccess.classList.add('hidden');

			// Show loading state
			if (fetchSpinner) fetchSpinner.classList.remove('hidden');
			if (fetchLabel) fetchLabel.textContent = '取得中...';
			if (fetchBtn) fetchBtn.disabled = true;

			try {
				const productName = document.querySelector('input[name="title"]')?.value?.trim() || '';
				const res = await fetch('/api/admin/products/fetch-url', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ url, product_name: productName })
				});

				const data = await res.json();

				if (!data.success) {
					showFetchError(data.error || '取得に失敗しました');
				} else {
					// Show warning if URL fetch failed but content was generated
					if (data.warning) {
						showFetchWarning(data.warning);
					}
					showPreview(data);
				}
			} catch (err) {
				showFetchError('通信エラーが発生しました');
			} finally {
				if (fetchSpinner) fetchSpinner.classList.add('hidden');
				if (fetchLabel) fetchLabel.textContent = '取得';
				if (fetchBtn) fetchBtn.disabled = false;
			}
		});

		cancelPreviewBtn?.addEventListener('click', hidePreview);

		// Manual input handler
		const manualImageInput = document.getElementById('manual-image');
		const manualDescInput = document.getElementById('manual-description');
		const manualApplyBtn = document.getElementById('manual-apply-btn');

		manualApplyBtn?.addEventListener('click', async () => {
			const imageUrl = manualImageInput?.value?.trim();
			const description = manualDescInput?.value?.trim();

			if (!imageUrl && !description) {
				showFetchError('画像URLまたは説明文を入力してください');
				return;
			}

			hideFetchError();
			if (applySuccess) applySuccess.classList.add('hidden');

			const productTitle = document.querySelector('input[name="title"]')?.value?.trim() || 'Product';

			try {
				const res = await fetch('/api/admin/products/fetch-url', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						image_url: imageUrl,
						description,
						product_name: productTitle
					})
				});

				const data = await res.json();
				if (data.success) {
					showPreview(data);
				}
			} catch (err) {
				showFetchError('エラーが発生しました');
			}
		});

		// Apply all (title + description) directly to form
		applyAllBtn?.addEventListener('click', () => {
			if (!fetchedData) return;

			const titleInput = document.getElementById('title');
			const descTextarea = document.getElementById('description');

			if (titleInput && fetchedData.generated_title) {
				titleInput.value = fetchedData.generated_title;
			}
			if (descTextarea && fetchedData.generated_description) {
				descTextarea.value = fetchedData.generated_description;
			}

			hidePreview();
			titleInput?.scrollIntoView({ behavior: 'smooth', block: 'center' });
			titleInput?.focus();
		});

		// Apply title only
		applyTitleOnlyBtn?.addEventListener('click', () => {
			if (!fetchedData) return;

			const titleInput = document.getElementById('title');
			if (titleInput && fetchedData.generated_title) {
				titleInput.value = fetchedData.generated_title;
			}

			titleInput?.scrollIntoView({ behavior: 'smooth', block: 'center' });
			titleInput?.focus();
		});

		// Apply description only
		applyDescOnlyBtn?.addEventListener('click', () => {
			if (!fetchedData) return;

			const descTextarea = document.getElementById('description');
			if (descTextarea && fetchedData.generated_description) {
				descTextarea.value = fetchedData.generated_description;
			}

			descTextarea?.scrollIntoView({ behavior: 'smooth', block: 'center' });
			descTextarea?.focus();
		});

		// Send to inbox for approval
		sendInboxBtn?.addEventListener('click', async () => {
			if (!fetchedData) return;

			sendInboxBtn.disabled = true;
			sendInboxBtn.textContent = '送信中...';

			try {
				// Create inbox item via API
				const res = await fetch(`${apiBase}/inbox`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'x-admin-key': apiKey
					},
					body: JSON.stringify({
						title: `Product Update: ${document.querySelector('input[name="title"]')?.value || 'Unknown'}`,
						body: `Web取得による商品情報更新の提案\n\n画像: ${fetchedData.image_url || 'なし'}\n元タイトル: ${fetchedData.original_title || 'なし'}\n生成タイトル: ${fetchedData.generated_title || 'なし'}\nソース: ${fetchedData.source || 'なし'}`,
						severity: 'info',
						kind: 'product_update',
						metadata: JSON.stringify({
							product_id: parseInt(productId),
							image_url: fetchedData.image_url,
							title: fetchedData.generated_title,
							description: fetchedData.generated_description,
							original_title: fetchedData.original_title,
							specs: fetchedData.specs,
							source: fetchedData.source
						})
					})
				});

				if (!res.ok) {
					const data = await res.json();
					showFetchError(data.message || 'Inbox送信に失敗しました');
				} else {
					hidePreview();
					if (applySuccess) applySuccess.classList.remove('hidden');
				}
			} catch (err) {
				showFetchError('通信エラーが発生しました');
			} finally {
				sendInboxBtn.disabled = false;
				sendInboxBtn.textContent = 'Inboxに送信';
			}
		});


	// Archive product handler
	const archiveBtn = document.getElementById('archive-product-btn');
	archiveBtn?.addEventListener('click', async () => {
		if (!confirm('Archive this product?')) return;

		try {
			const res = await fetch(`${apiBase}/admin/products/${productId}`, {
				method: 'DELETE',
				headers: { 'x-admin-key': apiKey }
			});

			if (res.ok) {
				window.location.href = '/admin/products?status=archived';
			} else {
				const data = await res.json();
				alert(data.message || 'Failed to archive');
			}
		} catch (err) {
			alert('Failed to archive product');
		}
	});

	// Restore product handler
	const restoreBtn = document.getElementById('restore-product-btn');
	restoreBtn?.addEventListener('click', async () => {
		if (!confirm('Restore this product?')) return;

		try {
			const res = await fetch(`${apiBase}/admin/products/${productId}/restore`, {
				method: 'POST',
				headers: { 'x-admin-key': apiKey }
			});

			if (res.ok) {
				location.reload();
			} else {
				const data = await res.json();
				alert(data.message || 'Failed to restore');
			}
		} catch (err) {
			alert('Failed to restore product');
		}
	});

	}

	// Start initialization
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initProductPage);
	} else {
		initProductPage();
	}
</script>
