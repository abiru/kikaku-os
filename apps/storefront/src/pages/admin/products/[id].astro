---
export const prerender = false;

import { Alert } from '../../../components/catalyst/alert-banner';
import { Button } from '../../../components/catalyst/button';
import { Checkbox } from '../../../components/catalyst/checkbox';
import { Fieldset, Field, Label } from '../../../components/catalyst/fieldset';
import { Heading, Subheading } from '../../../components/catalyst/heading';
import { Input } from '../../../components/catalyst/input';
import { Select } from '../../../components/catalyst/select';
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getApiBase } from '../../../lib/api';
import { formatDate } from '../../../lib/format';
import MarkdownPreview from '../../../components/MarkdownPreview';
import ProductWebUpdate from '../../../components/admin/ProductWebUpdate.astro';
import ProductImages from '../../../components/admin/ProductImages.astro';
import ProductVariants from '../../../components/admin/ProductVariants.astro';

const { id } = Astro.params;
const apiBase = getApiBase();
const apiKey = import.meta.env.ADMIN_API_KEY;

type Price = {
	id: number;
	variant_id: number;
	currency: string;
	amount: number;
	provider_price_id: string | null;
};

type Variant = {
	id: number;
	product_id: number;
	title: string;
	sku: string | null;
	options: string | null;
	metadata: string | null;
	created_at: string;
	updated_at: string;
	prices: Price[];
};

type Product = {
	id: number;
	title: string;
	description: string | null;
	category: string | null;
	metadata: string | null;
	status: string | null;
	tax_rate_id: number | null;
	featured?: number;
	created_at: string;
	updated_at: string;
};

type TaxRate = {
	id: number;
	name: string;
	rate: number;
	is_active: number;
};

type ProductImage = {
	id: number;
	product_id: number;
	r2_key: string;
	filename: string;
	content_type: string;
	size_bytes: number;
	position: number;
	created_at: string;
	updated_at: string;
};

type Category = {
	category: string;
	product_count: number;
};

let product: Product | null = null;
let variants: Variant[] = [];
let images: ProductImage[] = [];
let categories: Category[] = [];
let taxRates: TaxRate[] = [];
let error: string | null = null;
let successMessage: string | null = null;

// Handle POST - Update product
if (Astro.request.method === 'POST' && apiKey) {
	try {
		const formData = await Astro.request.formData();
		const title = formData.get('title')?.toString().trim() || '';
		const description = formData.get('description')?.toString().trim() || '';
		const status = formData.get('status')?.toString() || 'active';
		const category = formData.get('category')?.toString().trim() || null;
		const tax_rate_id_str = formData.get('tax_rate_id')?.toString() || null;
		const tax_rate_id = tax_rate_id_str ? parseInt(tax_rate_id_str, 10) : null;
		const featured = formData.get('featured') === 'on' ? 1 : 0;

		if (!title) {
			error = 'Title is required';
		} else {
			const res = await fetch(`${apiBase}/admin/products/${id}`, {
				method: 'PUT',
				headers: {
					'Content-Type': 'application/json',
					'x-admin-key': apiKey
				},
				body: JSON.stringify({ title, description, status, category, tax_rate_id, featured })
			});

			const data = await res.json();

			if (!res.ok) {
				error = data.message || 'Failed to update product';
			} else {
				product = data.product;
				successMessage = 'Product updated successfully';
			}
		}
	} catch (e) {
		console.error(e);
		error = 'Failed to update product. Please check your connection.';
	}
}

// Fetch product data (if not already set from POST)
if (!product && apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/products/${id}`, {
			headers: { 'x-admin-key': apiKey }
		});

		if (!res.ok) {
			if (res.status === 404) {
				error = 'Product not found';
			} else {
				const data = await res.json();
				error = data.message || `API Error: ${res.status}`;
			}
		} else {
			const data = await res.json();
			product = data.product;
		}
	} catch (e) {
		console.error(e);
		error = error || 'Failed to load product. Please check your connection.';
	}
} else if (!apiKey) {
	error = 'ADMIN_API_KEY is missing in server environment';
}

// Fetch variants if product is loaded
if (product && apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/products/${id}/variants`, {
			headers: { 'x-admin-key': apiKey }
		});
		if (res.ok) {
			const data = await res.json();
			variants = data.variants || [];
		}
	} catch (e) {
		console.error('Failed to fetch variants:', e);
	}
}

// Fetch images if product is loaded
if (product && apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/products/${id}/images`, {
			headers: { 'x-admin-key': apiKey }
		});
		if (res.ok) {
			const data = await res.json();
			images = data.images || [];
		}
	} catch (e) {
		console.error('Failed to fetch images:', e);
	}
}

// Fetch categories for dropdown
if (apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/categories`, {
			headers: { 'x-admin-key': apiKey }
		});
		if (res.ok) {
			const data = await res.json();
			categories = data.categories || [];
		}
	} catch (e) {
		console.error('Failed to fetch categories:', e);
	}
}

// Fetch tax rates for dropdown
if (apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/tax-rates`, {
			headers: { 'x-admin-key': apiKey }
		});
		if (res.ok) {
			const data = await res.json();
			taxRates = data.filter((tr: TaxRate) => tr.is_active) || [];
		}
	} catch (e) {
		console.error('Failed to fetch tax rates:', e);
	}
}

const dateTimeOpts: Intl.DateTimeFormatOptions = {
	year: 'numeric',
	month: '2-digit',
	day: '2-digit',
	hour: '2-digit',
	minute: '2-digit'
};

const getExternalImageUrl = (metadata: string | null): string | null => {
	if (!metadata) return null;
	try {
		const parsed = JSON.parse(metadata);
		return parsed.image_url || null;
	} catch {
		return null;
	}
};

const externalImageUrl = product ? getExternalImageUrl(product.metadata) : null;
---

<AdminLayout title={product ? `${product.title} - Admin` : 'Product - Admin'}>
	<div class="space-y-6 max-w-2xl">
		<div class="flex items-center gap-4">
			<a href="/admin/products" class="text-indigo-600 hover:underline text-sm flex items-center gap-1">
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
				</svg>
				Products
			</a>
			<Heading>
				{product ? `Edit: ${product.title}` : 'Product'}
			</Heading>
		</div>
			{successMessage && (
				<Alert color="green" client:load>
					{successMessage}
				</Alert>
			)}

			{error && !product && (
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-8 text-center">
					<Alert color="red" client:load>
						{error}
					</Alert>
					<div class="mt-4">
						<Button href="/admin/products" outline client:load>
							Back to Products
						</Button>
					</div>
				</div>
			)}

			{error && product && (
				<Alert color="red" client:load>
					{error}
				</Alert>
			)}

			{product && (
				<form method="POST" class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6">
					<Fieldset client:load>
						<Field>
							<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">Title *</label>
							<Input client:load type="text" name="title" required value={product.title} />
						</Field>

						<Field>
							<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">Description（Markdown形式）</label>
							<MarkdownPreview
								client:load
								value={product.description || ''}
								onChange={(val: string) => {
									const input = document.getElementById('description-hidden') as HTMLInputElement;
									if (input) input.value = val;
								}}
							/>
							<input type="hidden" id="description-hidden" name="description" value={product.description || ''} />
						</Field>

						<Field>
							<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">Status</label>
							<Select client:load name="status">
								<option value="active" selected={product.status === 'active'}>Active</option>
								<option value="draft" selected={product.status === 'draft'}>Draft</option>
								<option value="archived" selected={product.status === 'archived'}>Archived</option>
							</Select>
						</Field>

						<Field>
							<div class="flex items-center gap-2">
								<Checkbox client:load id="featured" name="featured" checked={product.featured === 1} />
								<label for="featured" class="text-base/6 text-zinc-950 select-none sm:text-sm/6">
									ホームページに表示（Featured）
								</label>
							</div>
							<p class="text-xs text-secondary mt-1">チェックするとホームページのカテゴリグリッドに表示されます</p>
						</Field>

						<Field>
							<Label>Category</Label>
							<Input client:load type="text" name="category" list="category-list" value={product.category || ''} placeholder="Select or enter a category" />
							<datalist id="category-list">
								{categories.map((cat) => (
									<option value={cat.category} />
								))}
							</datalist>
							<p class="text-xs text-secondary mt-1">Type to create a new category or select from existing ones.</p>
						</Field>

						<Field>
							<Label>Tax Rate</Label>
							<Select client:load name="tax_rate_id">
								<option value="">Select tax rate...</option>
								{taxRates.map((rate) => (
									<option value={rate.id} selected={product.tax_rate_id === rate.id}>
										{rate.name} ({(rate.rate * 100).toFixed(1)}%)
									</option>
								))}
							</Select>
							<p class="text-xs text-secondary mt-1">All prices are tax-inclusive (税込)</p>
						</Field>
					</Fieldset>

					<div class="pt-4 border-t border-gray-100">
						<dl class="grid grid-cols-2 gap-4 text-sm">
							<div>
								<dt class="text-secondary">Created</dt>
								<dd class="text-zinc-950 tabular-nums">{formatDate(product.created_at, dateTimeOpts)}</dd>
							</div>
							<div>
								<dt class="text-secondary">Updated</dt>
								<dd class="text-zinc-950 tabular-nums">{formatDate(product.updated_at, dateTimeOpts)}</dd>
							</div>
						</dl>
					</div>

				<div class="flex justify-between gap-3 pt-4 border-t border-gray-100">
					<div>
						{product.status !== 'archived' && (
							<button
								type="button"
								id="archive-product-btn"
								class="px-4 py-2 text-sm font-medium text-white bg-red-500 rounded-lg hover:bg-red-600 transition-colors"
							>
								Archive Product
							</button>
						)}
						{product.status === 'archived' && (
							<button
								type="button"
								id="restore-product-btn"
								class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 transition-colors"
							>
								Restore Product
							</button>
						)}
					</div>
					<div class="flex gap-3">
						<Button href="/admin/products" outline client:load>
							Back
						</Button>
						<Button type="submit" color="indigo" client:load>
							Save Changes
						</Button>
					</div>
				</div>
				</form>

					<ProductWebUpdate />

					<!-- External Image URL (from metadata) -->
					{externalImageUrl && (
						<div class="mt-8">
							<Subheading>External Image</Subheading>
							<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
								<div class="flex gap-4">
									<img
										src={externalImageUrl}
										alt={product.title}
										class="w-32 h-32 object-contain rounded-lg bg-gray-50"
									/>
									<div class="flex-1 min-w-0">
										<p class="text-xs text-secondary mb-1">Image URL (from web search)</p>
										<p class="text-sm text-zinc-950 break-all font-mono">{externalImageUrl}</p>
									</div>
								</div>
							</div>
						</div>
					)}

					<ProductImages images={images} />
					<ProductVariants variants={variants} />
				)}
	</div>
</AdminLayout>

<script>
	import { initProductPage } from '../../../lib/admin/product-detail';

	const productId = document.currentScript?.closest('[data-product-id]')?.getAttribute('data-product-id')
		|| new URL(window.location.href).pathname.split('/').pop()
		|| '';

	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', () => initProductPage(productId));
	} else {
		initProductPage(productId);
	}
</script>
