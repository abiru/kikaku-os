---
export const prerender = false;

import { Alert } from'../../../components/catalyst/alert-banner';
import { Button } from'../../../components/catalyst/button';
import { Heading } from'../../../components/catalyst/heading';
import AdminLayout from'../../../layouts/AdminLayout.astro';
import { getApiBase } from'../../../lib/api';

const apiBase = getApiBase();
const apiKey = import.meta.env.ADMIN_API_KEY;

let error: string | null = null;
let formValues = { title:'', description:'', status:'active' };

// Handle POST - Create product
if (Astro.request.method ==='POST') {
	try {
		const formData = await Astro.request.formData();
		const title = formData.get('title')?.toString().trim() ||'';
		const description = formData.get('description')?.toString().trim() ||'';
		const status = formData.get('status')?.toString() ||'active';

		formValues = { title, description, status };

		if (!title) {
			error ='Title is required';
		} else if (!apiKey) {
			error ='ADMIN_API_KEY is missing in server environment';
		} else {
			const res = await fetch(`${apiBase}/admin/products`, {
				method:'POST',
				headers: {
					'Content-Type':'application/json',
					'x-admin-key': apiKey
				},
				body: JSON.stringify({ title, description, status })
			});

			const data = await res.json();

			if (!res.ok) {
				error = data.message ||'Failed to create product';
			} else if (data.product?.id) {
				return Astro.redirect(`/admin/products/${data.product.id}`);
			} else {
				error ='Failed to create product';
			}
		}
	} catch (e) {
		console.error(e);
		error ='Failed to create product. Please check your connection.';
	}
}
---

<AdminLayout title="New Product - Admin">
	<div class="space-y-6 max-w-2xl">
		<div class="flex items-center gap-4">
			<a href="/admin/products" class="text-indigo-600 hover:underline text-sm flex items-center gap-1">
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
				</svg>
				Products
			</a>
			<Heading>New Product</Heading>
		</div>
			{error && (
				<Alert color="red" client:load>
					{error}
				</Alert>
			)}

			<form method="POST" class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6">
				<div class="space-y-4">
					<div>
						<label class="block text-sm font-medium text-zinc-950 mb-2">Title *</label>
						<input type="text" name="title" required value={formValues.title} placeholder="Product title" class="w-full rounded-lg border border-zinc-300 px-3 py-2 text-sm text-zinc-950 placeholder-zinc-400 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/20" />
					</div>

					<div>
						<label class="block text-sm font-medium text-zinc-950 mb-2">Description</label>
						<textarea name="description" rows={4} placeholder="Product description (optional)" class="w-full rounded-lg border border-zinc-300 px-3 py-2 text-sm text-zinc-950 placeholder-zinc-400 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">{formValues.description}</textarea>
					</div>

					<div>
						<label class="block text-sm font-medium text-zinc-950 mb-2">Status</label>
						<select name="status" class="w-full rounded-lg border border-zinc-300 px-3 py-2 text-sm text-zinc-950 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
							<option value="active" selected={formValues.status ==='active'}>Active</option>
							<option value="draft" selected={formValues.status ==='draft'}>Draft</option>
						</select>
					</div>
				</div>

				<div class="flex justify-end gap-3 pt-4 border-t border-gray-100">
					<Button href="/admin/products" outline client:load>
						Cancel
					</Button>
					<Button type="submit" color="indigo" client:load>
						Create Product
					</Button>
				</div>
			</form>
	</div>
</AdminLayout>
