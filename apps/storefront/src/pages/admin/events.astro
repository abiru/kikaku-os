---
export const prerender = false;

import Badge from '../../components/Badge.astro';
import Button from '../../components/Button.astro';
import AdminLayout from '../../layouts/AdminLayout.astro';
import { getApiBase } from '../../lib/api';

const apiBase = getApiBase();
const page = Number(Astro.url.searchParams.get('page') || '1');
const perPage = 50;
const status = Astro.url.searchParams.get('status') || '';
const type = Astro.url.searchParams.get('type') || '';

let events: any[] = [];
let meta = { totalCount: 0, totalPages: 1 };
let error: string | null = null;

if (import.meta.env.ADMIN_API_KEY) {
	try {
		const query = new URLSearchParams({
			page: page.toString(),
			perPage: perPage.toString()
		});
		if (status) query.set('status', status);
		if (type) query.set('type', type);

		const res = await fetch(`${apiBase}/admin/stripe-events?${query}`, {
			headers: { 'x-admin-key': import.meta.env.ADMIN_API_KEY }
		});

		if (!res.ok) throw new Error(`API Error: ${res.status}`);

		const data = await res.json();
		events = data.events || [];
		meta = data.meta || meta;
	} catch (e) {
		console.error(e);
		error = 'Failed to load events.';
	}
} else {
	error = 'ADMIN_API_KEY is missing.';
}

const hasNext = page < meta.totalPages;
const hasPrev = page > 1;

const formatDate = (dateStr: string | null) => {
	if (!dateStr) return '-';
	const d = new Date(dateStr);
	return `${d.toLocaleDateString()} ${d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'})}`;
};

const getStatusSeverity = (s: string) => {
	switch (s) {
		case 'completed': return 'info';
		case 'pending': return 'warn';
		case 'failed': return 'critical';
		default: return 'secondary';
	}
};

const buildFilterUrl = (newStatus: string) => {
	const params = new URLSearchParams();
	params.set('page', '1');
	if (newStatus) params.set('status', newStatus);
	if (type) params.set('type', type);
	return `?${params}`;
};

const failedCount = events.filter(e => e.processing_status === 'failed').length;
---

<AdminLayout title="Stripe Events - Admin">
	<div class="space-y-6">
		<div class="flex items-center gap-4">
			<h1 class="text-2xl font-semibold text-zinc-900">Stripe Events</h1>
			<span class="text-xs text-zinc-500 bg-zinc-100 px-2 py-1 rounded-full">{meta.totalCount} total</span>
		</div>
			{/* Filter Tabs */}
			<div class="mb-6 flex gap-2 flex-wrap">
				<a
					href={buildFilterUrl('')}
					class:list={[
						"px-4 py-2 rounded-lg text-sm font-medium transition-colors",
						!status ? "bg-zinc-900 text-white" : "bg-white border border-zinc-200 text-zinc-900 hover:bg-zinc-50"
					]}
				>
					All
				</a>
				<a
					href={buildFilterUrl('completed')}
					class:list={[
						"px-4 py-2 rounded-lg text-sm font-medium transition-colors",
						status === 'completed' ? "bg-zinc-900 text-white" : "bg-white border border-zinc-200 text-zinc-900 hover:bg-zinc-50"
					]}
				>
					Completed
				</a>
				<a
					href={buildFilterUrl('pending')}
					class:list={[
						"px-4 py-2 rounded-lg text-sm font-medium transition-colors",
						status === 'pending' ? "bg-zinc-900 text-white" : "bg-white border border-zinc-200 text-zinc-900 hover:bg-zinc-50"
					]}
				>
					Pending
				</a>
				<a
					href={buildFilterUrl('failed')}
					class:list={[
						"px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2",
						status === 'failed' ? "bg-red-600 text-white" : "bg-white border border-red-200 text-red-600 hover:bg-red-50"
					]}
				>
					Failed
					{meta.totalCount > 0 && status !== 'failed' && (
						<span class="text-xs bg-red-100 text-red-600 px-1.5 py-0.5 rounded-full">{failedCount > 0 ? failedCount : ''}</span>
					)}
				</a>
			</div>

			{error && (
				<div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg mb-6 text-sm">
					{error}
				</div>
			)}

			{/* Events Table */}
			<div class="bg-white rounded-lg ring-1 ring-zinc-900/5 overflow-hidden">
				<div class="overflow-x-auto">
					<table class="w-full text-left text-sm text-zinc-900">
						<thead class="bg-zinc-50 border-b border-zinc-200">
							<tr>
								<th class="px-6 py-3 font-medium text-zinc-500">Received</th>
								<th class="px-6 py-3 font-medium text-zinc-500">Event ID</th>
								<th class="px-6 py-3 font-medium text-zinc-500">Type</th>
								<th class="px-6 py-3 font-medium text-zinc-500">Status</th>
								<th class="px-6 py-3 font-medium text-zinc-500">Error</th>
								<th class="px-6 py-3 font-medium text-zinc-500">Processed</th>
							</tr>
						</thead>
						<tbody class="divide-y divide-zinc-100">
							{events.length > 0 ? (
								events.map((e) => (
									<tr class:list={["hover:bg-zinc-50 transition-colors", e.processing_status === 'failed' && "bg-red-50/50"]}>
										<td class="px-6 py-4 text-zinc-500 tabular-nums whitespace-nowrap">
											{formatDate(e.received_at)}
										</td>
										<td class="px-6 py-4 font-mono text-xs">
											<span class="bg-zinc-100 px-1.5 py-0.5 rounded">{e.event_id}</span>
										</td>
										<td class="px-6 py-4 font-mono text-xs">{e.event_type}</td>
										<td class="px-6 py-4">
											<Badge severity={getStatusSeverity(e.processing_status)}>{e.processing_status}</Badge>
										</td>
										<td class="px-6 py-4 text-xs max-w-xs truncate" title={e.error || ''}>
											{e.error ? (
												<span class="text-red-600 bg-red-50 px-2 py-1 rounded">{e.error}</span>
											) : '-'}
										</td>
										<td class="px-6 py-4 text-zinc-500 tabular-nums whitespace-nowrap">
											{formatDate(e.processed_at)}
										</td>
									</tr>
								))
							) : (
								<tr>
									<td colspan="6" class="px-6 py-12 text-center text-zinc-500">
										No events found.
									</td>
								</tr>
							)}
						</tbody>
					</table>
				</div>

				{/* Pagination */}
				<div class="border-t border-zinc-200 px-6 py-4 flex items-center justify-between">
					<div class="text-xs text-zinc-500">
						Page {page} of {meta.totalPages}
					</div>
					<div class="flex gap-2">
						<Button
							href={hasPrev ? `?page=${page - 1}${status ? '&status=' + status : ''}${type ? '&type=' + type : ''}` : '#'}
							disabled={!hasPrev}
							size="sm"
							variant="secondary"
						>
							Previous
						</Button>
						<Button
							href={hasNext ? `?page=${page + 1}${status ? '&status=' + status : ''}${type ? '&type=' + type : ''}` : '#'}
							disabled={!hasNext}
							size="sm"
							variant="secondary"
						>
							Next
						</Button>
					</div>
				</div>
			</div>
	</div>
</AdminLayout>
