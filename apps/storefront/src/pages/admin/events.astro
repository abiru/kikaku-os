---
export const prerender = false;

import AdminLayout from '../../layouts/AdminLayout.astro';
import { Alert } from '../../components/catalyst/alert-banner';
import { Heading } from '../../components/catalyst/heading';
import EventsTable from '../../components/admin/EventsTable';
import { ErrorBoundary } from '../../components/ErrorBoundary';
import { adminFetchList } from '../../lib/admin/fetchAdmin';
import { t } from '../../i18n';

type StripeEvent = {
	event_id: string;
	event_type: string;
	processing_status: string;
	error: string | null;
	received_at: string;
	processed_at: string | null;
};

const page = Number(Astro.url.searchParams.get('page') || '1');
const perPage = 50;
const status = Astro.url.searchParams.get('status') || '';
const type = Astro.url.searchParams.get('type') || '';

const query = new URLSearchParams({
	page: page.toString(),
	perPage: perPage.toString()
});
if (status) query.set('status', status);
if (type) query.set('type', type);

type EventsMeta = { totalCount: number; totalPages: number };
const { data, error: fetchError } = await adminFetchList<{ events: StripeEvent[]; meta: EventsMeta }>('/admin/stripe-events', query);
const events = data?.events || [];
const meta = data?.meta || { totalCount: 0, totalPages: 1 };
const error: string | null = fetchError ? t('errors.failedToLoadEvents') : null;

const buildFilterUrl = (newStatus: string) => {
	const params = new URLSearchParams();
	params.set('page', '1');
	if (newStatus) params.set('status', newStatus);
	if (type) params.set('type', type);
	return `?${params}`;
};

const failedCount = events.filter(e => e.processing_status === 'failed').length;
---

<AdminLayout title={`${t('admin.stripeEvents')} - Admin`}>
	<div class="space-y-6">
		<div class="flex items-center gap-4">
			<Heading>{t('admin.stripeEvents')}</Heading>
			<span class="text-xs text-zinc-500 bg-zinc-100 px-2 py-1 rounded-full">{meta.totalCount} {t('admin.total')}</span>
		</div>
			{/* Filter Tabs */}
			<div class="mb-6 flex gap-2 flex-wrap">
				<a
					href={buildFilterUrl('')}
					class:list={[
						"px-4 py-2 rounded-lg text-sm font-medium transition-colors",
						!status ? "bg-indigo-600 text-white" : "bg-white border border-zinc-200 text-zinc-950 hover:bg-zinc-50"
					]}
				>
					{t('common.all')}
				</a>
				<a
					href={buildFilterUrl('completed')}
					class:list={[
						"px-4 py-2 rounded-lg text-sm font-medium transition-colors",
						status === 'completed' ? "bg-indigo-600 text-white" : "bg-white border border-zinc-200 text-zinc-950 hover:bg-zinc-50"
					]}
				>
					{t('admin.completed')}
				</a>
				<a
					href={buildFilterUrl('pending')}
					class:list={[
						"px-4 py-2 rounded-lg text-sm font-medium transition-colors",
						status === 'pending' ? "bg-indigo-600 text-white" : "bg-white border border-zinc-200 text-zinc-950 hover:bg-zinc-50"
					]}
				>
					{t('admin.pending')}
				</a>
				<a
					href={buildFilterUrl('failed')}
					class:list={[
						"px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2",
						status === 'failed' ? "bg-red-600 text-white" : "bg-white border border-red-200 text-red-600 hover:bg-red-50"
					]}
				>
					{t('admin.failed')}
					{meta.totalCount > 0 && status !== 'failed' && (
						<span class="text-xs bg-red-100 text-red-600 px-1.5 py-0.5 rounded-full">{failedCount > 0 ? failedCount : ''}</span>
					)}
				</a>
			</div>

			{error && (
				<div role="alert" class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg mb-6 text-sm">
					{error}
				</div>
			)}

			<ErrorBoundary client:visible>
				<EventsTable
					events={events}
					currentPage={page}
					totalPages={meta.totalPages}
					status={status}
					type={type}
				/>
			</ErrorBoundary>
	</div>
</AdminLayout>
