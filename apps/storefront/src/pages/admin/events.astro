---
export const prerender = false;

import AdminLayout from'../../layouts/AdminLayout.astro';
import { Alert } from'../../components/catalyst/alert-banner';
import { getApiBase } from'../../lib/api';
import { Heading } from'../../components/catalyst/heading';
import EventsTable from'../../components/admin/EventsTable';

const apiBase = getApiBase();
const page = Number(Astro.url.searchParams.get('page') ||'1');
const perPage = 50;
const status = Astro.url.searchParams.get('status') ||'';
const type = Astro.url.searchParams.get('type') ||'';

let events: any[] = [];
let meta = { totalCount: 0, totalPages: 1 };
let error: string | null = null;

if (import.meta.env.ADMIN_API_KEY) {
	try {
		const query = new URLSearchParams({
			page: page.toString(),
			perPage: perPage.toString()
		});
		if (status) query.set('status', status);
		if (type) query.set('type', type);

		const res = await fetch(`${apiBase}/admin/stripe-events?${query}`, {
			headers: {'x-admin-key': import.meta.env.ADMIN_API_KEY }
		});

		if (!res.ok) throw new Error(`API Error: ${res.status}`);

		const data = await res.json();
		events = data.events || [];
		meta = data.meta || meta;
	} catch (e) {
		console.error(e);
		error ='Failed to load events.';
	}
} else {
	error ='ADMIN_API_KEY is missing.';
}

const buildFilterUrl = (newStatus: string) => {
	const params = new URLSearchParams();
	params.set('page','1');
	if (newStatus) params.set('status', newStatus);
	if (type) params.set('type', type);
	return `?${params}`;
};

const failedCount = events.filter(e => e.processing_status ==='failed').length;
---

<AdminLayout title="Stripe Events - Admin">
	<div class="space-y-6">
		<div class="flex items-center gap-4">
			<Heading>Stripe Events</Heading>
			<span class="text-xs text-zinc-500 bg-zinc-100 px-2 py-1 rounded-full">{meta.totalCount} total</span>
		</Alert>
			{/* Filter Tabs */}
			<div class="mb-6 flex gap-2 flex-wrap">
				<a
					href={buildFilterUrl('')}
					class:list={[
						"px-4 py-2 rounded-lg text-sm font-medium transition-colors",
						!status ?"bg-indigo-600 text-white" :"bg-white border border-zinc-200 text-zinc-950 hover:bg-zinc-50"
					]}
				>
					All
				</a>
				<a
					href={buildFilterUrl('completed')}
					class:list={[
						"px-4 py-2 rounded-lg text-sm font-medium transition-colors",
						status ==='completed' ?"bg-indigo-600 text-white" :"bg-white border border-zinc-200 text-zinc-950 hover:bg-zinc-50"
					]}
				>
					Completed
				</a>
				<a
					href={buildFilterUrl('pending')}
					class:list={[
						"px-4 py-2 rounded-lg text-sm font-medium transition-colors",
						status ==='pending' ?"bg-indigo-600 text-white" :"bg-white border border-zinc-200 text-zinc-950 hover:bg-zinc-50"
					]}
				>
					Pending
				</a>
				<a
					href={buildFilterUrl('failed')}
					class:list={[
						"px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2",
						status ==='failed' ?"bg-red-600 text-white" :"bg-white border border-red-200 text-red-600 hover:bg-red-50"
					]}
				>
					Failed
					{meta.totalCount > 0 && status !=='failed' && (
						<span class="text-xs bg-red-100 text-red-600 px-1.5 py-0.5 rounded-full">{failedCount > 0 ? failedCount :''}</span>
					)}
				</a>
			</Alert>

			{error && (
				<div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg mb-6 text-sm">
					{error}
				</Alert>
			)}

			<EventsTable
				events={events}
				currentPage={page}
				totalPages={meta.totalPages}
				status={status}
				type={type}
				client:load
			/>
	</Alert>
</AdminLayout>
