---
export const prerender = false;

import AdminLayout from '../../layouts/AdminLayout.astro';
import { Alert } from '../../components/catalyst/alert-banner';
import ProductsTable from '../../components/admin/ProductsTable';
import { Button } from '../../components/catalyst/button';
import { Input } from '../../components/catalyst/input';
import { Heading } from '../../components/catalyst/heading';
import { getApiBase } from '../../lib/api';
import type { Product } from '../../lib/types';
import { t } from '../../i18n';
import { logError } from '../../utils/logger';

const apiBase = getApiBase();
const q = Astro.url.searchParams.get('q') || '';
const status = Astro.url.searchParams.get('status') || 'all';
const page = Number(Astro.url.searchParams.get('page') || '1');
const perPage = Number(Astro.url.searchParams.get('perPage') || '20');

let products: Product[] = [];
let meta = { totalCount: 0, totalPages: 1 };
let error = null;

// SSR Data Fetching
if (import.meta.env.ADMIN_API_KEY) {
	try {
		const query = new URLSearchParams({
			q,
			status,
			page: page.toString(),
			perPage: perPage.toString()
		});

		const res = await fetch(`${apiBase}/admin/products?${query}`, {
			headers: {
				'x-admin-key': import.meta.env.ADMIN_API_KEY
			}
		});

		if (!res.ok) {
			throw new Error(`API Error: ${res.status}`);
		}

		const data = await res.json();
		products = data.products || [];
		meta = data.meta || meta;
	} catch (e) {
		logError({ page: 'admin/products' }, e);
		error = t('errors.failedToLoadProducts');
	}
} else {
	error = t('errors.adminKeyMissing');
}
---

<AdminLayout title={`${t('admin.products')} - Admin`}>
	<div class="space-y-6">
		<div class="flex items-center justify-between">
			<div class="flex items-center gap-4">
				<Heading>{t('admin.products')}</Heading>
				<span class="text-xs text-zinc-500 bg-zinc-100 px-2 py-1 rounded-full">{meta.totalCount} {t('admin.items')}</span>
			</div>
			<Button client:only="react" href="/admin/products/new">
				{t('admin.newProduct')}
			</Button>
		</div>

		{/* Status Filter Tabs */}
		<div class="flex gap-2">
			<a
				href="?status=all"
				class={`px-4 py-2 text-sm rounded-lg transition-colors ${
					status === 'all'
						? 'bg-indigo-600 text-white'
						: 'bg-zinc-100 text-zinc-950 hover:bg-zinc-200'
				}`}
			>
				{t('common.all')}
			</a>
			<a
				href="?status=active"
				class={`px-4 py-2 text-sm rounded-lg transition-colors ${
					status === 'active'
						? 'bg-indigo-600 text-white'
						: 'bg-zinc-100 text-zinc-950 hover:bg-zinc-200'
				}`}
			>
				{t('admin.active')}
			</a>
			<a
				href="?status=draft"
				class={`px-4 py-2 text-sm rounded-lg transition-colors ${
					status === 'draft'
						? 'bg-indigo-600 text-white'
						: 'bg-zinc-100 text-zinc-950 hover:bg-zinc-200'
				}`}
			>
				{t('admin.draft')}
			</a>
			<a
				href="?status=archived"
				class={`px-4 py-2 text-sm rounded-lg transition-colors ${
					status === 'archived'
						? 'bg-indigo-600 text-white'
						: 'bg-zinc-100 text-zinc-950 hover:bg-zinc-200'
				}`}
			>
				{t('admin.archived')}
			</a>
		</div>

		{/* Search Bar + Controls */}
		<div class="flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
			<form method="get" class="relative max-w-md flex-1">
				<Input
					type="search"
					name="q"
					value={q}
					placeholder={t('admin.searchByTitle')}
					className="pl-10"
					client:load
				/>
				<svg
					class="absolute left-3 top-2.5 h-4 w-4 text-zinc-400"
					fill="none"
					stroke="currentColor"
					viewBox="0 0 24 24"
				>
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
				</svg>
				<input type="hidden" name="status" value={status} />
				<input type="hidden" name="perPage" value={perPage.toString()} />
			</form>
			<div class="flex items-center gap-2">
				<select
					onchange={`window.location.href='?status=${status}&q=${q}&perPage='+this.value`}
					class="rounded-lg border border-zinc-200 bg-white px-3 py-1.5 text-sm text-zinc-700 shadow-sm"
				>
					{[10, 20, 50, 100].map((n) => (
						<option value={n} selected={perPage === n}>{t('admin.perPage', { count: n })}</option>
					))}
				</select>
				<a
					href={`?status=${status}&q=${q}&perPage=${perPage}`}
					class="inline-flex items-center gap-1.5 rounded-lg border border-zinc-200 bg-white px-3 py-1.5 text-sm text-zinc-700 shadow-sm hover:bg-zinc-50 transition-colors"
					title={t('admin.refresh')}
				>
					<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
					</svg>
					{t('admin.refresh')}
				</a>
			</div>
		</div>

		{error && (
			<Alert color="red" client:load>
				{error}
			</Alert>
		)}

		<ProductsTable
			client:visible
			products={products}
			currentPage={page}
			totalPages={meta.totalPages}
			searchQuery={q}
			statusFilter={status}
		/>
	</div>
</AdminLayout>
