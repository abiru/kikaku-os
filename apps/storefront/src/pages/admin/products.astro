---
export const prerender = false;

import AdminLayout from'../../layouts/AdminLayout.astro';
import { Alert } from'../../components/catalyst/alert-banner';
import ProductsTable from'../../components/admin/ProductsTable';
import { Button } from'../../components/catalyst/button';
import { Heading } from'../../components/catalyst/heading';
import { getApiBase } from'../../lib/api';

const apiBase = getApiBase();
const q = Astro.url.searchParams.get('q') ||'';
const status = Astro.url.searchParams.get('status') ||'all';
const page = Number(Astro.url.searchParams.get('page') ||'1');
const perPage = 20;

let products: any[] = [];
let meta = { totalCount: 0, totalPages: 1 };
let error = null;

// SSR Data Fetching
if (import.meta.env.ADMIN_API_KEY) {
	try {
		const query = new URLSearchParams({
			q,
			status,
			page: page.toString(),
			perPage: perPage.toString()
		});

		const res = await fetch(`${apiBase}/admin/products?${query}`, {
			headers: {
				'x-admin-key': import.meta.env.ADMIN_API_KEY
			}
		});

		if (!res.ok) {
			throw new Error(`API Error: ${res.status}`);
		}

		const data = await res.json();
		products = data.products || [];
		meta = data.meta || meta;
	} catch (e) {
		console.error(e);
		error ='Failed to load products. Please check your admin key.';
	}
} else {
	error ='ADMIN_API_KEY is missing in server environment.';
}
---

<AdminLayout title="Products - Admin">
	<div class="space-y-6">
		<div class="flex items-center justify-between">
			<div class="flex items-center gap-4">
				<Heading>Products</Heading>
				<span class="text-xs text-zinc-500 bg-zinc-100 px-2 py-1 rounded-full">{meta.totalCount} items</span>
			</Alert>
			<Button client:only="react" href="/admin/products/new">
				+ New Product
			</Button>
		</Alert>

		{/* Status Filter Tabs */}
		<div class="flex gap-2">
			<a
				href="?status=all"
				class={`px-4 py-2 text-sm rounded-lg transition-colors ${
					status ==='all'
						?'bg-indigo-600 text-white'
						:'bg-zinc-100 text-zinc-950 hover:bg-zinc-200'
				}`}
			>
				All
			</a>
			<a
				href="?status=active"
				class={`px-4 py-2 text-sm rounded-lg transition-colors ${
					status ==='active'
						?'bg-indigo-600 text-white'
						:'bg-zinc-100 text-zinc-950 hover:bg-zinc-200'
				}`}
			>
				Active
			</a>
			<a
				href="?status=draft"
				class={`px-4 py-2 text-sm rounded-lg transition-colors ${
					status ==='draft'
						?'bg-indigo-600 text-white'
						:'bg-zinc-100 text-zinc-950 hover:bg-zinc-200'
				}`}
			>
				Draft
			</a>
			<a
				href="?status=archived"
				class={`px-4 py-2 text-sm rounded-lg transition-colors ${
					status ==='archived'
						?'bg-indigo-600 text-white'
						:'bg-zinc-100 text-zinc-950 hover:bg-zinc-200'
				}`}
			>
				Archived
			</a>
		</Alert>

		{/* Search Bar */}
		<div>
			<form method="get" class="relative max-w-md">
				<input
					type="search"
					name="q"
					value={q}
					placeholder="Search by title..."
					class="w-full pl-10 pr-4 py-2 bg-white border border-zinc-300 rounded-lg text-sm text-zinc-950 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all shadow-sm"
				/>
				<svg
					class="absolute left-3 top-2.5 h-4 w-4 text-zinc-400"
					fill="none"
					stroke="currentColor"
					viewBox="0 0 24 24"
				>
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
				</svg>
				<input type="hidden" name="status" value={status} />
			</form>
		</Alert>

		{error && (
			<Alert color="red" client:load>
				{error}
			</Alert>
		)}

		<ProductsTable
			client:load
			products={products}
			currentPage={page}
			totalPages={meta.totalPages}
			searchQuery={q}
			statusFilter={status}
			apiBase={apiBase}
			apiKey={import.meta.env.ADMIN_API_KEY}
		/>
	</Alert>
</AdminLayout>
