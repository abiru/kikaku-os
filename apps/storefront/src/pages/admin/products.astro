---
export const prerender = false;

import Badge from '../../components/Badge.astro';
import Button from '../../components/Button.astro';
import AdminLayout from '../../layouts/AdminLayout.astro';
import { getApiBase } from '../../lib/api';

const apiBase = getApiBase();
const q = Astro.url.searchParams.get('q') || '';
const status = Astro.url.searchParams.get('status') || 'all';
const page = Number(Astro.url.searchParams.get('page') || '1');
const perPage = 20;

let products: any[] = [];
let meta = { totalCount: 0, totalPages: 1 };
let error = null;

// SSR Data Fetching
if (import.meta.env.ADMIN_API_KEY) {
	try {
		const query = new URLSearchParams({
			q,
			status,
			page: page.toString(),
			perPage: perPage.toString()
		});

		const res = await fetch(`${apiBase}/admin/products?${query}`, {
			headers: {
				'x-admin-key': import.meta.env.ADMIN_API_KEY
			}
		});

		if (!res.ok) {
			throw new Error(`API Error: ${res.status}`);
		}

		const data = await res.json();
		products = data.products || [];
		meta = data.meta || meta;
	} catch (e) {
		console.error(e);
		error = 'Failed to load products. Please check your admin key.';
	}
} else {
	error = 'ADMIN_API_KEY is missing in server environment.';
}

const hasNext = page < meta.totalPages;
const hasPrev = page > 1;
---

<AdminLayout title="Products - Admin">
	<div class="space-y-6">
		<div class="flex items-center justify-between">
			<div class="flex items-center gap-4">
				<h1 class="text-2xl font-semibold text-zinc-900">Products</h1>
				<span class="text-xs text-zinc-500 bg-zinc-100 px-2 py-1 rounded-full">{meta.totalCount} items</span>
			</div>
			<Button href="/admin/products/new" size="sm" variant="primary">
				+ New Product
			</Button>
		</div>

		{/* Status Filter Tabs */}
		<div class="flex gap-2">
			<a
				href="?status=all"
				class={`px-4 py-2 text-sm rounded-lg ${status === 'all' ? 'bg-zinc-900 text-white' : 'bg-zinc-100 text-zinc-900'}`}
			>
				All
			</a>
			<a
				href="?status=active"
				class={`px-4 py-2 text-sm rounded-lg ${status === 'active' ? 'bg-zinc-900 text-white' : 'bg-zinc-100 text-zinc-900'}`}
			>
				Active
			</a>
			<a
				href="?status=draft"
				class={`px-4 py-2 text-sm rounded-lg ${status === 'draft' ? 'bg-zinc-900 text-white' : 'bg-zinc-100 text-zinc-900'}`}
			>
				Draft
			</a>
			<a
				href="?status=archived"
				class={`px-4 py-2 text-sm rounded-lg ${status === 'archived' ? 'bg-zinc-900 text-white' : 'bg-zinc-100 text-zinc-900'}`}
			>
				Archived
			</a>
		</div>

		{/* Search Bar */}
		<div class="mb-6">
			<form method="get" class="relative max-w-md">
				<input
					type="search"
					name="q"
					value={q}
					placeholder="Search by title..."
					class="w-full pl-10 pr-4 py-2 bg-white border border-zinc-200 rounded-lg text-sm text-zinc-900 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all"
				/>
				<svg
					class="absolute left-3 top-2.5 h-4 w-4 text-zinc-400"
					fill="none"
					stroke="currentColor"
					viewBox="0 0 24 24"
				>
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
				</svg>
			</form>
		</div>

		{error && (
			<div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg mb-6 text-sm">
				{error}
			</div>
		)}

		{/* Product Table */}
		<div class="bg-white rounded-lg ring-1 ring-zinc-900/5 overflow-hidden">
			<div class="overflow-x-auto">
				<table class="w-full text-left text-sm text-zinc-900">
					<thead class="bg-zinc-50 border-b border-zinc-200">
						<tr>
							<th class="px-6 py-3 font-medium text-zinc-500">Title</th>
							<th class="px-6 py-3 font-medium text-zinc-500">Status</th>
							<th class="px-6 py-3 font-medium text-zinc-500">Updated</th>
							<th class="px-6 py-3 font-medium text-zinc-500 text-right">Action</th>
						</tr>
					</thead>
					<tbody class="divide-y divide-zinc-100">
						{products.length > 0 ? (
							products.map((product) => (
								<tr class="hover:bg-zinc-50 transition-colors group">
									<td class="px-6 py-4">
										<div class="font-medium">{product.title}</div>
										<div class="text-xs text-zinc-500 truncate max-w-xs">{product.description}</div>
									</td>
									<td class="px-6 py-4">
										{product.status === 'draft' ? (
											<Badge severity="secondary">Draft</Badge>
										) : product.status === 'archived' ? (
											<Badge severity="critical">Archived</Badge>
										) : (
											<Badge severity="info">Active</Badge>
										)}
									</td>
									<td class="px-6 py-4 text-zinc-500 tabular-nums">
										{new Date(product.updated_at).toLocaleDateString()}
									</td>
									<td class="px-6 py-4 text-right">
										<div class="flex items-center justify-end gap-2">
											<a href={`/admin/products/${product.id}`} class="text-emerald-500 hover:underline font-medium">
												Edit
											</a>
											{product.status !== 'archived' && (
												<button
													type="button"
													class="archive-product-btn text-red-500 hover:underline text-sm"
													data-product-id={product.id}
													data-product-title={product.title}
												>
													Archive
												</button>
											)}
											{product.status === 'archived' && (
												<button
													type="button"
													class="restore-product-btn text-green-600 hover:underline text-sm"
													data-product-id={product.id}
													data-product-title={product.title}
												>
													Restore
												</button>
											)}
										</div>
									</td>
								</tr>
							))
						) : (
							<tr>
								<td colspan="4" class="px-6 py-12 text-center text-zinc-500">
									No products found.
								</td>
							</tr>
						)}
					</tbody>
				</table>
			</div>

			{/* Pagination */}
			<div class="border-t border-zinc-200 px-6 py-4 flex items-center justify-between">
				<div class="text-xs text-zinc-500">
					Page {page} of {meta.totalPages}
				</div>
				<div class="flex gap-2">
					<Button
						href={hasPrev ? `?page=${page - 1}&q=${q}&status=${status}` : '#'}
						disabled={!hasPrev}
						size="sm"
						variant="secondary"
					>
						Previous
					</Button>
					<Button
						href={hasNext ? `?page=${page + 1}&q=${q}&status=${status}` : '#'}
						disabled={!hasNext}
						size="sm"
						variant="secondary"
					>
						Next
					</Button>
				</div>
			</div>
		</div>
	</div>
</AdminLayout>

<script define:vars={{ apiBase, apiKey: import.meta.env.ADMIN_API_KEY }}>
	// Archive handler
	document.addEventListener('click', async (e) => {
		const archiveBtn = e.target.closest('.archive-product-btn');
		if (archiveBtn) {
			const productId = archiveBtn.dataset.productId;
			const productTitle = archiveBtn.dataset.productTitle;

			if (!confirm(`Archive "${productTitle}"?`)) return;

			try {
				const res = await fetch(`${apiBase}/admin/products/${productId}`, {
					method: 'DELETE',
					headers: { 'x-admin-key': apiKey }
				});

				if (res.ok) {
					location.reload();
				} else {
					const data = await res.json();
					alert(data.message || 'Failed to archive');
				}
			} catch (err) {
				alert('Failed to archive product');
			}
		}

		// Restore handler
		const restoreBtn = e.target.closest('.restore-product-btn');
		if (restoreBtn) {
			const productId = restoreBtn.dataset.productId;
			const productTitle = restoreBtn.dataset.productTitle;

			if (!confirm(`Restore "${productTitle}"?`)) return;

			try {
				const res = await fetch(`${apiBase}/admin/products/${productId}/restore`, {
					method: 'POST',
					headers: { 'x-admin-key': apiKey }
				});

				if (res.ok) {
					location.reload();
				} else {
					const data = await res.json();
					alert(data.message || 'Failed to restore');
				}
			} catch (err) {
				alert('Failed to restore product');
			}
		}
	});
</script>
