---
export const prerender = false;

import AdminLayout from '../../../layouts/AdminLayout.astro';
import { Alert } from '../../../components/catalyst/alert-banner';
import Button from '../../../components/Button.astro';
import { AdDraftForm } from '../../../components/admin/ads/AdDraftForm';
import { getApiBase } from '../../../lib/api';

const { id } = Astro.params;
const apiKey = import.meta.env.ADMIN_API_KEY;
const apiBase = getApiBase();

let draft: any | null = null;
let error: string | null = null;

if (apiKey && id) {
  try {
    const response = await fetch(`${apiBase}/admin/ads/drafts/${id}`, {
      headers: { 'x-admin-key': apiKey },
    });

    if (response.ok) {
      const data = await response.json();
      draft = data.draft;
    } else if (response.status === 404) {
      error = 'Ad draft not found';
    } else {
      error = 'Failed to load ad draft';
    }
  } catch (e) {
    error = 'Failed to connect to API';
    console.error(e);
  }
}
---

<AdminLayout title={draft ? `Edit: ${draft.campaign_name}` : 'Edit Ad Draft'}>
  <div class="max-w-6xl mx-auto px-6 py-8">
    {/* Header */}
    <div class="flex items-center gap-4 mb-8">
      <a href="/admin/ads" class="text-[#0071e3] hover:underline text-sm flex items-center gap-1">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
        </svg>
        Back to Ads
      </a>
      <h1 class="text-3xl font-semibold text-zinc-950 dark:text-white">
        {draft ? `Edit: ${draft.campaign_name}` : 'Edit Ad Draft'}
      </h1>
    </Alert>

    {/* Error Message */}
    {error && (
      <Alert color="red" client:load>
        {error}
      </Alert>
    )}

    {draft && (
      <div class="space-y-6">
        {/* Quick Actions */}
        <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4 flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">
              Last updated: {new Date(draft.updated_at).toLocaleString('ja-JP')}
            </p>
          </Alert>
          <div class="flex gap-2">
            <Button href={`/admin/ads/${id}/history`} variant="secondary" size="sm">
              View History
            </Button>
          </Alert>
        </Alert>

        {/* Edit Form */}
        <AdDraftForm
          client:load
          initialDraft={draft}
          apiKey={apiKey}
          apiBase={apiBase}
          draftId={parseInt(id || '0', 10)}
        />

        {/* Danger Zone - Delete */}
        <div class="bg-white rounded-xl border border-red-200 shadow-sm p-6">
          <h3 class="text-lg font-semibold text-red-600 mb-3">Danger Zone</h3>
          <p class="text-sm text-gray-600 mb-4">
            Once you delete this draft, there is no going back. Please be certain.
          </p>
          <button
            id="delete-btn"
            class="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 transition-colors"
          >
            Delete Draft
          </button>
        </Alert>
      </Alert>
    )}
  </Alert>

  {draft && (
    <script define:vars={{ apiKey, apiBase, id }}>
      const deleteBtn = document.getElementById('delete-btn');

      deleteBtn?.addEventListener('click', async () => {
        if (!confirm('Are you sure you want to delete this ad draft? This action cannot be undone.')) {
          return;
        }

        try {
          const response = await fetch(`${apiBase}/admin/ads/drafts/${id}`, {
            method: 'DELETE',
            headers: { 'x-admin-key': apiKey },
          });

          if (response.ok) {
            window.location.href = '/admin/ads';
          } else {
            const data = await response.json();
            alert(`Failed to delete: ${data.message || 'Unknown error'}`);
          }
        } catch (error) {
          alert(`Error: ${error.message}`);
        }
      });
    </script>
  )}
</AdminLayout>
