---
export const prerender = false;

import AdminLayout from '../../../layouts/AdminLayout.astro';
import { Alert } from '../../../components/catalyst/alert-banner';
import { AdDraftForm } from '../../../components/admin/ads/AdDraftForm';
import { getApiBase } from '../../../lib/api';

const apiKey = import.meta.env.ADMIN_API_KEY;
const apiBase = getApiBase();
---

<AdminLayout title="Create Ad Draft">
  <div class="max-w-6xl mx-auto px-6 py-8">
    {/* Header */}
    <div class="flex items-center gap-4 mb-8">
      <a href="/admin/ads" class="text-[#0071e3] hover:underline text-sm flex items-center gap-1">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
        </svg>
        Back to Ads
      </a>
      <h1 class="text-3xl font-semibold text-zinc-950 dark:text-white">Create Ad Draft</h1>
    </Alert>

    {/* AI Generation Section */}
    <div id="ai-generation-section" class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 mb-6">
      <h2 class="text-xl font-semibold text-zinc-950 dark:text-white mb-4">AI Ad Generation</h2>
      <p class="text-sm text-gray-600 mb-6">
        Generate multiple ad variations using AI. Fill in the product details below and click "Generate with AI".
      </p>

      <form id="generate-form" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="gen_productName" class="block text-sm font-medium text-zinc-950 dark:text-white mb-2">
              Product Name <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="gen_productName"
              required
              class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20"
            />
          </Alert>

          <div>
            <label for="gen_finalUrl" class="block text-sm font-medium text-zinc-950 dark:text-white mb-2">
              Landing Page URL <span class="text-red-500">*</span>
            </label>
            <input
              type="url"
              id="gen_finalUrl"
              required
              placeholder="https://example.com/product"
              class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20"
            />
          </Alert>
        </Alert>

        <div>
          <label for="gen_productDescription" class="block text-sm font-medium text-zinc-950 dark:text-white mb-2">
            Product Description <span class="text-red-500">*</span>
          </label>
          <textarea
            id="gen_productDescription"
            required
            rows="3"
            class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20"
          ></textarea>
        </Alert>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="gen_targetAudience" class="block text-sm font-medium text-zinc-950 dark:text-white mb-2">
              Target Audience <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="gen_targetAudience"
              required
              placeholder="e.g., Small business owners"
              class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20"
            />
          </Alert>

          <div>
            <label for="gen_keywords" class="block text-sm font-medium text-zinc-950 dark:text-white mb-2">
              Keywords <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="gen_keywords"
              required
              placeholder="keyword1, keyword2, keyword3"
              class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20"
            />
          </Alert>
        </Alert>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label for="gen_tone" class="block text-sm font-medium text-zinc-950 dark:text-white mb-2">
              Tone
            </label>
            <select
              id="gen_tone"
              class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20"
            >
              <option value="professional">Professional</option>
              <option value="casual">Casual</option>
              <option value="urgent">Urgent</option>
              <option value="informative">Informative</option>
            </select>
          </Alert>

          <div>
            <label for="gen_language" class="block text-sm font-medium text-zinc-950 dark:text-white mb-2">
              Language
            </label>
            <select
              id="gen_language"
              class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20"
            >
              <option value="ja">Japanese</option>
              <option value="en">English</option>
            </select>
          </Alert>

          <div>
            <label for="gen_adType" class="block text-sm font-medium text-zinc-950 dark:text-white mb-2">
              Ad Type
            </label>
            <select
              id="gen_adType"
              class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20"
            >
              <option value="search">Search</option>
              <option value="display">Display</option>
              <option value="performance_max">Performance Max</option>
            </select>
          </Alert>
        </Alert>

        <div>
          <button
            type="submit"
            id="generate-btn"
            class="px-6 py-3 bg-[#0071e3] text-white rounded-lg font-medium hover:bg-[#0077ed] transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Generate with AI
          </button>
        </Alert>
      </form>

      <div id="generation-error" class="hidden mt-4 bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm">
      </Alert>

      <div id="generation-loading" class="hidden mt-6 text-center py-8">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-[#0071e3]"></div>
        <p class="mt-4 text-sm text-gray-600">Generating ad variations with AI...</p>
        <p class="mt-2 text-xs text-gray-500">Results will be sent to inbox for review.</p>
      </Alert>
    </Alert>

    {/* Manual Form Section */}
    <div id="form-section">
      <h2 class="text-xl font-semibold text-zinc-950 dark:text-white mb-4">Ad Details</h2>
      <p class="text-sm text-gray-600 mb-6">
        Fill in the ad details manually or use AI generation above to auto-populate.
      </p>

      <AdDraftForm
        client:load
        apiKey={apiKey}
        apiBase={apiBase}
      />
    </Alert>
  </Alert>

  <script define:vars={{ apiKey, apiBase }}>
    const generateForm = document.getElementById('generate-form');
    const generateBtn = document.getElementById('generate-btn');
    const loadingDiv = document.getElementById('generation-loading');
    const errorDiv = document.getElementById('generation-error');

    generateForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const productName = document.getElementById('gen_productName').value;
      const productDescription = document.getElementById('gen_productDescription').value;
      const targetAudience = document.getElementById('gen_targetAudience').value;
      const keywordsStr = document.getElementById('gen_keywords').value;
      const tone = document.getElementById('gen_tone').value;
      const language = document.getElementById('gen_language').value;
      const adType = document.getElementById('gen_adType').value;
      const finalUrl = document.getElementById('gen_finalUrl').value;

      const keywords = keywordsStr.split(',').map((k) => k.trim()).filter((k) => k);

      if (keywords.length === 0) {
        errorDiv.textContent = 'Please enter at least one keyword';
        errorDiv.classList.remove('hidden');
        return;
      }

      // Show loading, hide error
      loadingDiv.classList.remove('hidden');
      errorDiv.classList.add('hidden');
      generateBtn.disabled = true;

      try {
        const response = await fetch(`${apiBase}/admin/ads/generate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': apiKey,
          },
          body: JSON.stringify({
            productName,
            productDescription,
            targetAudience,
            keywords,
            tone,
            language,
            adType,
            finalUrl,
          }),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Failed to generate ad copy');
        }

        // Hide loading
        loadingDiv.classList.add('hidden');

        // Redirect to inbox for human review (following "AIは信頼しない" principle)
        alert('Ad copy generated successfully! Redirecting to inbox for review...');
        window.location.href = '/admin/inbox';

      } catch (error) {
        loadingDiv.classList.add('hidden');
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
      } finally {
        generateBtn.disabled = false;
      }
    });
  </script>
</AdminLayout>
