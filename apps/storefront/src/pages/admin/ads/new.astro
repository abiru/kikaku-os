---
export const prerender = false;

import AdminLayout from '../../../layouts/AdminLayout.astro';
import Button from '../../../components/Button.astro';
import { AdDraftForm } from '../../../components/admin/ads/AdDraftForm';
import { GeneratedCandidates } from '../../../components/admin/ads/GeneratedCandidates';
import { getApiBase } from '../../../lib/api';

const apiKey = import.meta.env.ADMIN_API_KEY;
const apiBase = getApiBase();
---

<AdminLayout title="Create Ad Draft">
  <div class="max-w-6xl mx-auto px-6 py-8">
    {/* Header */}
    <div class="flex items-center gap-4 mb-8">
      <a href="/admin/ads" class="text-[#0071e3] hover:underline text-sm flex items-center gap-1">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
        </svg>
        Back to Ads
      </a>
      <h1 class="text-3xl font-semibold text-[#1d1d1f]">Create Ad Draft</h1>
    </div>

    {/* AI Generation Section */}
    <div id="ai-generation-section" class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 mb-6">
      <h2 class="text-xl font-semibold text-[#1d1d1f] mb-4">AI Ad Generation</h2>
      <p class="text-sm text-gray-600 mb-6">
        Generate multiple ad variations using AI. Fill in the product details below and click "Generate with AI".
      </p>

      <form id="generate-form" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="gen_productName" class="block text-sm font-medium text-[#1d1d1f] mb-2">
              Product Name <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="gen_productName"
              required
              class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20"
            />
          </div>

          <div>
            <label for="gen_finalUrl" class="block text-sm font-medium text-[#1d1d1f] mb-2">
              Landing Page URL <span class="text-red-500">*</span>
            </label>
            <input
              type="url"
              id="gen_finalUrl"
              required
              placeholder="https://example.com/product"
              class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20"
            />
          </div>
        </div>

        <div>
          <label for="gen_productDescription" class="block text-sm font-medium text-[#1d1d1f] mb-2">
            Product Description <span class="text-red-500">*</span>
          </label>
          <textarea
            id="gen_productDescription"
            required
            rows="3"
            class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20"
          ></textarea>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="gen_targetAudience" class="block text-sm font-medium text-[#1d1d1f] mb-2">
              Target Audience <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="gen_targetAudience"
              required
              placeholder="e.g., Small business owners"
              class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20"
            />
          </div>

          <div>
            <label for="gen_keywords" class="block text-sm font-medium text-[#1d1d1f] mb-2">
              Keywords <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="gen_keywords"
              required
              placeholder="keyword1, keyword2, keyword3"
              class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20"
            />
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label for="gen_tone" class="block text-sm font-medium text-[#1d1d1f] mb-2">
              Tone
            </label>
            <select
              id="gen_tone"
              class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20"
            >
              <option value="professional">Professional</option>
              <option value="casual">Casual</option>
              <option value="urgent">Urgent</option>
              <option value="informative">Informative</option>
            </select>
          </div>

          <div>
            <label for="gen_language" class="block text-sm font-medium text-[#1d1d1f] mb-2">
              Language
            </label>
            <select
              id="gen_language"
              class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20"
            >
              <option value="ja">Japanese</option>
              <option value="en">English</option>
            </select>
          </div>

          <div>
            <label for="gen_adType" class="block text-sm font-medium text-[#1d1d1f] mb-2">
              Ad Type
            </label>
            <select
              id="gen_adType"
              class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3]/20"
            >
              <option value="search">Search</option>
              <option value="display">Display</option>
              <option value="performance_max">Performance Max</option>
            </select>
          </div>
        </div>

        <div>
          <button
            type="submit"
            id="generate-btn"
            class="px-6 py-3 bg-[#0071e3] text-white rounded-lg font-medium hover:bg-[#0077ed] transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Generate with AI
          </button>
        </div>
      </form>

      <div id="generation-error" class="hidden mt-4 bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm">
      </div>

      <div id="generation-loading" class="hidden mt-6 text-center py-8">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-[#0071e3]"></div>
        <p class="mt-4 text-sm text-gray-600">Generating ad variations with AI...</p>
      </div>

      <div id="candidates-container" class="hidden mt-6">
      </div>
    </div>

    {/* Manual Form Section */}
    <div id="form-section">
      <h2 class="text-xl font-semibold text-[#1d1d1f] mb-4">Ad Details</h2>
      <p class="text-sm text-gray-600 mb-6">
        Fill in the ad details manually or use AI generation above to auto-populate.
      </p>

      <AdDraftForm
        client:load
        apiKey={apiKey}
        apiBase={apiBase}
      />
    </div>
  </div>

  <script define:vars={{ apiKey, apiBase }}>
    const generateForm = document.getElementById('generate-form');
    const generateBtn = document.getElementById('generate-btn');
    const loadingDiv = document.getElementById('generation-loading');
    const errorDiv = document.getElementById('generation-error');
    const candidatesContainer = document.getElementById('candidates-container');

    generateForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const productName = document.getElementById('gen_productName').value;
      const productDescription = document.getElementById('gen_productDescription').value;
      const targetAudience = document.getElementById('gen_targetAudience').value;
      const keywordsStr = document.getElementById('gen_keywords').value;
      const tone = document.getElementById('gen_tone').value;
      const language = document.getElementById('gen_language').value;
      const adType = document.getElementById('gen_adType').value;
      const finalUrl = document.getElementById('gen_finalUrl').value;

      const keywords = keywordsStr.split(',').map((k) => k.trim()).filter((k) => k);

      if (keywords.length === 0) {
        errorDiv.textContent = 'Please enter at least one keyword';
        errorDiv.classList.remove('hidden');
        return;
      }

      // Show loading, hide error and candidates
      loadingDiv.classList.remove('hidden');
      errorDiv.classList.add('hidden');
      candidatesContainer.classList.add('hidden');
      generateBtn.disabled = true;

      try {
        const response = await fetch(`${apiBase}/admin/ads/generate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': apiKey,
          },
          body: JSON.stringify({
            productName,
            productDescription,
            targetAudience,
            keywords,
            tone,
            language,
            adType,
            finalUrl,
          }),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Failed to generate ad copy');
        }

        // Hide loading
        loadingDiv.classList.add('hidden');

        // Display candidates
        displayCandidates(data.candidates, language);

      } catch (error) {
        loadingDiv.classList.add('hidden');
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
      } finally {
        generateBtn.disabled = false;
      }
    });

    function displayCandidates(candidates, language) {
      const limits = language === 'ja'
        ? { headline: 15, description: 45 }
        : { headline: 30, description: 90 };

      candidatesContainer.innerHTML = `
        <h3 class="text-lg font-semibold text-[#1d1d1f] mb-4">AI Generated Candidates</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          ${candidates.map((candidate, index) => `
            <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
              <div class="flex items-center justify-between mb-3">
                <span class="text-sm font-medium text-gray-500">Variation ${index + 1}</span>
              </div>

              <div class="mb-4">
                <h4 class="text-xs font-semibold text-gray-700 mb-2">Headlines (${candidate.headlines.length})</h4>
                <div class="space-y-1">
                  ${candidate.headlines.slice(0, 5).map(h => `
                    <div class="text-sm text-gray-800">${h}</div>
                  `).join('')}
                  ${candidate.headlines.length > 5 ? `<p class="text-xs text-gray-500">+${candidate.headlines.length - 5} more...</p>` : ''}
                </div>
              </div>

              <div class="mb-4">
                <h4 class="text-xs font-semibold text-gray-700 mb-2">Descriptions</h4>
                <div class="space-y-1">
                  ${candidate.descriptions.map(d => `
                    <div class="text-sm text-gray-600">${d}</div>
                  `).join('')}
                </div>
              </div>

              <button
                type="button"
                class="use-candidate-btn w-full px-4 py-2 bg-[#0071e3] text-white rounded-lg text-sm font-medium hover:bg-[#0077ed] transition-colors"
                data-index="${index}"
              >
                Use This Candidate
              </button>
            </div>
          `).join('')}
        </div>
      `;

      candidatesContainer.classList.remove('hidden');

      // Add event listeners to "Use" buttons
      document.querySelectorAll('.use-candidate-btn').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.target.dataset.index, 10);
          const candidate = candidates[index];

          // Populate form (scroll to form section)
          document.getElementById('form-section').scrollIntoView({ behavior: 'smooth' });

          // Trigger custom event to populate form
          window.dispatchEvent(new CustomEvent('populate-form', {
            detail: { candidate }
          }));

          // Show success message
          alert('Candidate loaded into form! You can now edit and save.');
        });
      });
    }
  </script>
</AdminLayout>
