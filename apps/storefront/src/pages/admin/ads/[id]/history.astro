---
export const prerender = false;

import AdminLayout from '../../../../layouts/AdminLayout.astro';
import { Alert } from '../../../../components/catalyst/alert-banner';
import { Badge } from '../../../../components/catalyst/badge';
import { Button } from '../../../../components/catalyst/button';
import { getApiBase } from '../../../../lib/api';

const { id } = Astro.params;
const apiKey = import.meta.env.ADMIN_API_KEY;
const apiBase = getApiBase();

let draft: any | null = null;
let history: any[] = [];
let error: string | null = null;

if (apiKey && id) {
  try {
    // Fetch draft
    const draftResponse = await fetch(`${apiBase}/admin/ads/drafts/${id}`, {
      headers: { 'x-admin-key': apiKey },
    });

    if (draftResponse.ok) {
      const draftData = await draftResponse.json();
      draft = draftData.draft;
    }

    // Fetch history
    const historyResponse = await fetch(`${apiBase}/admin/ads/drafts/${id}/history`, {
      headers: { 'x-admin-key': apiKey },
    });

    if (historyResponse.ok) {
      const historyData = await historyResponse.json();
      history = historyData.history || [];
    } else if (historyResponse.status === 404) {
      error = 'Draft not found';
    }
  } catch (e) {
    error = 'Failed to load history';
    console.error(e);
  }
}

const formatDate = (dateStr: string) => {
  return new Date(dateStr).toLocaleString('ja-JP', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
  });
};
---

<AdminLayout title={draft ? `History: ${draft.campaign_name}` : 'Generation History'}>
  <div class="max-w-7xl mx-auto px-6 py-8">
    {/* Header */}
    <div class="flex items-center gap-4 mb-8">
      <a href={`/admin/ads/${id}`} class="text-[#0071e3] hover:underline text-sm flex items-center gap-1">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
        </svg>
        Back to Draft
      </a>
      <h1 class="text-3xl font-semibold text-zinc-950">
        Generation History
      </h1>
    </Alert>

    {draft && (
      <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4 mb-6">
        <p class="text-sm text-gray-600">
          <span class="font-medium">Campaign:</span> {draft.campaign_name}
        </p>
      </Alert>
    )}

    {error && (
      <Alert color="red" client:load>
        {error}
      </Alert>
    )}

    {history.length === 0 ? (
      <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-16 text-center">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <h3 class="mt-4 text-lg font-medium text-gray-900">No generation history</h3>
        <p class="mt-1 text-sm text-gray-500">
          No AI generations have been created for this draft yet.
        </p>
      </Alert>
    ) : (
      <div class="space-y-4">
        {history.map((item) => {
          let candidates = [];
          try {
            const content = JSON.parse(item.generated_content);
            candidates = content.candidates || [];
          } catch (e) {
            console.error('Failed to parse generated_content:', e);
          }

          return (
            <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
              <div class="flex items-start justify-between mb-4">
                <div>
                  <div class="flex items-center gap-2 mb-2">
                    <span class="text-sm text-gray-500">{formatDate(item.created_at)}</span>
                    {item.selected === 1 && (
                      <Badge color="blue" client:load>Selected</Badge>
                    )}
                  </Alert>
                </Alert>
                <button
                  class="adopt-btn px-3 py-1 text-sm bg-[#0071e3] text-white rounded-lg hover:bg-[#0077ed] transition-colors"
                  data-history-id={item.id}
                >
                  Adopt This Version
                </button>
              </Alert>

              {/* Candidates */}
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                {candidates.map((candidate: any, idx: number) => (
                  <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="text-sm font-semibold text-gray-700 mb-2">Variation {idx + 1}</h4>

                    <div class="mb-3">
                      <p class="text-xs text-gray-500 mb-1">Headlines ({candidate.headlines?.length || 0})</p>
                      <div class="space-y-1">
                        {(candidate.headlines || []).slice(0, 3).map((h: string) => (
                          <p class="text-xs text-gray-700">{h}</p>
                        ))}
                        {candidate.headlines?.length > 3 && (
                          <p class="text-xs text-gray-400">+{candidate.headlines.length - 3} more...</p>
                        )}
                      </Alert>
                    </Alert>

                    <div>
                      <p class="text-xs text-gray-500 mb-1">Descriptions ({candidate.descriptions?.length || 0})</p>
                      <div class="space-y-1">
                        {(candidate.descriptions || []).slice(0, 2).map((d: string) => (
                          <p class="text-xs text-gray-600">{d}</p>
                        ))}
                      </Alert>
                    </Alert>
                  </Alert>
                ))}
              </Alert>
            </Alert>
          );
        })}
      </Alert>
    )}
  </Alert>

  <script define:vars={{ id }}>
    document.querySelectorAll('.adopt-btn').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        const historyId = parseInt(e.target.dataset.historyId, 10);

        if (!confirm('Adopt this version? This will replace the current draft content.')) {
          return;
        }

        try {
          const response = await fetch(`/api/admin/ads/drafts/${id}/select-history`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ historyId }),
          });

          if (response.ok) {
            window.location.href = `/admin/ads/${id}`;
          } else {
            const data = await response.json();
            alert(`Failed to adopt: ${data.message || 'Unknown error'}`);
          }
        } catch (error) {
          alert(`Error: ${error.message}`);
        }
      });
    });
  </script>
</AdminLayout>
