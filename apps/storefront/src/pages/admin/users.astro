---
export const prerender = false;

import AdminLayout from '../../layouts/AdminLayout.astro';
import { Alert } from '../../components/catalyst/alert-banner';
import { adminFetchList } from '../../lib/admin/fetchAdmin';
import { Heading } from '../../components/catalyst/heading';
import UsersTable from '../../components/admin/UsersTable';
import { t } from '../../i18n';

const q = Astro.url.searchParams.get('q') || '';
const roleFilter = Astro.url.searchParams.get('role') || '';
const activeFilter = Astro.url.searchParams.get('active') || 'all';
const page = Number(Astro.url.searchParams.get('page') || '1');
const perPage = 20;

type AdminUser = {
	id: number;
	clerk_user_id: string;
	email: string;
	name: string | null;
	role_id: string;
	role_name: string;
	role_priority: number;
	is_active: number;
	last_login_at: string | null;
	created_at: string;
	updated_at: string;
};

type Role = {
	id: string;
	name: string;
	description: string | null;
	priority: number;
};

// Fetch roles for filter dropdown
const { data: rolesData } = await adminFetchList<{ roles: Role[] }>('/admin/roles');
const roles = rolesData?.roles || [];

// Fetch users
const query = new URLSearchParams({
	q,
	page: page.toString(),
	perPage: perPage.toString(),
	active: activeFilter
});
if (roleFilter) {
	query.set('role', roleFilter);
}

const { data, error: fetchError } = await adminFetchList<{ users: AdminUser[]; meta: { totalCount: number; totalPages: number } }>('/admin/users', query);
const users = data?.users || [];
const meta = data?.meta || { totalCount: 0, totalPages: 1 };
const error: string | null = fetchError ? t('errors.failedToLoadUsers') : null;
---

<AdminLayout title={`${t('admin.users')} - Admin`}>
	<div class="space-y-6">
		<div class="flex items-center justify-between gap-4">
			<div class="flex items-center gap-4">
				<Heading>{t('admin.adminUsers')}</Heading>
				<span class="text-xs text-zinc-500 bg-zinc-100 px-2 py-1 rounded-full">{meta.totalCount} {t('admin.users')}</span>
			</div>
			<a
				href="/admin/users/new"
				class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-indigo-600 text-white text-sm font-medium hover:bg-indigo-700 transition-colors"
			>
				<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
				</svg>
				{t('admin.addUser')}
			</a>
		</div>

		{/* Filters */}
		<div class="flex flex-wrap items-center gap-4">
			{/* Search */}
			<form method="get" class="relative flex-1 max-w-md">
					<input type="hidden" name="role" value={roleFilter} />
					<input type="hidden" name="active" value={activeFilter} />
					<label for="user-search" class="sr-only">{t('admin.searchByNameOrEmail')}</label>
					<input
						type="search"
						id="user-search"
					name="q"
					value={q}
					placeholder={t('admin.searchByNameOrEmail')}
					class="w-full pl-10 pr-4 py-2 bg-white border border-zinc-200 rounded-lg text-sm text-zinc-950 placeholder:text-zinc-500 focus:outline-none focus:ring-2 focus:ring-indigo-600/20 focus:border-indigo-600 transition-all shadow-sm"
				/>
				<svg
					class="absolute left-3 top-2.5 h-4 w-4 text-zinc-400"
					fill="none"
					stroke="currentColor"
					viewBox="0 0 24 24"
				>
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
				</svg>
			</form>

			{/* Role Filter */}
			<label for="role-filter" class="sr-only">Filter by role</label>
			<select
				id="role-filter"
				aria-label="Filter by role"
				onchange="window.location.href = window.location.pathname + '?q=' + encodeURIComponent(document.querySelector('[name=q]').value) + '&role=' + this.value + '&active=' + document.querySelector('[name=activeFilter]').value"
				class="px-3 py-2 bg-white border border-zinc-200 rounded-lg text-sm text-zinc-950 focus:outline-none focus:ring-2 focus:ring-indigo-600/20 focus:border-indigo-600"
			>
				<option value="" selected={!roleFilter}>{t('admin.allRoles')}</option>
				{roles.map(role => (
					<option value={role.id} selected={roleFilter === role.id}>{role.name}</option>
				))}
			</select>

			{/* Active Filter */}
			<label for="active-filter" class="sr-only">Filter by status</label>
			<select
				id="active-filter"
				name="activeFilter"
				aria-label="Filter by status"
				onchange="window.location.href = window.location.pathname + '?q=' + encodeURIComponent(document.querySelector('[name=q]').value) + '&role=' + (document.querySelector('[name=roleSelect]')?.value || '') + '&active=' + this.value"
				class="px-3 py-2 bg-white border border-zinc-200 rounded-lg text-sm text-zinc-950 focus:outline-none focus:ring-2 focus:ring-indigo-600/20 focus:border-indigo-600"
			>
				<option value="all" selected={activeFilter === 'all'}>{t('admin.allStatus')}</option>
				<option value="true" selected={activeFilter === 'true'}>{t('admin.active')}</option>
				<option value="false" selected={activeFilter === 'false'}>{t('admin.inactive')}</option>
			</select>
		</div>

		{error && (
			<Alert color="red" client:load>
				{error}
			</Alert>
		)}

		<UsersTable
			users={users}
			currentPage={page}
			totalPages={meta.totalPages}
			searchQuery={q}
			roleFilter={roleFilter}
			activeFilter={activeFilter}
			client:visible
		/>
	</div>
</AdminLayout>
