---
export const prerender = false;

import { Alert } from '../../../components/catalyst/alert-banner';
import { Input } from '../../../components/catalyst/input';
import { Textarea } from '../../../components/catalyst/textarea';
import { Select } from '../../../components/catalyst/select';
import { Field, Label, Description } from '../../../components/catalyst/fieldset';
import { Button } from '../../../components/catalyst/button';
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getApiBase } from '../../../lib/api';

const apiBase = getApiBase();
const apiKey = import.meta.env.ADMIN_API_KEY;

type Page = {
	id: number;
	slug: string;
	title: string;
	meta_title: string | null;
	meta_description: string | null;
	body: string;
	status: string;
	created_at: string;
	updated_at: string;
};

let error: string | null = null;
let page: Page | null = null;

// Handle POST - Create page
if (Astro.request.method === 'POST' && apiKey) {
	try {
		const formData = await Astro.request.formData();
		const slug = formData.get('slug')?.toString().trim().toLowerCase() || '';
		const title = formData.get('title')?.toString().trim() || '';
		const meta_title = formData.get('meta_title')?.toString().trim() || '';
		const meta_description = formData.get('meta_description')?.toString().trim() || '';
		const body = formData.get('body')?.toString() || '';
		const status = formData.get('status')?.toString() || 'draft';

		if (!slug) {
			error = 'Slug is required';
		} else if (!/^[a-z0-9-]+$/.test(slug)) {
			error = 'Slug must contain only lowercase letters, numbers, and hyphens';
		} else if (!title) {
			error = 'Title is required';
		} else {
			const res = await fetch(`${apiBase}/admin/pages`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'x-admin-key': apiKey
				},
				body: JSON.stringify({
					slug,
					title,
					meta_title: meta_title || null,
					meta_description: meta_description || null,
					body,
					status
				})
			});

			const data = await res.json();

			if (!res.ok) {
				error = data.message || 'Failed to create page';
			} else {
				page = data.page;
				// Redirect to edit page
				return Astro.redirect(`/admin/pages/${page.id}`);
			}
		}
	} catch (e) {
		console.error(e);
		error = 'Failed to create page. Please check your connection.';
	}
}

if (!apiKey) {
	error = 'ADMIN_API_KEY is missing in server environment';
}
---

<AdminLayout title="New Page - Admin">
	<div class="space-y-6 max-w-4xl">
		<div class="flex items-center gap-4">
			<a href="/admin/pages" class="text-[#0071e3] hover:underline text-sm flex items-center gap-1">
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
				</svg>
				Pages
			</a>
			<h1 class="text-2xl font-semibold text-gray-900">New Page</h1>
		</div>
			{error && (
				<Alert color="red" client:load>
					{error}
				</Alert>
			)}

			<form method="POST" class="space-y-6">
				{/* Basic Info */}
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6">
					<h2 class="text-sm font-medium text-[#86868b]">Basic Information</h2>

					<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
						<Field>
							<Label>
								Title <span class="text-red-500">*</span>
							</Label>
							<Input
								type="text"
								id="title"
								name="title"
								required
								placeholder="Page Title"
								client:load
							/>
						</Field>

						<div>
							<Field>
								<Label>
									Slug <span class="text-red-500">*</span>
								</Label>
								<div class="flex items-center gap-2">
									<span class="text-sm text-[#86868b]">/</span>
									<Input
										type="text"
										id="slug"
										name="slug"
										required
										placeholder="page-slug"
										pattern="^[a-z0-9-]+$"
										class="flex-1 font-mono"
										client:load
									/>
								</div>
								<Description>Only lowercase letters, numbers, and hyphens</Description>
							</Field>
						</div>

						<Field>
							<Label>Status</Label>
							<Select
								id="status"
								name="status"
								client:load
							>
								<option value="draft" selected>Draft</option>
								<option value="published">Published</option>
							</Select>
						</Field>
					</div>
				</div>

				{/* SEO */}
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6">
					<h2 class="text-sm font-medium text-[#86868b]">SEO Settings</h2>

					<div class="space-y-6">
						<Field>
							<Label>Meta Title</Label>
							<Input
								type="text"
								id="meta_title"
								name="meta_title"
								placeholder="Page Title - Site Name"
								maxlength="255"
								client:load
							/>
							<Description>Used as the browser tab title and in search results</Description>
						</Field>

						<Field>
							<Label>Meta Description</Label>
							<Textarea
								id="meta_description"
								name="meta_description"
								rows={2}
								maxlength="500"
								placeholder="Brief description of the page content..."
								client:load
							/>
							<Description>Displayed in search engine results</Description>
						</Field>
					</div>
				</div>

				{/* Content */}
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6">
					<div class="flex items-center justify-between">
						<h2 class="text-sm font-medium text-[#86868b]">Page Content (Markdown)</h2>
						<button
							type="button"
							id="preview-toggle"
							class="text-sm text-[#0071e3] hover:underline"
						>
							Toggle Preview
						</button>
					</div>

					<div id="editor-container">
						<Field>
							<Textarea
								id="body"
								name="body"
								rows={20}
								placeholder="# Heading 1

## Heading 2

**Bold text** and *italic text*

- List item 1
- List item 2

[Link text](https://example.com)

> Blockquote

```
Code block
```"
								class="font-mono resize-y"
								client:load
							/>
							<Description>
								Supports Markdown syntax. HTML is also valid within Markdown.
							</Description>
						</Field>
					</div>

					<div id="preview-container" class="hidden">
						<div id="preview-content" class="min-h-[300px] p-4 border border-gray-200 rounded-lg bg-white prose prose-sm max-w-none">
							<p class="text-[#86868b]">Preview will appear here...</p>
						</div>
					</div>
				</div>

				{/* Actions */}
				<div class="flex justify-end gap-3">
					<Button href="/admin/pages" color="zinc" client:load>
						Cancel
					</Button>
					<Button type="submit" color="indigo" client:load>
						Create Page
					</Button>
				</div>
			</form>
	</Alert>
</AdminLayout>

<script>
	import { marked } from 'marked';
	import DOMPurify from 'isomorphic-dompurify';

	const previewToggle = document.getElementById('preview-toggle');
	const editorContainer = document.getElementById('editor-container');
	const previewContainer = document.getElementById('preview-container');
	const bodyTextarea = document.getElementById('body') as HTMLTextAreaElement;
	const previewContent = document.getElementById('preview-content');

	let showPreview = false;

	previewToggle?.addEventListener('click', async () => {
		showPreview = !showPreview;

		if (showPreview) {
			editorContainer?.classList.add('hidden');
			previewContainer?.classList.remove('hidden');
			if (previewContent && bodyTextarea) {
				const markdown = bodyTextarea.value;
				if (!markdown || markdown.trim() === '') {
					previewContent.innerHTML = '<p class="text-[#86868b]">No content to preview...</p>';
				} else {
					try {
						const html = await marked.parse(markdown);
						// Sanitize HTML to prevent XSS
						const sanitized = DOMPurify.sanitize(html, {
							ALLOWED_TAGS: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'br', 'strong', 'em', 'u', 's', 'a', 'ul', 'ol', 'li', 'blockquote', 'code', 'pre', 'hr', 'table', 'thead', 'tbody', 'tr', 'th', 'td', 'img', 'div', 'span'],
							ALLOWED_ATTR: ['href', 'target', 'rel', 'src', 'alt', 'title', 'class', 'id'],
							ALLOW_DATA_ATTR: false,
						});
						previewContent.innerHTML = sanitized;
					} catch (error) {
						console.error('Failed to parse markdown:', error);
						previewContent.innerHTML = '<p class="text-red-500">Failed to parse markdown. Please check your syntax.</p>';
					}
				}
			}
			previewToggle.textContent = 'Edit';
		} else {
			editorContainer?.classList.remove('hidden');
			previewContainer?.classList.add('hidden');
			previewToggle.textContent = 'Toggle Preview';
		}
	});

	// Auto-generate slug from title
	const titleInput = document.getElementById('title') as HTMLInputElement;
	const slugInput = document.getElementById('slug') as HTMLInputElement;

	titleInput?.addEventListener('input', () => {
		if (!slugInput.value || slugInput.dataset.autoGenerated === 'true') {
			const slug = titleInput.value
				.toLowerCase()
				.replace(/[^a-z0-9\s-]/g, '')
				.replace(/\s+/g, '-')
				.replace(/-+/g, '-')
				.replace(/^-|-$/g, '');
			slugInput.value = slug;
			slugInput.dataset.autoGenerated = 'true';
		}
	});

	slugInput?.addEventListener('input', () => {
		slugInput.dataset.autoGenerated = 'false';
	});
</script>
