---
export const prerender = false;

import { Badge } from '../../../components/catalyst/badge';
import { Alert } from '../../../components/catalyst/alert-banner';
import { Input } from '../../../components/catalyst/input';
import { Textarea } from '../../../components/catalyst/textarea';
import { Select } from '../../../components/catalyst/select';
import { Field, Label, Description } from '../../../components/catalyst/fieldset';
import { Button } from '../../../components/catalyst/button';
import AdminLayout from '../../../layouts/AdminLayout.astro';
import ConfirmDialog from '../../../components/admin/ConfirmDialog.astro';
import { getApiBase } from '../../../lib/api';
import { formatDate } from '../../../lib/format';
import { DATE_FORMATS } from '../../../lib/constants';
import { handlePageUpdate } from '../../../lib/admin/page-actions';
import { fetchAdminResource } from '../../../lib/admin/fetch-helpers';
import { t } from '../../../i18n';

const { id } = Astro.params;
const apiBase = getApiBase();
const apiKey = import.meta.env.ADMIN_API_KEY;

type Page = {
	id: number;
	slug: string;
	title: string;
	meta_title: string | null;
	meta_description: string | null;
	body: string;
	status: string;
	created_at: string;
	updated_at: string;
};

let page: Page | null = null;
let isCorePage = false;
let error: string | null = null;
let successMessage: string | null = null;

// Handle POST - Update page
if (Astro.request.method === 'POST' && apiKey) {
	const formData = await Astro.request.formData();
	const result = await handlePageUpdate(formData, apiBase, apiKey, id!, t);
	page = result.page as Page | null;
	error = result.error;
	successMessage = result.successMessage;
}

// Fetch page data (also re-fetches isCorePage after update)
type PageResponse = { page: Page; isCorePage?: boolean }

if (apiKey) {
	const { data, error: fetchError } = await fetchAdminResource<PageResponse>({
		apiBase,
		apiKey,
		resource: 'pages',
		id: id!,
		notFoundMessage: 'Page not found',
		errorMessage: 'Failed to load page. Please check your connection.',
	});
	if (data) {
		if (!page) page = data.page;
		isCorePage = data.isCorePage || false;
	}
	if (!page) error = error || fetchError;
}

const dateTimeOpts = DATE_FORMATS.DATETIME;

const canDelete = page && !isCorePage;
---

<AdminLayout title={page ? `${page.title} - Admin` : 'Page - Admin'}>
	<div class="space-y-6 max-w-4xl">
		<div class="flex items-center gap-4">
			<a href="/admin/pages" class="text-brand hover:underline text-sm flex items-center gap-1">
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
				</svg>
				Pages
			</a>
			<h1 class="typo-h2 text-gray-900">
				{page ? `Edit: ${page.title}` : 'Page'}
			</h1>
			{page && (
				<a
					href={`/${page.slug}`}
					target="_blank"
					class="text-xs text-secondary hover:text-brand flex items-center gap-1"
				>
					<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
					</svg>
					View page
				</a>
			)}
		</div>
		{successMessage && (
			<div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-6 text-sm">
				{successMessage}
			</div>
		)}

		{error && !page && (
			<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-8 text-center">
				<div class="text-red-600 mb-4">{error}</div>
				<Button href="/admin/pages" color="zinc" client:load>
					Back to Pages
				</Button>
			</div>
		)}

		{error && page && (
			<Alert color="red" client:load>
				{error}
			</Alert>
		)}

		{page && (
			<form method="POST" class="space-y-6">
				{/* Status Card */}
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
					<div class="flex items-center justify-between">
						<div class="flex items-center gap-4">
							{page.status === 'published' ? (
								<Badge color="blue" client:load data-status-badge>{t('admin.published')}</Badge>
							) : (
								<Badge color="zinc" client:load data-status-badge>{t('admin.draft')}</Badge>
							)}
							{isCorePage && (
								<span class="text-xs text-secondary bg-gray-100 px-2 py-1 rounded">Core page</span>
							)}
						</div>
						<div class="flex gap-2">
							<button
								type="button"
								id="publish-btn"
								class={`px-4 py-2 text-sm font-medium rounded-lg transition-colors ${page.status === 'published' ? 'bg-yellow-100 text-yellow-700 hover:bg-yellow-200' : 'bg-green-100 text-green-700 hover:bg-green-200'}`}
							>
								{page.status === 'published' ? t('admin.unpublish') : t('admin.publish')}
							</button>
						</div>
					</div>
				</div>

				{/* Basic Info */}
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6">
					<h2 class="text-sm font-medium text-secondary">Basic Information</h2>

					<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
						<Field>
							<Label>
								Title <span class="text-red-500">*</span>
							</Label>
							<Input
								type="text"
								id="title"
								name="title"
								required
								value={page.title}
								client:load
							/>
						</Field>

						<div>
							<Field>
								<Label>
									Slug <span class="text-red-500">*</span>
								</Label>
								<div class="flex items-center gap-2">
									<span class="text-sm text-secondary">/</span>
									<Input
										type="text"
										id="slug"
										name="slug"
										required
										value={page.slug}
										pattern="^[a-z0-9-]+$"
										className="flex-1 font-mono"
										client:load
									/>
								</div>
								<p data-slot="description" class="text-base/6 text-zinc-500 sm:text-sm/6">Only lowercase letters, numbers, and hyphens</p>
							</Field>
						</div>

						<Field>
							<Label>Status</Label>
							<Select
								id="status"
								name="status"
								client:load
							>
								<option value="draft" selected={page.status === 'draft'}>{t('admin.draft')}</option>
								<option value="published" selected={page.status === 'published'}>{t('admin.published')}</option>
							</Select>
						</Field>
					</div>
				</div>

				{/* SEO */}
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6">
					<h2 class="text-sm font-medium text-secondary">SEO Settings</h2>

					<div class="space-y-6">
						<Field>
							<Label>Meta Title</Label>
							<Input
								type="text"
								id="meta_title"
								name="meta_title"
								value={page.meta_title || ''}
								placeholder="Page Title - Site Name"
								maxLength={255}
								client:load
							/>
							<p data-slot="description" class="text-base/6 text-zinc-500 sm:text-sm/6">Used as the browser tab title and in search results</p>
						</Field>

						<Field>
							<Label>Meta Description</Label>
							<Textarea
								id="meta_description"
								name="meta_description"
								rows={2}
								maxLength={500}
								placeholder="Brief description of the page content..."
								client:load
							>{page.meta_description || ''}</Textarea>
							<p data-slot="description" class="text-base/6 text-zinc-500 sm:text-sm/6">Displayed in search engine results</p>
						</Field>
					</div>
				</div>

				{/* Content */}
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6">
					<div class="flex items-center justify-between">
						<h2 class="text-sm font-medium text-secondary">Page Content (Markdown)</h2>
						<button
							type="button"
							id="preview-toggle"
							class="text-sm text-brand hover:underline"
						>
							Toggle Preview
						</button>
					</div>

					<div id="editor-container">
						<Field>
							<Textarea
								id="body"
								name="body"
								rows={20}
								placeholder={`# Heading 1

## Heading 2

**Bold text** and *italic text*

- List item 1
- List item 2

[Link text](https://example.com)

> Blockquote

\`\`\`
Code block
\`\`\``}
								className="font-mono resize-y"
								client:load
							>{page.body}</Textarea>
							<p data-slot="description" class="text-base/6 text-zinc-500 sm:text-sm/6">
								Supports Markdown syntax. HTML is also valid within Markdown.
							</p>
						</Field>
					</div>

					<div id="preview-container" class="hidden">
						<div id="preview-content" class="min-h-[300px] p-4 border border-gray-200 rounded-lg bg-white prose prose-sm max-w-none">
							<p class="text-secondary">Preview will appear here...</p>
						</div>
					</div>
				</div>

				{/* Meta Info */}
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
					<dl class="grid grid-cols-2 gap-4 text-sm">
						<div>
							<dt class="text-secondary">Created</dt>
							<dd class="text-zinc-950 tabular-nums">{formatDate(page.created_at, dateTimeOpts)}</dd>
						</div>
						<div>
							<dt class="text-secondary">Updated</dt>
							<dd class="text-zinc-950 tabular-nums">{formatDate(page.updated_at, dateTimeOpts)}</dd>
						</div>
					</dl>
				</div>

				{/* Actions */}
				<div class="flex justify-between items-center gap-3">
					<div>
						{canDelete ? (
							<button
								type="button"
								id="delete-btn"
								class="text-sm text-red-500 hover:underline"
							>
								Delete Page
							</button>
						) : isCorePage ? (
							<span class="text-sm text-secondary">Core pages cannot be deleted</span>
						) : null}
					</div>
					<div class="flex gap-3">
						<Button href="/admin/pages" color="zinc" client:load>
							Back
						</Button>
						<Button type="submit" color="indigo" client:load>
							Save Changes
						</Button>
					</div>
				</div>
			</form>
		)}
	</div>
	<ConfirmDialog />
</AdminLayout>

<script define:vars={{ pageId: id, canDelete, currentStatus: page?.status, pageTitle: page?.title, i18nPublish: t('admin.publish'), i18nUnpublish: t('admin.unpublish'), i18nPublished: t('admin.published'), i18nDraft: t('admin.draft') }}>
	// Store server variables in window for module script access
	window.__PAGE_CONFIG__ = { pageId, canDelete, currentStatus, pageTitle, i18nPublish, i18nUnpublish, i18nPublished, i18nDraft };
</script>

<script>
	import { initPageDetailPage } from '../../../lib/admin/page-detail';

	const config = (window as any).__PAGE_CONFIG__;

	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', () => initPageDetailPage(config));
	} else {
		initPageDetailPage(config);
	}
</script>
