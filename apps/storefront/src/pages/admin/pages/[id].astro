---
export const prerender = false;

import { Badge } from '../../../components/catalyst/badge';
import { Alert } from '../../../components/catalyst/alert-banner';
import { Input } from '../../../components/catalyst/input';
import { Textarea } from '../../../components/catalyst/textarea';
import { Select } from '../../../components/catalyst/select';
import { Field, Label, Description } from '../../../components/catalyst/fieldset';
import { Button } from '../../../components/catalyst/button';
import AdminLayout from '../../../layouts/AdminLayout.astro';
import ConfirmDialog from '../../../components/admin/ConfirmDialog.astro';
import { getApiBase } from '../../../lib/api';
import { formatDate } from '../../../lib/format';
import { DATE_FORMATS } from '../../../lib/constants';
import { handlePageUpdate } from '../../../lib/admin/page-actions';
import { logError } from '../../../lib/logger';
import { t } from '../../../i18n';

const { id } = Astro.params;
const apiBase = getApiBase();
const apiKey = import.meta.env.ADMIN_API_KEY;

type Page = {
	id: number;
	slug: string;
	title: string;
	meta_title: string | null;
	meta_description: string | null;
	body: string;
	status: string;
	created_at: string;
	updated_at: string;
};

let page: Page | null = null;
let isCorePage = false;
let error: string | null = null;
let successMessage: string | null = null;

// Handle POST - Update page
if (Astro.request.method === 'POST' && apiKey) {
	const formData = await Astro.request.formData();
	const result = await handlePageUpdate(formData, apiBase, apiKey, id!, t);
	page = result.page as Page | null;
	error = result.error;
	successMessage = result.successMessage;
}

// Fetch page data
if (!page && apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/pages/${id}`, {
			headers: { 'x-admin-key': apiKey }
		});

		if (!res.ok) {
			if (res.status === 404) {
				error = 'Page not found';
			} else {
				const data = await res.json();
				error = data.message || `API Error: ${res.status}`;
			}
		} else {
			const data = await res.json();
			page = data.page;
			isCorePage = data.isCorePage || false;
		}
	} catch (e) {
		logError('Failed to load page', e, { page: 'admin/pages/[id]', action: 'fetchPage', resourceId: id });
		error = error || 'Failed to load page. Please check your connection.';
	}
} else if (!apiKey) {
	error = 'ADMIN_API_KEY is missing in server environment';
}

// Re-fetch isCorePage after update
if (page && apiKey && successMessage) {
	try {
		const res = await fetch(`${apiBase}/admin/pages/${id}`, {
			headers: { 'x-admin-key': apiKey }
		});
		if (res.ok) {
			const data = await res.json();
			isCorePage = data.isCorePage || false;
		}
	} catch (e) {
		logError('Failed to fetch page info', e, { page: 'admin/pages/[id]', action: 'refetchPageInfo', resourceId: id });
	}
}

const dateTimeOpts = DATE_FORMATS.DATETIME;

const canDelete = page && !isCorePage;
---

<AdminLayout title={page ? `${page.title} - Admin` : 'Page - Admin'}>
	<div class="space-y-6 max-w-4xl">
		<div class="flex items-center gap-4">
			<a href="/admin/pages" class="text-brand hover:underline text-sm flex items-center gap-1">
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
				</svg>
				Pages
			</a>
			<h1 class="text-2xl font-semibold text-gray-900">
				{page ? `Edit: ${page.title}` : 'Page'}
			</h1>
			{page && (
				<a
					href={`/${page.slug}`}
					target="_blank"
					class="text-xs text-secondary hover:text-brand flex items-center gap-1"
				>
					<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
					</svg>
					View page
				</a>
			)}
		</div>
		{successMessage && (
			<div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-6 text-sm">
				{successMessage}
			</div>
		)}

		{error && !page && (
			<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-8 text-center">
				<div class="text-red-600 mb-4">{error}</div>
				<Button href="/admin/pages" color="zinc" client:load>
					Back to Pages
				</Button>
			</div>
		)}

		{error && page && (
			<Alert color="red" client:load>
				{error}
			</Alert>
		)}

		{page && (
			<form method="POST" class="space-y-6">
				{/* Status Card */}
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
					<div class="flex items-center justify-between">
						<div class="flex items-center gap-4">
							{page.status === 'published' ? (
								<Badge color="blue" client:load data-status-badge>{t('admin.published')}</Badge>
							) : (
								<Badge color="zinc" client:load data-status-badge>{t('admin.draft')}</Badge>
							)}
							{isCorePage && (
								<span class="text-xs text-secondary bg-gray-100 px-2 py-1 rounded">Core page</span>
							)}
						</div>
						<div class="flex gap-2">
							<button
								type="button"
								id="publish-btn"
								class={`px-4 py-2 text-sm font-medium rounded-lg transition-colors ${page.status === 'published' ? 'bg-yellow-100 text-yellow-700 hover:bg-yellow-200' : 'bg-green-100 text-green-700 hover:bg-green-200'}`}
							>
								{page.status === 'published' ? t('admin.unpublish') : t('admin.publish')}
							</button>
						</div>
					</div>
				</div>

				{/* Basic Info */}
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6">
					<h2 class="text-sm font-medium text-secondary">Basic Information</h2>

					<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
						<Field>
							<Label>
								Title <span class="text-red-500">*</span>
							</Label>
							<Input
								type="text"
								id="title"
								name="title"
								required
								value={page.title}
								client:load
							/>
						</Field>

						<div>
							<Field>
								<Label>
									Slug <span class="text-red-500">*</span>
								</Label>
								<div class="flex items-center gap-2">
									<span class="text-sm text-secondary">/</span>
									<Input
										type="text"
										id="slug"
										name="slug"
										required
										value={page.slug}
										pattern="^[a-z0-9-]+$"
										className="flex-1 font-mono"
										client:load
									/>
								</div>
								<p data-slot="description" class="text-base/6 text-zinc-500 sm:text-sm/6">Only lowercase letters, numbers, and hyphens</p>
							</Field>
						</div>

						<Field>
							<Label>Status</Label>
							<Select
								id="status"
								name="status"
								client:load
							>
								<option value="draft" selected={page.status === 'draft'}>{t('admin.draft')}</option>
								<option value="published" selected={page.status === 'published'}>{t('admin.published')}</option>
							</Select>
						</Field>
					</div>
				</div>

				{/* SEO */}
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6">
					<h2 class="text-sm font-medium text-secondary">SEO Settings</h2>

					<div class="space-y-6">
						<Field>
							<Label>Meta Title</Label>
							<Input
								type="text"
								id="meta_title"
								name="meta_title"
								value={page.meta_title || ''}
								placeholder="Page Title - Site Name"
								maxLength={255}
								client:load
							/>
							<p data-slot="description" class="text-base/6 text-zinc-500 sm:text-sm/6">Used as the browser tab title and in search results</p>
						</Field>

						<Field>
							<Label>Meta Description</Label>
							<Textarea
								id="meta_description"
								name="meta_description"
								rows={2}
								maxLength={500}
								placeholder="Brief description of the page content..."
								client:load
							>{page.meta_description || ''}</Textarea>
							<p data-slot="description" class="text-base/6 text-zinc-500 sm:text-sm/6">Displayed in search engine results</p>
						</Field>
					</div>
				</div>

				{/* Content */}
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6">
					<div class="flex items-center justify-between">
						<h2 class="text-sm font-medium text-secondary">Page Content (Markdown)</h2>
						<button
							type="button"
							id="preview-toggle"
							class="text-sm text-brand hover:underline"
						>
							Toggle Preview
						</button>
					</div>

					<div id="editor-container">
						<Field>
							<Textarea
								id="body"
								name="body"
								rows={20}
								placeholder={`# Heading 1

## Heading 2

**Bold text** and *italic text*

- List item 1
- List item 2

[Link text](https://example.com)

> Blockquote

\`\`\`
Code block
\`\`\``}
								className="font-mono resize-y"
								client:load
							>{page.body}</Textarea>
							<p data-slot="description" class="text-base/6 text-zinc-500 sm:text-sm/6">
								Supports Markdown syntax. HTML is also valid within Markdown.
							</p>
						</Field>
					</div>

					<div id="preview-container" class="hidden">
						<div id="preview-content" class="min-h-[300px] p-4 border border-gray-200 rounded-lg bg-white prose prose-sm max-w-none">
							<p class="text-secondary">Preview will appear here...</p>
						</div>
					</div>
				</div>

				{/* Meta Info */}
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
					<dl class="grid grid-cols-2 gap-4 text-sm">
						<div>
							<dt class="text-secondary">Created</dt>
							<dd class="text-zinc-950 tabular-nums">{formatDate(page.created_at, dateTimeOpts)}</dd>
						</div>
						<div>
							<dt class="text-secondary">Updated</dt>
							<dd class="text-zinc-950 tabular-nums">{formatDate(page.updated_at, dateTimeOpts)}</dd>
						</div>
					</dl>
				</div>

				{/* Actions */}
				<div class="flex justify-between items-center gap-3">
					<div>
						{canDelete ? (
							<button
								type="button"
								id="delete-btn"
								class="text-sm text-red-500 hover:underline"
							>
								Delete Page
							</button>
						) : isCorePage ? (
							<span class="text-sm text-secondary">Core pages cannot be deleted</span>
						) : null}
					</div>
					<div class="flex gap-3">
						<Button href="/admin/pages" color="zinc" client:load>
							Back
						</Button>
						<Button type="submit" color="indigo" client:load>
							Save Changes
						</Button>
					</div>
				</div>
			</form>
		)}
	</div>
	<ConfirmDialog />
</AdminLayout>

<script define:vars={{ pageId: id, canDelete, currentStatus: page?.status, pageTitle: page?.title, i18nPublish: t('admin.publish'), i18nUnpublish: t('admin.unpublish'), i18nPublished: t('admin.published'), i18nDraft: t('admin.draft') }}>
	// Store server variables in window for module script access
	window.__PAGE_CONFIG__ = { pageId, canDelete, currentStatus, pageTitle, i18nPublish, i18nUnpublish, i18nPublished, i18nDraft };
</script>

<script type="module">
	import { marked } from 'marked';
	import DOMPurify from 'isomorphic-dompurify';
	import { logError } from '../../../lib/logger';

	const { pageId, canDelete, currentStatus, pageTitle, i18nPublish, i18nUnpublish, i18nPublished, i18nDraft } = window.__PAGE_CONFIG__;

	const deleteBtn = document.getElementById('delete-btn');
	const publishBtn = document.getElementById('publish-btn');
	const previewToggle = document.getElementById('preview-toggle');
	const editorContainer = document.getElementById('editor-container');
	const previewContainer = document.getElementById('preview-container');
	const bodyTextarea = document.getElementById('body');
	const previewContent = document.getElementById('preview-content');

	let showPreview = false;

	// Preview toggle
	previewToggle?.addEventListener('click', async () => {
		showPreview = !showPreview;

		if (showPreview) {
			editorContainer?.classList.add('hidden');
			previewContainer?.classList.remove('hidden');
			if (previewContent && bodyTextarea) {
				const markdown = bodyTextarea.value;
				if (!markdown || markdown.trim() === '') {
					previewContent.innerHTML = '<p class="text-secondary">No content to preview...</p>';
				} else {
					try {
						const html = await marked.parse(markdown);
						// Sanitize HTML to prevent XSS
						const sanitized = DOMPurify.sanitize(html, {
							ALLOWED_TAGS: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'br', 'strong', 'em', 'u', 's', 'a', 'ul', 'ol', 'li', 'blockquote', 'code', 'pre', 'hr', 'table', 'thead', 'tbody', 'tr', 'th', 'td', 'img', 'div', 'span'],
							ALLOWED_ATTR: ['href', 'target', 'rel', 'src', 'alt', 'title', 'class', 'id'],
							ALLOW_DATA_ATTR: false,
						});
						previewContent.innerHTML = sanitized;
					} catch (error) {
						logError('Failed to parse markdown', error, { page: 'admin/pages/[id]', action: 'previewMarkdown' });
						previewContent.innerHTML = '<p class="text-red-500">Failed to parse markdown. Please check your syntax.</p>';
					}
				}
			}
			previewToggle.textContent = 'Edit';
		} else {
			editorContainer?.classList.remove('hidden');
			previewContainer?.classList.add('hidden');
			previewToggle.textContent = 'Toggle Preview';
		}
	});

	// Delete button
	if (deleteBtn && canDelete) {
		deleteBtn.addEventListener('click', async () => {
			const confirmed = await window.__confirmDialog({
				title: 'Delete Page',
				message: `Are you sure you want to delete "${pageTitle}"? This action cannot be undone.`,
				confirmLabel: 'Delete',
				danger: true,
			});
			if (!confirmed) return;

			try {
				const res = await fetch(`/api/admin/pages/${pageId}`, {
					method: 'DELETE',
				});

				if (res.ok) {
					window.location.href = '/admin/pages';
				} else {
					const data = await res.json();
					alert(data.message || 'Failed to delete page');
				}
			} catch (e) {
				alert('Failed to delete page. Please try again.');
			}
		});
	}

	// Publish/Unpublish button
	if (publishBtn) {
		publishBtn.addEventListener('click', async () => {
			const action = window.__PAGE_CONFIG__.currentStatus === 'published' ? 'unpublish' : 'publish';

			try {
				const res = await fetch(`/api/admin/pages/${pageId}/${action}`, {
					method: 'POST',
				});

				if (res.ok) {
					const newStatus = action === 'publish' ? 'published' : 'draft';
					window.__PAGE_CONFIG__.currentStatus = newStatus;

					publishBtn.textContent = newStatus === 'published' ? i18nUnpublish : i18nPublish;
					publishBtn.className = newStatus === 'published'
						? 'px-4 py-2 text-sm font-medium rounded-lg transition-colors bg-yellow-100 text-yellow-700 hover:bg-yellow-200'
						: 'px-4 py-2 text-sm font-medium rounded-lg transition-colors bg-green-100 text-green-700 hover:bg-green-200';

					const statusCard = publishBtn.closest('.bg-white');
					const badge = statusCard?.querySelector('[data-status-badge]');
					if (badge) {
						badge.textContent = newStatus === 'published' ? i18nPublished : i18nDraft;
						badge.className = 'inline-flex items-center gap-x-1.5 rounded-md px-1.5 py-0.5 text-sm/5 font-medium sm:text-xs/5 forced-colors:outline '
							+ (newStatus === 'published'
								? 'bg-blue-500/15 text-blue-700 group-data-hover:bg-blue-500/25'
								: 'bg-zinc-600/10 text-zinc-700 group-data-hover:bg-zinc-600/20');
					}

					const statusSelect = document.getElementById('status');
					if (statusSelect) {
						statusSelect.value = newStatus;
					}
				} else {
					const data = await res.json();
					alert(data.message || `Failed to ${action} page`);
				}
			} catch (e) {
				alert(`Failed to ${action} page. Please try again.`);
			}
		});
	}
</script>
