---
export const prerender = false;

import AdminLayout from '../../layouts/AdminLayout.astro';
import AdminKpiCards from '../../components/admin/AdminKpiCards.astro';
import AdminRecentOrders from '../../components/admin/AdminRecentOrders.astro';
import { Alert } from '../../components/catalyst/alert-banner';
import { Badge } from '../../components/catalyst/badge';
import { Button } from '../../components/catalyst/button';
import { Heading, Subheading } from '../../components/catalyst/heading';
import { getApiBase } from '../../lib/api';
import { formatDate } from '../../lib/format';
import { t } from '../../i18n';

const apiBase = getApiBase();

type DashboardData = {
	today: { orders: number; revenue: number; refunds: number };
	week: { orders: number; revenue: number; refunds: number };
	pending: { inbox: number; unfulfilled: number };
	recentOrders: Array<{
		id: number;
		customer_email: string | null;
		total_net: number;
		currency: string;
		status: string;
		created_at: string;
	}>;
	recentInbox: Array<{
		id: number;
		title: string;
		severity: string;
		kind: string;
		created_at: string;
	}>;
};

type AnalyticsData = {
	dailySales: Array<{ date: string; orders: number; revenue: number }>;
	customerBreakdown: { newCustomers: number; returningCustomers: number };
	summary: { totalRevenue: number; totalOrders: number; averageOrderValue: number };
};

type LowStockItem = {
	variant_id: number;
	on_hand: number;
	threshold: number;
	variant_title?: string;
	product_title?: string;
};

let data: DashboardData | null = null;
let analyticsData: AnalyticsData | null = null;
let lowStockItems: LowStockItem[] = [];
let lowStockCount = 0;
let error: string | null = null;

// Get period from query params (default: 7 days)
const periodParam = Astro.url.searchParams.get('period') || '7';
const period = ['7', '30', '90'].includes(periodParam) ? parseInt(periodParam) : 7;

// Calculate date range for analytics
const today = new Date();
const todayStr = today.toISOString().slice(0, 10);
const fromDate = new Date(today);
fromDate.setDate(fromDate.getDate() - (period - 1));
const fromStr = fromDate.toISOString().slice(0, 10);

const periodLabels: Record<number, string> = {
	7: t('admin.nDays', { n: '7' }),
	30: t('admin.nDays', { n: '30' }),
	90: t('admin.nDays', { n: '90' }),
};

if (import.meta.env.ADMIN_API_KEY) {
	try {
		// Fetch dashboard data, analytics, and low stock in parallel
		const [dashboardRes, analyticsRes, lowStockRes] = await Promise.all([
			fetch(`${apiBase}/admin/dashboard`, {
				headers: { 'x-admin-key': import.meta.env.ADMIN_API_KEY }
			}),
			fetch(`${apiBase}/admin/analytics?from=${fromStr}&to=${todayStr}`, {
				headers: { 'x-admin-key': import.meta.env.ADMIN_API_KEY }
			}),
			fetch(`${apiBase}/inventory/low?limit=10`, {
				headers: { 'x-admin-key': import.meta.env.ADMIN_API_KEY }
			})
		]);

		if (!dashboardRes.ok) throw new Error(`Dashboard API Error: ${dashboardRes.status}`);
		if (!analyticsRes.ok) throw new Error(`Analytics API Error: ${analyticsRes.status}`);

		const dashboardJson = await dashboardRes.json();
		const analyticsJson = await analyticsRes.json();

		data = dashboardJson as DashboardData;
		if (analyticsJson.ok) {
			analyticsData = analyticsJson as AnalyticsData;
		}

		if (lowStockRes.ok) {
			const lowStockJson = await lowStockRes.json() as { items?: LowStockItem[] };
			lowStockItems = lowStockJson.items || [];
			lowStockCount = lowStockItems.length;
		}
	} catch (e) {
		console.error(e);
		error = t('errors.failedToLoadDashboard');
	}
} else {
	error = t('errors.adminKeyMissing');
}

const formatCurrency = (amount: number, currency = 'JPY') => {
	return new Intl.NumberFormat('ja-JP', { style: 'currency', currency }).format(amount);
};

const getSeverityColor = (severity: string) => {
	switch (severity) {
		case 'critical': return 'red' as const;
		case 'warning': return 'amber' as const;
		default: return 'blue' as const;
	}
};
---

<AdminLayout title={`${t('admin.dashboard')} - Admin`}>
	<div class="space-y-8">
		<div>
			<Heading>{t('admin.dashboard')}</Heading>
		</div>

		{error && (
			<Alert color="red" client:load>
				{error}
			</Alert>
		)}

			{data && (
				<>
					{/* KPI Cards */}
					<AdminKpiCards
						todayOrders={data.today.orders}
						todayRevenue={data.today.revenue}
						pendingInbox={data.pending.inbox}
						unfulfilled={data.pending.unfulfilled}
						formatCurrency={formatCurrency}
					/>

					{/* Sales Chart */}
					{analyticsData && (
						<div class="bg-white rounded-xl border border-zinc-200 p-6 shadow-sm">
							<div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4">
								<Subheading>{t('admin.salesTrend')} ({t('admin.past', { period: periodLabels[period] ?? period.toString() })})</Subheading>
								<div class="flex items-center gap-2">
									<div class="flex rounded-lg border border-zinc-200 p-0.5">
										{[7, 30, 90].map((p) => (
											<a
												href={`?period=${p}`}
												class={`px-3 py-1 text-xs font-medium rounded-md transition-colors ${
													period === p
														? 'bg-indigo-600 text-white'
														: 'text-zinc-600 hover:bg-zinc-100'
												}`}
											>
												{p}D
											</a>
										))}
									</div>
									<div class="hidden sm:flex items-center gap-3 ml-4 text-xs text-zinc-500">
										<span class="flex items-center gap-1">
											<span class="w-3 h-0.5 bg-indigo-500 rounded"></span>
											{t('admin.revenue')}
										</span>
										<span class="flex items-center gap-1">
											<span class="w-3 h-3 bg-emerald-500/80 rounded-sm"></span>
											{t('admin.orders')}
										</span>
									</div>
								</div>
							</div>
							{analyticsData.dailySales.length > 0 ? (
								<div class="h-64">
									<canvas id="salesChart"></canvas>
								</div>
							) : (
								<div class="h-64 flex items-center justify-center text-sm text-zinc-500">
									{t('admin.noSalesData')}
								</div>
							)}
						</div>
					)}

					{/* Week Summary */}
					<div class="bg-white rounded-xl border border-zinc-200 p-6 shadow-sm">
						<Subheading>{t('admin.thisWeek')}</Subheading>
						<div class="grid grid-cols-3 gap-6">
							<div>
								<p class="text-xs text-zinc-500 mb-1">{t('admin.orders')}</p>
								<p class="text-xl font-semibold text-zinc-950 tabular-nums">{data.week.orders}</p>
							</div>
							<div>
								<p class="text-xs text-zinc-500 mb-1">{t('admin.revenue')}</p>
								<p class="text-xl font-semibold text-zinc-950 tabular-nums">{formatCurrency(data.week.revenue)}</p>
							</div>
							<div>
								<p class="text-xs text-zinc-500 mb-1">{t('admin.refunds')}</p>
								<p class="text-xl font-semibold text-red-600 tabular-nums">{formatCurrency(data.week.refunds)}</p>
							</div>
						</div>
					</div>

					{/* Recent Activity */}
					<div class="grid lg:grid-cols-2 gap-6">
						{/* Recent Orders */}
						<AdminRecentOrders orders={data.recentOrders} formatCurrency={formatCurrency} />

						{/* Recent Inbox */}
						<div>
							<div class="px-6 py-4 border-b border-zinc-100 flex items-center justify-between">
								<Subheading>{t('admin.pendingInbox')}</Subheading>
								<Button client:load href="/admin/inbox" plain>{t('admin.viewAll')}</Button>
							</div>
							<div class="divide-y divide-zinc-100">
								{data.recentInbox.length > 0 ? (
									data.recentInbox.map((item) => (
										<a href="/admin/inbox" class="flex items-center justify-between px-6 py-3 hover:bg-zinc-50 transition-colors">
											<div class="flex items-center gap-3">
												<Badge client:load color={getSeverityColor(item.severity)}>
													{item.severity}
												</Badge>
												<span class="text-sm text-zinc-950 truncate max-w-[200px]">
													{item.title}
												</span>
											</div>
											<span class="text-xs text-zinc-500">
												{formatDate(item.created_at, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}
											</span>
										</a>
									))
								) : (
									<div class="px-6 py-8 text-center text-sm text-zinc-500">
										{t('admin.noPendingItems')}
									</div>
								)}
							</div>
						</div>
					</div>

					{/* Low Stock Alerts */}
					{lowStockCount > 0 && (
						<div class="bg-white rounded-xl border border-amber-200 shadow-sm overflow-hidden">
							<div class="px-6 py-4 border-b border-amber-100 flex items-center justify-between bg-amber-50">
								<div class="flex items-center gap-2">
									<svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
									</svg>
									<Subheading>{t('admin.lowStockAlerts')}</Subheading>
									<Badge client:load color="amber">{lowStockCount}</Badge>
								</div>
								<Button client:load href="/admin/inventory?status=low" plain>{t('admin.viewAll')}</Button>
							</div>
							<div class="divide-y divide-zinc-100">
								{lowStockItems.slice(0, 5).map((item) => (
									<div class="flex items-center justify-between px-6 py-3">
										<div class="flex flex-col">
											<span class="text-sm font-medium text-zinc-950">
												{item.product_title || `Variant #${item.variant_id}`}
											</span>
											{item.variant_title && (
												<span class="text-xs text-zinc-500">{item.variant_title}</span>
											)}
										</div>
										<div class="flex items-center gap-3">
											<div class="text-right">
												<span class="text-sm font-semibold tabular-nums text-zinc-950">{item.on_hand}</span>
												<span class="text-xs text-zinc-500"> / {item.threshold}</span>
											</div>
											<Badge client:load color={item.on_hand <= 0 ? 'red' : 'amber'}>
												{item.on_hand <= 0 ? t('admin.outOfStock') : t('admin.lowStock')}
											</Badge>
										</div>
									</div>
								))}
							</div>
						</div>
					)}
				</>
			)}
	</div>
</AdminLayout>

<!-- Pass analytics data to client-side script -->
<script id="analytics-data" type="application/json" set:html={JSON.stringify(analyticsData)}></script>

<script>
	import '../../scripts/adminDashboardChart';
</script>
