---
export const prerender = false;

import Badge from '../../components/Badge.astro';
import Button from '../../components/Button.astro';
import AdminLayout from '../../layouts/AdminLayout.astro';
import { getApiBase } from '../../lib/api';

const apiBase = getApiBase();

type DashboardData = {
	today: { orders: number; revenue: number; refunds: number };
	week: { orders: number; revenue: number; refunds: number };
	pending: { inbox: number; unfulfilled: number };
	recentOrders: Array<{
		id: number;
		customer_email: string | null;
		total_net: number;
		currency: string;
		status: string;
		created_at: string;
	}>;
	recentInbox: Array<{
		id: number;
		title: string;
		severity: string;
		kind: string;
		created_at: string;
	}>;
};

type DailySale = {
	date: string;
	orders: number;
	revenue: number;
};

type AnalyticsData = {
	dailySales: DailySale[];
	customerBreakdown: {
		newCustomers: number;
		returningCustomers: number;
	};
	summary: {
		totalRevenue: number;
		totalOrders: number;
		averageOrderValue: number;
	};
};

let data: DashboardData | null = null;
let analyticsData: AnalyticsData | null = null;
let error: string | null = null;

// Get period from query params (default: 7 days)
const periodParam = Astro.url.searchParams.get('period') || '7';
const period = ['7', '30', '90'].includes(periodParam) ? parseInt(periodParam) : 7;

// Calculate date range for analytics
const today = new Date();
const todayStr = today.toISOString().slice(0, 10);
const fromDate = new Date(today);
fromDate.setDate(fromDate.getDate() - (period - 1));
const fromStr = fromDate.toISOString().slice(0, 10);

const periodLabels: Record<number, string> = {
	7: '7 Days',
	30: '30 Days',
	90: '90 Days'
};

if (import.meta.env.ADMIN_API_KEY) {
	try {
		// Fetch dashboard data and analytics in parallel
		const [dashboardRes, analyticsRes] = await Promise.all([
			fetch(`${apiBase}/admin/dashboard`, {
				headers: { 'x-admin-key': import.meta.env.ADMIN_API_KEY }
			}),
			fetch(`${apiBase}/admin/analytics?from=${fromStr}&to=${todayStr}`, {
				headers: { 'x-admin-key': import.meta.env.ADMIN_API_KEY }
			})
		]);

		if (!dashboardRes.ok) throw new Error(`Dashboard API Error: ${dashboardRes.status}`);
		if (!analyticsRes.ok) throw new Error(`Analytics API Error: ${analyticsRes.status}`);

		const dashboardJson = await dashboardRes.json();
		const analyticsJson = await analyticsRes.json();

		data = dashboardJson as DashboardData;
		if (analyticsJson.ok) {
			analyticsData = analyticsJson as AnalyticsData;
		}
	} catch (e) {
		console.error(e);
		error = 'Failed to load dashboard data.';
	}
} else {
	error = 'ADMIN_API_KEY is missing.';
}

const formatCurrency = (amount: number, currency = 'JPY') => {
	return new Intl.NumberFormat('ja-JP', { style: 'currency', currency }).format(amount);
};

const formatDate = (dateStr: string) => {
	return new Date(dateStr).toLocaleDateString('ja-JP', {
		month: 'short',
		day: 'numeric',
		hour: '2-digit',
		minute: '2-digit'
	});
};

const getSeverityVariant = (severity: string) => {
	switch (severity) {
		case 'critical': return 'critical';
		case 'warning': return 'warn';
		default: return 'info';
	}
};

const getStatusVariant = (status: string) => {
	switch (status) {
		case 'paid': return 'info';
		case 'fulfilled': return 'secondary';
		case 'partial_refunded': return 'warn';
		case 'refunded': return 'critical';
		default: return 'secondary';
	}
};
---

<AdminLayout title="Dashboard - Admin">
	<div class="space-y-8">
		<div>
			<h1 class="text-2xl font-semibold text-zinc-900">Dashboard</h1>
		</div>

		{error && (
			<div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm">
				{error}
			</div>
		)}

			{data && (
				<>
					{/* KPI Cards */}
					<div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
						<div class="bg-white rounded-lg p-5 ring-1 ring-zinc-900/5">
							<div class="flex items-center gap-3 mb-2">
								<div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center">
									<svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
									</svg>
								</div>
								<span class="text-xs text-zinc-500 font-medium">Today's Orders</span>
							</div>
							<p class="text-2xl font-semibold text-zinc-900 tabular-nums">{data.today.orders}</p>
						</div>

						<div class="bg-white rounded-lg p-5 ring-1 ring-zinc-900/5">
							<div class="flex items-center gap-3 mb-2">
								<div class="w-10 h-10 rounded-full bg-green-50 flex items-center justify-center">
									<svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
									</svg>
								</div>
								<span class="text-xs text-zinc-500 font-medium">Today's Revenue</span>
							</div>
							<p class="text-2xl font-semibold text-zinc-900 tabular-nums">{formatCurrency(data.today.revenue)}</p>
						</div>

						<div class="bg-white rounded-lg p-5 ring-1 ring-zinc-900/5">
							<div class="flex items-center gap-3 mb-2">
								<div class="w-10 h-10 rounded-full bg-amber-50 flex items-center justify-center">
									<svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
									</svg>
								</div>
								<span class="text-xs text-zinc-500 font-medium">Pending Inbox</span>
							</div>
							<p class="text-2xl font-semibold text-zinc-900 tabular-nums">{data.pending.inbox}</p>
						</div>

						<div class="bg-white rounded-lg p-5 ring-1 ring-zinc-900/5">
							<div class="flex items-center gap-3 mb-2">
								<div class="w-10 h-10 rounded-full bg-purple-50 flex items-center justify-center">
									<svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
									</svg>
								</div>
								<span class="text-xs text-zinc-500 font-medium">Unfulfilled</span>
							</div>
							<p class="text-2xl font-semibold text-zinc-900 tabular-nums">{data.pending.unfulfilled}</p>
						</div>
					</div>

					{/* Sales Chart */}
					{analyticsData && (
						<div class="bg-white rounded-lg p-6 ring-1 ring-zinc-900/5">
							<div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4">
								<h2 class="text-sm font-semibold text-zinc-900">Sales Trend (Past {periodLabels[period]})</h2>
								<div class="flex items-center gap-2">
									<div class="flex rounded-lg border border-zinc-200 p-0.5">
										{[7, 30, 90].map((p) => (
											<a
												href={`?period=${p}`}
												class={`px-3 py-1 text-xs font-medium rounded-md transition-colors ${
													period === p
														? 'bg-zinc-900 text-white'
														: 'text-zinc-600 hover:bg-zinc-100'
												}`}
											>
												{p}D
											</a>
										))}
									</div>
									<div class="hidden sm:flex items-center gap-3 ml-4 text-xs text-zinc-500">
										<span class="flex items-center gap-1">
											<span class="w-3 h-0.5 bg-emerald-500 rounded"></span>
											Revenue
										</span>
										<span class="flex items-center gap-1">
											<span class="w-3 h-3 bg-emerald-500/80 rounded-sm"></span>
											Orders
										</span>
									</div>
								</div>
							</div>
							{analyticsData.dailySales.length > 0 ? (
								<div class="h-64">
									<canvas id="salesChart"></canvas>
								</div>
							) : (
								<div class="h-64 flex items-center justify-center text-sm text-zinc-500">
									No sales data for this period
								</div>
							)}
						</div>
					)}

					{/* Week Summary */}
					<div class="bg-white rounded-lg p-6 ring-1 ring-zinc-900/5">
						<h2 class="text-sm font-semibold text-zinc-900 mb-4">This Week</h2>
						<div class="grid grid-cols-3 gap-6">
							<div>
								<p class="text-xs text-zinc-500 mb-1">Orders</p>
								<p class="text-xl font-semibold text-zinc-900 tabular-nums">{data.week.orders}</p>
							</div>
							<div>
								<p class="text-xs text-zinc-500 mb-1">Revenue</p>
								<p class="text-xl font-semibold text-zinc-900 tabular-nums">{formatCurrency(data.week.revenue)}</p>
							</div>
							<div>
								<p class="text-xs text-zinc-500 mb-1">Refunds</p>
								<p class="text-xl font-semibold text-red-600 tabular-nums">{formatCurrency(data.week.refunds)}</p>
							</div>
						</div>
					</div>

					{/* Recent Activity */}
					<div class="grid lg:grid-cols-2 gap-6">
						{/* Recent Orders */}
						<div class="bg-white rounded-lg ring-1 ring-zinc-900/5 overflow-hidden">
							<div class="px-6 py-4 border-b border-zinc-100 flex items-center justify-between">
								<h2 class="text-sm font-semibold text-zinc-900">Recent Orders</h2>
								<Button href="/admin/orders" size="sm" variant="link">View All</Button>
							</div>
							<div class="divide-y divide-zinc-100">
								{data.recentOrders.length > 0 ? (
									data.recentOrders.map((order) => (
										<a href={`/admin/orders/${order.id}`} class="flex items-center justify-between px-6 py-3 hover:bg-zinc-50 transition-colors">
											<div class="flex items-center gap-3">
												<span class="text-sm font-medium text-zinc-900">#{order.id}</span>
												<span class="text-xs text-zinc-500 truncate max-w-[120px]">
													{order.customer_email || 'No email'}
												</span>
											</div>
											<div class="flex items-center gap-3">
												<span class="text-sm font-medium text-zinc-900 tabular-nums">
													{formatCurrency(order.total_net, order.currency)}
												</span>
												<Badge variant={getStatusVariant(order.status)} size="sm">
													{order.status}
												</Badge>
											</div>
										</a>
									))
								) : (
									<div class="px-6 py-8 text-center text-sm text-zinc-500">
										No recent orders
									</div>
								)}
							</div>
						</div>

						{/* Recent Inbox */}
						<div class="bg-white rounded-lg ring-1 ring-zinc-900/5 overflow-hidden">
							<div class="px-6 py-4 border-b border-zinc-100 flex items-center justify-between">
								<h2 class="text-sm font-semibold text-zinc-900">Pending Inbox</h2>
								<Button href="/admin/inbox" size="sm" variant="link">View All</Button>
							</div>
							<div class="divide-y divide-zinc-100">
								{data.recentInbox.length > 0 ? (
									data.recentInbox.map((item) => (
										<a href="/admin/inbox" class="flex items-center justify-between px-6 py-3 hover:bg-zinc-50 transition-colors">
											<div class="flex items-center gap-3">
												<Badge variant={getSeverityVariant(item.severity)} size="sm">
													{item.severity}
												</Badge>
												<span class="text-sm text-zinc-900 truncate max-w-[200px]">
													{item.title}
												</span>
											</div>
											<span class="text-xs text-zinc-500">
												{formatDate(item.created_at)}
											</span>
										</a>
									))
								) : (
									<div class="px-6 py-8 text-center text-sm text-zinc-500">
										No pending items
									</div>
								)}
							</div>
						</div>
					</div>
				</>
			)}
	</div>
</AdminLayout>

<!-- Pass analytics data to client-side script -->
<script id="analytics-data" type="application/json" set:html={JSON.stringify(analyticsData)}></script>

<script>
	import Chart from 'chart.js/auto';

	function initChart() {
		const dataElement = document.getElementById('analytics-data');
		const chartData = dataElement ? JSON.parse(dataElement.textContent || 'null') : null;

		if (!chartData || !chartData.dailySales || chartData.dailySales.length === 0) {
			return; // No data to display
		}

		const salesCtx = document.getElementById('salesChart') as HTMLCanvasElement | null;

		// If canvas doesn't exist yet (React still loading), retry
		if (!salesCtx) {
			setTimeout(initChart, 100);
			return;
		}

		const labels = chartData.dailySales.map((d: { date: string }) => {
			const date = new Date(d.date);
			return `${date.getMonth() + 1}/${date.getDate()}`;
		});
		const revenues = chartData.dailySales.map((d: { revenue: number }) => d.revenue);
		const orders = chartData.dailySales.map((d: { orders: number }) => d.orders);

		new Chart(salesCtx, {
			type: 'bar',
			data: {
				labels,
				datasets: [
					{
						type: 'line',
						label: 'Revenue',
						data: revenues,
						borderColor: 'rgb(16, 185, 129)',
						backgroundColor: 'rgba(16, 185, 129, 0.1)',
						fill: true,
						tension: 0.3,
						yAxisID: 'y'
					},
					{
						type: 'bar',
						label: 'Orders',
						data: orders,
						backgroundColor: 'rgba(16, 185, 129, 0.8)',
						borderColor: 'rgb(16, 185, 129)',
						borderWidth: 1,
						yAxisID: 'y1'
					}
				]
			},
			options: {
				responsive: true,
				maintainAspectRatio: false,
				interaction: {
					mode: 'index',
					intersect: false
				},
				plugins: {
					legend: {
						display: false
					},
					tooltip: {
						callbacks: {
							label: (context) => {
								const value = context.raw as number;
								if (context.dataset.label === 'Revenue') {
									return `Revenue: ${new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(value)}`;
								}
								return `Orders: ${value}`;
							}
						}
					}
				},
				scales: {
					y: {
						type: 'linear',
						display: true,
						position: 'left',
						beginAtZero: true,
						ticks: {
							callback: (value) => {
								const numValue = Number(value);
								if (numValue >= 10000) {
									return `${numValue / 10000}ä¸‡`;
								}
								return numValue.toLocaleString();
							}
						},
						grid: {
							color: 'rgba(0, 0, 0, 0.05)'
						}
					},
					y1: {
						type: 'linear',
						display: true,
						position: 'right',
						beginAtZero: true,
						ticks: {
							stepSize: 1
						},
						grid: {
							drawOnChartArea: false
						}
					},
					x: {
						grid: {
							display: false
						}
					}
				}
			}
		});
	}

	// Start initialization
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initChart);
	} else {
		initChart();
	}
</script>
