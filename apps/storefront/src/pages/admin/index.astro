---
export const prerender = false;

import AdminLayout from '../../layouts/AdminLayout.astro';
import { Alert } from '../../components/catalyst/alert-banner';
import { Badge } from '../../components/catalyst/badge';
import { Button } from '../../components/catalyst/button';
import { Heading, Subheading } from '../../components/catalyst/heading';
import { getApiBase } from '../../lib/api';

const apiBase = getApiBase();

type DashboardData = {
	today: { orders: number; revenue: number; refunds: number };
	week: { orders: number; revenue: number; refunds: number };
	pending: { inbox: number; unfulfilled: number };
	recentOrders: Array<{
		id: number;
		customer_email: string | null;
		total_net: number;
		currency: string;
		status: string;
		created_at: string;
	}>;
	recentInbox: Array<{
		id: number;
		title: string;
		severity: string;
		kind: string;
		created_at: string;
	}>;
};

type DailySale = {
	date: string;
	orders: number;
	revenue: number;
};

type AnalyticsData = {
	dailySales: DailySale[];
	customerBreakdown: {
		newCustomers: number;
		returningCustomers: number;
	};
	summary: {
		totalRevenue: number;
		totalOrders: number;
		averageOrderValue: number;
	};
};

type LowStockItem = {
	variant_id: number;
	on_hand: number;
	threshold: number;
	variant_title?: string;
	product_title?: string;
};

let data: DashboardData | null = null;
let analyticsData: AnalyticsData | null = null;
let lowStockItems: LowStockItem[] = [];
let lowStockCount = 0;
let error: string | null = null;

// Get period from query params (default: 7 days)
const periodParam = Astro.url.searchParams.get('period') || '7';
const period = ['7', '30', '90'].includes(periodParam) ? parseInt(periodParam) : 7;

// Calculate date range for analytics
const today = new Date();
const todayStr = today.toISOString().slice(0, 10);
const fromDate = new Date(today);
fromDate.setDate(fromDate.getDate() - (period - 1));
const fromStr = fromDate.toISOString().slice(0, 10);

const periodLabels: Record<number, string> = {
	7: '7 Days',
	30: '30 Days',
	90: '90 Days'
};

if (import.meta.env.ADMIN_API_KEY) {
	try {
		// Fetch dashboard data, analytics, and low stock in parallel
		const [dashboardRes, analyticsRes, lowStockRes] = await Promise.all([
			fetch(`${apiBase}/admin/dashboard`, {
				headers: { 'x-admin-key': import.meta.env.ADMIN_API_KEY }
			}),
			fetch(`${apiBase}/admin/analytics?from=${fromStr}&to=${todayStr}`, {
				headers: { 'x-admin-key': import.meta.env.ADMIN_API_KEY }
			}),
			fetch(`${apiBase}/inventory/low?limit=10`, {
				headers: { 'x-admin-key': import.meta.env.ADMIN_API_KEY }
			})
		]);

		if (!dashboardRes.ok) throw new Error(`Dashboard API Error: ${dashboardRes.status}`);
		if (!analyticsRes.ok) throw new Error(`Analytics API Error: ${analyticsRes.status}`);

		const dashboardJson = await dashboardRes.json();
		const analyticsJson = await analyticsRes.json();

		data = dashboardJson as DashboardData;
		if (analyticsJson.ok) {
			analyticsData = analyticsJson as AnalyticsData;
		}

		if (lowStockRes.ok) {
			const lowStockJson = await lowStockRes.json() as { items?: LowStockItem[] };
			lowStockItems = lowStockJson.items || [];
			lowStockCount = lowStockItems.length;
		}
	} catch (e) {
		console.error(e);
		error = 'Failed to load dashboard data.';
	}
} else {
	error = 'ADMIN_API_KEY is missing.';
}

const formatCurrency = (amount: number, currency = 'JPY') => {
	return new Intl.NumberFormat('ja-JP', { style: 'currency', currency }).format(amount);
};

const formatDate = (dateStr: string) => {
	return new Date(dateStr).toLocaleDateString('ja-JP', {
		month: 'short',
		day: 'numeric',
		hour: '2-digit',
		minute: '2-digit'
	});
};

const getSeverityColor = (severity: string) => {
	switch (severity) {
		case 'critical': return 'red' as const;
		case 'warning': return 'amber' as const;
		default: return 'blue' as const;
	}
};

const getStatusColor = (status: string) => {
	switch (status) {
		case 'paid': return 'lime' as const;
		case 'fulfilled': return 'lime' as const;
		case 'partial_refunded': return 'amber' as const;
		case 'refunded': return 'red' as const;
		default: return 'zinc' as const;
	}
};
---

<AdminLayout title="Dashboard - Admin">
	<div class="space-y-8">
		<div>
			<Heading>Dashboard</Heading>
		</Alert>

		{error && (
			<Alert color="red" client:load>
				{error}
			</Alert>
		)}

			{data && (
				<>
					{/* KPI Cards */}
					<div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
						<div class="bg-white rounded-xl border border-zinc-200 p-5 shadow-sm">
							<div class="flex items-center gap-3 mb-2">
								<div class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center">
									<svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
									</svg>
								</Alert>
								<span class="text-xs text-zinc-500 font-medium">Today's Orders</span>
							</Alert>
							<p class="text-2xl font-semibold text-zinc-950 tabular-nums">{data.today.orders}</p>
						</Alert>

						<div class="bg-white rounded-xl border border-zinc-200 p-5 shadow-sm">
							<div class="flex items-center gap-3 mb-2">
								<div class="w-10 h-10 rounded-full bg-green-50 flex items-center justify-center">
									<svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
									</svg>
								</Alert>
								<span class="text-xs text-zinc-500 font-medium">Today's Revenue</span>
							</Alert>
							<p class="text-2xl font-semibold text-zinc-950 tabular-nums">{formatCurrency(data.today.revenue)}</p>
						</Alert>

						<div class="bg-white rounded-xl border border-zinc-200 p-5 shadow-sm">
							<div class="flex items-center gap-3 mb-2">
								<div class="w-10 h-10 rounded-full bg-amber-50 flex items-center justify-center">
									<svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
									</svg>
								</Alert>
								<span class="text-xs text-zinc-500 font-medium">Pending Inbox</span>
							</Alert>
							<p class="text-2xl font-semibold text-zinc-950 tabular-nums">{data.pending.inbox}</p>
						</Alert>

						<div class="bg-white rounded-xl border border-zinc-200 p-5 shadow-sm">
							<div class="flex items-center gap-3 mb-2">
								<div class="w-10 h-10 rounded-full bg-purple-50 flex items-center justify-center">
									<svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
									</svg>
								</Alert>
								<span class="text-xs text-zinc-500 font-medium">Unfulfilled</span>
							</Alert>
							<p class="text-2xl font-semibold text-zinc-950 tabular-nums">{data.pending.unfulfilled}</p>
						</Alert>
					</Alert>

					{/* Sales Chart */}
					{analyticsData && (
						<div class="bg-white rounded-xl border border-zinc-200 p-6 shadow-sm">
							<div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4">
								<Subheading>Sales Trend (Past {periodLabels[period]})</Subheading>
								<div class="flex items-center gap-2">
									<div class="flex rounded-lg border border-zinc-200 p-0.5">
										{[7, 30, 90].map((p) => (
											<a
												href={`?period=${p}`}
												class={`px-3 py-1 text-xs font-medium rounded-md transition-colors ${
													period === p
														? 'bg-indigo-600 text-white'
														: 'text-zinc-600 hover:bg-zinc-100'
												}`}
											>
												{p}D
											</a>
										))}
									</Alert>
									<div class="hidden sm:flex items-center gap-3 ml-4 text-xs text-zinc-500">
										<span class="flex items-center gap-1">
											<span class="w-3 h-0.5 bg-indigo-500 rounded"></span>
											Revenue
										</span>
										<span class="flex items-center gap-1">
											<span class="w-3 h-3 bg-emerald-500/80 rounded-sm"></span>
											Orders
										</span>
									</Alert>
								</Alert>
							</Alert>
							{analyticsData.dailySales.length > 0 ? (
								<div class="h-64">
									<canvas id="salesChart"></canvas>
								</Alert>
							) : (
								<div class="h-64 flex items-center justify-center text-sm text-zinc-500">
									No sales data for this period
								</Alert>
							)}
						</Alert>
					)}

					{/* Week Summary */}
					<div class="bg-white rounded-xl border border-zinc-200 p-6 shadow-sm">
						<Subheading>This Week</Subheading>
						<div class="grid grid-cols-3 gap-6">
							<div>
								<p class="text-xs text-zinc-500 mb-1">Orders</p>
								<p class="text-xl font-semibold text-zinc-950 tabular-nums">{data.week.orders}</p>
							</Alert>
							<div>
								<p class="text-xs text-zinc-500 mb-1">Revenue</p>
								<p class="text-xl font-semibold text-zinc-950 tabular-nums">{formatCurrency(data.week.revenue)}</p>
							</Alert>
							<div>
								<p class="text-xs text-zinc-500 mb-1">Refunds</p>
								<p class="text-xl font-semibold text-red-600 tabular-nums">{formatCurrency(data.week.refunds)}</p>
							</Alert>
						</Alert>
					</Alert>

					{/* Recent Activity */}
					<div class="grid lg:grid-cols-2 gap-6">
						{/* Recent Orders */}
						<div>
							<div class="px-6 py-4 border-b border-zinc-100 flex items-center justify-between">
								<Subheading>Recent Orders</Subheading>
								<Button client:load href="/admin/orders" plain>View All</Button>
							</Alert>
							<div class="divide-y divide-zinc-100">
								{data.recentOrders.length > 0 ? (
									data.recentOrders.map((order) => (
										<a href={`/admin/orders/${order.id}`} class="flex items-center justify-between px-6 py-3 hover:bg-zinc-50 transition-colors">
											<div class="flex items-center gap-3">
												<span class="text-sm font-medium text-zinc-950">#{order.id}</span>
												<span class="text-xs text-zinc-500 truncate max-w-[120px]">
													{order.customer_email || 'No email'}
												</span>
											</Alert>
											<div class="flex items-center gap-3">
												<span class="text-sm font-medium text-zinc-950 tabular-nums">
													{formatCurrency(order.total_net, order.currency)}
												</span>
												<Badge client:load color={getStatusColor(order.status)}>
													{order.status}
												</Badge>
											</Alert>
										</a>
									))
								) : (
									<div class="px-6 py-8 text-center text-sm text-zinc-500">
										No recent orders
									</Alert>
								)}
							</Alert>
						</Alert>

						{/* Recent Inbox */}
						<div>
							<div class="px-6 py-4 border-b border-zinc-100 flex items-center justify-between">
								<Subheading>Pending Inbox</Subheading>
								<Button client:load href="/admin/inbox" plain>View All</Button>
							</Alert>
							<div class="divide-y divide-zinc-100">
								{data.recentInbox.length > 0 ? (
									data.recentInbox.map((item) => (
										<a href="/admin/inbox" class="flex items-center justify-between px-6 py-3 hover:bg-zinc-50 transition-colors">
											<div class="flex items-center gap-3">
												<Badge client:load color={getSeverityColor(item.severity)}>
													{item.severity}
												</Badge>
												<span class="text-sm text-zinc-950 truncate max-w-[200px]">
													{item.title}
												</span>
											</Alert>
											<span class="text-xs text-zinc-500">
												{formatDate(item.created_at)}
											</span>
										</a>
									))
								) : (
									<div class="px-6 py-8 text-center text-sm text-zinc-500">
										No pending items
									</Alert>
								)}
							</Alert>
						</Alert>
					</Alert>

					{/* Low Stock Alerts */}
					{lowStockCount > 0 && (
						<div class="bg-white rounded-xl border border-amber-200 shadow-sm overflow-hidden">
							<div class="px-6 py-4 border-b border-amber-100 flex items-center justify-between bg-amber-50">
								<div class="flex items-center gap-2">
									<svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
									</svg>
									<Subheading>Low Stock Alerts</Subheading>
									<Badge client:load color="amber">{lowStockCount}</Badge>
								</div>
								<Button client:load href="/admin/inventory?status=low" plain>View All</Button>
							</div>
							<div class="divide-y divide-zinc-100">
								{lowStockItems.slice(0, 5).map((item) => (
									<div class="flex items-center justify-between px-6 py-3">
										<div class="flex flex-col">
											<span class="text-sm font-medium text-zinc-950">
												{item.product_title || `Variant #${item.variant_id}`}
											</span>
											{item.variant_title && (
												<span class="text-xs text-zinc-500">{item.variant_title}</span>
											)}
										</div>
										<div class="flex items-center gap-3">
											<div class="text-right">
												<span class="text-sm font-semibold tabular-nums text-zinc-950">{item.on_hand}</span>
												<span class="text-xs text-zinc-500"> / {item.threshold}</span>
											</div>
											<Badge client:load color={item.on_hand <= 0 ? 'red' : 'amber'}>
												{item.on_hand <= 0 ? 'Out' : 'Low'}
											</Badge>
										</div>
									</div>
								))}
							</div>
						</div>
					)}
				</>
			)}
	</Alert>
</AdminLayout>

<!-- Pass analytics data to client-side script -->
<script id="analytics-data" type="application/json" set:html={JSON.stringify(analyticsData)}></script>

<script>
	import Chart from 'chart.js/auto';

	function initChart() {
		const dataElement = document.getElementById('analytics-data');
		const chartData = dataElement ? JSON.parse(dataElement.textContent || 'null') : null;

		if (!chartData || !chartData.dailySales || chartData.dailySales.length === 0) {
			return; // No data to display
		}

		const salesCtx = document.getElementById('salesChart') as HTMLCanvasElement | null;

		// If canvas doesn't exist yet (React still loading), retry
		if (!salesCtx) {
			setTimeout(initChart, 100);
			return;
		}

		const labels = chartData.dailySales.map((d: { date: string }) => {
			const date = new Date(d.date);
			return `${date.getMonth() + 1}/${date.getDate()}`;
		});
		const revenues = chartData.dailySales.map((d: { revenue: number }) => d.revenue);
		const orders = chartData.dailySales.map((d: { orders: number }) => d.orders);

		new Chart(salesCtx, {
			type: 'bar',
			data: {
				labels,
				datasets: [
					{
						type: 'line',
						label: 'Revenue',
						data: revenues,
						borderColor: 'rgb(79, 70, 229)',
						backgroundColor: 'rgba(79, 70, 229, 0.1)',
						fill: true,
						tension: 0.3,
						yAxisID: 'y'
					},
					{
						type: 'bar',
						label: 'Orders',
						data: orders,
						backgroundColor: 'rgba(16, 185, 129, 0.8)',
						borderColor: 'rgb(16, 185, 129)',
						borderWidth: 1,
						yAxisID: 'y1'
					}
				]
			},
			options: {
				responsive: true,
				maintainAspectRatio: false,
				interaction: {
					mode: 'index',
					intersect: false
				},
				plugins: {
					legend: {
						display: false
					},
					tooltip: {
						callbacks: {
							label: (context) => {
								const value = context.raw as number;
								if (context.dataset.label === 'Revenue') {
									return `Revenue: ${new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(value)}`;
								}
								return `Orders: ${value}`;
							}
						}
					}
				},
				scales: {
					y: {
						type: 'linear',
						display: true,
						position: 'left',
						beginAtZero: true,
						ticks: {
							callback: (value) => {
								const numValue = Number(value);
								if (numValue >= 10000) {
									return `${numValue / 10000}ä¸‡`;
								}
								return numValue.toLocaleString();
							}
						},
						grid: {
							color: 'rgba(0, 0, 0, 0.05)'
						}
					},
					y1: {
						type: 'linear',
						display: true,
						position: 'right',
						beginAtZero: true,
						ticks: {
							stepSize: 1
						},
						grid: {
							drawOnChartArea: false
						}
					},
					x: {
						grid: {
							display: false
						}
					}
				}
			}
		});
	}

	// Start initialization
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initChart);
	} else {
		initChart();
	}
</script>
