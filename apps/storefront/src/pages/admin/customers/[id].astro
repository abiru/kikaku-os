---
export const prerender = false;

import { Alert } from '../../../components/catalyst/alert-banner';
import { Badge } from '../../../components/catalyst/badge';
import { Button } from '../../../components/catalyst/button';
import { Fieldset, Field } from '../../../components/catalyst/fieldset';
import { Heading, Subheading } from '../../../components/catalyst/heading';
import { Input } from '../../../components/catalyst/input';
import { Pagination, PaginationPrevious, PaginationNext } from '../../../components/catalyst/pagination';
import { Table, TableHead, TableBody, TableRow, TableHeader, TableCell } from '../../../components/catalyst/table';
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getApiBase } from '../../../lib/api';
import { formatDate } from '../../../lib/format';
import { DATE_FORMATS } from '../../../lib/constants';
import { t } from '../../../i18n';
import { logError } from '../../../lib/logger';

const { id } = Astro.params;
const apiBase = getApiBase();
const apiKey = import.meta.env.ADMIN_API_KEY;
const orderPage = Number(Astro.url.searchParams.get('orderPage') || '1');
const ordersPerPage = 10;

type Customer = {
	id: number;
	name: string;
	email: string | null;
	metadata: string | null;
	created_at: string;
	updated_at: string;
};

type Order = {
	id: number;
	status: string;
	total_net: number;
	currency: string;
	created_at: string;
	paid_at: string | null;
};

type Stats = {
	total_orders: number;
	total_spent: number;
	avg_order_value: number;
};

let customer: Customer | null = null;
let orders: Order[] = [];
let stats: Stats | null = null;
let error: string | null = null;
let successMessage: string | null = null;

// Handle POST - Update customer
if (Astro.request.method === 'POST' && apiKey) {
	try {
		const formData = await Astro.request.formData();
		const name = formData.get('name')?.toString().trim() || '';
		const email = formData.get('email')?.toString().trim() || null;

		if (!name) {
			error = t('errors.nameRequired');
		} else {
			const res = await fetch(`${apiBase}/admin/customers/${id}`, {
				method: 'PUT',
				headers: {
					'Content-Type': 'application/json',
					'x-admin-key': apiKey
				},
				body: JSON.stringify({ name, email })
			});

			const data = await res.json();

			if (!res.ok) {
				error = data.message || t('errors.failedToUpdateCustomer');
			} else {
				customer = data.customer;
				successMessage = t('admin.customerUpdated');
			}
		}
	} catch (e) {
		logError('Failed to update customer', e, { page: 'admin/customers/[id]', action: 'updateCustomer', resourceId: id });
		error = t('errors.failedToUpdateCustomer');
	}
}

// Fetch customer data (if not already set from POST)
if (!customer && apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/customers/${id}`, {
			headers: { 'x-admin-key': apiKey }
		});

		if (!res.ok) {
			if (res.status === 404) {
				error = t('errors.customerNotFound');
			} else {
				const data = await res.json();
				error = data.message || `API Error: ${res.status}`;
			}
		} else {
			const data = await res.json();
			customer = data.customer;
			orders = data.orders || [];
			stats = data.stats || { total_orders: 0, total_spent: 0, avg_order_value: 0 };
		}
	} catch (e) {
		logError('Failed to load customer', e, { page: 'admin/customers/[id]', action: 'fetchCustomer', resourceId: id });
		error = error || t('errors.failedToLoadCustomer');
	}
} else if (!apiKey) {
	error = t('errors.adminKeyMissing');
}

// Re-fetch orders and stats if customer was updated via POST
if (customer && successMessage && apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/customers/${id}`, {
			headers: { 'x-admin-key': apiKey }
		});
		if (res.ok) {
			const data = await res.json();
			orders = data.orders || [];
			stats = data.stats || { total_orders: 0, total_spent: 0, avg_order_value: 0 };
		}
	} catch (e) {
		logError('Failed to re-fetch orders', e, { page: 'admin/customers/[id]', action: 'refetchOrders', resourceId: id });
	}
}

const dateTimeOpts = DATE_FORMATS.DATETIME;

const formatCurrency = (amount: number, currency: string = 'JPY') => {
	return new Intl.NumberFormat('ja-JP', {
		style: 'currency',
		currency: currency,
		minimumFractionDigits: 0
	}).format(amount);
};

const getStatusBadge = (status: string) => {
	switch (status) {
		case 'paid':
			return { color: 'blue' as const, label: t('admin.paid') };
		case 'pending':
			return { color: 'amber' as const, label: t('admin.pending') };
		case 'failed':
			return { color: 'red' as const, label: t('admin.failed') };
		default:
			return { color: 'zinc' as const, label: status };
	}
};
---

<AdminLayout title={customer ? `${customer.name} - Admin` : 'Customer - Admin'}>
	<div class="space-y-6 max-w-4xl">
		<div class="flex items-center gap-4">
			<a href="/admin/customers" class="text-indigo-600 hover:underline text-sm flex items-center gap-1">
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
				</svg>
				{t('admin.customers')}
			</a>
			<Heading>
				{customer ? customer.name : 'Customer'}
			</Heading>
		</div>
			{successMessage && (
				<div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-6 text-sm">
					{successMessage}
				</div>
			)}

			{error && !customer && (
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-8 text-center">
					<div class="text-red-600 mb-4">{error}</div>
					<Button href="/admin/customers" outline client:load>
						{t('admin.backToCustomers')}
					</Button>
				</div>
			)}

			{error && customer && (
				<div role="alert" class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg mb-6 text-sm">
					{error}
				</div>
			)}

			{customer && stats && (
				<>
					{/* Stats Cards */}
					<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
						<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
							<div class="text-sm text-secondary mb-1">{t('admin.totalOrders')}</div>
							<div class="text-2xl font-semibold text-zinc-950 tabular-nums">{stats.total_orders}</div>
						</div>
						<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
							<div class="text-sm text-secondary mb-1">{t('admin.totalSpent')}</div>
							<div class="text-2xl font-semibold text-zinc-950 tabular-nums">{formatCurrency(stats.total_spent)}</div>
						</div>
						<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
							<div class="text-sm text-secondary mb-1">{t('admin.avgOrderValue')}</div>
							<div class="text-2xl font-semibold text-zinc-950 tabular-nums">{formatCurrency(Math.round(stats.avg_order_value))}</div>
						</div>
					</div>

					{/* Edit Form */}
					<form method="POST" class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6 mb-8">
						<Subheading>{t('admin.customerDetails')}</Subheading>

						<Fieldset client:load>
							<Field>
								<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">{t('admin.nameLabel')} *</label>
								<Input
									type="text"
									name="name"
									required
									value={customer.name}
								/>
							</Field>

							<Field>
								<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">{t('admin.email')}</label>
								<Input
									type="email"
									name="email"
									value={customer.email || ''}
									placeholder="customer@example.com"
								/>
							</Field>
						</Fieldset>

						<div class="pt-4 border-t border-gray-100">
							<dl class="grid grid-cols-2 gap-4 text-sm">
								<div>
									<dt class="text-secondary">{t('admin.created')}</dt>
									<dd class="text-zinc-950 tabular-nums">{formatDate(customer.created_at, dateTimeOpts)}</dd>
								</div>
								<div>
									<dt class="text-secondary">{t('admin.updated')}</dt>
									<dd class="text-zinc-950 tabular-nums">{formatDate(customer.updated_at, dateTimeOpts)}</dd>
								</div>
							</dl>
						</div>

						<div class="flex justify-end gap-3 pt-4 border-t border-gray-100">
							<Button href="/admin/customers" outline client:load>
								{t('admin.back')}
							</Button>
							<Button type="submit" color="indigo" client:load>
								{t('admin.saveChanges')}
							</Button>
						</div>
					</form>

					{/* Order History */}
					{(() => {
						const totalOrders = orders.length;
						const totalOrderPages = Math.max(1, Math.ceil(totalOrders / ordersPerPage));
						const paginatedOrders = orders.slice(
							(orderPage - 1) * ordersPerPage,
							orderPage * ordersPerPage
						);
						const hasOrderPrev = orderPage > 1;
						const hasOrderNext = orderPage < totalOrderPages;

						return (
							<div>
								<div class="flex items-center justify-between mb-4">
									<Subheading>{t('admin.orderHistory')}</Subheading>
									{totalOrders > 0 && (
										<span class="text-xs text-zinc-500 bg-zinc-100 px-2 py-1 rounded-full">{totalOrders} {t('admin.orders')}</span>
									)}
								</div>

								{orders.length === 0 ? (
									<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-8 text-center">
										<p class="text-secondary text-sm">{t('admin.noOrdersYet')}</p>
									</div>
								) : (
									<>
										<div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
											<div class="overflow-x-auto">
												<Table client:only="react">
													<TableHead>
														<TableRow>
															<TableHeader>{t('admin.orderId')}</TableHeader>
															<TableHeader>{t('admin.status')}</TableHeader>
															<TableHeader>{t('admin.total')}</TableHeader>
															<TableHeader>{t('admin.created')}</TableHeader>
															<TableHeader>{t('admin.paid')}</TableHeader>
															<TableHeader>{t('admin.action')}</TableHeader>
														</TableRow>
													</TableHead>
													<TableBody>
														{paginatedOrders.map((order) => {
															const badge = getStatusBadge(order.status);
															return (
																<TableRow href={`/admin/orders/${order.id}`}>
																	<TableCell className="font-mono text-xs">
																		#{order.id}
																	</TableCell>
																	<TableCell>
																		<Badge color={badge.color} client:load>{badge.label}</Badge>
																	</TableCell>
																	<TableCell className="tabular-nums">
																		{formatCurrency(order.total_net, order.currency)}
																	</TableCell>
																	<TableCell className="text-secondary tabular-nums">
																		{formatDate(order.created_at, dateTimeOpts)}
																	</TableCell>
																	<TableCell className="text-secondary tabular-nums">
																		{formatDate(order.paid_at, dateTimeOpts)}
																	</TableCell>
																	<TableCell>
																		<a href={`/admin/orders/${order.id}`} class="text-brand hover:underline font-medium">{t('admin.view')}</a>
																	</TableCell>
																</TableRow>
															);
														})}
													</TableBody>
												</Table>
											</div>
										</div>
										{totalOrderPages > 1 && (
											<div class="flex items-center justify-between mt-4">
												<div class="text-xs text-zinc-500">
													Page {orderPage} / {totalOrderPages}
												</div>
												<Pagination client:load>
													<PaginationPrevious href={hasOrderPrev ? `?orderPage=${orderPage - 1}` : null} />
													<PaginationNext href={hasOrderNext ? `?orderPage=${orderPage + 1}` : null} />
												</Pagination>
											</div>
										)}
									</>
								)}
							</div>
						);
					})()}
				</>
			)}
	</div>
</AdminLayout>
