---
export const prerender = false;

import { Alert } from '../../../components/catalyst/alert-banner';
import Badge from '../../../components/Badge.astro';
import { Button } from '../../../components/catalyst/button';
import { Fieldset, Field, Label } from '../../../components/catalyst/fieldset';
import { Heading, Subheading } from '../../../components/catalyst/heading';
import { Input } from '../../../components/catalyst/input';
import { Table, TableHead, TableBody, TableRow, TableHeader, TableCell } from '../../../components/catalyst/table';
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getApiBase } from '../../../lib/api';

const { id } = Astro.params;
const apiBase = getApiBase();
const apiKey = import.meta.env.ADMIN_API_KEY;

type Customer = {
	id: number;
	name: string;
	email: string | null;
	metadata: string | null;
	created_at: string;
	updated_at: string;
};

type Order = {
	id: number;
	status: string;
	total_net: number;
	currency: string;
	created_at: string;
	paid_at: string | null;
};

type Stats = {
	total_orders: number;
	total_spent: number;
	avg_order_value: number;
};

let customer: Customer | null = null;
let orders: Order[] = [];
let stats: Stats | null = null;
let error: string | null = null;
let successMessage: string | null = null;

// Handle POST - Update customer
if (Astro.request.method === 'POST' && apiKey) {
	try {
		const formData = await Astro.request.formData();
		const name = formData.get('name')?.toString().trim() || '';
		const email = formData.get('email')?.toString().trim() || null;

		if (!name) {
			error = 'Name is required';
		} else {
			const res = await fetch(`${apiBase}/admin/customers/${id}`, {
				method: 'PUT',
				headers: {
					'Content-Type': 'application/json',
					'x-admin-key': apiKey
				},
				body: JSON.stringify({ name, email })
			});

			const data = await res.json();

			if (!res.ok) {
				error = data.message || 'Failed to update customer';
			} else {
				customer = data.customer;
				successMessage = 'Customer updated successfully';
			}
		}
	} catch (e) {
		console.error(e);
		error = 'Failed to update customer. Please check your connection.';
	}
}

// Fetch customer data (if not already set from POST)
if (!customer && apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/customers/${id}`, {
			headers: { 'x-admin-key': apiKey }
		});

		if (!res.ok) {
			if (res.status === 404) {
				error = 'Customer not found';
			} else {
				const data = await res.json();
				error = data.message || `API Error: ${res.status}`;
			}
		} else {
			const data = await res.json();
			customer = data.customer;
			orders = data.orders || [];
			stats = data.stats || { total_orders: 0, total_spent: 0, avg_order_value: 0 };
		}
	} catch (e) {
		console.error(e);
		error = error || 'Failed to load customer. Please check your connection.';
	}
} else if (!apiKey) {
	error = 'ADMIN_API_KEY is missing in server environment';
}

// Re-fetch orders and stats if customer was updated via POST
if (customer && successMessage && apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/customers/${id}`, {
			headers: { 'x-admin-key': apiKey }
		});
		if (res.ok) {
			const data = await res.json();
			orders = data.orders || [];
			stats = data.stats || { total_orders: 0, total_spent: 0, avg_order_value: 0 };
		}
	} catch (e) {
		console.error('Failed to re-fetch orders:', e);
	}
}

const formatDate = (dateStr: string | null) => {
	if (!dateStr) return '-';
	return new Date(dateStr).toLocaleString('ja-JP', {
		year: 'numeric',
		month: '2-digit',
		day: '2-digit',
		hour: '2-digit',
		minute: '2-digit'
	});
};

const formatCurrency = (amount: number, currency: string = 'JPY') => {
	return new Intl.NumberFormat('ja-JP', {
		style: 'currency',
		currency: currency,
		minimumFractionDigits: 0
	}).format(amount);
};

const getStatusBadge = (status: string) => {
	switch (status) {
		case 'paid':
			return { severity: 'info' as const, label: 'Paid' };
		case 'pending':
			return { severity: 'warn' as const, label: 'Pending' };
		case 'failed':
			return { severity: 'critical' as const, label: 'Failed' };
		default:
			return { severity: 'secondary' as const, label: status };
	}
};
---

<AdminLayout title={customer ? `${customer.name} - Admin` : 'Customer - Admin'}>
	<div class="space-y-6 max-w-4xl">
		<div class="flex items-center gap-4">
			<a href="/admin/customers" class="text-indigo-600 hover:underline text-sm flex items-center gap-1">
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
				</svg>
				Customers
			</a>
			<Heading>
				{customer ? customer.name : 'Customer'}
			</Heading>
		</div>
			{successMessage && (
				<div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-6 text-sm">
					{successMessage}
				</div>
			)}

			{error && !customer && (
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-8 text-center">
					<div class="text-red-600 mb-4">{error}</div>
					<Button href="/admin/customers" outline client:load>
						Back to Customers
					</Button>
				</div>
			)}

			{error && customer && (
				<div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg mb-6 text-sm">
					{error}
				</div>
			)}

			{customer && stats && (
				<>
					{/* Stats Cards */}
					<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
						<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
							<div class="text-sm text-[#86868b] mb-1">Total Orders</div>
							<div class="text-2xl font-semibold text-zinc-950 dark:text-white tabular-nums">{stats.total_orders}</div>
						</div>
						<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
							<div class="text-sm text-[#86868b] mb-1">Total Spent</div>
							<div class="text-2xl font-semibold text-zinc-950 dark:text-white tabular-nums">{formatCurrency(stats.total_spent)}</div>
						</div>
						<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
							<div class="text-sm text-[#86868b] mb-1">Avg. Order Value</div>
							<div class="text-2xl font-semibold text-zinc-950 dark:text-white tabular-nums">{formatCurrency(Math.round(stats.avg_order_value))}</div>
						</div>
					</div>

					{/* Edit Form */}
					<form method="POST" class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6 mb-8">
						<Subheading>Customer Details</Subheading>

						<Fieldset client:only="react">
							<Field>
								<Label>Name *</Label>
								<Input
									type="text"
									name="name"
									required
									value={customer.name}
								/>
							</Field>

							<Field>
								<Label>Email</Label>
								<Input
									type="email"
									name="email"
									value={customer.email || ''}
									placeholder="customer@example.com"
								/>
							</Field>
						</Fieldset>

						<div class="pt-4 border-t border-gray-100">
							<dl class="grid grid-cols-2 gap-4 text-sm">
								<div>
									<dt class="text-[#86868b]">Created</dt>
									<dd class="text-zinc-950 tabular-nums">{formatDate(customer.created_at)}</dd>
								</div>
								<div>
									<dt class="text-[#86868b]">Updated</dt>
									<dd class="text-zinc-950 tabular-nums">{formatDate(customer.updated_at)}</dd>
								</div>
							</dl>
						</div>

						<div class="flex justify-end gap-3 pt-4 border-t border-gray-100">
							<Button href="/admin/customers" outline client:load>
								Back
							</Button>
							<Button type="submit" color="indigo" client:load>
								Save Changes
							</Button>
						</div>
					</form>

					{/* Order History */}
					<div>
						<Subheading>Order History</Subheading>

						{orders.length === 0 ? (
							<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-8 text-center">
								<p class="text-[#86868b] text-sm">No orders yet.</p>
							</div>
						) : (
							<div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
								<div class="overflow-x-auto">
									<Table client:load>
										<TableHead>
											<TableRow>
												<TableHeader>Order ID</TableHeader>
												<TableHeader>Status</TableHeader>
												<TableHeader>Total</TableHeader>
												<TableHeader>Created</TableHeader>
												<TableHeader>Paid</TableHeader>
												<TableHeader>Action</TableHeader>
											</TableRow>
										</TableHead>
										<TableBody>
											{orders.map((order) => {
												const badge = getStatusBadge(order.status);
												return (
													<TableRow href={`/admin/orders/${order.id}`}>
														<TableCell className="font-mono text-xs">
															#{order.id}
														</TableCell>
														<TableCell>
															<Badge severity={badge.severity}>{badge.label}</Badge>
														</TableCell>
														<TableCell className="tabular-nums">
															{formatCurrency(order.total_net, order.currency)}
														</TableCell>
														<TableCell className="text-[#86868b] tabular-nums">
															{formatDate(order.created_at)}
														</TableCell>
														<TableCell className="text-[#86868b] tabular-nums">
															{formatDate(order.paid_at)}
														</TableCell>
														<TableCell>
															<a href={`/admin/orders/${order.id}`} class="text-[#0071e3] hover:underline font-medium">View</a>
														</TableCell>
													</TableRow>
												);
											})}
										</TableBody>
									</Table>
								</div>
							</div>
						)}
					</div>
				</>
			)}
	</div>
</AdminLayout>
