---
export const prerender = false;

import Badge from '../../../components/Badge.astro';
import Button from '../../../components/Button.astro';
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getApiBase } from '../../../lib/api';

const { id } = Astro.params;
const apiBase = getApiBase();
const apiKey = import.meta.env.ADMIN_API_KEY;

type Customer = {
	id: number;
	name: string;
	email: string | null;
	metadata: string | null;
	created_at: string;
	updated_at: string;
};

type Order = {
	id: number;
	status: string;
	total_net: number;
	currency: string;
	created_at: string;
	paid_at: string | null;
};

type Stats = {
	total_orders: number;
	total_spent: number;
	avg_order_value: number;
};

let customer: Customer | null = null;
let orders: Order[] = [];
let stats: Stats | null = null;
let error: string | null = null;
let successMessage: string | null = null;

// Handle POST - Update customer
if (Astro.request.method === 'POST' && apiKey) {
	try {
		const formData = await Astro.request.formData();
		const name = formData.get('name')?.toString().trim() || '';
		const email = formData.get('email')?.toString().trim() || null;

		if (!name) {
			error = 'Name is required';
		} else {
			const res = await fetch(`${apiBase}/admin/customers/${id}`, {
				method: 'PUT',
				headers: {
					'Content-Type': 'application/json',
					'x-admin-key': apiKey
				},
				body: JSON.stringify({ name, email })
			});

			const data = await res.json();

			if (!res.ok) {
				error = data.message || 'Failed to update customer';
			} else {
				customer = data.customer;
				successMessage = 'Customer updated successfully';
			}
		}
	} catch (e) {
		console.error(e);
		error = 'Failed to update customer. Please check your connection.';
	}
}

// Fetch customer data (if not already set from POST)
if (!customer && apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/customers/${id}`, {
			headers: { 'x-admin-key': apiKey }
		});

		if (!res.ok) {
			if (res.status === 404) {
				error = 'Customer not found';
			} else {
				const data = await res.json();
				error = data.message || `API Error: ${res.status}`;
			}
		} else {
			const data = await res.json();
			customer = data.customer;
			orders = data.orders || [];
			stats = data.stats || { total_orders: 0, total_spent: 0, avg_order_value: 0 };
		}
	} catch (e) {
		console.error(e);
		error = error || 'Failed to load customer. Please check your connection.';
	}
} else if (!apiKey) {
	error = 'ADMIN_API_KEY is missing in server environment';
}

// Re-fetch orders and stats if customer was updated via POST
if (customer && successMessage && apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/customers/${id}`, {
			headers: { 'x-admin-key': apiKey }
		});
		if (res.ok) {
			const data = await res.json();
			orders = data.orders || [];
			stats = data.stats || { total_orders: 0, total_spent: 0, avg_order_value: 0 };
		}
	} catch (e) {
		console.error('Failed to re-fetch orders:', e);
	}
}

const formatDate = (dateStr: string | null) => {
	if (!dateStr) return '-';
	return new Date(dateStr).toLocaleString('ja-JP', {
		year: 'numeric',
		month: '2-digit',
		day: '2-digit',
		hour: '2-digit',
		minute: '2-digit'
	});
};

const formatCurrency = (amount: number, currency: string = 'JPY') => {
	return new Intl.NumberFormat('ja-JP', {
		style: 'currency',
		currency: currency,
		minimumFractionDigits: 0
	}).format(amount);
};

const getStatusBadge = (status: string) => {
	switch (status) {
		case 'paid':
			return { severity: 'info' as const, label: 'Paid' };
		case 'pending':
			return { severity: 'warn' as const, label: 'Pending' };
		case 'failed':
			return { severity: 'critical' as const, label: 'Failed' };
		default:
			return { severity: 'secondary' as const, label: status };
	}
};
---

<AdminLayout title={customer ? `${customer.name} - Admin` : 'Customer - Admin'}>
	<div class="space-y-6 max-w-4xl">
		<div class="flex items-center gap-4">
			<a href="/admin/customers" class="text-emerald-500 hover:underline text-sm flex items-center gap-1">
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
				</svg>
				Customers
			</a>
			<h1 class="text-2xl font-semibold text-zinc-900">
				{customer ? customer.name : 'Customer'}
			</h1>
		</div>
			{successMessage && (
				<div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-6 text-sm">
					{successMessage}
				</div>
			)}

			{error && !customer && (
				<div class="bg-white rounded-lg ring-1 ring-zinc-900/5 p-8 text-center">
					<div class="text-red-600 mb-4">{error}</div>
					<Button href="/admin/customers" variant="secondary" size="sm">
						Back to Customers
					</Button>
				</div>
			)}

			{error && customer && (
				<div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg mb-6 text-sm">
					{error}
				</div>
			)}

			{customer && stats && (
				<>
					{/* Stats Cards */}
					<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
						<div class="bg-white rounded-lg ring-1 ring-zinc-900/5 p-6">
							<div class="text-sm text-zinc-500 mb-1">Total Orders</div>
							<div class="text-2xl font-semibold text-zinc-900 tabular-nums">{stats.total_orders}</div>
						</div>
						<div class="bg-white rounded-lg ring-1 ring-zinc-900/5 p-6">
							<div class="text-sm text-zinc-500 mb-1">Total Spent</div>
							<div class="text-2xl font-semibold text-zinc-900 tabular-nums">{formatCurrency(stats.total_spent)}</div>
						</div>
						<div class="bg-white rounded-lg ring-1 ring-zinc-900/5 p-6">
							<div class="text-sm text-zinc-500 mb-1">Avg. Order Value</div>
							<div class="text-2xl font-semibold text-zinc-900 tabular-nums">{formatCurrency(Math.round(stats.avg_order_value))}</div>
						</div>
					</div>

					{/* Edit Form */}
					<form method="POST" class="bg-white rounded-lg ring-1 ring-zinc-900/5 p-6 space-y-6 mb-8">
						<h2 class="text-lg font-semibold text-zinc-900">Customer Details</h2>

						<div>
							<label for="name" class="block text-sm font-medium text-zinc-900 mb-2">
								Name <span class="text-red-500">*</span>
							</label>
							<input
								type="text"
								id="name"
								name="name"
								required
								value={customer.name}
								class="w-full px-4 py-2 border border-zinc-200 rounded-lg text-sm text-zinc-900 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all"
							/>
						</div>

						<div>
							<label for="email" class="block text-sm font-medium text-zinc-900 mb-2">
								Email
							</label>
							<input
								type="email"
								id="email"
								name="email"
								value={customer.email || ''}
								class="w-full px-4 py-2 border border-zinc-200 rounded-lg text-sm text-zinc-900 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all"
								placeholder="customer@example.com"
							/>
						</div>

						<div class="pt-4 border-t border-zinc-100">
							<dl class="grid grid-cols-2 gap-4 text-sm">
								<div>
									<dt class="text-zinc-500">Created</dt>
									<dd class="text-zinc-900 tabular-nums">{formatDate(customer.created_at)}</dd>
								</div>
								<div>
									<dt class="text-zinc-500">Updated</dt>
									<dd class="text-zinc-900 tabular-nums">{formatDate(customer.updated_at)}</dd>
								</div>
							</dl>
						</div>

						<div class="flex justify-end gap-3 pt-4 border-t border-zinc-100">
							<Button href="/admin/customers" variant="secondary" size="sm">
								Back
							</Button>
							<Button type="submit" variant="primary" size="sm">
								Save Changes
							</Button>
						</div>
					</form>

					{/* Order History */}
					<div>
						<h2 class="text-lg font-semibold text-zinc-900 mb-4">Order History</h2>

						{orders.length === 0 ? (
							<div class="bg-white rounded-lg ring-1 ring-zinc-900/5 p-8 text-center">
								<p class="text-zinc-500 text-sm">No orders yet.</p>
							</div>
						) : (
							<div class="bg-white rounded-lg ring-1 ring-zinc-900/5 overflow-hidden">
								<div class="overflow-x-auto">
									<table class="w-full text-left text-sm text-zinc-900">
										<thead class="bg-zinc-50 border-b border-zinc-200">
											<tr>
												<th class="px-6 py-3 font-medium text-zinc-500">Order ID</th>
												<th class="px-6 py-3 font-medium text-zinc-500">Status</th>
												<th class="px-6 py-3 font-medium text-zinc-500 text-right">Total</th>
												<th class="px-6 py-3 font-medium text-zinc-500">Created</th>
												<th class="px-6 py-3 font-medium text-zinc-500">Paid</th>
												<th class="px-6 py-3 font-medium text-zinc-500 text-right">Action</th>
											</tr>
										</thead>
										<tbody class="divide-y divide-zinc-100">
											{orders.map((order) => {
												const badge = getStatusBadge(order.status);
												return (
													<tr class="hover:bg-zinc-50 transition-colors">
														<td class="px-6 py-4 font-mono text-xs">
															<a href={`/admin/orders/${order.id}`} class="text-emerald-500 hover:underline">
																#{order.id}
															</a>
														</td>
														<td class="px-6 py-4">
															<Badge severity={badge.severity}>{badge.label}</Badge>
														</td>
														<td class="px-6 py-4 text-right tabular-nums">
															{formatCurrency(order.total_net, order.currency)}
														</td>
														<td class="px-6 py-4 text-zinc-500 tabular-nums">
															{formatDate(order.created_at)}
														</td>
														<td class="px-6 py-4 text-zinc-500 tabular-nums">
															{formatDate(order.paid_at)}
														</td>
														<td class="px-6 py-4 text-right">
															<a href={`/admin/orders/${order.id}`} class="text-emerald-500 hover:underline font-medium">View</a>
														</td>
													</tr>
												);
											})}
										</tbody>
									</table>
								</div>
							</div>
						)}
					</div>
				</>
			)}
	</div>
</AdminLayout>
