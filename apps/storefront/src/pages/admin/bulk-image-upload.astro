---
export const prerender = false;

import { Button } from '../../components/catalyst/button';
import { Input } from '../../components/catalyst/input';
import { Heading, Subheading } from '../../components/catalyst/heading';
import AdminLayout from '../../layouts/AdminLayout.astro';
import { t } from '../../i18n';
---

<AdminLayout title={`${t('admin.bulkImageUpload')} - Admin`}>
	<div class="space-y-6 max-w-4xl">
		<div class="flex items-center justify-between">
			<Heading>{t('admin.bulkImageUploadTitle')}</Heading>
			<Button href="/admin/products" outline client:load>
				{t('admin.backToProducts')}
			</Button>
		</div>

		<!-- Step 1: Upload File -->
		<div class="bg-white rounded-lg shadow p-6 space-y-4">
			<Subheading>{t('admin.step1Upload')}</Subheading>

			<div class="bg-zinc-50 border border-zinc-200 rounded-lg p-4 space-y-2">
				<p class="text-sm font-medium text-zinc-700">{t('admin.formatExamples')}</p>
				<div class="space-y-2 text-xs text-zinc-500">
					<div>
						<strong>CSV:</strong>
						<pre class="bg-white border border-zinc-200 rounded p-2 mt-1 overflow-x-auto">product_id,image_url,position
1,https://example.com/image1.jpg,0
1,https://example.com/image2.jpg,1
2,https://example.com/image3.jpg,0</pre>
					</div>
					<div>
						<strong>JSON:</strong>
						<pre class="bg-white border border-zinc-200 rounded p-2 mt-1 overflow-x-auto" set:html={`[
  {
    "product_id": 1,
    "image_urls": [
      "https://example.com/image1.jpg",
      "https://example.com/image2.jpg"
    ]
  },
  {
    "product_id": 2,
    "image_urls": ["https://example.com/image3.jpg"]
  }
]`}></pre>
					</div>
				</div>
			</div>

			<div class="flex items-center gap-4">
				<input
					type="file"
					id="fileInput"
					accept=".csv,.json"
					class="block w-full text-sm text-zinc-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"
				/>
				<Button
					id="parseBtn"
					color="indigo"
					client:load
				>
					{t('admin.parseFile')}
				</Button>
			</div>

			<div id="parseStatus" class="hidden mt-4"></div>
		</div>

		<!-- Step 2: Preview -->
		<div id="previewSection" class="hidden bg-white rounded-lg shadow p-6 space-y-4">
			<Subheading>{t('admin.step2Preview')}</Subheading>
			<div id="previewSummary" class="text-sm text-zinc-500"></div>
			<div id="previewContent" class="space-y-4"></div>
			<div id="previewErrors" class="hidden space-y-2"></div>

			<div class="flex gap-4 pt-4">
				<Input
					type="text"
					id="batchName"
					placeholder="Batch name (optional, e.g., 'Q1 2026 LED Products')"
					className="flex-1"
					client:load
				/>
				<Button
					id="sendToInboxBtn"
					color="green"
					client:load
				>
					{t('admin.sendToInboxForApproval')}
				</Button>
			</div>
		</div>

		<div id="resultSection" class="hidden bg-white rounded-lg shadow p-6 space-y-4"></div>
	</div>

	<script>
		import DOMPurify from 'isomorphic-dompurify';

		type ParsedMapping = {
			product_id: number;
			product_title: string;
			image_urls: string[];
			existing_r2_images: number;
		};

		type ParsedError = {
			row: number;
			error: string;
		};

		type ParsedData = {
			summary: { total_products: number; total_images: number; skipped: number };
			mappings: ParsedMapping[];
			errors: ParsedError[];
		};

		let parsedResult: ParsedData | null = null;

		const fileInput = document.getElementById('fileInput') as HTMLInputElement | null;
		const parseBtn = document.getElementById('parseBtn') as HTMLButtonElement | null;
		const parseStatus = document.getElementById('parseStatus');
		const previewSection = document.getElementById('previewSection');
		const previewSummary = document.getElementById('previewSummary');
		const previewContent = document.getElementById('previewContent');
		const previewErrors = document.getElementById('previewErrors');
		const batchName = document.getElementById('batchName') as HTMLInputElement | null;
		const sendToInboxBtn = document.getElementById('sendToInboxBtn') as HTMLButtonElement | null;
		const resultSection = document.getElementById('resultSection');

		parseBtn?.addEventListener('click', async () => {
			const file = fileInput?.files?.[0];
			if (!file) {
				showParseStatus('error', 'Please select a file');
				return;
			}

			if (parseBtn) {
				parseBtn.disabled = true;
				parseBtn.textContent = 'Parsing...';
			}
			previewSection?.classList.add('hidden');
			resultSection?.classList.add('hidden');

			try {
				const formData = new FormData();
				formData.append('file', file);

				const response = await fetch(`/api/admin/bulk-image-upload/parse`, {
					method: 'POST',
					body: formData
				});

				if (!response.ok) {
					const errorData = await response.json() as { message?: string };
					throw new Error(errorData.message || 'Failed to parse file');
				}

				parsedResult = await response.json() as ParsedData;
				showParseStatus('success', `Parsed successfully: ${parsedResult.summary.total_products} products, ${parsedResult.summary.total_images} images`);
				renderPreview(parsedResult);
			} catch (error) {
				showParseStatus('error', error instanceof Error ? error.message : 'Unknown error');
			} finally {
				if (parseBtn) {
					parseBtn.disabled = false;
					parseBtn.textContent = 'Parse File';
				}
			}
		});

		sendToInboxBtn?.addEventListener('click', async () => {
			if (!parsedResult || !parsedResult.mappings || parsedResult.mappings.length === 0) {
				alert('No mappings to send');
				return;
			}

			if (sendToInboxBtn) {
				sendToInboxBtn.disabled = true;
				sendToInboxBtn.textContent = 'Sending...';
			}

			try {
				const response = await fetch(`/api/admin/bulk-image-upload/execute`, {
					method: 'POST',
					headers: {
						'content-type': 'application/json'
					},
					body: JSON.stringify({
						mappings: parsedResult.mappings,
						batch_name: batchName?.value || 'Bulk Image Upload'
					})
				});

				if (!response.ok) {
					const errorData = await response.json() as { message?: string };
					throw new Error(errorData.message || 'Failed to create inbox item');
				}

				const result = await response.json() as { message: string; inbox_id?: number };
				showResult('success', result.message, result.inbox_id ?? null);
			} catch (error) {
				showResult('error', error instanceof Error ? error.message : 'Unknown error');
			} finally {
				if (sendToInboxBtn) {
					sendToInboxBtn.disabled = false;
					sendToInboxBtn.textContent = 'Send to Inbox for Approval';
				}
			}
		});

		function escapeHtml(text: string): string {
			const div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}

		function showParseStatus(type: string, message: string) {
			if (!parseStatus) return;
			parseStatus.className = `mt-4 px-4 py-3 rounded-lg ${
				type === 'success'
					? 'bg-green-50 text-green-800 border border-green-200'
					: 'bg-red-50 text-red-800 border border-red-200'
			}`;
			parseStatus.textContent = message;
			parseStatus.classList.remove('hidden');
		}

		function renderPreview(data: ParsedData) {
			previewSection?.classList.remove('hidden');

			// Summary
			if (previewSummary) {
				previewSummary.innerHTML = DOMPurify.sanitize(`
					<div class="flex gap-4">
						<span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
							${data.summary.total_products} products
						</span>
						<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
							${data.summary.total_images} images
						</span>
						${data.summary.skipped > 0 ? `
							<span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-medium">
								${data.summary.skipped} errors
							</span>
						` : ''}
					</div>
				`);
			}

			// Mappings
			if (data.mappings && data.mappings.length > 0 && previewContent) {
				previewContent.innerHTML = DOMPurify.sanitize(data.mappings.map((mapping: ParsedMapping) => `
					<div class="border border-zinc-200 rounded-lg p-4 space-y-2">
						<div class="flex items-center justify-between">
							<p class="font-medium text-zinc-950">
								${escapeHtml(mapping.product_title)} <span class="text-zinc-500 text-sm">(ID: ${mapping.product_id})</span>
							</p>
							<span class="text-sm text-zinc-500">
								${mapping.image_urls.length} image${mapping.image_urls.length !== 1 ? 's' : ''} |
								Existing: ${mapping.existing_r2_images}
							</span>
						</div>
						<div class="flex gap-2 overflow-x-auto">
							${mapping.image_urls.map((url: string) => `
								<div class="flex-shrink-0">
									<img
										src="${escapeHtml(url)}"
										alt="Preview"
										class="w-20 h-20 object-cover rounded border border-zinc-200"
									/>
								</div>
							`).join('')}
						</div>
						<details class="text-xs text-zinc-500">
							<summary class="cursor-pointer hover:text-zinc-950">View URLs</summary>
							<ul class="mt-2 space-y-1 pl-4">
								${mapping.image_urls.map((url: string) => `<li class="truncate">${escapeHtml(url)}</li>`).join('')}
							</ul>
						</details>
					</div>
				`).join(''), { ADD_TAGS: ['img', 'details', 'summary'], ADD_ATTR: ['src', 'alt', 'loading'] });
			}

			// Errors
			if (data.errors && data.errors.length > 0 && previewErrors) {
				previewErrors.classList.remove('hidden');
				previewErrors.innerHTML = DOMPurify.sanitize(`
					<p class="text-sm font-medium text-red-700">Errors:</p>
					<ul class="space-y-1">
						${data.errors.map((err: ParsedError) => `
							<li class="text-sm text-red-600">
								${err.row > 0 ? `Row ${err.row}: ` : ''}${escapeHtml(err.error)}
							</li>
						`).join('')}
					</ul>
				`);
			} else {
				previewErrors?.classList.add('hidden');
			}
		}

		function showResult(type: string, message: string, inboxId: number | null = null) {
			if (!resultSection) return;
			resultSection.classList.remove('hidden');
			resultSection.className = `bg-white rounded-lg shadow p-6 space-y-4 ${
				type === 'success' ? 'border-l-4 border-green-500' : 'border-l-4 border-red-500'
			}`;

			resultSection.innerHTML = DOMPurify.sanitize(`
				<div class="${type === 'success' ? 'text-green-800' : 'text-red-800'}">
					<p class="font-medium">${escapeHtml(message)}</p>
					${inboxId ? `
						<a
							href="/admin/inbox/${inboxId}"
							class="inline-block mt-2 text-blue-600 hover:text-blue-800 underline"
						>
							View Inbox Item #${inboxId}
						</a>
					` : ''}
				</div>
			`, { ADD_TAGS: ['a'], ADD_ATTR: ['href'] });

			if (type === 'success') {
				previewSection?.classList.add('hidden');
				if (fileInput) fileInput.value = '';
				if (batchName) batchName.value = '';
				parsedResult = null;
			}
		}
	</script>
</AdminLayout>
