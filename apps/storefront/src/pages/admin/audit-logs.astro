---
export const prerender = false;

import AdminLayout from '../../layouts/AdminLayout.astro';
import { Alert } from '../../components/catalyst/alert-banner';
import { Heading } from '../../components/catalyst/heading';
import AuditLogsTable from '../../components/admin/AuditLogsTable';
import { ErrorBoundary } from '../../components/ErrorBoundary';
import { adminFetchList } from '../../lib/admin/fetchAdmin';
import { t } from '../../i18n';

const action = Astro.url.searchParams.get('action') || '';
const target = Astro.url.searchParams.get('target') || '';
const dateFrom = Astro.url.searchParams.get('date_from') || '';
const dateTo = Astro.url.searchParams.get('date_to') || '';
const page = Number(Astro.url.searchParams.get('page') || '1');
const perPage = 50;

type AuditLog = {
	id: number;
	actor: string | null;
	action: string;
	target: string | null;
	metadata: string | null;
	created_at: string;
};

const query = new URLSearchParams({
	limit: perPage.toString(),
	offset: ((page - 1) * perPage).toString(),
});
if (action) query.set('action', action);
if (target) query.set('target', target);
if (dateFrom) query.set('date_from', dateFrom);
if (dateTo) query.set('date_to', dateTo);

type AuditLogsResponse = { logs: AuditLog[]; total: number; filters?: { actions: string[]; targets: string[] } };
const { data, error: fetchError } = await adminFetchList<AuditLogsResponse>('/admin/audit-logs', query);
const logs = data?.logs || [];
const total = data?.total || 0;
const availableActions = data?.filters?.actions || [];
const availableTargets = data?.filters?.targets || [];
const error: string | null = fetchError ? t('errors.failedToLoadAuditLogs') : null;

const totalPages = Math.max(1, Math.ceil(total / perPage));
---

<AdminLayout title={`${t('admin.auditLogs')} - Admin`}>
	<div class="space-y-6">
		<div class="flex items-center gap-4">
			<Heading>{t('admin.auditLogs')}</Heading>
			<span class="text-xs text-zinc-500 bg-zinc-100 px-2 py-1 rounded-full">{total} {t('admin.entries')}</span>
		</div>

		{error && (
			<Alert color="red" client:load>
				{error}
			</Alert>
		)}

		<ErrorBoundary client:visible>
			<AuditLogsTable
				logs={logs}
				total={total}
				currentPage={page}
				totalPages={totalPages}
				actionFilter={action}
				targetFilter={target}
				dateFrom={dateFrom}
				dateTo={dateTo}
				availableActions={availableActions}
				availableTargets={availableTargets}
			/>
		</ErrorBoundary>
	</div>
</AdminLayout>
