---
export const prerender = false;

import { Alert } from '../../../components/catalyst/alert-banner';
import { Button } from '../../../components/catalyst/button';
import AdminLayout from '../../../layouts/AdminLayout.astro';
import ConfirmDialog from '../../../components/admin/ConfirmDialog.astro';
import { getApiBase } from '../../../lib/api';
import { Input } from '../../../components/catalyst/input';
import { Textarea } from '../../../components/catalyst/textarea';
import { Checkbox } from '../../../components/catalyst/checkbox';
import { Fieldset, Field, Label } from '../../../components/catalyst/fieldset';
import { getCsrfToken, validateCsrfToken, CSRF_FIELD_NAME } from '../../../lib/csrf';
import { t } from '../../../i18n';

const apiBase = getApiBase();
const apiKey = import.meta.env.ADMIN_API_KEY;
const { id } = Astro.params;

type TaxRate = {
	id: number;
	name: string;
	rate: number;
	applicable_from: string;
	applicable_to: string | null;
	is_active: number;
	description: string | null;
	created_at: string;
	updated_at: string;
};

let taxRate: TaxRate | null = null;
let error: string | null = null;
let success: string | null = null;

// Fetch tax rate
if (!apiKey) {
	error = t('errors.adminKeyMissing');
} else {
	try {
		const res = await fetch(`${apiBase}/admin/tax-rates/${id}`, {
			headers: { 'x-admin-key': apiKey }
		});

		if (res.ok) {
			taxRate = await res.json();
		} else if (res.status === 404) {
			error = t('errors.taxRateNotFound');
		} else {
			error = t('errors.failedToLoadTaxRates');
		}
	} catch (e) {
		console.error(e);
		error = t('errors.failedToLoadTaxRates');
	}
}

// Handle form submission
if (Astro.request.method === 'POST' && taxRate) {
	try {
		const formData = await Astro.request.formData();

		if (!validateCsrfToken(Astro.request, formData)) {
			error = 'Invalid CSRF token. Please reload and try again.';
		} else {
			const action = formData.get('action')?.toString();

			if (action === 'delete') {
				// Delete tax rate
				const res = await fetch(`${apiBase}/admin/tax-rates/${id}`, {
					method: 'DELETE',
					headers: { 'x-admin-key': apiKey! }
				});

				if (res.ok) {
					return Astro.redirect('/admin/tax-rates');
				} else {
					const data = await res.json();
					error = data.message || t('errors.failedToDeleteTaxRate');
				}
			} else {
				// Update tax rate
				const name = formData.get('name')?.toString().trim() || '';
				const rateStr = formData.get('rate')?.toString() || '';
				const applicable_from = formData.get('applicable_from')?.toString() || '';
				const applicable_to = formData.get('applicable_to')?.toString() || '';
				const description = formData.get('description')?.toString().trim() || '';
				const is_active = formData.get('is_active') === 'true';

				const rate = parseFloat(rateStr);

				if (!name) {
					error = t('errors.nameRequired');
				} else if (isNaN(rate) || rate < 0 || rate > 1) {
					error = t('errors.rateBetween');
				} else if (!applicable_from) {
					error = t('errors.applicableFromRequired');
				} else {
					const res = await fetch(`${apiBase}/admin/tax-rates/${id}`, {
						method: 'PUT',
						headers: {
							'Content-Type': 'application/json',
							'x-admin-key': apiKey!
						},
						body: JSON.stringify({
							name,
							rate,
							applicable_from,
							applicable_to: applicable_to || null,
							description: description || null,
							is_active
						})
					});

					if (res.ok) {
						taxRate = await res.json();
						success = t('admin.taxRateUpdated');
					} else {
						const data = await res.json();
						error = data.message || t('errors.failedToUpdateTaxRate');
					}
				}
			}
		}
	} catch (e) {
		console.error(e);
		error = t('errors.failedToProcessRequest');
	}
}

const formatRate = (rate: number) => `${(rate * 100).toFixed(1)}%`;

const { token: csrfToken, cookieHeader: csrfCookieHeader } = getCsrfToken(Astro.request);
if (csrfCookieHeader) {
	Astro.response.headers.append('Set-Cookie', csrfCookieHeader);
}
---

<AdminLayout title={taxRate ? `${t('common.edit')}: ${taxRate.name}` : `${t('admin.taxRates')} - Admin`}>
	<div class="space-y-6 max-w-2xl">
		<div class="flex items-center gap-4">
			<a href="/admin/tax-rates" class="text-indigo-600 hover:text-indigo-500 text-sm flex items-center gap-1">
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
				</svg>
				{t('admin.taxRates')}
			</a>
			<h1 class="text-2xl font-semibold text-gray-900">
				{taxRate ? `${t('common.edit')}: ${taxRate.name}` : t('admin.taxRates')}
			</h1>
		</div>

		{error && (
			<Alert color="red" client:load>
				{error}
			</Alert>
		)}

		{success && (
			<Alert color="green" client:load>
				{success}
			</Alert>
		)}

		{taxRate && (
			<>
				<form method="POST" class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6">
					<input type="hidden" name={CSRF_FIELD_NAME} value={csrfToken} />
					<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
						<div class="md:col-span-2">
				<Fieldset client:load>
							<Field>
								<Label htmlFor="name">{t('admin.name')} <span class="text-red-500">*</span></Label>
								<Input client:load
									type="text"
									id="name"
									name="name"
									required
									value={taxRate.name}
								/>
							</Field>
						</div>

						<div>
							<Field>
								<Label htmlFor="rate">{t('admin.rateDecimal')} <span class="text-red-500">*</span></Label>
								<Input client:load
									type="number"
									id="rate"
									name="rate"
									required
									step="0.01"
									min="0"
									max="1"
									value={taxRate.rate}
								/>
								<p data-slot="description" class="text-base/6 text-zinc-500 sm:text-sm/6">{t('admin.currentRate', { rate: formatRate(taxRate.rate) })}</p>
							</Field>
						</div>

						<div>
							<Field>
								<Label htmlFor="applicable_from">{t('admin.applicableFrom')} <span class="text-red-500">*</span></Label>
								<Input client:load
									type="date"
									id="applicable_from"
									name="applicable_from"
									required
									value={taxRate.applicable_from}
								/>
							</Field>
						</div>

						<div>
							<Field>
								<Label htmlFor="applicable_to">{t('admin.applicableTo')}</Label>
								<Input client:load
									type="date"
									id="applicable_to"
									name="applicable_to"
									value={taxRate.applicable_to || ''}
								/>
								<p data-slot="description" class="text-base/6 text-zinc-500 sm:text-sm/6">{t('admin.noEndDate')}</p>
							</Field>
						</div>

						<div class="md:col-span-2">
							<Field>
								<Label htmlFor="description">{t('admin.description')}</Label>
								<Textarea client:load
									id="description"
									name="description"
									rows={3}
								>{taxRate.description || ''}</Textarea>
							</Field>
						</div>

						<div class="md:col-span-2">
							<Field>
								<div class="flex items-center gap-2">
									<Checkbox client:load
										id="is_active"
										name="is_active"
										value="true"
										checked={taxRate.is_active === 1}
									/>
									<label for="is_active" class="text-base/6 text-zinc-950 select-none sm:text-sm/6">{t('admin.active')}</label>
								</div>
							</Field>
				</Fieldset>
						</div>
					</div>

					<div class="flex gap-3 pt-4 border-t border-gray-200">
						<Button type="submit" color="indigo" client:load >
							{t('admin.saveChanges')}
						</Button>
						<Button href="/admin/tax-rates" outline client:load >
							{t('common.cancel')}
						</Button>
					</div>
				</form>

				<form method="POST" class="bg-white rounded-xl border border-red-200 shadow-sm p-6">
					<input type="hidden" name={CSRF_FIELD_NAME} value={csrfToken} />
					<h3 class="text-lg font-semibold text-red-600 mb-3">	{t('admin.dangerZone')}</h3>
					<p class="text-sm text-secondary mb-4">
						{t('admin.deactivateDescription')}
					</p>
						<input type="hidden" name="action" value="delete" />
						<button
							type="submit"
							onclick={`return confirm('${t('admin.deactivateConfirm')}')`}
							class="relative isolate inline-flex items-baseline justify-center gap-x-2 rounded-lg border text-base/6 font-semibold px-[calc(var(--spacing)*3.5-1px)] py-[calc(var(--spacing)*2.5-1px)] sm:px-[calc(var(--spacing)*3-1px)] sm:py-[calc(var(--spacing)*1.5-1px)] sm:text-sm/6 border-transparent text-white cursor-default [--btn-bg:var(--color-red-600)] [--btn-border:var(--color-red-700)]/90 bg-[--btn-border] before:absolute before:inset-0 before:-z-10 before:rounded-[calc(var(--radius-lg)-1px)] before:bg-[--btn-bg] before:shadow-sm"
						>
							{t('admin.deactivateTaxRate')}
						</button>
				</form>

				<div class="bg-gray-50 rounded-lg p-4 text-sm text-secondary">
					<div class="grid grid-cols-2 gap-4">
						<div>
							<div class="font-medium text-zinc-950">	{t('admin.created')}</div>
							<div>{new Date(taxRate.created_at).toLocaleString('ja-JP')}</div>
						</div>
						<div>
							<div class="font-medium text-zinc-950">	{t('admin.updated')}</div>
							<div>{new Date(taxRate.updated_at).toLocaleString('ja-JP')}</div>
						</div>
					</div>
				</div>
			</>
		)}
	</div>
	<ConfirmDialog />
</AdminLayout>

<script define:vars={{ taxRateName: taxRate?.name }}>
	window.__taxRateConfig = { taxRateName };
</script>
<script type="module">
	const { taxRateName } = window.__taxRateConfig;
	const deleteForm = document.getElementById('tax-rate-delete-form');
	deleteForm?.addEventListener('submit', async (e) => {
		e.preventDefault();
		const confirmed = await window.__confirmDialog({
			title: 'Deactivate Tax Rate',
			message: `Are you sure you want to deactivate "${taxRateName}"? It will no longer be assignable to products.`,
			confirmLabel: 'Deactivate',
			danger: true,
		});
		if (confirmed) {
			deleteForm.submit();
		}
	});
</script>
