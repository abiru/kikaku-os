---
export const prerender = false;

import AdminLayout from'../../layouts/AdminLayout.astro';
import { Alert } from'../../components/catalyst/alert-banner';
import OrdersTable from'../../components/admin/OrdersTable';
import { Heading } from'../../components/catalyst/heading';
import { getApiBase } from'../../lib/api';
import type { Order } from'../../lib/types';
import { t } from '../../i18n';

const apiBase = getApiBase();
const q = Astro.url.searchParams.get('q') ||'';
const page = Number(Astro.url.searchParams.get('page') ||'1');
const paymentStatus = Astro.url.searchParams.get('payment') || '';
const fulfillmentStatus = Astro.url.searchParams.get('fulfillment') || '';
const dateFrom = Astro.url.searchParams.get('from') || '';
const dateTo = Astro.url.searchParams.get('to') || '';
const perPage = Number(Astro.url.searchParams.get('perPage') || '20');

let orders: Order[] = [];
let meta = { totalCount: 0, totalPages: 1 };
let error = null;

if (import.meta.env.ADMIN_API_KEY) {
	try {
		const query = new URLSearchParams({
			q,
			page: page.toString(),
			perPage: perPage.toString()
		});
		if (paymentStatus) query.set('status', paymentStatus);
		if (fulfillmentStatus) query.set('fulfillment', fulfillmentStatus);
		if (dateFrom) query.set('from', dateFrom);
		if (dateTo) query.set('to', dateTo);

		const res = await fetch(`${apiBase}/admin/orders?${query}`, {
			headers: {'x-admin-key': import.meta.env.ADMIN_API_KEY }
		});

		if (!res.ok) throw new Error(`API Error: ${res.status}`);

		const data = await res.json();
		orders = data.orders || [];
		meta = data.meta || meta;
	} catch (e) {
		console.error(e);
		error = t('errors.failedToLoadOrders');
	}
} else {
	error = t('errors.adminKeyMissing');
}

const hasFilters = paymentStatus || fulfillmentStatus || dateFrom || dateTo;
---

<AdminLayout title={`${t('admin.orders')} - Admin`}>
	<div class="space-y-6">
		<div class="flex items-center gap-4">
			<Heading>{t('admin.orders')}</Heading>
			<span class="text-xs text-zinc-500 bg-zinc-100 px-2 py-1 rounded-full">{meta.totalCount} {t('admin.total')}</span>
		</div>

		{/* Toolbar */}
		<div class="flex flex-col sm:flex-row gap-4 justify-between">
			{/* CSV Export */}
			<details class="bg-white rounded-xl border border-gray-200 shadow-sm w-full">
				<summary class="px-4 py-3 text-sm font-medium text-zinc-700 cursor-pointer hover:text-indigo-600 flex items-center gap-2">
					<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
					</svg>
					{t('admin.exportOrders')}
				</summary>
				<div class="px-4 pb-4 pt-2">
					<form id="export-form" class="flex flex-wrap items-end gap-4">
						<div>
							<label for="export-from" class="block text-xs font-medium text-zinc-600 mb-1">{t('admin.exportDateFrom')}</label>
							<input type="date" id="export-from" name="from" class="rounded-md border-zinc-200 text-sm py-1.5" required />
						</div>
						<div>
							<label for="export-to" class="block text-xs font-medium text-zinc-600 mb-1">{t('admin.exportDateTo')}</label>
							<input type="date" id="export-to" name="to" class="rounded-md border-zinc-200 text-sm py-1.5" required />
						</div>
						<button type="submit" class="px-4 py-1.5 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700">
							{t('admin.exportCsv')}
						</button>
					</form>
					<div id="export-error" class="hidden mt-2 text-sm text-red-600"></div>
				</div>
			</details>
		</div>

		<div class="flex flex-col sm:flex-row gap-4 justify-between">
			<form method="get" class="relative w-full max-w-md">
				<label for="order-search" class="sr-only">{t('admin.searchOrders')}</label>
				<input
					type="search"
					id="order-search"
					name="q"
					value={q}
					placeholder={t('admin.searchOrders')}
					class="w-full pl-10 pr-4 py-2 bg-white border border-zinc-200 rounded-lg text-sm text-zinc-950 focus:outline-none focus:ring-2 focus:ring-indigo-600/20 focus:border-indigo-600 transition-all shadow-sm"
				/>
				<svg
					class="absolute left-3 top-2.5 h-4 w-4 text-zinc-400"
					fill="none"
					stroke="currentColor"
					viewBox="0 0 24 24"
				>
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
				</svg>
				{/* Preserve filter values */}
				{paymentStatus && <input type="hidden" name="payment" value={paymentStatus} />}
				{fulfillmentStatus && <input type="hidden" name="fulfillment" value={fulfillmentStatus} />}
				{dateFrom && <input type="hidden" name="from" value={dateFrom} />}
				{dateTo && <input type="hidden" name="to" value={dateTo} />}
				<input type="hidden" name="perPage" value={perPage.toString()} />
			</form>
			<div class="flex items-center gap-2">
				<select
					onchange={`window.location.href='?q=${q}&perPage='+this.value${paymentStatus ? `+'&payment=${paymentStatus}'` : ''}${fulfillmentStatus ? `+'&fulfillment=${fulfillmentStatus}'` : ''}${dateFrom ? `+'&from=${dateFrom}'` : ''}${dateTo ? `+'&to=${dateTo}'` : ''}`}
					class="rounded-lg border border-zinc-200 bg-white px-3 py-1.5 text-sm text-zinc-700 shadow-sm"
				>
					{[10, 20, 50, 100].map((n) => (
						<option value={n} selected={perPage === n}>{t('admin.perPage', { count: n })}</option>
					))}
				</select>
				<a
					href={Astro.url.pathname + Astro.url.search}
					class="inline-flex items-center gap-1.5 rounded-lg border border-zinc-200 bg-white px-3 py-1.5 text-sm text-zinc-700 shadow-sm hover:bg-zinc-50 transition-colors"
					title={t('admin.refresh')}
				>
					<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
					</svg>
					{t('admin.refresh')}
				</a>
			</div>
		</div>

		{/* Advanced Filters */}
		<details class={`bg-white rounded-xl border border-gray-200 shadow-sm ${hasFilters ? '' : ''}`} open={!!hasFilters}>
			<summary class="px-4 py-3 text-sm font-medium text-zinc-700 cursor-pointer hover:text-indigo-600">
				Filters
				{hasFilters && <span class="ml-2 text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full">Active</span>}
			</summary>
			<form method="get" class="px-4 pb-4 pt-2">
				<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
					<div>
						<label for="filter-payment" class="block text-xs font-medium text-zinc-600 mb-1">Payment Status</label>
						<select id="filter-payment" name="payment" class="w-full rounded-md border-zinc-200 text-sm py-1.5">
							<option value="">All</option>
							<option value="paid" selected={paymentStatus === 'paid'}>Paid</option>
							<option value="pending" selected={paymentStatus === 'pending'}>Pending</option>
							<option value="refunded" selected={paymentStatus === 'refunded'}>Refunded</option>
						</select>
					</div>
					<div>
						<label for="filter-fulfillment" class="block text-xs font-medium text-zinc-600 mb-1">Fulfillment</label>
						<select id="filter-fulfillment" name="fulfillment" class="w-full rounded-md border-zinc-200 text-sm py-1.5">
							<option value="">All</option>
							<option value="shipped" selected={fulfillmentStatus === 'shipped'}>Shipped</option>
							<option value="unfulfilled" selected={fulfillmentStatus === 'unfulfilled'}>Unfulfilled</option>
						</select>
					</div>
					<div>
						<label for="filter-from" class="block text-xs font-medium text-zinc-600 mb-1">Date From</label>
						<input type="date" id="filter-from" name="from" value={dateFrom} class="w-full rounded-md border-zinc-200 text-sm py-1.5" />
					</div>
					<div>
						<label for="filter-to" class="block text-xs font-medium text-zinc-600 mb-1">Date To</label>
						<input type="date" id="filter-to" name="to" value={dateTo} class="w-full rounded-md border-zinc-200 text-sm py-1.5" />
					</div>
				</div>
				{q && <input type="hidden" name="q" value={q} />}
				<div class="flex gap-2 mt-4">
					<button type="submit" class="px-4 py-1.5 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700">
						Apply Filters
					</button>
					{hasFilters && (
						<a href={q ? `?q=${q}` : '?'} class="px-4 py-1.5 text-sm font-medium text-zinc-600 bg-zinc-100 rounded-lg hover:bg-zinc-200">
							Clear Filters
						</a>
					)}
				</div>
			</form>
		</details>

		{error && (
			<Alert color="red" client:load>
				{error}
			</Alert>
		)}

		<OrdersTable
			client:visible
			orders={orders}
			currentPage={page}
			totalPages={meta.totalPages}
			searchQuery={q}
		/>
	</div>

	<script>
		const form = document.getElementById('export-form') as HTMLFormElement | null;
		const errorDiv = document.getElementById('export-error');
		if (form) {
			form.addEventListener('submit', (e) => {
				e.preventDefault();
				const fromInput = form.querySelector<HTMLInputElement>('[name="from"]');
				const toInput = form.querySelector<HTMLInputElement>('[name="to"]');
				const from = fromInput?.value || '';
				const to = toInput?.value || '';

				if (errorDiv) {
					errorDiv.classList.add('hidden');
					errorDiv.textContent = '';
				}

				if (!from || !to) {
					if (errorDiv) {
						errorDiv.textContent = '日付範囲を指定してください。';
						errorDiv.classList.remove('hidden');
					}
					return;
				}

				if (from > to) {
					if (errorDiv) {
						errorDiv.textContent = '開始日は終了日以前にしてください。';
						errorDiv.classList.remove('hidden');
					}
					return;
				}

				window.location.href = `/api/admin/orders/export?from=${from}&to=${to}&format=csv`;
			});
		}
	</script>
</AdminLayout>
