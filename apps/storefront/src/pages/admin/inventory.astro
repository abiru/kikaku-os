---
export const prerender = false;

import { Alert } from '../../components/catalyst/alert-banner';
import AdminLayout from '../../layouts/AdminLayout.astro';
import { getApiBase } from '../../lib/api';
import { Heading } from '../../components/catalyst/heading';
import InventoryPage from '../../components/admin/InventoryPage';

const apiBase = getApiBase();
const apiKey = import.meta.env.ADMIN_API_KEY || '';

type InventoryItem = {
	variant_id: number;
	variant_title: string;
	product_id: number;
	product_title: string;
	sku: string | null;
	on_hand: number;
	threshold: number | null;
	status: 'ok' | 'low' | 'out';
};

let inventory: InventoryItem[] = [];
let error: string | null = null;

// Get filter from query params
const statusFilter = Astro.url.searchParams.get('status') || '';
const searchQuery = Astro.url.searchParams.get('q') || '';

// Fetch inventory
if (apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/inventory`, {
			headers: { 'x-admin-key': apiKey }
		});

		if (!res.ok) {
			const data = await res.json();
			error = data.message || `API Error: ${res.status}`;
		} else {
			const data = await res.json();
			inventory = data.inventory || [];
		}
	} catch (e) {
		console.error(e);
		error = 'Failed to load inventory. Please check your connection.';
	}
} else {
	error = 'ADMIN_API_KEY is missing in server environment.';
}

// Apply filters
let filteredInventory = inventory;

if (statusFilter) {
	filteredInventory = filteredInventory.filter((item) => item.status === statusFilter);
}

if (searchQuery) {
	const q = searchQuery.toLowerCase();
	filteredInventory = filteredInventory.filter(
		(item) =>
			item.product_title.toLowerCase().includes(q) ||
			item.variant_title.toLowerCase().includes(q) ||
			(item.sku && item.sku.toLowerCase().includes(q))
	);
}

// Counts for tabs
const counts = {
	all: inventory.length,
	low: inventory.filter((i) => i.status === 'low').length,
	out: inventory.filter((i) => i.status === 'out').length
};

const buildFilterUrl = (newStatus: string) => {
	const params = new URLSearchParams();
	if (newStatus) params.set('status', newStatus);
	if (searchQuery) params.set('q', searchQuery);
	const queryString = params.toString();
	return queryString ? `?${queryString}` : '/admin/inventory';
};
---

<AdminLayout title="Inventory - Admin">
	<div class="space-y-6">
		<div class="flex items-center gap-4">
			<Heading>Inventory</Heading>
			<span class="text-xs text-zinc-500 bg-zinc-100 px-2 py-1 rounded-full">{inventory.length} variants</span>
		</div>

		{error && (
			<Alert color="red" client:load>
				{error}
			</Alert>
		)}

		<!-- Filter Tabs -->
		<div class="mb-6 flex gap-2 flex-wrap">
			<a
				href={buildFilterUrl('')}
				class:list={[
					'px-4 py-2 rounded-lg text-sm font-medium transition-colors',
					!statusFilter
						? 'bg-indigo-600 text-white'
						: 'bg-white border border-zinc-200 text-zinc-950 hover:bg-zinc-50'
				]}
			>
				All ({counts.all})
			</a>
			<a
				href={buildFilterUrl('low')}
				class:list={[
					'px-4 py-2 rounded-lg text-sm font-medium transition-colors',
					statusFilter === 'low'
						? 'bg-amber-500 text-white'
						: 'bg-white border border-zinc-200 text-zinc-950 hover:bg-zinc-50'
				]}
			>
				Low Stock ({counts.low})
			</a>
			<a
				href={buildFilterUrl('out')}
				class:list={[
					'px-4 py-2 rounded-lg text-sm font-medium transition-colors',
					statusFilter === 'out'
						? 'bg-red-600 text-white'
						: 'bg-white border border-zinc-200 text-zinc-950 hover:bg-zinc-50'
				]}
			>
				Out of Stock ({counts.out})
			</a>
		</div>

		<!-- Search -->
		<div class="mb-6">
			<form method="get" class="relative max-w-md">
				<input type="hidden" name="status" value={statusFilter} />
				<input
					type="search"
					name="q"
					value={searchQuery}
					placeholder="Search by product, variant, or SKU..."
					class="w-full pl-10 pr-4 py-2 bg-white border border-zinc-200 rounded-lg text-sm text-zinc-950 placeholder:text-zinc-500 focus:outline-none focus:ring-2 focus:ring-indigo-600/20 focus:border-indigo-600 transition-all shadow-sm"
				/>
				<svg class="absolute left-3 top-2.5 h-4 w-4 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
				</svg>
			</form>
		</div>

		<InventoryPage
			client:only="react"
			inventory={filteredInventory}
			apiBase={apiBase}
			apiKey={apiKey}
		/>
	</div>
</AdminLayout>
