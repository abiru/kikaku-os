---
export const prerender = false;

import { Alert } from '../../components/catalyst/alert-banner';
import EmptyState from '../../components/EmptyState.astro';
import AdminLayout from '../../layouts/AdminLayout.astro';
import { Heading, Subheading } from '../../components/catalyst/heading';
import { getApiBase } from '../../lib/api';
import { Button } from '../../components/catalyst/button';

const apiBase = getApiBase();
const apiKey = import.meta.env.ADMIN_API_KEY;

// Form Action Handling (SSR)
let actionMessage = null;

if (Astro.request.method === 'POST') {
	try {
		const formData = await Astro.request.formData();
		const action = formData.get('action');
		const id = formData.get('id');

		if (apiKey && id && (action === 'approve' || action === 'reject')) {
			const res = await fetch(`${apiBase}/inbox/${id}/${action}`, {
				method: 'POST',
				headers: { 'x-admin-key': apiKey }
			});
			if (!res.ok) throw new Error(`API Error: ${res.status}`);
			actionMessage = { type: 'success', text: `Item ${action}ed successfully.` };
		}
	} catch (e) {
		console.error(e);
		actionMessage = { type: 'error', text: 'Failed to process action.' };
	}
}

// Data Fetching
let items: any[] = [];
let error = null;

if (apiKey) {
	try {
		const res = await fetch(`${apiBase}/inbox?status=open&limit=50`, {
			headers: { 'x-admin-key': apiKey }
		});
		if (!res.ok) throw new Error(`API Error: ${res.status}`);
		const data = await res.json();
		items = data.items || [];
	} catch (e) {
		error = 'Failed to load inbox.';
	}
} else {
	error = 'ADMIN_API_KEY is missing.';
}

const parseBody = (body: string) => {
	try {
		if (body.startsWith('{') || body.startsWith('[')) {
			const json = JSON.parse(body);
			return JSON.stringify(json, null, 2);
		}
		return body;
	} catch {
		return body;
	}
};

const parseMetadata = (metadataStr: string | null) => {
	if (!metadataStr) return null;
	try {
		return JSON.parse(metadataStr);
	} catch {
		return null;
	}
};

const getBadgeColor = (severity: string) => {
	switch (severity) {
		case 'critical': return 'red';
		case 'warning': return 'amber';
		default: return 'blue';
	}
};
---

<AdminLayout title="Inbox - Admin">
	<div class="space-y-6 max-w-4xl">
		<div class="flex items-center justify-between">
			<div class="flex items-center gap-4">
				<Heading>Inbox</Heading>
				<span class="text-xs text-zinc-500 bg-zinc-100 px-2 py-1 rounded-full">{items.length} pending</span>
			</div>
		</div>

		{actionMessage && (
			<Alert color={actionMessage.type === 'success' ? 'green' : 'red'} client:load>
				{actionMessage.text}
			</Alert>
		)}

		{error && (
			<Alert color="red" client:load>
				{error}
			</Alert>
		)}

		{items.length > 0 ? (
			<div class="space-y-4">
				{items.map((item) => {
					const metadata = parseMetadata(item.metadata);
					const isBulkImageUpload = item.kind === 'bulk_image_upload';
					const badgeColor = getBadgeColor(item.severity);

					return (
						<div class="bg-white rounded-xl p-6 shadow-sm border border-zinc-200 flex flex-col sm:flex-row gap-6">
							<div class="flex-1 space-y-3">
								<div class="flex items-center gap-3 flex-wrap">
									<span class={`inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ring-1 ring-inset ${
										badgeColor === 'red' ? 'bg-red-50 text-red-700 ring-red-600/20' :
										badgeColor === 'amber' ? 'bg-amber-50 text-amber-700 ring-amber-600/20' :
										'bg-blue-50 text-blue-700 ring-blue-600/20'
									}`}>
										{item.severity}
									</span>
									<Subheading>{item.title}</Subheading>
									<span class="text-xs text-zinc-500 ml-auto sm:ml-0">
										{new Date(item.created_at).toLocaleString('ja-JP')}
									</span>
								</div>

								{isBulkImageUpload && metadata && metadata.upload_items ? (
									<div class="space-y-4">
										<div class="flex gap-4 flex-wrap">
											<span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
												ğŸ“¦ {metadata.upload_items.length} products
											</span>
											<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
												ğŸ–¼ï¸ {metadata.total_images} images
											</span>
										</div>

										<div class="space-y-3 max-h-96 overflow-y-auto">
											{metadata.upload_items.map((uploadItem: any) => (
												<div class="border border-zinc-200 rounded-lg p-3 space-y-2">
													<div class="flex items-center justify-between flex-wrap gap-2">
														<p class="font-medium text-zinc-900 text-sm">
															{uploadItem.product_title} <span class="text-zinc-500 text-xs">(ID: {uploadItem.product_id})</span>
														</p>
														<span class="text-xs text-zinc-600">
															ğŸ“· {uploadItem.image_urls.length} image{uploadItem.image_urls.length !== 1 ? 's' : ''} | Existing: {uploadItem.existing_r2_images}
														</span>
													</div>
													<div class="flex gap-2 overflow-x-auto">
														{uploadItem.image_urls.map((url: string) => (
															<img
																src={url}
																alt="Preview"
																class="w-16 h-16 object-cover rounded border border-zinc-300 flex-shrink-0"
																onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2264%22 height=%2264%22%3E%3Crect fill=%22%23ddd%22 width=%2264%22 height=%2264%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-size=%2210%22%3EError%3C/text%3E%3C/svg%3E'"
															/>
														))}
													</div>
												</div>
											))}
										</div>

										{metadata.results && (
											<div class="bg-green-50 border border-green-200 rounded-lg p-3">
												<p class="text-sm text-green-800 font-medium">
													âœ… Upload results: {metadata.results.succeeded || 0} succeeded, {metadata.results.failed || 0} failed
												</p>
											</div>
										)}
									</div>
								) : (
									<div class="text-sm text-zinc-700 whitespace-pre-wrap">
										{parseBody(item.body)}
									</div>
								)}
							</div>

							<div class="flex flex-col gap-2 sm:w-32">
								<form method="post">
									<input type="hidden" name="id" value={item.id} />
									<input type="hidden" name="action" value="approve" />
									<Button client:load type="submit" color="indigo" className="w-full">
										âœ“ Approve
									</Button>
								</form>
								<form method="post">
									<input type="hidden" name="id" value={item.id} />
									<input type="hidden" name="action" value="reject" />
									<Button client:load type="submit" color="zinc" className="w-full">
										âœ• Dismiss
									</Button>
								</form>
							</div>
						</div>
					);
				})}
			</div>
		) : (
			<EmptyState
				title="No pending items"
				description="Your inbox is clear. All items have been reviewed."
			/>
		)}
	</div>
</AdminLayout>
