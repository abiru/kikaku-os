---
export const prerender = false;

import Badge from '../../components/Badge.astro';
import Button from '../../components/Button.astro';
import EmptyState from '../../components/EmptyState.astro';
import AdminLayout from '../../layouts/AdminLayout.astro';
import { getApiBase } from '../../lib/api';

const apiBase = getApiBase();
const apiKey = import.meta.env.ADMIN_API_KEY;

// Form Action Handling (SSR)
let actionMessage = null;

if (Astro.request.method === 'POST') {
	try {
		const formData = await Astro.request.formData();
		const action = formData.get('action');
		const id = formData.get('id');

		if (apiKey && id && (action === 'approve' || action === 'reject')) {
			const res = await fetch(`${apiBase}/inbox/${id}/${action}`, {
				method: 'POST',
				headers: { 'x-admin-key': apiKey }
			});
			if (!res.ok) throw new Error(`API Error: ${res.status}`);
			actionMessage = { type: 'success', text: `Item ${action}ed successfully.` };
		}
	} catch (e) {
		console.error(e);
		actionMessage = { type: 'error', text: 'Failed to process action.' };
	}
}

// Data Fetching
let items: any[] = [];
let error = null;

if (apiKey) {
	try {
		const res = await fetch(`${apiBase}/inbox?status=open&limit=50`, {
			headers: { 'x-admin-key': apiKey }
		});
		if (!res.ok) throw new Error(`API Error: ${res.status}`);
		const data = await res.json();
		items = data.items || [];
	} catch (e) {
		error = 'Failed to load inbox.';
	}
} else {
	error = 'ADMIN_API_KEY is missing.';
}

const parseBody = (body: string) => {
	try {
		// Attempt to parse if it looks like JSON
		if (body.startsWith('{') || body.startsWith('[')) {
			const json = JSON.parse(body);
			return JSON.stringify(json, null, 2);
		}
		return body;
	} catch {
		return body;
	}
};

const parseMetadata = (metadataStr: string | null) => {
	if (!metadataStr) return null;
	try {
		return JSON.parse(metadataStr);
	} catch {
		return null;
	}
};
---

<AdminLayout title="Inbox - Admin">
	<div class="space-y-6 max-w-4xl">
		<div class="flex items-center justify-between">
			<div class="flex items-center gap-4">
				<h1 class="text-2xl font-semibold text-zinc-900">Inbox</h1>
				<span class="text-xs text-zinc-500 bg-zinc-100 px-2 py-1 rounded-full">{items.length} pending</span>
			</div>
			<Button href="/admin/products" size="sm" variant="secondary">
				Products
			</Button>
		</div>
			{actionMessage && (
				<div class={`mb-6 px-4 py-3 rounded-lg text-sm border ${
					actionMessage.type === 'success' ? 'bg-green-50 text-green-700 border-green-200' : 'bg-red-50 text-red-700 border-red-200'
				}`}>
					{actionMessage.text}
				</div>
			)}

			{error && (
				<div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg mb-6 text-sm">
					{error}
				</div>
			)}

			{items.length > 0 ? (
				<div class="space-y-4">
					{items.map((item) => {
						const metadata = parseMetadata(item.metadata);
						const isBulkImageUpload = item.kind === 'bulk_image_upload';

						return (
							<div class="bg-white rounded-lg p-6 ring-1 ring-zinc-900/5 flex flex-col sm:flex-row gap-6">
								<div class="flex-1 space-y-3">
									<div class="flex items-center gap-3">
										<Badge severity={item.severity === 'critical' ? 'critical' : item.severity === 'warning' ? 'warn' : 'info'}>
											{item.severity}
										</Badge>
										<h2 class="text-base font-semibold text-zinc-900">{item.title}</h2>
										<span class="text-xs text-zinc-500 ml-auto sm:ml-0">
											{new Date(item.created_at).toLocaleString()}
										</span>
									</div>

									{isBulkImageUpload && metadata && metadata.upload_items ? (
										<div class="space-y-4">
											<div class="flex gap-4">
												<span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
													ğŸ“¦ {metadata.upload_items.length} products
												</span>
												<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
													ğŸ–¼ï¸ {metadata.total_images} images
												</span>
											</div>

											<div class="space-y-3 max-h-96 overflow-y-auto">
												{metadata.upload_items.map((uploadItem: any) => (
													<div class="border border-zinc-200 rounded-lg p-3 space-y-2">
														<div class="flex items-center justify-between">
															<p class="font-medium text-zinc-900 text-sm">
																{uploadItem.product_title} <span class="text-zinc-500 text-xs">(ID: {uploadItem.product_id})</span>
															</p>
															<span class="text-xs text-zinc-600">
																ğŸ“· {uploadItem.image_urls.length} image{uploadItem.image_urls.length !== 1 ? 's' : ''} | Existing: {uploadItem.existing_r2_images}
															</span>
														</div>
														<div class="flex gap-2 overflow-x-auto">
															{uploadItem.image_urls.map((url: string) => (
																<img
																	src={url}
																	alt="Preview"
																	class="w-16 h-16 object-cover rounded border border-zinc-300 flex-shrink-0"
																	onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2264%22 height=%2264%22%3E%3Crect fill=%22%23ddd%22 width=%2264%22 height=%2264%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-size=%2210%22%3EError%3C/text%3E%3C/svg%3E'"
																/>
															))}
														</div>
													</div>
												))}
											</div>

											{metadata.results && (
												<div class="bg-green-50 border border-green-200 rounded-lg p-3">
													<p class="text-sm text-green-800 font-medium">
														âœ“ Upload completed: {metadata.results.success_count} products, {metadata.results.images_added} images added
													</p>
													{metadata.results.failed_count > 0 && (
														<details class="mt-2">
															<summary class="cursor-pointer text-red-600 text-sm">
																âš  {metadata.results.failed_count} errors
															</summary>
															<ul class="mt-2 text-xs space-y-1">
																{metadata.results.errors.map((err: any) => (
																	<li class="text-red-600">
																		Product {err.product_id}: {err.url} - {err.error}
																	</li>
																))}
															</ul>
														</details>
													)}
												</div>
											)}
										</div>
									) : (
										<div class="bg-zinc-50 rounded-lg p-3 text-sm font-mono text-zinc-600 overflow-x-auto">
											<pre class="whitespace-pre-wrap">{parseBody(item.body)}</pre>
										</div>
									)}
								</div>

								<div class="flex sm:flex-col gap-3 justify-center sm:min-w-[120px]">
									<form method="POST" class="w-full">
										<input type="hidden" name="id" value={item.id} />
										<input type="hidden" name="action" value="approve" />
										<button
											type="submit"
											class="w-full rounded-lg bg-emerald-50 text-zinc-900 border border-emerald-200 px-4 py-2 text-sm font-medium hover:bg-emerald-100 transition-colors"
										>
											Approve
										</button>
									</form>
									<form method="POST" class="w-full">
										<input type="hidden" name="id" value={item.id} />
										<input type="hidden" name="action" value="reject" />
										<button
											type="submit"
											class="w-full rounded-lg bg-white text-zinc-500 border border-zinc-200 px-4 py-2 text-sm font-medium hover:bg-zinc-50 hover:text-zinc-900 transition-colors"
										>
											Dismiss
										</button>
									</form>
								</div>
							</div>
						);
					})}
				</div>
			) : (
				<div class="py-20">
					<EmptyState
						title="All caught up"
						description="No pending items in your inbox."
						ctaLabel="Refresh"
						ctaHref="/admin/inbox"
					/>
				</div>
			)}
	</div>
</AdminLayout>
