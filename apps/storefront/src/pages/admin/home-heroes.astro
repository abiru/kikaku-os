---
export const prerender = false;

import { Alert } from '../../components/catalyst/alert-banner';
import { Badge } from '../../components/catalyst/badge';
import { Button } from '../../components/catalyst/button';
import { Heading } from '../../components/catalyst/heading';
import { Table, TableHead, TableBody, TableRow, TableHeader, TableCell } from '../../components/catalyst/table';
import AdminLayout from '../../layouts/AdminLayout.astro';
import { getApiBase } from '../../lib/api';

const apiBase = getApiBase();
const status = Astro.url.searchParams.get('status') || 'all';
const page = Number(Astro.url.searchParams.get('page') || '1');
const perPage = 20;

let heroes: any[] = [];
let meta = { totalCount: 0, totalPages: 1 };
let error = null;

// SSR Data Fetching
if (import.meta.env.ADMIN_API_KEY) {
	try {
		const query = new URLSearchParams({
			status,
			page: page.toString(),
			perPage: perPage.toString()
		});

		const res = await fetch(`${apiBase}/admin/home/heroes?${query}`, {
			headers: {
				'x-admin-key': import.meta.env.ADMIN_API_KEY
			}
		});

		if (!res.ok) {
			throw new Error(`API Error: ${res.status}`);
		}

		const data = await res.json();
		heroes = data.heroes || [];
		meta = data.meta || meta;
	} catch (e) {
		console.error(e);
		error = 'Failed to load hero sections. Please check your admin key.';
	}
} else {
	error = 'ADMIN_API_KEY is missing in server environment.';
}

const hasNext = page < meta.totalPages;
const hasPrev = page > 1;
---

<AdminLayout title="Home Heroes - Admin">
	<div class="space-y-6">
		<div class="flex items-center justify-between">
			<div class="flex items-center gap-4">
				<Heading>Home Hero Sections</Heading>
				<span class="text-xs text-zinc-500 bg-zinc-100 px-2 py-1 rounded-full">{meta.totalCount} items</span>
			</div>
			<Button href="/admin/home-heroes/new"  color="indigo" client:load>
				+ New Hero Section
			</Button>
		</div>

		{/* Status Filter Tabs */}
		<div class="flex gap-2">
			<a
				href="?status=all"
				class={`px-4 py-2 text-sm font-medium rounded-lg transition-colors ${status === 'all' ? 'bg-indigo-600 text-white' : 'bg-white text-zinc-950 border border-zinc-200 hover:bg-zinc-50'}`}
			>
				All
			</a>
			<a
				href="?status=active"
				class={`px-4 py-2 text-sm font-medium rounded-lg transition-colors ${status === 'active' ? 'bg-indigo-600 text-white' : 'bg-white text-zinc-950 border border-zinc-200 hover:bg-zinc-50'}`}
			>
				Active
			</a>
			<a
				href="?status=draft"
				class={`px-4 py-2 text-sm font-medium rounded-lg transition-colors ${status === 'draft' ? 'bg-indigo-600 text-white' : 'bg-white text-zinc-950 border border-zinc-200 hover:bg-zinc-50'}`}
			>
				Draft
			</a>
			<a
				href="?status=archived"
				class={`px-4 py-2 text-sm font-medium rounded-lg transition-colors ${status === 'archived' ? 'bg-indigo-600 text-white' : 'bg-white text-zinc-950 border border-zinc-200 hover:bg-zinc-50'}`}
			>
				Archived
			</a>
		</div>

		{error && (
			<Alert color="red" client:load>
				{error}
			</Alert>
		)}

		{/* Hero Sections Table */}
		<div class="bg-white rounded-xl border border-zinc-200 shadow-sm overflow-hidden">
			<div class="overflow-x-auto">
				<Table client:only="react">
					<TableHead>
						<TableRow>
							<TableHeader>Position</TableHeader>
							<TableHeader>Title</TableHeader>
							<TableHeader>Status</TableHeader>
							<TableHeader>Updated</TableHeader>
							<TableHeader className="text-right">Action</TableHeader>
						</TableRow>
					</TableHead>
					<TableBody>
						{heroes.length > 0 ? (
							heroes.map((hero) => (
								<TableRow href={`/admin/home-heroes/${hero.id}`}>
									<TableCell>
										<span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-zinc-100 text-xs font-medium">
											{hero.position}
										</span>
									</TableCell>
									<TableCell>
										<div class="font-medium">{hero.title}</div>
										<div class="text-xs text-zinc-500 truncate max-w-xs">{hero.subtitle}</div>
									</TableCell>
									<TableCell>
										{hero.status === 'draft' ? (
											<Badge color="zinc" client:only="react">Draft</Badge>
										) : hero.status === 'archived' ? (
											<Badge color="red" client:only="react">Archived</Badge>
										) : (
											<Badge color="blue" client:only="react">Active</Badge>
										)}
									</TableCell>
									<TableCell className="text-zinc-500 tabular-nums">
										{new Date(hero.updated_at).toLocaleDateString('ja-JP')}
									</TableCell>
									<TableCell className="text-right">
										<div class="flex items-center justify-end gap-2">
											<a
												href={`/admin/home-heroes/${hero.id}`}
												class="text-indigo-600 hover:underline text-xs font-medium"
											>
												Edit
											</a>
											{hero.status !== 'archived' && (
												<button
													data-id={hero.id}
													data-action="archive"
													class="archive-btn text-red-600 hover:underline text-xs font-medium"
												>
													Archive
												</button>
											)}
											{hero.status === 'archived' && (
												<button
													data-id={hero.id}
													data-action="restore"
													class="restore-btn text-green-600 hover:underline text-xs font-medium"
												>
													Restore
												</button>
											)}
										</div>
									</TableCell>
								</TableRow>
							))
						) : (
							<TableRow>
								<TableCell colSpan={5} className="text-center text-zinc-500">
									No hero sections found. Create your first one!
								</TableCell>
							</TableRow>
						)}
					</TableBody>
				</Table>
			</div>
		</div>

		{/* Pagination */}
		{meta.totalPages > 1 && (
			<div class="flex items-center justify-between">
				<div class="text-sm text-zinc-500">
					Page {page} of {meta.totalPages}
				</div>
				<div class="flex gap-2">
					{hasPrev ? (
						<Button
							href={`?status=${status}&page=${page - 1}`}
							outline
							client:load
						>
							Previous
						</Button>
					) : (
						<Button plain disabled client:load>
							Previous
						</Button>
					)}
					{hasNext ? (
						<Button
							href={`?status=${status}&page=${page + 1}`}
							outline
							client:load
						>
							Next
						</Button>
					) : (
						<Button plain disabled client:load>
							Next
						</Button>
					)}
				</div>
			</div>
		)}
	</div>
</AdminLayout>

<script define:vars={{ apiBase, adminKey: import.meta.env.ADMIN_API_KEY }}>
	document.querySelectorAll('.archive-btn').forEach(btn => {
		btn.addEventListener('click', async (e) => {
			const id = e.target.dataset.id;
			if (!confirm('Archive this hero section?')) return;

			try {
				const res = await fetch(`${apiBase}/admin/home/heroes/${id}`, {
					method: 'DELETE',
					headers: { 'x-admin-key': adminKey }
				});

				if (res.ok) {
					window.location.reload();
				} else {
					alert('Failed to archive hero section');
				}
			} catch (error) {
				alert('Error: ' + error.message);
			}
		});
	});

	document.querySelectorAll('.restore-btn').forEach(btn => {
		btn.addEventListener('click', async (e) => {
			const id = e.target.dataset.id;

			try {
				const res = await fetch(`${apiBase}/admin/home/heroes/${id}/restore`, {
					method: 'POST',
					headers: { 'x-admin-key': adminKey }
				});

				if (res.ok) {
					window.location.reload();
				} else {
					alert('Failed to restore hero section');
				}
			} catch (error) {
				alert('Error: ' + error.message);
			}
		});
	});
</script>
