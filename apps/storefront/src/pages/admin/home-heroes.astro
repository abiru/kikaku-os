---
export const prerender = false;

import { Alert } from '../../components/catalyst/alert-banner';
import { Button } from '../../components/catalyst/button';
import { Heading } from '../../components/catalyst/heading';
import AdminLayout from '../../layouts/AdminLayout.astro';
import { adminFetchList } from '../../lib/admin/fetchAdmin';
import HomeHeroesPage from '../../components/admin/HomeHeroesPage';
import { t } from '../../i18n';
import type { HeroSection } from '../../lib/types';

const status = Astro.url.searchParams.get('status') || 'all';
const page = Number(Astro.url.searchParams.get('page') || '1');
const perPage = 20;

const query = new URLSearchParams({
	status,
	page: page.toString(),
	perPage: perPage.toString()
});

const { data, error: fetchError } = await adminFetchList<{ heroes: HeroSection[]; meta: { totalCount: number; totalPages: number } }>('/admin/home/heroes', query);
const heroes = data?.heroes || [];
const meta = data?.meta || { totalCount: 0, totalPages: 1 };
const error = fetchError ? t('errors.failedToLoadHeroes') : null;

const hasNext = page < meta.totalPages;
const hasPrev = page > 1;
---

<AdminLayout title={`${t('admin.homeHeroes')} - Admin`}>
	<div class="space-y-6">
		<div class="flex items-center justify-between">
			<div class="flex items-center gap-4">
				<Heading>{t('admin.homeHeroSections')}</Heading>
				<span class="text-xs text-zinc-500 bg-zinc-100 px-2 py-1 rounded-full">{meta.totalCount} {t('admin.items')}</span>
			</div>
			<Button href="/admin/home-heroes/new" color="indigo" client:load>
				{t('admin.newHeroSection')}
			</Button>
		</div>

		{/* Status Filter Tabs */}
		<div class="flex gap-2">
			<a
				href="?status=all"
				class={`px-4 py-2 text-sm font-medium rounded-lg transition-colors ${status === 'all' ? 'bg-indigo-600 text-white' : 'bg-white text-zinc-950 border border-zinc-200 hover:bg-zinc-50'}`}
			>
				{t('common.all')}
			</a>
			<a
				href="?status=active"
				class={`px-4 py-2 text-sm font-medium rounded-lg transition-colors ${status === 'active' ? 'bg-indigo-600 text-white' : 'bg-white text-zinc-950 border border-zinc-200 hover:bg-zinc-50'}`}
			>
				{t('admin.active')}
			</a>
			<a
				href="?status=draft"
				class={`px-4 py-2 text-sm font-medium rounded-lg transition-colors ${status === 'draft' ? 'bg-indigo-600 text-white' : 'bg-white text-zinc-950 border border-zinc-200 hover:bg-zinc-50'}`}
			>
				{t('admin.draft')}
			</a>
			<a
				href="?status=archived"
				class={`px-4 py-2 text-sm font-medium rounded-lg transition-colors ${status === 'archived' ? 'bg-indigo-600 text-white' : 'bg-white text-zinc-950 border border-zinc-200 hover:bg-zinc-50'}`}
			>
				{t('admin.archived')}
			</a>
		</div>

		{error && (
			<Alert color="red" client:load>
				{error}
			</Alert>
		)}

		<HomeHeroesPage
			client:only="react"
			heroes={heroes}
		/>

		{/* Pagination */}
		{meta.totalPages > 1 && (
			<div class="flex items-center justify-between">
				<div class="text-sm text-zinc-500">
					{t('admin.pageOf', { page, totalPages: meta.totalPages })}
				</div>
				<div class="flex gap-2">
					{hasPrev ? (
						<Button
							href={`?status=${status}&page=${page - 1}`}
							outline
							client:load
						>
							{t('admin.previous')}
						</Button>
					) : (
						<Button plain disabled client:load>
							{t('admin.previous')}
						</Button>
					)}
					{hasNext ? (
						<Button
							href={`?status=${status}&page=${page + 1}`}
							outline
							client:load
						>
							{t('admin.next')}
						</Button>
					) : (
						<Button plain disabled client:load>
							{t('admin.next')}
						</Button>
					)}
				</div>
			</div>
		)}
	</div>
</AdminLayout>
