---
export const prerender = false;

import { Alert } from '../../components/catalyst/alert-banner';
import { Button } from '../../components/catalyst/button';
import { Heading } from '../../components/catalyst/heading';
import AdminLayout from '../../layouts/AdminLayout.astro';
import { getApiBase } from '../../lib/api';
import HomeHeroesPage from '../../components/admin/HomeHeroesPage';

const apiBase = getApiBase();
const status = Astro.url.searchParams.get('status') || 'all';
const page = Number(Astro.url.searchParams.get('page') || '1');
const perPage = 20;

let heroes: any[] = [];
let meta = { totalCount: 0, totalPages: 1 };
let error = null;

// SSR Data Fetching
if (import.meta.env.ADMIN_API_KEY) {
	try {
		const query = new URLSearchParams({
			status,
			page: page.toString(),
			perPage: perPage.toString()
		});

		const res = await fetch(`${apiBase}/admin/home/heroes?${query}`, {
			headers: {
				'x-admin-key': import.meta.env.ADMIN_API_KEY
			}
		});

		if (!res.ok) {
			throw new Error(`API Error: ${res.status}`);
		}

		const data = await res.json();
		heroes = data.heroes || [];
		meta = data.meta || meta;
	} catch (e) {
		console.error(e);
		error = 'Failed to load hero sections. Please check your admin key.';
	}
} else {
	error = 'ADMIN_API_KEY is missing in server environment.';
}

const hasNext = page < meta.totalPages;
const hasPrev = page > 1;
---

<AdminLayout title="Home Heroes - Admin">
	<div class="space-y-6">
		<div class="flex items-center justify-between">
			<div class="flex items-center gap-4">
				<Heading>Home Hero Sections</Heading>
				<span class="text-xs text-zinc-500 bg-zinc-100 px-2 py-1 rounded-full">{meta.totalCount} items</span>
			</div>
			<Button href="/admin/home-heroes/new" color="indigo" client:load>
				+ New Hero Section
			</Button>
		</div>

		{/* Status Filter Tabs */}
		<div class="flex gap-2">
			<a
				href="?status=all"
				class={`px-4 py-2 text-sm font-medium rounded-lg transition-colors ${status === 'all' ? 'bg-indigo-600 text-white' : 'bg-white text-zinc-950 border border-zinc-200 hover:bg-zinc-50'}`}
			>
				All
			</a>
			<a
				href="?status=active"
				class={`px-4 py-2 text-sm font-medium rounded-lg transition-colors ${status === 'active' ? 'bg-indigo-600 text-white' : 'bg-white text-zinc-950 border border-zinc-200 hover:bg-zinc-50'}`}
			>
				Active
			</a>
			<a
				href="?status=draft"
				class={`px-4 py-2 text-sm font-medium rounded-lg transition-colors ${status === 'draft' ? 'bg-indigo-600 text-white' : 'bg-white text-zinc-950 border border-zinc-200 hover:bg-zinc-50'}`}
			>
				Draft
			</a>
			<a
				href="?status=archived"
				class={`px-4 py-2 text-sm font-medium rounded-lg transition-colors ${status === 'archived' ? 'bg-indigo-600 text-white' : 'bg-white text-zinc-950 border border-zinc-200 hover:bg-zinc-50'}`}
			>
				Archived
			</a>
		</div>

		{error && (
			<Alert color="red" client:load>
				{error}
			</Alert>
		)}

		<HomeHeroesPage
			client:only="react"
			heroes={heroes}
		/>

		{/* Pagination */}
		{meta.totalPages > 1 && (
			<div class="flex items-center justify-between">
				<div class="text-sm text-zinc-500">
					Page {page} of {meta.totalPages}
				</div>
				<div class="flex gap-2">
					{hasPrev ? (
						<Button
							href={`?status=${status}&page=${page - 1}`}
							outline
							client:load
						>
							Previous
						</Button>
					) : (
						<Button plain disabled client:load>
							Previous
						</Button>
					)}
					{hasNext ? (
						<Button
							href={`?status=${status}&page=${page + 1}`}
							outline
							client:load
						>
							Next
						</Button>
					) : (
						<Button plain disabled client:load>
							Next
						</Button>
					)}
				</div>
			</div>
		)}
	</div>
</AdminLayout>
