---
export const prerender = false;

import { Badge } from '../../../components/catalyst/badge';
import { Button } from '../../../components/catalyst/button';
import { Fieldset, Field } from '../../../components/catalyst/fieldset';
import { Heading, Subheading } from '../../../components/catalyst/heading';
import { Input } from '../../../components/catalyst/input';
import { Select } from '../../../components/catalyst/select';
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getApiBase } from '../../../lib/api';
import { formatDate } from '../../../lib/format';

const { id } = Astro.params;
const apiBase = getApiBase();
const apiKey = import.meta.env.ADMIN_API_KEY;

type AdminUser = {
	id: number;
	clerk_user_id: string;
	email: string;
	name: string | null;
	role_id: string;
	role_name: string;
	role_priority: number;
	is_active: number;
	last_login_at: string | null;
	created_at: string;
	updated_at: string;
};

type Role = {
	id: string;
	name: string;
	description: string | null;
	priority: number;
};

type Permission = {
	id: string;
	name: string;
	resource: string;
	action: string;
};

let user: AdminUser | null = null;
let roles: Role[] = [];
let permissions: Permission[] = [];
let error: string | null = null;
let successMessage: string | null = null;

// Handle POST - Update user
if (Astro.request.method === 'POST' && apiKey) {
	try {
		const formData = await Astro.request.formData();
		const action = formData.get('action')?.toString();

		if (action === 'delete') {
			// Handle delete
			const res = await fetch(`${apiBase}/admin/users/${id}`, {
				method: 'DELETE',
				headers: { 'x-admin-key': apiKey }
			});

			const data = await res.json();

			if (!res.ok) {
				error = data.error || 'Failed to delete user';
			} else {
				return Astro.redirect('/admin/users?deleted=true');
			}
		} else {
			// Handle update
			const email = formData.get('email')?.toString().trim();
			const name = formData.get('name')?.toString().trim() || null;
			const role_id = formData.get('role_id')?.toString();
			const is_active = formData.get('is_active') === 'true';

			const updateData: Record<string, unknown> = {};
			if (email) updateData.email = email;
			if (name !== undefined) updateData.name = name;
			if (role_id) updateData.role_id = role_id;
			updateData.is_active = is_active;

			const res = await fetch(`${apiBase}/admin/users/${id}`, {
				method: 'PUT',
				headers: {
					'Content-Type': 'application/json',
					'x-admin-key': apiKey
				},
				body: JSON.stringify(updateData)
			});

			const data = await res.json();

			if (!res.ok) {
				error = data.error || 'Failed to update user';
			} else {
				user = data.user;
				successMessage = 'User updated successfully';
			}
		}
	} catch (e) {
		console.error(e);
		error = 'Failed to update user. Please check your connection.';
	}
}

// Fetch roles list
if (apiKey) {
	try {
		const rolesRes = await fetch(`${apiBase}/admin/roles`, {
			headers: { 'x-admin-key': apiKey }
		});
		if (rolesRes.ok) {
			const rolesData = await rolesRes.json();
			roles = rolesData.roles || [];
		}
	} catch (e) {
		console.error('Failed to fetch roles:', e);
	}
}

// Fetch user data (if not already set from POST)
if (!user && apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/users/${id}`, {
			headers: { 'x-admin-key': apiKey }
		});

		if (!res.ok) {
			if (res.status === 404) {
				error = 'User not found';
			} else {
				const data = await res.json();
				error = data.error || `API Error: ${res.status}`;
			}
		} else {
			const data = await res.json();
			user = data.user;
			permissions = data.permissions || [];
		}
	} catch (e) {
		console.error(e);
		error = error || 'Failed to load user. Please check your connection.';
	}
} else if (!apiKey) {
	error = 'ADMIN_API_KEY is missing in server environment';
}

// Re-fetch permissions if user was updated via POST
if (user && successMessage && apiKey) {
	try {
		const res = await fetch(`${apiBase}/admin/users/${id}`, {
			headers: { 'x-admin-key': apiKey }
		});
		if (res.ok) {
			const data = await res.json();
			permissions = data.permissions || [];
		}
	} catch (e) {
		console.error('Failed to re-fetch permissions:', e);
	}
}

const dateTimeOpts: Intl.DateTimeFormatOptions = {
	year: 'numeric',
	month: '2-digit',
	day: '2-digit',
	hour: '2-digit',
	minute: '2-digit'
};

const getRoleBadgeColor = (roleId: string): 'amber' | 'blue' | 'green' | 'zinc' => {
	switch (roleId) {
		case 'admin':
			return 'amber';
		case 'manager':
			return 'blue';
		case 'accountant':
			return 'green';
		default:
			return 'zinc';
	}
};

// Group permissions by resource
const groupedPermissions = permissions.reduce((acc, perm) => {
	if (!acc[perm.resource]) {
		acc[perm.resource] = [];
	}
	const group = acc[perm.resource];
	if (group) group.push(perm);
	return acc;
}, {} as Record<string, Permission[]>);
---

<AdminLayout title={user ? `${user.name || user.email} - Admin` : 'User - Admin'}>
	<div class="space-y-6 max-w-4xl">
		<div class="flex items-center gap-4">
			<a href="/admin/users" class="text-indigo-600 hover:underline text-sm flex items-center gap-1">
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
				</svg>
				Users
			</a>
			<Heading>
				{user ? (user.name || user.email) : 'User'}
			</Heading>
			{user && (
				<Badge color={getRoleBadgeColor(user.role_id)} client:load>
					{user.role_name}
				</Badge>
			)}
		</div>

		{successMessage && (
			<div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg text-sm">
				{successMessage}
			</div>
		)}

		{error && !user && (
			<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-8 text-center">
				<div class="text-red-600 mb-4">{error}</div>
				<Button href="/admin/users" outline client:load>
					Back to Users
				</Button>
			</div>
		)}

		{error && user && (
			<div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm">
				{error}
			</div>
		)}

		{user && (
			<>
				{/* Edit Form */}
				<form method="POST" class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6">
					<Subheading>User Details</Subheading>

					<Fieldset client:load>
						<Field>
							<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">Clerk User ID</label>
							<Input
								type="text"
								value={user.clerk_user_id}
								disabled
								className="bg-zinc-50 cursor-not-allowed"
							/>
							<p class="text-xs text-zinc-500 mt-1">This ID cannot be changed.</p>
						</Field>

						<Field>
							<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">Email *</label>
							<Input
								type="email"
								name="email"
								required
								value={user.email}
							/>
						</Field>

						<Field>
							<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">Name</label>
							<Input
								type="text"
								name="name"
								value={user.name || ''}
								placeholder="Display name"
							/>
						</Field>

						<Field>
							<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">Role</label>
							<Select name="role_id">
								{roles.map(role => (
									<option value={role.id} selected={user.role_id === role.id}>
										{role.name} - {role.description}
									</option>
								))}
							</Select>
						</Field>

						<Field>
							<label data-slot="label" class="text-base/6 font-medium text-zinc-950 select-none sm:text-sm/6">Status</label>
							<Select name="is_active">
								<option value="true" selected={user.is_active === 1}>Active</option>
								<option value="false" selected={user.is_active === 0}>Inactive</option>
							</Select>
						</Field>
					</Fieldset>

					<div class="pt-4 border-t border-gray-100">
						<dl class="grid grid-cols-2 gap-4 text-sm">
							<div>
								<dt class="text-[#86868b]">Created</dt>
								<dd class="text-zinc-950 tabular-nums">{formatDate(user.created_at, dateTimeOpts)}</dd>
							</div>
							<div>
								<dt class="text-[#86868b]">Last Login</dt>
								<dd class="text-zinc-950 tabular-nums">{formatDate(user.last_login_at, dateTimeOpts)}</dd>
							</div>
						</dl>
					</div>

					<div class="flex justify-end gap-3 pt-4 border-t border-gray-100">
						<Button href="/admin/users" outline client:load>
							Back
						</Button>
						<Button type="submit" color="indigo" client:load>
							Save Changes
						</Button>
					</div>
				</form>

				{/* Delete Form (separate) */}
				<form method="POST" class="bg-white rounded-xl border border-red-200 shadow-sm p-6" id="delete-form">
					<input type="hidden" name="action" value="delete" />
					<div class="flex items-center justify-between">
						<div>
							<h3 class="font-medium text-red-600">Danger Zone</h3>
							<p class="text-sm text-zinc-500">Permanently delete this user. This action cannot be undone.</p>
						</div>
						<Button type="submit" color="red" client:load>
							Delete User
						</Button>
					</div>
				</form>

				<script>
					const deleteForm = document.getElementById('delete-form');
					deleteForm?.addEventListener('submit', (e) => {
						if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
							e.preventDefault();
						}
					});
				</script>

				{/* Permissions */}
				<div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
					<Subheading>Permissions</Subheading>
					<p class="text-sm text-zinc-500 mb-4">Permissions are determined by the user's role.</p>

					{Object.keys(groupedPermissions).length === 0 ? (
						<p class="text-zinc-500 text-sm">No permissions assigned.</p>
					) : (
						<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
							{Object.entries(groupedPermissions).map(([resource, perms]) => (
								<div class="border border-zinc-200 rounded-lg p-3">
									<h4 class="font-medium text-zinc-900 capitalize mb-2">{resource}</h4>
									<div class="flex flex-wrap gap-1">
										{perms.map(perm => (
											<Badge color="zinc" client:load>{perm.action}</Badge>
										))}
									</div>
								</div>
							))}
						</div>
					)}
				</div>
			</>
		)}
	</div>
</AdminLayout>
