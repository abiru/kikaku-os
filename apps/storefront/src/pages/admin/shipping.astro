---
export const prerender = false;

import Badge from '../../components/Badge.astro';
import AdminLayout from '../../layouts/AdminLayout.astro';
import { getApiBase } from '../../lib/api';

const apiBase = getApiBase();

type ReadyToShipOrder = {
	order_id: number;
	customer_email: string | null;
	total: number;
	paid_at: string | null;
	fulfillment_id: number | null;
	fulfillment_status: string | null;
};

let orders: ReadyToShipOrder[] = [];
let error: string | null = null;

if (import.meta.env.ADMIN_API_KEY) {
	try {
		const res = await fetch(`${apiBase}/admin/orders/ready-to-ship`, {
			headers: { 'x-admin-key': import.meta.env.ADMIN_API_KEY }
		});

		if (!res.ok) throw new Error(`API Error: ${res.status}`);

		const data = await res.json();
		orders = data.orders || [];
	} catch (e) {
		console.error(e);
		error = 'Failed to load orders ready to ship.';
	}
} else {
	error = 'ADMIN_API_KEY is missing.';
}

const formatCurrency = (amount: number) => {
	return new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(amount);
};

const formatDate = (dateStr: string | null) => {
	if (!dateStr) return '-';
	const d = new Date(dateStr);
	return `${d.toLocaleDateString()} ${d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
};

const apiKey = import.meta.env.ADMIN_API_KEY;
---

<AdminLayout title="Shipping - Admin">
	<div class="space-y-6">
		<div class="flex items-center gap-4">
			<h1 class="text-2xl font-semibold text-gray-900">Shipping</h1>
			<span class="text-xs text-white bg-indigo-600 px-2 py-1 rounded-full font-medium">{orders.length} ready</span>
		</div>
			{error && (
				<div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg mb-6 text-sm">
					{error}
				</div>
			)}

			<div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
				<div class="overflow-x-auto">
					<table class="w-full text-left text-sm text-[#1d1d1f]">
						<thead class="bg-gray-50 border-b border-gray-200">
							<tr>
								<th class="px-6 py-3 font-medium text-[#86868b]">Order</th>
								<th class="px-6 py-3 font-medium text-[#86868b]">Customer</th>
								<th class="px-6 py-3 font-medium text-[#86868b]">Paid At</th>
								<th class="px-6 py-3 font-medium text-[#86868b]">Status</th>
								<th class="px-6 py-3 font-medium text-[#86868b] text-right">Total</th>
								<th class="px-6 py-3 font-medium text-[#86868b] text-right">Actions</th>
							</tr>
						</thead>
						<tbody class="divide-y divide-gray-100">
							{orders.length > 0 ? (
								orders.map((order) => (
									<tr class="hover:bg-gray-50 transition-colors">
										<td class="px-6 py-4 font-medium">
											<a href={`/admin/orders/${order.order_id}`} class="text-[#0071e3] hover:underline">
												#{order.order_id}
											</a>
										</td>
										<td class="px-6 py-4">
											<div class="text-[#1d1d1f]">{order.customer_email || 'Guest'}</div>
										</td>
										<td class="px-6 py-4 text-[#86868b] tabular-nums">
											{formatDate(order.paid_at)}
										</td>
										<td class="px-6 py-4">
											<Badge severity="secondary">
												{order.fulfillment_status || 'Unfulfilled'}
											</Badge>
										</td>
										<td class="px-6 py-4 text-right font-medium tabular-nums">
											{formatCurrency(order.total)}
										</td>
										<td class="px-6 py-4 text-right">
											<button
												type="button"
												class="ship-btn px-3 py-1.5 text-sm font-medium text-white bg-[#0071e3] rounded-lg hover:bg-[#0077ED] transition-colors"
												data-order-id={order.order_id}
												data-fulfillment-id={order.fulfillment_id || ''}
											>
												Ship
											</button>
										</td>
									</tr>
								))
							) : (
								<tr>
									<td colspan="6" class="px-6 py-12 text-center text-[#86868b]">
										No orders ready to ship.
									</td>
								</tr>
							)}
						</tbody>
					</table>
				</div>
			</div>

		<!-- Ship Modal -->
		<div id="ship-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
			<div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
				<div class="p-6 border-b border-gray-100">
					<h3 class="text-lg font-semibold text-gray-900">Ship Order</h3>
					<p id="ship-subtitle" class="text-sm text-gray-500 mt-1"></p>
				</div>
				<form id="ship-form" class="p-6 space-y-4">
					<input type="hidden" id="ship-order-id" name="orderId" />
					<input type="hidden" id="ship-fulfillment-id" name="fulfillmentId" />

					<div>
						<label for="ship-tracking" class="block text-sm font-medium text-gray-900 mb-2">
							Tracking Number
						</label>
						<input
							type="text"
							id="ship-tracking"
							name="tracking_number"
							class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm text-gray-900 font-mono focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all"
							placeholder="Optional tracking number"
						/>
					</div>

					<div id="ship-error" class="hidden bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm"></div>

					<div class="flex justify-end gap-3 pt-4 border-t border-gray-100">
						<button
							type="button"
							id="cancel-ship-btn"
							class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
						>
							Cancel
						</button>
						<button
							type="submit"
							class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors"
						>
							Mark as Shipped
						</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</AdminLayout>

<script define:vars={{ apiBase, apiKey }}>
	const modal = document.getElementById('ship-modal');
	const form = document.getElementById('ship-form');
	const subtitle = document.getElementById('ship-subtitle');
	const orderIdInput = document.getElementById('ship-order-id');
	const fulfillmentIdInput = document.getElementById('ship-fulfillment-id');
	const trackingInput = document.getElementById('ship-tracking');
	const errorEl = document.getElementById('ship-error');
	const cancelBtn = document.getElementById('cancel-ship-btn');

	function showModal(orderId, fulfillmentId) {
		if (!modal || !orderIdInput || !fulfillmentIdInput || !subtitle || !trackingInput || !errorEl) {
			console.error('Ship modal elements not found');
			return;
		}
		orderIdInput.value = orderId;
		fulfillmentIdInput.value = fulfillmentId || '';
		subtitle.textContent = `Order #${orderId}`;
		trackingInput.value = '';
		errorEl.classList.add('hidden');
		modal.classList.remove('hidden');
	}

	function hideModal() {
		if (!modal || !form) return;
		modal.classList.add('hidden');
		form.reset();
	}

	function showError(message) {
		if (!errorEl) return;
		errorEl.textContent = message;
		errorEl.classList.remove('hidden');
	}

	// Event listeners for Ship buttons
	document.querySelectorAll('.ship-btn').forEach((btn) => {
		btn.addEventListener('click', () => {
			const button = btn;
			const orderId = button.dataset.orderId;
			const fulfillmentId = button.dataset.fulfillmentId;
			showModal(orderId, fulfillmentId);
		});
	});

	cancelBtn?.addEventListener('click', hideModal);

	modal?.addEventListener('click', (e) => {
		if (e.target === modal) hideModal();
	});

	// Form submission
	form?.addEventListener('submit', async (e) => {
		e.preventDefault();

		const orderId = orderIdInput.value;
		const fulfillmentId = fulfillmentIdInput.value;
		const tracking_number = trackingInput.value.trim() || null;

		try {
			let res;
			if (fulfillmentId) {
				// Update existing fulfillment
				res = await fetch(`${apiBase}/admin/fulfillments/${fulfillmentId}`, {
					method: 'PUT',
					headers: {
						'Content-Type': 'application/json',
						'x-admin-key': apiKey
					},
					body: JSON.stringify({ status: 'shipped', tracking_number })
				});
			} else {
				// Create new fulfillment
				res = await fetch(`${apiBase}/admin/orders/${orderId}/fulfillments`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'x-admin-key': apiKey
					},
					body: JSON.stringify({ status: 'shipped', tracking_number })
				});
			}

			if (!res.ok) {
				const data = await res.json();
				showError(data.message || 'Failed to update shipping status');
				return;
			}

			location.reload();
		} catch (err) {
			showError('An error occurred. Please try again.');
		}
	});
</script>
