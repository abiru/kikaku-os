---
import Button from '../components/Button.astro';
import Container from '../components/Container.astro';
import Layout from '../layouts/Layout.astro';
---

<Layout title="Shopping Cart - Led Kikaku">
	<div class="min-h-screen bg-[#f5f5f7]">
		<Container class="py-16">
			<h1 class="text-4xl font-semibold tracking-tight text-[#1d1d1f] md:text-5xl">
				Your cart
			</h1>

			{/* Cart Content - Rendered by JS */}
			<div id="cart-content" class="mt-10"></div>
		</Container>
	</div>
</Layout>

<script>
	import { $cartItems, $cartArray, $cartTotal, $cartCurrency, removeFromCart, updateQuantity, clearCart, type CartItem } from '../lib/cart';
	import { getApiBase } from '../lib/api';

	const formatPrice = (amount: number, currency: string) => {
		return new Intl.NumberFormat('ja-JP', {
			style: 'currency',
			currency: currency || 'JPY'
		}).format(amount);
	};

	const renderCart = () => {
		const container = document.getElementById('cart-content');
		if (!container) return;

		const items = $cartArray.get();
		const total = $cartTotal.get();
		const currency = $cartCurrency.get();

		if (items.length === 0) {
			container.innerHTML = `
				<div class="text-center py-16">
					<div class="mx-auto flex h-20 w-20 items-center justify-center rounded-full bg-gray-100 mb-8">
						<svg class="h-10 w-10 text-[#86868b]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
							<path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 00-16.536-1.84M7.5 14.25L5.106 5.272M6 20.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm12.75 0a.75.75 0 11-1.5 0 .75.75 0 011.5 0z" />
						</svg>
					</div>
					<h2 class="text-2xl font-semibold text-[#1d1d1f] mb-4">Your cart is empty</h2>
					<p class="text-[#86868b] mb-8">Add some products to get started.</p>
					<a href="/products" class="inline-flex items-center justify-center rounded-full bg-[#0071e3] px-6 py-3 text-white font-medium hover:bg-[#0077ED] transition-colors">
						Browse products
					</a>
				</div>
			`;
			return;
		}

		const itemsHtml = items.map((item: CartItem) => `
			<div class="flex items-start gap-6 py-6 border-b border-gray-200" data-variant-id="${item.variantId}">
				<div class="flex-1">
					<h3 class="font-semibold text-[#1d1d1f]">${item.title}</h3>
					${item.variantTitle !== 'Default' ? `<p class="text-sm text-[#86868b]">${item.variantTitle}</p>` : ''}
					<p class="mt-2 text-[#1d1d1f]">${formatPrice(item.price, item.currency)}</p>
				</div>
				<div class="flex items-center gap-3">
					<button class="qty-btn w-8 h-8 rounded-full border border-gray-300 flex items-center justify-center hover:bg-gray-100 transition-colors" data-action="decrease" data-variant-id="${item.variantId}">
						<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
							<path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" />
						</svg>
					</button>
					<span class="w-8 text-center font-medium">${item.quantity}</span>
					<button class="qty-btn w-8 h-8 rounded-full border border-gray-300 flex items-center justify-center hover:bg-gray-100 transition-colors" data-action="increase" data-variant-id="${item.variantId}">
						<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
							<path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
						</svg>
					</button>
				</div>
				<div class="text-right">
					<p class="font-semibold text-[#1d1d1f]">${formatPrice(item.price * item.quantity, item.currency)}</p>
					<button class="remove-btn mt-2 text-sm text-[#0071e3] hover:underline" data-variant-id="${item.variantId}">
						Remove
					</button>
				</div>
			</div>
		`).join('');

		container.innerHTML = `
			<div class="grid gap-10 lg:grid-cols-3">
				<div class="lg:col-span-2">
					<div class="rounded-3xl bg-white p-6 shadow-sm">
						${itemsHtml}
					</div>
				</div>
				<div class="lg:col-span-1">
					<div class="rounded-3xl bg-white p-6 shadow-sm sticky top-24">
						<h2 class="text-xl font-semibold text-[#1d1d1f] mb-6">Order summary</h2>
						<div class="space-y-4 pb-6 border-b border-gray-200">
							<div class="flex justify-between">
								<span class="text-[#86868b]">Subtotal</span>
								<span class="text-[#1d1d1f]">${formatPrice(total, currency)}</span>
							</div>
							<div class="flex justify-between">
								<span class="text-[#86868b]">Shipping</span>
								<span class="text-[#1d1d1f]">Calculated at checkout</span>
							</div>
						</div>
						<div class="flex justify-between py-6 text-lg font-semibold">
							<span>Total</span>
							<span>${formatPrice(total, currency)}</span>
						</div>
						<button id="checkout-btn" class="w-full rounded-full bg-[#0071e3] px-6 py-4 text-white font-medium hover:bg-[#0077ED] transition-colors">
							Proceed to checkout
						</button>
						<a href="/products" class="block mt-4 text-center text-[#0071e3] hover:underline">
							Continue shopping
						</a>
					</div>
				</div>
			</div>
		`;

		// Attach event listeners
		container.querySelectorAll('.qty-btn').forEach((btn) => {
			btn.addEventListener('click', (e) => {
				const target = e.currentTarget as HTMLElement;
				const variantId = Number(target.dataset.variantId);
				const action = target.dataset.action;
				const item = $cartItems.get()[String(variantId)];
				if (!item) return;

				if (action === 'increase') {
					updateQuantity(variantId, item.quantity + 1);
				} else if (action === 'decrease') {
					updateQuantity(variantId, item.quantity - 1);
				}
			});
		});

		container.querySelectorAll('.remove-btn').forEach((btn) => {
			btn.addEventListener('click', (e) => {
				const target = e.currentTarget as HTMLElement;
				const variantId = Number(target.dataset.variantId);
				removeFromCart(variantId);
			});
		});

		const checkoutBtn = document.getElementById('checkout-btn');
		if (checkoutBtn) {
			checkoutBtn.addEventListener('click', handleCheckout);
		}
	};

	const handleCheckout = async () => {
		const items = $cartArray.get();
		if (items.length === 0) return;

		const checkoutBtn = document.getElementById('checkout-btn');
		if (checkoutBtn) {
			checkoutBtn.textContent = 'Processing...';
			checkoutBtn.setAttribute('disabled', 'true');
		}

		try {
			const res = await fetch(`${getApiBase()}/checkout/session`, {
				method: 'POST',
				headers: { 'content-type': 'application/json' },
				body: JSON.stringify({
					items: items.map((item) => ({
						variantId: item.variantId,
						quantity: item.quantity
					}))
				})
			});

			const data = await res.json();
			if (data.ok && data.url) {
				clearCart();
				window.location.href = data.url;
			} else {
				throw new Error(data.message || 'Checkout failed');
			}
		} catch (err) {
			console.error('Checkout error:', err);
			alert('Failed to start checkout. Please try again.');
			if (checkoutBtn) {
				checkoutBtn.textContent = 'Proceed to checkout';
				checkoutBtn.removeAttribute('disabled');
			}
		}
	};

	// Initialize cart
	const init = () => {
		renderCart();
		$cartItems.subscribe(() => {
			renderCart();
		});
	};

	// Ensure DOM is ready
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', init);
	} else {
		init();
	}
</script>
