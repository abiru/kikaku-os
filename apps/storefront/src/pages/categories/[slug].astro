---
import Container from '../../components/Container.astro';
import EmptyState from '../../components/EmptyState.astro';
import Layout from '../../layouts/Layout.astro';
import { buildStoreUrl, fetchJson, getApiBase } from '../../lib/api';
import { t } from '../../i18n';
import { formatPrice } from '../../lib/format';

export const prerender = false;

const apiBase = getApiBase();
const { slug } = Astro.params;
const decodedSlug = decodeURIComponent(slug || '');
const page = Number(Astro.url.searchParams.get('page') || '1');
const perPage = 20;

// Format category name for display (capitalize first letter of each word)
const categoryDisplayName = decodedSlug
	.split(/[-_]/)
	.map((word) => word.charAt(0).toUpperCase() + word.slice(1))
	.join(' ');

type Product = {
	id: number;
	title: string;
	description: string | null;
	image: string | null;
	mainImage: string | null;
	images: string[];
	tax_rate: number | null;
	variants: Array<{
		id: number;
		title: string;
		sku: string | null;
		stock: number;
		price: {
			id: number;
			amount: number;
			currency: string;
			provider_price_id: string | null;
		};
	}>;
};

type ApiResponse = {
	products: Product[];
	meta: {
		page: number;
		perPage: number;
		totalCount: number;
		totalPages: number;
	};
};

let products: Product[] = [];
let meta = { page: 1, perPage, totalCount: 0, totalPages: 0 };
let loadState: 'ready' | 'error' = 'ready';

try {
	const params = new URLSearchParams();
	params.set('category', decodedSlug);
	params.set('page', String(page));
	params.set('perPage', String(perPage));

	const data = await fetchJson<ApiResponse>(
		buildStoreUrl(`/products?${params.toString()}`, apiBase)
	);
	products = data?.products ?? [];
	meta = data?.meta ?? meta;
} catch {
	loadState = 'error';
}

const buildPageUrl = (newPage: number): string => {
	return `/categories/${encodeURIComponent(decodedSlug)}?page=${newPage}`;
};

// CollectionPage JSON-LD for SEO
const siteUrl = 'https://led-kikaku.com';
const categoryDescription = t('seo.categoryDescription', { category: categoryDisplayName });
const jsonLdCollectionPage = {
	'@context': 'https://schema.org',
	'@type': 'CollectionPage',
	name: categoryDisplayName,
	description: categoryDescription,
	url: `${siteUrl}/categories/${encodeURIComponent(decodedSlug)}`,
	numberOfItems: meta.totalCount,
	...(products.length > 0 ? {
		mainEntity: {
			'@type': 'ItemList',
			numberOfItems: meta.totalCount,
			itemListElement: products.map((product, index) => {
				const variant = product.variants?.[0];
				return {
					'@type': 'ListItem',
					position: (meta.page - 1) * meta.perPage + index + 1,
					url: `${siteUrl}/products/${product.id}`,
					name: product.title,
					...(variant?.price ? {
						item: {
							'@type': 'Product',
							name: product.title,
							url: `${siteUrl}/products/${product.id}`,
							...(product.image || product.mainImage ? { image: product.mainImage || product.image } : {}),
							offers: {
								'@type': 'Offer',
								price: variant.price.amount,
								priceCurrency: variant.price.currency || 'JPY',
							},
						},
					} : {}),
				};
			}),
		},
	} : {}),
};

// BreadcrumbList JSON-LD for SEO
const jsonLdBreadcrumb = {
	'@context': 'https://schema.org',
	'@type': 'BreadcrumbList',
	itemListElement: [
		{
			'@type': 'ListItem',
			position: 1,
			name: t('category.home'),
			item: siteUrl,
		},
		{
			'@type': 'ListItem',
			position: 2,
			name: t('nav.products'),
			item: `${siteUrl}/products`,
		},
		{
			'@type': 'ListItem',
			position: 3,
			name: categoryDisplayName,
		},
	],
};
---

<Layout title={`${categoryDisplayName} - Led Kikaku`} description={categoryDescription}>
	<script type="application/ld+json" set:html={JSON.stringify(jsonLdCollectionPage)} />
	<script type="application/ld+json" set:html={JSON.stringify(jsonLdBreadcrumb)} />
	<div class="bg-white min-h-screen">
		{/* Breadcrumb */}
		<nav aria-label="Breadcrumb" class="pt-24 sm:pt-32">
			<Container>
				<ol role="list" class="flex items-center space-x-4 text-sm">
					<li>
						<a href="/" class="text-gray-500 hover:text-gray-700">{t('category.home')}</a>
					</li>
					<li class="flex items-center">
						<svg viewBox="0 0 6 20" aria-hidden="true" class="h-5 w-auto text-gray-300 mr-4">
							<path d="M4.878 4.34H3.551L.27 16.532h1.327l3.281-12.19z" fill="currentColor" />
						</svg>
						<a href="/products" class="text-gray-500 hover:text-gray-700">{t('nav.products')}</a>
					</li>
					<li class="flex items-center">
						<svg viewBox="0 0 6 20" aria-hidden="true" class="h-5 w-auto text-gray-300 mr-4">
							<path d="M4.878 4.34H3.551L.27 16.532h1.327l3.281-12.19z" fill="currentColor" />
						</svg>
						<span class="font-medium text-gray-900">{categoryDisplayName}</span>
					</li>
				</ol>
			</Container>
		</nav>

		{/* Header */}
		<section class="pt-8 pb-12 border-b border-gray-200">
			<Container>
				<h1 class="text-4xl font-semibold tracking-tight text-primary md:text-5xl">
					{categoryDisplayName}
				</h1>
				{meta.totalCount > 0 && (
					<p class="mt-2 text-secondary">
						{t('category.itemCount', { count: meta.totalCount })}
					</p>
				)}
			</Container>
		</section>

		{/* Product Grid */}
		<section class="py-12 bg-subtle">
			<Container>
				{loadState === 'error' ? (
					<EmptyState
						title={t('errors.storeUnavailable')}
						description={t('errors.storeUnavailableDescription')}
						ctaLabel={t('errors.refresh')}
						ctaHref={`/categories/${encodeURIComponent(decodedSlug)}`}
					/>
				) : products.length === 0 ? (
					<EmptyState
						title={t('category.noProducts')}
						description={t('category.noProductsDescription')}
						ctaLabel={t('products.viewAllProducts')}
						ctaHref="/products"
					/>
				) : (
					<>
						<div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:gap-8">
							{products.map((product) => {
								const variant = product.variants?.[0];
								const stock = variant?.stock ?? 0;
								const imageUrl = product.mainImage || product.image;

								return (
									<a
										href={`/products/${product.id}`}
										class="group relative flex flex-col overflow-hidden rounded-3xl bg-white p-8 shadow-sm ring-1 ring-black/5 transition-all duration-300 hover:shadow-xl hover:scale-[1.01]"
									>
										{/* Tag */}
										<span class="mb-2 text-[10px] font-bold uppercase tracking-wider text-[#bf4800]">
											{categoryDisplayName}
										</span>

										{/* Title */}
										<h2 class="text-xl font-semibold text-primary group-hover:underline decoration-1 underline-offset-2">
											{product.title}
										</h2>

										{/* Shipping badge */}
										<span class={stock > 0
											? 'mt-2 inline-flex items-center self-start px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800'
											: 'mt-2 inline-flex items-center self-start px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800'
										}>
											{stock > 0 ? t('category.domesticShipping') : t('category.internationalShipping')}
										</span>

										{/* Image */}
										<div class="mt-8 aspect-[4/3] w-full overflow-hidden rounded-2xl bg-subtle flex items-center justify-center">
											{imageUrl ? (
												<img
													src={imageUrl}
													alt={product.title}
													class="w-full h-full object-cover"
													loading="lazy"
												/>
											) : (
												<div class="w-full h-full flex items-center justify-center" aria-hidden="true">
													<svg class="w-16 h-16 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
														<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
														<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
													</svg>
												</div>
											)}
										</div>

										{/* Price & Buy */}
										<div class="mt-auto pt-6 flex items-center justify-between">
											<span class="text-[15px] text-primary">
												{variant?.price ? `${t('products.from')} ${formatPrice(variant.price.amount, variant.price.currency)}` : ''}
											</span>
											<span class="rounded-lg bg-brand px-4 py-1.5 text-[12px] font-medium text-white opacity-0 transition-opacity group-hover:opacity-100">
												{t('products.buy')}
											</span>
										</div>
									</a>
								);
							})}
						</div>

						{/* Pagination */}
						{meta.totalPages > 1 && (
							<div class="mt-12 flex items-center justify-between border-t border-gray-200 pt-6">
								<div class="text-sm text-gray-600">
									{((meta.page - 1) * meta.perPage + 1)}-{Math.min(meta.page * meta.perPage, meta.totalCount)} / {t('category.itemCount', { count: meta.totalCount })}
								</div>
								<div class="flex gap-2">
									{meta.page > 1 && (
										<a
											href={buildPageUrl(meta.page - 1)}
											class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
										>
											&larr; {t('common.previous')}
										</a>
									)}
									<span class="px-4 py-2 text-sm font-medium text-gray-900">
										{t('common.page')} {meta.page} / {meta.totalPages}
									</span>
									{meta.page < meta.totalPages && (
										<a
											href={buildPageUrl(meta.page + 1)}
											class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
										>
											{t('common.next')} &rarr;
										</a>
									)}
								</div>
							</div>
						)}
					</>
				)}
			</Container>
		</section>
	</div>
</Layout>
