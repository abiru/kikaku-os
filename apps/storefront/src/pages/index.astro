---
import Layout from '../layouts/Layout.astro';
import HomeHero from "../components/HomeHero.astro";
import HomeCategoryGrid from "../components/HomeCategoryGrid.astro";
import LogoGrid from "../components/LogoGrid.astro";
import Copy from "../components/Copy.astro";
import Research from "../components/Research.astro";
import Button from "../components/ui/Button.astro";
import { getApiBase } from '../lib/api';
import { t } from '../i18n';
import { logError } from '../lib/logger';
import type { HeroSection, Product } from '../lib/types';

const apiBase = getApiBase();

// SSR: Fetch hero sections from API
let heroes: HeroSection[] = [];
try {
  const res = await fetch(`${apiBase}/store/home/heroes`);
  if (res.ok) {
    const data = await res.json();
    heroes = data.heroes || [];
  }
} catch (e) {
  logError('Failed to fetch heroes', e, { page: 'index', action: 'fetchHeroes' });
}

// SSR: Fetch featured products for category grid
let featuredProducts: Product[] = [];
try {
  const res = await fetch(`${apiBase}/store/home/featured-categories`);
  if (res.ok) {
    const data = await res.json();
    featuredProducts = data.products || [];
  }
} catch (e) {
  logError('Failed to fetch featured products', e, { page: 'index', action: 'fetchFeaturedProducts' });
}
// Organization JSON-LD for SEO
const siteUrl = 'https://led-kikaku.com';
const jsonLdOrganization = {
	'@context': 'https://schema.org',
	'@type': 'Organization',
	name: t('seo.siteName'),
	url: siteUrl,
	description: t('seo.orgDescription'),
	logo: `${siteUrl}/favicon.svg`,
};
---

<Layout title="Led Kikaku - Pro Growth" description={t('seo.homeDescription')}>
	<script type="application/ld+json" set:html={JSON.stringify(jsonLdOrganization)} />

	{/* Copy (Hero Headline) */}
	<Copy />

	{/* Logo Trust Bar */}
	<LogoGrid />

	{/* Dynamic Heroes */}
	{heroes.length > 0 ? (
		heroes.map((hero) => (
			<HomeHero
				title={hero.title}
				subtitle={hero.subtitle}
				image={hero.image}
				imageSmall={hero.imageSmall}
				ctaPrimaryText={hero.cta_primary_text}
				ctaPrimaryUrl={hero.cta_primary_url}
				ctaSecondaryText={hero.cta_secondary_text}
				ctaSecondaryUrl={hero.cta_secondary_url}
			/>
		))
	) : (
		<section class="py-16 text-center bg-white">
			<div class="mx-auto max-w-2xl px-6">
				<h2 class="typo-h1 text-primary">{t('home.heroTagline')}</h2>
				<p class="mt-4 text-lg text-secondary">{t('home.heroSubtagline')}</p>
				<div class="mt-8">
					<Button href="/products">{t('home.viewProducts')}</Button>
				</div>
			</div>
		</section>
	)}

	{/* Featured Products */}
	{featuredProducts.length > 0 ? (
		<HomeCategoryGrid products={featuredProducts} />
	) : (
		<section class="py-16 text-center bg-white">
			<div class="mx-auto max-w-2xl px-6">
				<h2 class="typo-h2 text-primary">{t('home.viewProducts')}</h2>
				<p class="mt-4 text-secondary">{t('home.heroSubtagline')}</p>
				<div class="mt-6">
					<Button href="/products">{t('home.viewProducts')}</Button>
				</div>
			</div>
		</section>
	)}

	{/* Research */}
	<Research />

	{/* CTA Section */}
	<section class="bg-white py-24 text-center" data-reveal>
		<div class="mx-auto max-w-2xl px-6">
			<h2 class="typo-h1 text-primary sm:text-4xl">
				{t('home.heroTagline')}
			</h2>
			<p class="mt-4 text-lg text-secondary">
				{t('home.heroSubtagline')}
			</p>
			<div class="mt-10 flex items-center justify-center gap-4">
				<Button href="/products" size="lg">
					{t('home.viewProducts')}
				</Button>
				<Button href="/contact" variant="secondary" size="lg">
					{t('home.researchCta')}
				</Button>
			</div>
		</div>
	</section>
</Layout>
