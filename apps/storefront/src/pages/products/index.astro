---
import Badge from '../../components/Badge.astro';
import Container from '../../components/Container.astro';
import EmptyState from '../../components/EmptyState.astro';
import Layout from '../../layouts/Layout.astro';
import ProductFilters from '../../components/ProductFilters';
import { t } from '../../i18n';

const skeletonCards = Array.from({ length: 6 });
---

<Layout title="Store - Led Kikaku">
	<div class="bg-white min-h-screen">
		<section class="pt-24 pb-12 sm:pt-32 border-b border-gray-200">
			<Container>
				<h1 class="text-4xl font-semibold tracking-tight text-[#1d1d1f] md:text-5xl">
					{t('products.title')} <span class="text-[#86868b]">{t('products.subtitle')}</span>
				</h1>
			</Container>
		</section>

		<section class="py-12 bg-[#f5f5f7]">
			<Container>
				<div id="search-info" class="hidden mb-6">
					<div class="flex items-center justify-between">
						<p class="text-gray-600">
							{t('products.showingResultsFor')} "<span id="search-term"></span>"
						</p>
						<a href="/products" class="text-sm font-medium text-indigo-600 hover:text-indigo-500">
							{t('products.clearSearch')}
						</a>
					</div>
				</div>

				<div id="filter-info" class="hidden mb-6">
					<div class="flex items-center gap-2 flex-wrap">
						<span class="text-gray-600">{t('products.activeFilters')}:</span>
						<span id="active-filters" class="flex items-center gap-2"></span>
					</div>
				</div>

				<div class="flex items-center justify-between mb-8">
					<h2 id="section-title" class="text-2xl font-semibold tracking-tight text-[#1d1d1f]">{t('products.theLatest')}</h2>
					<Badge severity="new">{t('products.newArrivals')}</Badge>
				</div>

				<div class="flex gap-8">
					{/* Filter Sidebar */}
					<aside class="hidden lg:block w-64 flex-shrink-0">
						<div class="sticky top-20 bg-white rounded-2xl p-6 shadow-sm ring-1 ring-black/5">
							<h2 class="text-lg font-semibold text-[#1d1d1f] mb-4">{t('products.filters')}</h2>
							<ProductFilters client:only="react" />
						</div>
					</aside>

					{/* Product Grid */}
					<div class="flex-1">
						<div id="product-state">
							{/* Skeleton State */}
							<div id="product-skeleton" class="grid grid-cols-1 gap-6 sm:grid-cols-2 xl:gap-8">
								{skeletonCards.map(() => (
									<div class="group relative flex flex-col overflow-hidden rounded-3xl bg-white p-6 shadow-sm ring-1 ring-black/5 transition-all duration-300 hover:shadow-lg">
										<div class="aspect-[4/3] w-full overflow-hidden rounded-xl bg-[#f5f5f7]"></div>
										<div class="mt-6 flex flex-col gap-2">
											<div class="h-4 w-24 bg-gray-100 rounded-full"></div>
											<div class="h-6 w-48 bg-gray-100 rounded-lg"></div>
											<div class="mt-2 h-4 w-16 bg-gray-100 rounded-full"></div>
										</div>
									</div>
								))}
							</div>

							{/* Error State */}
							<div id="product-error" class="hidden py-20">
								<EmptyState
									title="Store unavailable"
									description="We couldn't load the catalog. Please try again later."
									ctaLabel="Refresh"
									ctaHref="/products"
								/>
							</div>

							{/* Empty State */}
							<div id="product-empty" class="hidden py-20">
								<EmptyState
									title="No products found"
									description="Try a different search term or adjust your filters."
									ctaLabel="View all products"
									ctaHref="/products"
								/>
							</div>

							{/* Loaded Grid */}
							<div id="product-grid" class="hidden grid grid-cols-1 gap-6 sm:grid-cols-2 xl:gap-8"></div>
						</div>

						{/* Pagination */}
						<div id="pagination" class="hidden mt-12 flex items-center justify-between border-t border-gray-200 pt-6">
							<div class="text-sm text-gray-600">
								<span id="pagination-info"></span>
							</div>
							<div class="flex gap-2">
								<a id="prev-page" href="#" class="hidden px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
									← {t('admin.previous')}
								</a>
								<span id="current-page" class="px-4 py-2 text-sm font-medium text-gray-900"></span>
								<a id="next-page" href="#" class="hidden px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
									{t('admin.next')} →
								</a>
							</div>
						</div>
					</div>
				</div>
			</Container>
		</section>
	</div>

	<script>
		import { buildStoreUrl, fetchJson, getApiBase } from '../../lib/api';

		const setState = (next: string) => {
			const skeleton = document.getElementById('product-skeleton');
			const errorState = document.getElementById('product-error');
			const emptyState = document.getElementById('product-empty');
			const grid = document.getElementById('product-grid');

			const isLoading = next === 'loading';
			const isError = next === 'error';
			const isEmpty = next === 'empty';
			const isLoaded = next === 'loaded';

			skeleton?.classList.toggle('hidden', !isLoading);
			errorState?.classList.toggle('hidden', !isError);
			emptyState?.classList.toggle('hidden', !isEmpty);
			grid?.classList.toggle('hidden', !isLoaded);
		};

		const isRecord = (value: unknown): value is Record<string, unknown> => typeof value === 'object' && value !== null;
		const isProduct = (value: unknown) => isRecord(value) && 'id' in value && 'title' in value;

		const renderProducts = (products: any[]) => {
			const grid = document.getElementById('product-grid');
			if (!grid) return;
			grid.innerHTML = '';

			products.forEach((product) => {
				const card = document.createElement('div');
				card.className = 'group relative flex flex-col overflow-hidden rounded-3xl bg-white p-8 shadow-sm ring-1 ring-black/5 transition-all duration-300 hover:shadow-xl hover:scale-[1.01]';

				// 1. Tag / Badge (Top Left)
				const tag = document.createElement('span');
				tag.className = 'mb-2 text-[10px] font-bold uppercase tracking-wider text-[#bf4800]';
				tag.textContent = 'New';
				card.appendChild(tag);

				// 2. Title & Desc
				const titleLink = document.createElement('a');
				titleLink.href = `/products/${product.id}`;
				titleLink.className = 'text-xl font-semibold text-[#1d1d1f] hover:underline decoration-1 underline-offset-2';
				titleLink.textContent = String(product.title ?? '');

				const fullLinkOverlay = document.createElement('span');
				fullLinkOverlay.className = 'absolute inset-0';
				titleLink.appendChild(fullLinkOverlay);

				card.appendChild(titleLink);

				// 3. Image Container
				const imgContainer = document.createElement('div');
				imgContainer.className = 'mt-8 aspect-[4/3] w-full overflow-hidden rounded-2xl bg-[#f5f5f7] flex items-center justify-center';

				if (product.image) {
					const img = document.createElement('img');
					img.src = product.image;
					img.alt = product.title ?? '';
					img.className = 'w-full h-full object-cover';
					imgContainer.appendChild(img);
				} else {
					const imgPlaceholder = document.createElement('div');
					imgPlaceholder.className = 'text-4xl font-bold text-gray-200 select-none';
					imgPlaceholder.textContent = 'IMG';
					imgContainer.appendChild(imgPlaceholder);
				}

				card.appendChild(imgContainer);

				// 4. Price & Buy (Bottom)
				const footer = document.createElement('div');
				footer.className = 'mt-auto pt-6 flex items-center justify-between';

				const variant = Array.isArray(product.variants) ? product.variants[0] : null;
				const price = variant?.price;

				const priceEl = document.createElement('span');
				priceEl.className = 'text-[15px] text-[#1d1d1f]';
				priceEl.textContent = price ? `From ${price.amount} ${price.currency}` : '';

				const buyBtn = document.createElement('span');
				buyBtn.className = 'rounded-full bg-[#0071e3] px-4 py-1.5 text-[12px] font-medium text-white opacity-0 transition-opacity group-hover:opacity-100';
				buyBtn.textContent = 'Buy';

				footer.appendChild(priceEl);
				footer.appendChild(buyBtn);
				card.appendChild(footer);

				grid.appendChild(card);
			});
		};

		const buildPageUrl = (newPage: number): string => {
			const params = new URLSearchParams(window.location.search);
			params.set('page', String(newPage));
			return `?${params.toString()}`;
		};

		const renderPagination = (meta: any) => {
			const pagination = document.getElementById('pagination');
			const paginationInfo = document.getElementById('pagination-info');
			const prevPage = document.getElementById('prev-page') as HTMLAnchorElement | null;
			const nextPage = document.getElementById('next-page') as HTMLAnchorElement | null;
			const currentPage = document.getElementById('current-page');

			if (!meta || !pagination || !paginationInfo || !prevPage || !nextPage || !currentPage) return;

			const { page, perPage, totalCount, totalPages } = meta;
			const start = (page - 1) * perPage + 1;
			const end = Math.min(page * perPage, totalCount);

			paginationInfo.textContent = `Showing ${start}-${end} of ${totalCount} products`;
			currentPage.textContent = `Page ${page} / ${totalPages}`;

			// Show/hide prev/next buttons
			if (page > 1) {
				prevPage.classList.remove('hidden');
				prevPage.href = buildPageUrl(page - 1);
			} else {
				prevPage.classList.add('hidden');
			}

			if (page < totalPages) {
				nextPage.classList.remove('hidden');
				nextPage.href = buildPageUrl(page + 1);
			} else {
				nextPage.classList.add('hidden');
			}

			pagination.classList.remove('hidden');
		};

		const loadProducts = async () => {
			const apiBase = getApiBase();
			setState('loading');

			// Get all filter params from URL
			const urlParams = new URLSearchParams(window.location.search);
			const searchQuery = urlParams.get('q') || '';
			const category = urlParams.get('category') || '';
			const minPrice = urlParams.get('minPrice') || '';
			const maxPrice = urlParams.get('maxPrice') || '';
			const page = urlParams.get('page') || '1';

			// Update UI for search
			const searchInfo = document.getElementById('search-info');
			const searchTerm = document.getElementById('search-term');
			const sectionTitle = document.getElementById('section-title');
			const filterInfo = document.getElementById('filter-info');
			const activeFilters = document.getElementById('active-filters');

			if (searchQuery && searchInfo && searchTerm && sectionTitle) {
				searchTerm.textContent = searchQuery;
				searchInfo.classList.remove('hidden');
				sectionTitle.textContent = 'Search results';
			}

			// Show active filters info
			const hasFilters = category || minPrice || maxPrice;
			if (hasFilters && filterInfo && activeFilters) {
				const badges: string[] = [];
				if (category) badges.push(`<span class="px-2 py-1 text-xs bg-[#0071e3]/10 text-[#0071e3] rounded-full capitalize">${category}</span>`);
				if (minPrice || maxPrice) {
					const priceLabel = minPrice && maxPrice
						? `${Number(minPrice).toLocaleString()} - ${Number(maxPrice).toLocaleString()} JPY`
						: minPrice
						? `${Number(minPrice).toLocaleString()}+ JPY`
						: `Up to ${Number(maxPrice).toLocaleString()} JPY`;
					badges.push(`<span class="px-2 py-1 text-xs bg-[#0071e3]/10 text-[#0071e3] rounded-full">${priceLabel}</span>`);
				}
				activeFilters.innerHTML = badges.join('');
				filterInfo.classList.remove('hidden');
				if (sectionTitle && !searchQuery) {
					sectionTitle.textContent = 'Filtered results';
				}
			}

			try {
				// Build URL with all params
				const params = new URLSearchParams();
				if (searchQuery) params.set('q', searchQuery);
				if (category) params.set('category', category);
				if (minPrice) params.set('minPrice', minPrice);
				if (maxPrice) params.set('maxPrice', maxPrice);
				params.set('page', page);

				const queryString = params.toString();
				const url = buildStoreUrl(queryString ? `/products?${queryString}` : '/products', apiBase);
				const data = await fetchJson(url);
				const products = Array.isArray(data?.products) ? data.products.filter(isProduct) : [];

				if (!products.length) {
					setState('empty');
					return;
				}

				renderProducts(products);
				renderPagination(data?.meta);
				setState('loaded');
			} catch (error) {
				setState('error');
			}
		};

		loadProducts();
	</script>
</Layout>
