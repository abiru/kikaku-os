---
import { Badge } from '../../components/catalyst/badge';
import Container from '../../components/Container.astro';
import EmptyState from '../../components/EmptyState.astro';
import Layout from '../../layouts/Layout.astro';
import ProductFilters from '../../components/ProductFilters';
import { t } from '../../i18n';

const skeletonCards = Array.from({ length: 6 });
---

<Layout title="Store - Led Kikaku">
	<div class="bg-white min-h-screen">
		<section class="pt-24 pb-12 sm:pt-32 border-b border-gray-200">
			<Container>
				<h1 class="text-4xl font-semibold tracking-tight text-[#1d1d1f] md:text-5xl">
					{t('products.title')} <span class="text-[#86868b]">{t('products.subtitle')}</span>
				</h1>
			</Container>
		</section>

		<section class="py-12 bg-[#f5f5f7]">
			<Container>
				<div id="search-info" class="hidden mb-6">
					<div class="flex items-center justify-between">
						<p class="text-gray-600">
							{t('products.showingResultsFor')} "<span id="search-term"></span>"
						</p>
						<a href="/products" class="text-sm font-medium text-indigo-600 hover:text-indigo-500">
							{t('products.clearSearch')}
						</a>
					</div>
				</div>

				<div id="filter-info" class="hidden mb-6">
					<div class="flex items-center gap-2 flex-wrap">
						<span class="text-gray-600">{t('products.activeFilters')}:</span>
						<span id="active-filters" class="flex items-center gap-2"></span>
					</div>
				</div>

				<div class="flex items-center justify-between mb-8">
					<h2 id="section-title" class="text-2xl font-semibold tracking-tight text-[#1d1d1f]">{t('products.theLatest')}</h2>
					<Badge color="green" client:load>{t('products.newArrivals')}</Badge>
				</div>

				<div class="flex gap-8">
					{/* Filter Sidebar */}
					<aside class="hidden lg:block w-64 flex-shrink-0">
						<div class="sticky top-20 bg-white rounded-2xl p-6 shadow-sm ring-1 ring-black/5">
							<h2 class="text-lg font-semibold text-[#1d1d1f] mb-4">{t('products.filters')}</h2>
							<ProductFilters client:only="react" />
						</div>
					</aside>

					{/* Product Grid */}
					<div class="flex-1">
						<div id="product-state">
							{/* Skeleton State */}
							<div id="product-skeleton" class="grid grid-cols-1 gap-6 sm:grid-cols-2 xl:gap-8">
								{skeletonCards.map(() => (
									<div class="group relative flex flex-col overflow-hidden rounded-3xl bg-white p-6 shadow-sm ring-1 ring-black/5 transition-all duration-300 hover:shadow-lg">
										<div class="aspect-[4/3] w-full overflow-hidden rounded-xl bg-[#f5f5f7]"></div>
										<div class="mt-6 flex flex-col gap-2">
											<div class="h-4 w-24 bg-gray-100 rounded-full"></div>
											<div class="h-6 w-48 bg-gray-100 rounded-lg"></div>
											<div class="mt-2 h-4 w-16 bg-gray-100 rounded-full"></div>
										</div>
									</div>
								))}
							</div>

							{/* Error State */}
							<div id="product-error" class="hidden py-20">
								<EmptyState
									title={t('errors.storeUnavailable')}
									description={t('errors.storeUnavailableDescription')}
									ctaLabel={t('errors.refresh')}
									ctaHref="/products"
								/>
							</div>

							{/* Empty State */}
							<div id="product-empty" class="hidden py-20">
								<EmptyState
									title={t('products.noProducts')}
									description={t('products.noProductsDescription')}
									ctaLabel={t('products.viewAllProducts')}
									ctaHref="/products"
								/>
							</div>

							{/* Loaded Grid */}
							<div id="product-grid" class="hidden grid grid-cols-1 gap-6 sm:grid-cols-2 xl:gap-8"></div>
						</div>

						{/* i18n data for client script */}
						<div
							id="i18n-data"
							class="hidden"
							data-new={t('products.new')}
							data-from={t('products.from')}
							data-buy={t('products.buy')}
							data-search-results={t('products.searchResults')}
							data-filtered-results={t('products.filteredResults')}
							data-showing-count={t('products.showingCount')}
							data-page-info={t('products.pageInfo')}
							data-price-above={t('products.priceAbove')}
							data-price-up-to={t('products.priceUpTo')}
							data-domestic-shipping={t('category.domesticShipping')}
							data-international-shipping={t('category.internationalShipping')}
						></div>

						{/* Pagination */}
						<div id="pagination" class="hidden mt-12 flex items-center justify-between border-t border-gray-200 pt-6">
							<div class="text-sm text-gray-600">
								<span id="pagination-info"></span>
							</div>
							<div class="flex gap-2">
								<a id="prev-page" href="#" class="hidden px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
									← {t('admin.previous')}
								</a>
								<span id="current-page" class="px-4 py-2 text-sm font-medium text-gray-900"></span>
								<a id="next-page" href="#" class="hidden px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
									{t('admin.next')} →
								</a>
							</div>
						</div>
					</div>
				</div>
			</Container>
		</section>
	</div>

	<script>
		import { buildStoreUrl, fetchJson, getApiBase } from '../../lib/api';
		import { $wishlistItems, toggleWishlist, type WishlistItem } from '../../lib/wishlist';

		// Read i18n translations from data attributes
		const i18nEl = document.getElementById('i18n-data');
		const i18n = {
			new: i18nEl?.dataset.new || '新着',
			from: i18nEl?.dataset.from || 'から',
			buy: i18nEl?.dataset.buy || '購入',
			searchResults: i18nEl?.dataset.searchResults || '検索結果',
			filteredResults: i18nEl?.dataset.filteredResults || 'フィルター結果',
			showingCount: i18nEl?.dataset.showingCount || '{start}〜{end}件目（全{total}件）',
			pageInfo: i18nEl?.dataset.pageInfo || 'ページ {page} / {totalPages}',
			priceAbove: i18nEl?.dataset.priceAbove || '{min}円以上',
			priceUpTo: i18nEl?.dataset.priceUpTo || '{max}円以下',
			domesticShipping: i18nEl?.dataset.domesticShipping || '国内発送 2〜3日',
			internationalShipping: i18nEl?.dataset.internationalShipping || '海外発送 10日程',
		};

		const setState = (next: string) => {
			const skeleton = document.getElementById('product-skeleton');
			const errorState = document.getElementById('product-error');
			const emptyState = document.getElementById('product-empty');
			const grid = document.getElementById('product-grid');

			const isLoading = next === 'loading';
			const isError = next === 'error';
			const isEmpty = next === 'empty';
			const isLoaded = next === 'loaded';

			skeleton?.classList.toggle('hidden', !isLoading);
			errorState?.classList.toggle('hidden', !isError);
			emptyState?.classList.toggle('hidden', !isEmpty);
			grid?.classList.toggle('hidden', !isLoaded);
		};

		const isRecord = (value: unknown): value is Record<string, unknown> => typeof value === 'object' && value !== null;
		const isProduct = (value: unknown) => isRecord(value) && 'id' in value && 'title' in value;

		type ProductListItem = { id: number; title: string; image?: string; tax_rate?: number; variants?: Array<{ id: number; title?: string; price?: { amount: number; currency: string } }> };
		type VariantListItem = { id: number; title?: string; price?: { amount: number; currency: string } };
		type PageMeta = { page: number; perPage: number; totalCount: number; totalPages: number };

		const createWishlistHeart = (product: ProductListItem, variant: VariantListItem | undefined): HTMLButtonElement => {
			const btn = document.createElement('button');
			btn.type = 'button';
			btn.className = 'absolute top-4 right-4 z-10 p-2 rounded-full bg-white/80 backdrop-blur-sm shadow-sm transition-all duration-200 hover:scale-110 active:scale-95';
			btn.setAttribute('aria-label', 'お気に入り');

			const productId = Number(product.id);
			const wishlistItem: Omit<WishlistItem, 'addedAt'> = {
				productId,
				title: String(product.title ?? ''),
				price: variant?.price?.amount ?? 0,
				currency: variant?.price?.currency ?? 'JPY',
				taxRate: product.tax_rate ?? 0.10,
				imageUrl: product.image || undefined,
				variantId: variant?.id,
				variantTitle: variant?.title || 'Default',
			};

			const updateIcon = () => {
				const isWishlisted = !!$wishlistItems.get()[String(productId)];
				btn.innerHTML = isWishlisted
					? '<svg class="size-5 text-red-500" viewBox="0 0 24 24" fill="currentColor"><path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z"/></svg>'
					: '<svg class="size-5 text-gray-400 hover:text-red-400 transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z"/></svg>';
			};

			updateIcon();
			$wishlistItems.subscribe(updateIcon);

			btn.addEventListener('click', (e) => {
				e.preventDefault();
				e.stopPropagation();
				toggleWishlist(wishlistItem);
			});

			return btn;
		};

		const renderProducts = (products: ProductListItem[]) => {
			const grid = document.getElementById('product-grid');
			if (!grid) return;
			grid.innerHTML = '';

			products.forEach((product) => {
				const card = document.createElement('div');
				card.className = 'group relative flex flex-col overflow-hidden rounded-3xl bg-white p-8 shadow-sm ring-1 ring-black/5 transition-all duration-300 hover:shadow-xl hover:scale-[1.01]';

				// Wishlist heart button (top-right, above link overlay)
				const variant = Array.isArray(product.variants) ? product.variants[0] : null;
				const heartBtn = createWishlistHeart(product, variant);
				card.appendChild(heartBtn);

				// 1. Tag / Badge (Top Left)
				const tag = document.createElement('span');
				tag.className = 'mb-2 text-[10px] font-bold uppercase tracking-wider text-[#bf4800]';
				tag.textContent = i18n.new;
				card.appendChild(tag);

				// 2. Title & Desc
				const titleLink = document.createElement('a');
				titleLink.href = `/products/${product.id}`;
				titleLink.className = 'text-xl font-semibold text-[#1d1d1f] hover:underline decoration-1 underline-offset-2';
				titleLink.textContent = String(product.title ?? '');

				const fullLinkOverlay = document.createElement('span');
				fullLinkOverlay.className = 'absolute inset-0';
				titleLink.appendChild(fullLinkOverlay);

				card.appendChild(titleLink);

				// Shipping badge based on stock
				const stock = variant?.stock ?? 0;

				const shippingBadge = document.createElement('span');
				shippingBadge.className = stock > 0
					? 'mt-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800'
					: 'mt-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800';
				shippingBadge.textContent = stock > 0 ? i18n.domesticShipping : i18n.internationalShipping;
				card.appendChild(shippingBadge);

				// 3. Image Container
				const imgContainer = document.createElement('div');
				imgContainer.className = 'mt-8 aspect-[4/3] w-full overflow-hidden rounded-2xl bg-[#f5f5f7] flex items-center justify-center';

				if (product.image) {
					const img = document.createElement('img');
					img.src = product.image;
					img.alt = product.title ?? '';
					img.loading = 'lazy';
					img.className = 'w-full h-full object-cover';
					imgContainer.appendChild(img);
				} else {
					const imgPlaceholder = document.createElement('div');
					imgPlaceholder.className = 'text-4xl font-bold text-gray-200 select-none';
					imgPlaceholder.textContent = 'IMG';
					imgContainer.appendChild(imgPlaceholder);
				}

				card.appendChild(imgContainer);

				// 4. Price & Buy (Bottom)
				const footer = document.createElement('div');
				footer.className = 'mt-auto pt-6 flex items-center justify-between';

				const price = variant?.price;

				const priceEl = document.createElement('span');
				priceEl.className = 'text-[15px] text-[#1d1d1f]';
				priceEl.textContent = price ? `${i18n.from} ${price.amount.toLocaleString()} ${price.currency}` : '';

				const buyBtn = document.createElement('span');
				buyBtn.className = 'rounded-full bg-[#0071e3] px-4 py-1.5 text-[12px] font-medium text-white opacity-0 transition-opacity group-hover:opacity-100';
				buyBtn.textContent = i18n.buy;

				footer.appendChild(priceEl);
				footer.appendChild(buyBtn);
				card.appendChild(footer);

				grid.appendChild(card);
			});
		};

		const buildPageUrl = (newPage: number): string => {
			const params = new URLSearchParams(window.location.search);
			params.set('page', String(newPage));
			return `?${params.toString()}`;
		};

		const renderPagination = (meta: PageMeta | null) => {
			const pagination = document.getElementById('pagination');
			const paginationInfo = document.getElementById('pagination-info');
			const prevPage = document.getElementById('prev-page') as HTMLAnchorElement | null;
			const nextPage = document.getElementById('next-page') as HTMLAnchorElement | null;
			const currentPage = document.getElementById('current-page');

			if (!meta || !pagination || !paginationInfo || !prevPage || !nextPage || !currentPage) return;

			const { page, perPage, totalCount, totalPages } = meta;
			const start = (page - 1) * perPage + 1;
			const end = Math.min(page * perPage, totalCount);

			paginationInfo.textContent = i18n.showingCount
				.replace('{start}', String(start))
				.replace('{end}', String(end))
				.replace('{total}', String(totalCount));
			currentPage.textContent = i18n.pageInfo
				.replace('{page}', String(page))
				.replace('{totalPages}', String(totalPages));

			// Show/hide prev/next buttons
			if (page > 1) {
				prevPage.classList.remove('hidden');
				prevPage.href = buildPageUrl(page - 1);
			} else {
				prevPage.classList.add('hidden');
			}

			if (page < totalPages) {
				nextPage.classList.remove('hidden');
				nextPage.href = buildPageUrl(page + 1);
			} else {
				nextPage.classList.add('hidden');
			}

			pagination.classList.remove('hidden');
		};

		const escapeHtml = (str: string): string => {
			const div = document.createElement('div');
			div.textContent = str;
			return div.innerHTML;
		};

		const loadProducts = async () => {
			const apiBase = getApiBase();
			setState('loading');

			// Get all filter params from URL
			const urlParams = new URLSearchParams(window.location.search);
			const searchQuery = urlParams.get('q') || '';
			const category = urlParams.get('category') || '';
			const minPrice = urlParams.get('minPrice') || '';
			const maxPrice = urlParams.get('maxPrice') || '';
			const page = urlParams.get('page') || '1';

			// Update UI for search
			const searchInfo = document.getElementById('search-info');
			const searchTerm = document.getElementById('search-term');
			const sectionTitle = document.getElementById('section-title');
			const filterInfo = document.getElementById('filter-info');
			const activeFilters = document.getElementById('active-filters');

			if (searchQuery && searchInfo && searchTerm && sectionTitle) {
				searchTerm.textContent = searchQuery;
				searchInfo.classList.remove('hidden');
				sectionTitle.textContent = i18n.searchResults;
			}

			// Show active filters info
			const hasFilters = category || minPrice || maxPrice;
			if (hasFilters && filterInfo && activeFilters) {
				const badges: string[] = [];
				if (category) badges.push(`<span class="px-2 py-1 text-xs bg-[#0071e3]/10 text-[#0071e3] rounded-full capitalize">${escapeHtml(category)}</span>`);
				if (minPrice || maxPrice) {
					const priceLabel = minPrice && maxPrice
						? `${Number(minPrice).toLocaleString()} - ${Number(maxPrice).toLocaleString()} JPY`
						: minPrice
						? i18n.priceAbove.replace('{min}', Number(minPrice).toLocaleString())
						: i18n.priceUpTo.replace('{max}', Number(maxPrice).toLocaleString());
					badges.push(`<span class="px-2 py-1 text-xs bg-[#0071e3]/10 text-[#0071e3] rounded-full">${priceLabel}</span>`);
				}
				activeFilters.innerHTML = badges.join('');
				filterInfo.classList.remove('hidden');
				if (sectionTitle && !searchQuery) {
					sectionTitle.textContent = i18n.filteredResults;
				}
			}

			try {
				// Build URL with all params
				const params = new URLSearchParams();
				if (searchQuery) params.set('q', searchQuery);
				if (category) params.set('category', category);
				if (minPrice) params.set('minPrice', minPrice);
				if (maxPrice) params.set('maxPrice', maxPrice);
				params.set('page', page);

				const queryString = params.toString();
				const url = buildStoreUrl(queryString ? `/products?${queryString}` : '/products', apiBase);
				const data = await fetchJson(url) as any;
				const products = Array.isArray(data?.products) ? data.products.filter(isProduct) : [];

				if (!products.length) {
					setState('empty');
					return;
				}

				renderProducts(products);
				renderPagination(data?.meta);
				setState('loaded');
			} catch (error) {
				setState('error');
			}
		};

		loadProducts();
	</script>
</Layout>
