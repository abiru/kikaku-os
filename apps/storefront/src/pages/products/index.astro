---
import Badge from '../../components/Badge.astro';
import Container from '../../components/Container.astro';
import EmptyState from '../../components/EmptyState.astro';
import Layout from '../../layouts/Layout.astro';

const skeletonCards = Array.from({ length: 6 });
---

<Layout title="Store - Led Kikaku">
	<div class="bg-white min-h-screen">
		<section class="pt-24 pb-12 sm:pt-32 border-b border-gray-200">
			<Container>
				<h1 class="text-4xl font-semibold tracking-tight text-[#1d1d1f] md:text-5xl">
					Store. <span class="text-[#86868b]">The best way to buy the products you love.</span>
				</h1>
			</Container>
		</section>

		<section class="py-12 bg-[#f5f5f7]">
			<Container>
				<div class="flex items-center justify-between mb-8">
					<h2 class="text-2xl font-semibold tracking-tight text-[#1d1d1f]">The latest.</h2>
					<Badge severity="new">New Arrivals</Badge>
				</div>

				<div id="product-state">
					{/* Skeleton State */}
					<div id="product-skeleton" class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:gap-8">
						{skeletonCards.map(() => (
							<div class="group relative flex flex-col overflow-hidden rounded-3xl bg-white p-6 shadow-sm ring-1 ring-black/5 transition-all duration-300 hover:shadow-lg">
								<div class="aspect-[4/3] w-full overflow-hidden rounded-xl bg-[#f5f5f7]"></div>
								<div class="mt-6 flex flex-col gap-2">
									<div class="h-4 w-24 bg-gray-100 rounded-full"></div>
									<div class="h-6 w-48 bg-gray-100 rounded-lg"></div>
									<div class="mt-2 h-4 w-16 bg-gray-100 rounded-full"></div>
								</div>
							</div>
						))}
					</div>

					{/* Error State */}
					<div id="product-error" class="hidden py-20">
						<EmptyState
							title="Store unavailable"
							description="We couldn't load the catalog. Please try again later."
							ctaLabel="Refresh"
							ctaHref="/products"
						/>
					</div>

					{/* Empty State */}
					<div id="product-empty" class="hidden py-20">
						<EmptyState
							title="No products found"
							description="We are updating our inventory."
							ctaLabel="Check back later"
							ctaHref="/"
						/>
					</div>

					{/* Loaded Grid */}
					<div id="product-grid" class="hidden grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:gap-8"></div>
				</div>
			</Container>
		</section>
	</div>

	<script>
		import { buildStoreUrl, fetchJson, getApiBase } from '../../lib/api';

		const apiBase = getApiBase();
		const skeleton = document.getElementById('product-skeleton');
		const errorState = document.getElementById('product-error');
		const emptyState = document.getElementById('product-empty');
		const grid = document.getElementById('product-grid');

		const setState = (next) => {
			const isLoading = next === 'loading';
			const isError = next === 'error';
			const isEmpty = next === 'empty';
			const isLoaded = next === 'loaded';

			skeleton?.classList.toggle('hidden', !isLoading);
			errorState?.classList.toggle('hidden', !isError);
			emptyState?.classList.toggle('hidden', !isEmpty);
			grid?.classList.toggle('hidden', !isLoaded);
		};

		const isRecord = (value) => typeof value === 'object' && value !== null;
		const isProduct = (value) => isRecord(value) && 'id' in value && 'title' in value;

		const renderProducts = (products) => {
			if (!grid) return;
			grid.innerHTML = '';

			products.forEach((product) => {
				const card = document.createElement('div');
				card.className = 'group relative flex flex-col overflow-hidden rounded-3xl bg-white p-8 shadow-sm ring-1 ring-black/5 transition-all duration-300 hover:shadow-xl hover:scale-[1.01]';

				// 1. Tag / Badge (Top Left)
				const tag = document.createElement('span');
				tag.className = 'mb-2 text-[10px] font-bold uppercase tracking-wider text-[#bf4800]';
				tag.textContent = 'New';
				card.appendChild(tag);

				// 2. Title & Desc
				const titleLink = document.createElement('a');
				titleLink.href = `/products/${product.id}`;
				titleLink.className = 'text-xl font-semibold text-[#1d1d1f] hover:underline decoration-1 underline-offset-2';
				titleLink.textContent = String(product.title ?? '');
				
				const fullLinkOverlay = document.createElement('span');
				fullLinkOverlay.className = 'absolute inset-0';
				titleLink.appendChild(fullLinkOverlay);

				card.appendChild(titleLink);

				// 3. Image Container
				const imgContainer = document.createElement('div');
				imgContainer.className = 'mt-8 aspect-[4/3] w-full overflow-hidden rounded-2xl bg-[#f5f5f7] flex items-center justify-center';

				// Image or Placeholder with View Transition support
				if (product.image) {
					const img = document.createElement('img');
					img.src = product.image;
					img.alt = product.title ?? '';
					img.className = 'w-full h-full object-cover';
					img.style.viewTransitionName = `product-image-${product.id}`;
					imgContainer.appendChild(img);
				} else {
					const imgPlaceholder = document.createElement('div');
					imgPlaceholder.className = 'text-4xl font-bold text-gray-200 select-none';
					imgPlaceholder.textContent = 'IMG';
					imgPlaceholder.style.viewTransitionName = `product-image-${product.id}`;
					imgContainer.appendChild(imgPlaceholder);
				}

				card.appendChild(imgContainer);

				// 4. Price & Buy (Bottom)
				const footer = document.createElement('div');
				footer.className = 'mt-auto pt-6 flex items-center justify-between';

				const variant = Array.isArray(product.variants) ? product.variants[0] : null;
				const price = variant?.price;
				
				const priceEl = document.createElement('span');
				priceEl.className = 'text-[15px] text-[#1d1d1f]';
				priceEl.textContent = price ? `From ${price.amount} ${price.currency}` : '';

				const buyBtn = document.createElement('span');
				buyBtn.className = 'rounded-full bg-[#0071e3] px-4 py-1.5 text-[12px] font-medium text-white opacity-0 transition-opacity group-hover:opacity-100';
				buyBtn.textContent = 'Buy';

				footer.appendChild(priceEl);
				footer.appendChild(buyBtn);
				card.appendChild(footer);

				grid.appendChild(card);
			});
		};

		const loadProducts = async () => {
			setState('loading');

			try {
				const data = await fetchJson(buildStoreUrl('/products', apiBase));
				const products = Array.isArray(data?.products) ? data.products.filter(isProduct) : [];

				if (!products.length) {
					setState('empty');
					return;
				}

				renderProducts(products);
				setState('loaded');
			} catch (error) {
				setState('error');
			}
		};

		loadProducts();
	</script>
</Layout>
