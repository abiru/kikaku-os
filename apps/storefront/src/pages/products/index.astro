---
import Breadcrumb from '../../components/Breadcrumb.astro';
import Container from '../../components/Container.astro';
import Layout from '../../layouts/Layout.astro';
import ProductFilters from '../../components/ProductFilters';
import ProductGrid from '../../components/ProductGrid';
import { buildStoreUrl, fetchJson, getApiBase } from '../../lib/api';
import { formatPrice } from '../../lib/format';
import { t } from '../../i18n';

export const prerender = false;

// SSR: Fetch initial products for SEO
type SSRProduct = {
	id: number;
	title: string;
	description: string | null;
	image: string | null;
	variants: Array<{
		id: number;
		title: string;
		price: { amount: number; currency: string } | null;
		stock: number | null;
	}>;
};
let ssrProducts: SSRProduct[] = [];
try {
	const apiBase = getApiBase();
	const data = await fetchJson<{ products: SSRProduct[] }>(buildStoreUrl('/products?perPage=20', apiBase));
	ssrProducts = data?.products ?? [];
} catch {
	// SSR fetch failed - client-side will retry
}

// ItemList JSON-LD for SEO
const siteUrl = 'https://led-kikaku.com';
const jsonLdItemList = ssrProducts.length > 0 ? {
	'@context': 'https://schema.org',
	'@type': 'ItemList',
	name: t('products.title'),
	numberOfItems: ssrProducts.length,
	itemListElement: ssrProducts.map((product, index) => {
		const variant = product.variants?.[0];
		return {
			'@type': 'ListItem',
			position: index + 1,
			url: `${siteUrl}/products/${product.id}`,
			name: product.title,
			...(variant?.price ? {
				item: {
					'@type': 'Product',
					name: product.title,
					url: `${siteUrl}/products/${product.id}`,
					...(product.image ? { image: product.image } : {}),
					offers: {
						'@type': 'Offer',
						price: variant.price.amount,
						priceCurrency: variant.price.currency || 'JPY',
					},
				},
			} : {}),
		};
	}),
} : null;
---

<Layout title="Store - Led Kikaku" description={t('seo.productsDescription')}>
	{jsonLdItemList && (
		<script type="application/ld+json" set:html={JSON.stringify(jsonLdItemList)} />
	)}
	<div class="bg-white min-h-screen">
		<Breadcrumb items={[
			{ label: t('breadcrumb.home'), href: '/' },
			{ label: t('products.title') },
		]} />

		<section class="pt-24 pb-12 sm:pt-32 border-b border-neutral-200">
			<Container>
				<h1 class="typo-h1 text-primary">
					{t('products.title')} <span class="text-secondary">{t('products.subtitle')}</span>
				</h1>
			</Container>
		</section>

		<section class="py-12 bg-subtle">
			<Container>
				<div class="flex items-center justify-between mb-8">
					<h2 id="section-title" class="typo-h2 text-primary">{t('products.theLatest')}</h2>
					<div class="flex items-center gap-3">
						<select
							id="sort-select"
							class="px-3 py-2 min-h-[44px] text-sm font-medium text-primary bg-white rounded-full shadow-sm ring-1 ring-black/5 hover:bg-neutral-50 transition-colors appearance-none pr-8 cursor-pointer"
							aria-label={t('products.sortLabel')}
						>
							<option value="newest">{t('products.sortNewest')}</option>
							<option value="price_asc">{t('products.sortPriceAsc')}</option>
							<option value="price_desc">{t('products.sortPriceDesc')}</option>
						</select>
						<button
							id="mobile-filter-btn"
							type="button"
							class="lg:hidden inline-flex items-center gap-2 px-4 py-2 min-h-[44px] text-sm font-medium text-primary bg-white rounded-full shadow-sm ring-1 ring-black/5 hover:bg-neutral-50 transition-colors relative"
							aria-label={t('filters.showFilters')}
						>
							<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
							{t('filters.showFilters')}
							<span
								id="mobile-filter-count"
								class="hidden absolute -top-1.5 -right-1.5 inline-flex items-center justify-center min-w-[20px] h-5 px-1.5 text-xs font-bold text-white bg-brand rounded-full"
							></span>
						</button>
					</div>
				</div>

				{/* Mobile Filter Bottom Sheet */}
				<div id="mobile-filter-overlay" class="fixed inset-0 z-[60] bg-black/40 backdrop-blur-sm hidden lg:hidden" aria-hidden="true"></div>
				<div
					id="mobile-filter-sheet"
					class="fixed inset-x-0 bottom-0 z-[70] max-h-[85vh] bg-white rounded-t-2xl shadow-xl transform translate-y-full transition-transform duration-300 ease-in-out lg:hidden"
					role="dialog"
					aria-modal="true"
					aria-label={t('filters.showFilters')}
				>
					<div class="flex items-center justify-between px-6 py-4 border-b border-neutral-100">
						<h2 class="typo-h3 text-primary">{t('products.filters')}</h2>
						<button
							id="mobile-filter-close"
							type="button"
							class="min-h-[44px] min-w-[44px] flex items-center justify-center text-primary/60 hover:text-primary transition-colors"
							aria-label={t('filters.closeFilters')}
						>
							<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
						</button>
					</div>
					<div class="overflow-y-auto p-6" style="max-height: calc(85vh - 65px);">
						<ProductFilters client:visible />
					</div>
				</div>

				<div class="flex gap-8">
					{/* Filter Sidebar - Desktop */}
					<aside class="hidden lg:block w-64 flex-shrink-0" aria-label={t('products.filters')}>
						<div class="sticky top-24 bg-white rounded-2xl p-6 shadow-sm ring-1 ring-black/5">
							<h2 class="typo-h3 text-primary mb-4">{t('products.filters')}</h2>
							<ProductFilters client:idle />
						</div>
					</aside>

					{/* Product Grid */}
					<div class="flex-1">
						<ProductGrid client:only="react" />
					</div>
				</div>
			</Container>
		</section>
	</div>

	{/* SSR product data for SEO crawlers */}
	{ssrProducts.length > 0 && (
		<noscript>
			<div class="max-w-7xl mx-auto px-4 py-8">
				<ul>
					{ssrProducts.map((product) => {
						const variant = product.variants?.[0];
						return (
							<li>
								<a href={`/products/${product.id}`}>
									{product.title}
									{variant?.price && ` - ${formatPrice(variant.price.amount, variant.price.currency)}`}
								</a>
							</li>
						);
					})}
				</ul>
			</div>
		</noscript>
	)}

	<script>
		// Sort select handler
		const sortSelect = document.getElementById('sort-select') as HTMLSelectElement | null;
		if (sortSelect) {
			const currentSort = new URLSearchParams(window.location.search).get('sort') || 'newest';
			sortSelect.value = currentSort;
			sortSelect.addEventListener('change', () => {
				const params = new URLSearchParams(window.location.search);
				if (sortSelect.value && sortSelect.value !== 'newest') {
					params.set('sort', sortSelect.value);
				} else {
					params.delete('sort');
				}
				params.delete('page');
				const newUrl = params.toString()
					? `${window.location.pathname}?${params.toString()}`
					: window.location.pathname;
				window.location.href = newUrl;
			});
		}

		// Mobile filter bottom sheet
		const mobileFilterBtn = document.getElementById('mobile-filter-btn');
		const mobileFilterSheet = document.getElementById('mobile-filter-sheet');
		const mobileFilterOverlay = document.getElementById('mobile-filter-overlay');
		const mobileFilterClose = document.getElementById('mobile-filter-close');

		if (mobileFilterBtn && mobileFilterSheet && mobileFilterOverlay) {
			const getFocusableElements = (): HTMLElement[] => {
				const selector = 'a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])';
				return Array.from(mobileFilterSheet.querySelectorAll<HTMLElement>(selector));
			};

			const handleTrapKeydown = (e: KeyboardEvent) => {
				if (e.key === 'Escape') {
					closeFilters();
					return;
				}
				if (e.key !== 'Tab') return;
				const focusable = getFocusableElements();
				if (focusable.length === 0) return;
				const first = focusable[0]!;
				const last = focusable[focusable.length - 1]!;
				if (e.shiftKey) {
					if (document.activeElement === first) {
						e.preventDefault();
						last.focus();
					}
				} else {
					if (document.activeElement === last) {
						e.preventDefault();
						first.focus();
					}
				}
			};

			const openFilters = () => {
				mobileFilterSheet.classList.remove('translate-y-full');
				mobileFilterOverlay.classList.remove('hidden');
				document.body.style.overflow = 'hidden';
				document.addEventListener('keydown', handleTrapKeydown);
				mobileFilterClose?.focus();
			};

			const closeFilters = () => {
				mobileFilterSheet.classList.add('translate-y-full');
				mobileFilterOverlay.classList.add('hidden');
				document.body.style.overflow = '';
				document.removeEventListener('keydown', handleTrapKeydown);
				mobileFilterBtn.focus();
			};

			mobileFilterBtn.addEventListener('click', openFilters);
			mobileFilterClose?.addEventListener('click', closeFilters);
			mobileFilterOverlay.addEventListener('click', closeFilters);
		}
	</script>
</Layout>
