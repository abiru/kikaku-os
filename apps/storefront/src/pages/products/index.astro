---
import { Badge } from '../../components/catalyst/badge';
import Container from '../../components/Container.astro';
import EmptyState from '../../components/EmptyState.astro';
import Layout from '../../layouts/Layout.astro';
import ProductFilters from '../../components/ProductFilters';
import { buildStoreUrl, fetchJson, getApiBase } from '../../lib/api';
import { formatPrice } from '../../lib/format';
import { t } from '../../i18n';

export const prerender = false;

const skeletonCards = Array.from({ length: 6 });

// SSR: Fetch initial products for SEO
type SSRProduct = {
	id: number;
	title: string;
	description: string | null;
	image: string | null;
	variants: Array<{
		id: number;
		title: string;
		price: { amount: number; currency: string } | null;
		stock: number | null;
	}>;
};
let ssrProducts: SSRProduct[] = [];
try {
	const apiBase = getApiBase();
	const data = await fetchJson<{ products: SSRProduct[] }>(buildStoreUrl('/products?perPage=20', apiBase));
	ssrProducts = data?.products ?? [];
} catch {
	// SSR fetch failed - client-side will retry
}

// ItemList JSON-LD for SEO
const siteUrl = 'https://led-kikaku.com';
const jsonLdItemList = ssrProducts.length > 0 ? {
	'@context': 'https://schema.org',
	'@type': 'ItemList',
	name: t('products.title'),
	numberOfItems: ssrProducts.length,
	itemListElement: ssrProducts.map((product, index) => {
		const variant = product.variants?.[0];
		return {
			'@type': 'ListItem',
			position: index + 1,
			url: `${siteUrl}/products/${product.id}`,
			name: product.title,
			...(variant?.price ? {
				item: {
					'@type': 'Product',
					name: product.title,
					url: `${siteUrl}/products/${product.id}`,
					...(product.image ? { image: product.image } : {}),
					offers: {
						'@type': 'Offer',
						price: variant.price.amount,
						priceCurrency: variant.price.currency || 'JPY',
					},
				},
			} : {}),
		};
	}),
} : null;
---

<Layout title="Store - Led Kikaku" description={t('seo.productsDescription')}>
	{jsonLdItemList && (
		<script type="application/ld+json" set:html={JSON.stringify(jsonLdItemList)} />
	)}
	<div class="bg-white min-h-screen">
		<section class="pt-24 pb-12 sm:pt-32 border-b border-gray-200">
			<Container>
				<h1 class="text-4xl font-semibold tracking-tight text-primary md:text-5xl">
					{t('products.title')} <span class="text-secondary">{t('products.subtitle')}</span>
				</h1>
			</Container>
		</section>

		<section class="py-12 bg-subtle">
			<Container>
				<div id="search-info" class="hidden mb-6">
					<div class="flex items-center justify-between">
						<p class="text-gray-600">
							{t('products.showingResultsFor')} "<span id="search-term"></span>"
						</p>
						<a href="/products" class="text-sm font-medium text-indigo-600 hover:text-indigo-500">
							{t('products.clearSearch')}
						</a>
					</div>
				</div>

				<div id="filter-info" class="hidden mb-6">
					<div class="flex items-center gap-2 flex-wrap">
						<span class="text-gray-600">{t('products.activeFilters')}:</span>
						<span id="active-filters" class="flex items-center gap-2"></span>
					</div>
				</div>

				<div class="flex items-center justify-between mb-8">
					<h2 id="section-title" class="text-2xl font-semibold tracking-tight text-primary">{t('products.theLatest')}</h2>
					<div class="flex items-center gap-3">
						{/* Sort Dropdown */}
						<select
							id="sort-select"
							class="px-3 py-2 min-h-[44px] text-sm font-medium text-[#1d1d1f] bg-white rounded-full shadow-sm ring-1 ring-black/5 hover:bg-gray-50 transition-colors appearance-none pr-8 cursor-pointer"
							aria-label={t('products.sortLabel')}
						>
							<option value="newest">{t('products.sortNewest')}</option>
							<option value="price_asc">{t('products.sortPriceAsc')}</option>
							<option value="price_desc">{t('products.sortPriceDesc')}</option>
						</select>
						{/* Mobile Filter Button */}
						<button
							id="mobile-filter-btn"
							type="button"
							class="lg:hidden inline-flex items-center gap-2 px-4 py-2 min-h-[44px] text-sm font-medium text-primary bg-white rounded-full shadow-sm ring-1 ring-black/5 hover:bg-gray-50 transition-colors"
							aria-label={t('filters.showFilters')}
						>
							<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
							{t('filters.showFilters')}
						</button>
						<Badge color="green" client:load>{t('products.newArrivals')}</Badge>
					</div>
				</div>

				{/* Mobile Filter Bottom Sheet */}
				<div id="mobile-filter-overlay" class="fixed inset-0 z-[60] bg-black/40 backdrop-blur-sm hidden lg:hidden" aria-hidden="true"></div>
				<div
					id="mobile-filter-sheet"
					class="fixed inset-x-0 bottom-0 z-[70] max-h-[85vh] bg-white rounded-t-2xl shadow-xl transform translate-y-full transition-transform duration-300 ease-in-out lg:hidden"
					role="dialog"
					aria-modal="true"
					aria-label={t('filters.showFilters')}
				>
					<div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
						<h2 class="text-lg font-semibold text-primary">{t('products.filters')}</h2>
						<button
							id="mobile-filter-close"
							type="button"
							class="min-h-[44px] min-w-[44px] flex items-center justify-center text-primary/60 hover:text-primary transition-colors"
							aria-label={t('filters.closeFilters')}
						>
							<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
						</button>
					</div>
					<div class="overflow-y-auto p-6" style="max-height: calc(85vh - 65px);">
						<ProductFilters client:only="react" />
					</div>
				</div>

				<div class="flex gap-8">
					{/* Filter Sidebar - Desktop only */}
					<aside class="hidden lg:block w-64 flex-shrink-0" aria-label={t('products.filters')}>
						<div class="sticky top-20 bg-white rounded-2xl p-6 shadow-sm ring-1 ring-black/5">
							<h2 class="text-lg font-semibold text-primary mb-4">{t('products.filters')}</h2>
							<ProductFilters client:only="react" />
						</div>
					</aside>

					{/* Product Grid */}
					<div class="flex-1">
						<div id="product-state">
							{/* Skeleton State */}
							<div id="product-skeleton" class="grid grid-cols-1 gap-6 sm:grid-cols-2 xl:gap-8">
								{skeletonCards.map(() => (
									<div class="group relative flex flex-col overflow-hidden rounded-3xl bg-white p-6 shadow-sm ring-1 ring-black/5 transition-all duration-300 hover:shadow-lg">
										<div class="aspect-[4/3] w-full overflow-hidden rounded-xl bg-subtle"></div>
										<div class="mt-6 flex flex-col gap-2">
											<div class="h-4 w-24 bg-gray-100 rounded-full"></div>
											<div class="h-6 w-48 bg-gray-100 rounded-lg"></div>
											<div class="mt-2 h-4 w-16 bg-gray-100 rounded-full"></div>
										</div>
									</div>
								))}
							</div>

							{/* Error State */}
							<div id="product-error" class="hidden py-20">
								<div id="error-content" class="rounded-3xl border border-dashed border-zinc-200 bg-white p-8">
									<div class="mx-auto max-w-md text-center">
										<div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100 text-red-500">
											<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-6 w-6" aria-hidden="true">
												<path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
											</svg>
										</div>
										<h2 id="error-title" class="mt-4 text-lg font-semibold text-zinc-900">{t('errors.storeUnavailable')}</h2>
										<p id="error-description" class="mt-2 text-sm text-zinc-500">{t('errors.storeUnavailableDescription')}</p>
										<div class="mt-6 flex justify-center">
											<button id="error-retry-btn" type="button" class="inline-flex items-center gap-2 rounded-lg border border-zinc-300 bg-white px-4 py-2 text-sm font-medium text-zinc-700 shadow-sm hover:bg-zinc-50 transition-colors">
												<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
													<path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182" />
												</svg>
												{t('errors.retry')}
											</button>
										</div>
									</div>
								</div>
							</div>

							{/* Empty State */}
							<div id="product-empty" class="hidden py-20">
								<EmptyState
									title={t('products.noProducts')}
									description={t('products.noProductsDescription')}
									ctaLabel={t('products.viewAllProducts')}
									ctaHref="/products"
								/>
							</div>

							{/* Loaded Grid */}
							<div id="product-grid" class="hidden grid grid-cols-1 gap-6 sm:grid-cols-2 xl:gap-8"></div>
						</div>

						{/* i18n data for client script */}
						<div
							id="i18n-data"
							class="hidden"
							data-new={t('products.new')}
							data-from={t('products.from')}
							data-buy={t('products.buy')}
							data-search-results={t('products.searchResults')}
							data-filtered-results={t('products.filteredResults')}
							data-showing-count={t('products.showingCount')}
							data-page-info={t('products.pageInfo')}
							data-price-above={t('products.priceAbove')}
							data-price-up-to={t('products.priceUpTo')}
							data-domestic-shipping={t('category.domesticShipping')}
							data-international-shipping={t('category.internationalShipping')}
							data-error-network={t('errors.networkError')}
							data-error-network-desc={t('errors.networkErrorDescription')}
							data-error-server={t('errors.serverError')}
							data-error-server-desc={t('errors.serverErrorDescription')}
							data-error-not-found={t('errors.notFoundError')}
							data-error-not-found-desc={t('errors.notFoundErrorDescription')}
							data-error-generic={t('errors.storeUnavailable')}
							data-error-generic-desc={t('errors.storeUnavailableDescription')}
							data-announce-count={t('products.announceCount')}
							data-wishlist-label={t('wishlist.addToWishlist')}
						></div>

						{/* Pagination */}
						<nav id="pagination" class="hidden mt-12 flex items-center justify-between border-t border-gray-200 pt-6" aria-label={t('products.pagination')}>
							<div class="text-sm text-gray-600">
								<span id="pagination-info"></span>
							</div>
							<div class="flex gap-2">
								<a id="prev-page" href="#" class="hidden px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
									← {t('common.previous')}
								</a>
								<span id="current-page" class="px-4 py-2 text-sm font-medium text-gray-900" aria-current="page"></span>
								<a id="next-page" href="#" class="hidden px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
									{t('common.next')} →
								</a>
							</div>
						</nav>
					</div>
				</div>
			</Container>
		</section>
	</div>

	{/* SSR product data for SEO crawlers */}
	{ssrProducts.length > 0 && (
		<noscript>
			<div class="max-w-7xl mx-auto px-4 py-8">
				<ul>
					{ssrProducts.map((product) => {
						const variant = product.variants?.[0];
						return (
							<li>
								<a href={`/products/${product.id}`}>
									{product.title}
									{variant?.price && ` - ${formatPrice(variant.price.amount, variant.price.currency)}`}
								</a>
							</li>
						);
					})}
				</ul>
			</div>
		</noscript>
	)}

	<script>
		import '../../scripts/productList';
	</script>
</Layout>
