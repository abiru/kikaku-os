---
import EmptyState from '../../components/EmptyState.astro';
import ProductImageGallery from '../../components/ProductImageGallery.astro';
import ProductVariantSelector from '../../components/ProductVariantSelector.astro';
import RelatedProducts from '../../components/RelatedProducts.astro';
import ShippingPolicy from '../../components/ShippingPolicy.astro';
import WishlistButton from '../../components/WishlistButton';
import RestockNotification from '../../components/RestockNotification';
import ReviewSection from '../../components/ReviewSection';
import RecentlyViewed from '../../components/RecentlyViewed';
import Layout from '../../layouts/Layout.astro';
import { buildStoreUrl, fetchJson, getApiBase } from '../../lib/api';
import { renderMarkdown } from '../../utils/markdown';
import { t } from '../../i18n';
import type { Product } from '../../lib/types';

const apiBase = getApiBase();
const { id } = Astro.params;
const encodedId = encodeURIComponent(id || '');
export const prerender = false;

let product: Product | null = null;
let loadState: 'ready' | 'not-found' | 'unavailable' = 'ready';

try {
	const data = await fetchJson<{ product: Product | null }>(buildStoreUrl(`/products/${encodedId}`, apiBase));
	product = data?.product ?? null;
	if (!product) {
		loadState = 'not-found';
	}
} catch (error) {
	const status = typeof error === 'object' && error ? (error as { status?: number }).status : undefined;
	loadState = status === 404 ? 'not-found' : 'unavailable';
	product = null;
}

// Fetch related products (same category, exclude current product)
let relatedProducts: Product[] = [];
if (product?.category) {
	try {
		const params = new URLSearchParams();
		params.set('category', product.category);
		params.set('perPage', '5');
		const relatedData = await fetchJson<{ products: Product[] }>(buildStoreUrl(`/products?${params.toString()}`, apiBase));
		relatedProducts = (relatedData?.products ?? [])
			.filter((p) => p.id !== product!.id)
			.slice(0, 4);
	} catch {
		// Silently ignore - related products are not critical
	}
}

const variant = product?.variants?.[0] ?? null;
const variantId = variant?.id ?? null;

// Format price with tax indicator
const formatPriceWithTax = (amount: number, currency: string = 'JPY') => {
	const formatted = new Intl.NumberFormat('ja-JP', {
		style: 'currency',
		currency: currency,
		minimumFractionDigits: 0,
	}).format(amount);
	return `${formatted} (税込)`;
};

const priceLabel = variant?.price
	? formatPriceWithTax(variant.price.amount, variant.price.currency)
	: t('product.checkPrice');

const stockValue =
	typeof variant?.stock === 'number'
		? variant.stock
		: typeof variant?.inventory === 'number'
			? variant.inventory
			: null;

// Build images array from product data
const productImages: Array<{ id: number; src: string; alt: string; primary: boolean }> = [];
if (product?.image) {
	productImages.push({ id: 1, src: product.image, alt: product?.title || 'Product image', primary: true });
}
if (product?.images && Array.isArray(product.images)) {
	product.images.forEach((img: { url: string; alt: string | null }, index: number) => {
		if (img.url && img.url !== product.image) {
			productImages.push({
				id: index + 2,
				src: img.url,
				alt: img.alt || `${product?.title} - Image ${index + 2}`,
				primary: false
			});
		}
	});
}

// Breadcrumbs
const breadcrumbs = [
	{ id: 1, name: t('nav.products'), href: '/products' },
];
if (product?.category) {
	breadcrumbs.push({ id: 2, name: product.category, href: `/categories/${encodeURIComponent(product.category)}` });
}

// Product details/features
const productDetails = product?.details || [
	t('product.defaultDetail1'),
	t('product.defaultDetail2'),
	t('product.defaultDetail3'),
	t('product.defaultDetail4'),
];

// Policies
const shippingPolicy = stockValue !== null && stockValue > 0
	? {
		name: t('product.domesticShipping'),
		icon: 'globe',
		description: t('product.domesticShippingDescription')
	}
	: {
		name: t('product.internationalShipping'),
		icon: 'globe',
		description: t('product.internationalShippingDescription')
	};

const policies = [
	shippingPolicy,
	{ name: t('product.securePayment'), icon: 'currency', description: t('product.securePaymentDescription') },
];

// JSON-LD structured data for SEO
const jsonLdProduct = product && variant?.price ? {
	'@context': 'https://schema.org',
	'@type': 'Product',
	name: product.title,
	description: product.description || '',
	image: product.image || undefined,
	sku: variant?.sku || undefined,
	category: product.category || undefined,
	brand: {
		'@type': 'Organization',
		name: 'Led Kikaku',
	},
	offers: {
		'@type': 'Offer',
		price: variant.price.amount,
		priceCurrency: variant.price.currency || 'JPY',
		availability: stockValue !== null && stockValue > 0
			? 'https://schema.org/InStock'
			: 'https://schema.org/OutOfStock',
		seller: {
			'@type': 'Organization',
			name: 'Led Kikaku',
		},
	},
} : null;

// BreadcrumbList JSON-LD for SEO
const jsonLdBreadcrumb = product ? {
	'@context': 'https://schema.org',
	'@type': 'BreadcrumbList',
	itemListElement: [
		{
			'@type': 'ListItem',
			position: 1,
			name: t('breadcrumb.home'),
			item: '/',
		},
		{
			'@type': 'ListItem',
			position: 2,
			name: t('nav.products'),
			item: '/products',
		},
		{
			'@type': 'ListItem',
			position: 3,
			name: product.title,
		},
	],
} : null;
---

<Layout title={product ? `${product.title} - Led Kikaku` : 'Product Detail'} description={product?.description ? product.description.slice(0, 160) : undefined}>
	{jsonLdProduct && (
		<script type="application/ld+json" set:html={JSON.stringify(jsonLdProduct)} />
	)}
	{jsonLdBreadcrumb && (
		<script type="application/ld+json" set:html={JSON.stringify(jsonLdBreadcrumb)} />
	)}
	{loadState === 'ready' && product ? (
		<>
		<div
			id="product-page"
			data-variant-id={variantId ?? ''}
			data-product-id={product.id}
			data-product-title={product.title}
			data-variant-title={variant?.title || 'Default'}
			data-price={variant?.price?.amount || 0}
			data-currency={variant?.price?.currency || 'JPY'}
			data-tax-rate={product.tax_rate || 0.10}
			data-product-image={product.image || ''}
			class="bg-white"
		>
			<div class="pt-6 pb-16 sm:pb-24">
				{/* Breadcrumb */}
				<nav aria-label="Breadcrumb" class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
					<ol role="list" class="flex items-center space-x-4">
						{breadcrumbs.map((breadcrumb) => (
							<li>
								<div class="flex items-center">
									<a href={breadcrumb.href} class="mr-4 text-sm font-medium text-gray-900 hover:text-gray-600">
										{breadcrumb.name}
									</a>
									<svg viewBox="0 0 6 20" aria-hidden="true" class="h-5 w-auto text-gray-300">
										<path d="M4.878 4.34H3.551L.27 16.532h1.327l3.281-12.19z" fill="currentColor" />
									</svg>
								</div>
							</li>
						))}
						<li class="text-sm">
							<span aria-current="page" class="font-medium text-gray-500">
								{product.title}
							</span>
						</li>
					</ol>
				</nav>

				<div class="mx-auto mt-8 max-w-2xl px-4 sm:px-6 lg:max-w-7xl lg:px-8">
					<div class="lg:grid lg:auto-rows-min lg:grid-cols-12 lg:gap-x-8">
						{/* Product title and price */}
						<div class="lg:col-span-5 lg:col-start-8">
							<div class="flex justify-between items-start">
								<h1 class="text-xl font-medium text-gray-900">{product.title}</h1>
								<div class="flex items-center gap-2">
									<p class="text-xl font-medium text-gray-900">{priceLabel}</p>
									<WishlistButton
										client:only="react"
										product={{
											productId: product.id,
											title: product.title,
											price: variant?.price?.amount || 0,
											currency: variant?.price?.currency || 'JPY',
											taxRate: product.tax_rate || 0.10,
											imageUrl: product.image || undefined,
											variantId: variantId || undefined,
											variantTitle: variant?.title || 'Default',
										}}
										size="lg"
									/>
								</div>
							</div>

							{/* Stock status */}
							{stockValue !== null && (
								<div class="mt-4">
									<div class="flex items-center">
										{stockValue > 0 ? (
											<>
												<div class="flex items-center">
													<svg class="size-5 text-green-500" viewBox="0 0 20 20" fill="currentColor">
														<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
													</svg>
													<p class="ml-2 text-sm text-gray-700">{t('product.inStock')} ({stockValue})</p>
												</div>
											</>
										) : (
											<>
												<p class="text-sm text-gray-500">{t('product.checkAvailability')}</p>
												<RestockNotification client:only="react" productId={product.id} />
											</>
										)}
									</div>
								</div>
							)}
						</div>

						{/* Image gallery */}
						<ProductImageGallery images={productImages} />

						<div class="mt-8 lg:col-span-5">
							<ProductVariantSelector variantId={variantId} addedToCartLabel={t('wishlist.addedToCart')} />

							{/* Product description */}
							{product.description && (
								<div class="mt-10">
									<h2 class="text-sm font-medium text-gray-900">{t('product.description')}</h2>

									<div
										class="mt-4 space-y-4 text-sm leading-6 text-gray-500 product-description"
										set:html={renderMarkdown(product.description)}
									/>
								</div>
							)}

							{/* Product details */}
							<div class="mt-8 border-t border-gray-200 pt-8">
								<h2 class="text-sm font-medium text-gray-900">{t('product.details')}</h2>

								<div class="mt-4">
									<ul role="list" class="list-disc space-y-1 pl-5 text-sm leading-6 text-gray-500 marker:text-gray-300">
										{productDetails.map((item: string) => (
											<li class="pl-2">{item}</li>
										))}
									</ul>
								</div>
							</div>

							{/* Policies */}
							<ShippingPolicy policies={policies} />

							{/* Reviews */}
							<ReviewSection client:only="react" productId={product.id} />
						</div>
					</div>
				</div>
			</div>
		</div>
		{/* Related Products */}
		<RelatedProducts products={relatedProducts} />
		{/* Recently Viewed Products */}
		<RecentlyViewed client:only="react" excludeId={product.id} />
		</>
	) : loadState === 'unavailable' ? (
		<div class="mt-8">
			<EmptyState
				title={t('product.unavailable')}
				description={t('product.unavailableDescription')}
				ctaLabel={t('product.retry')}
				ctaHref={`/products/${encodedId}`}
			/>
		</div>
	) : (
		<div class="mt-8">
			<EmptyState
				title={t('product.notFound')}
				description={t('product.notFoundDescription')}
				ctaLabel={t('product.backToProducts')}
				ctaHref="/products"
			/>
		</div>
	)}

	<style>
		.product-description h1,
		.product-description h2,
		.product-description h3,
		.product-description h4 {
			color: #1f2937;
			font-weight: 600;
			margin-top: 1.5em;
			margin-bottom: 0.5em;
		}
		.product-description h3 { font-size: 1.125rem; }
		.product-description p { margin-bottom: 1em; }
		.product-description ul,
		.product-description ol {
			margin: 1em 0;
			padding-left: 1.5em;
		}
		.product-description li { margin-bottom: 0.5em; }
		.product-description strong { color: #1f2937; }
		.product-description a {
			color: #0071e3;
			text-decoration: underline;
		}
	</style>

	<script>
		import '../../scripts/productDetail';
	</script>
</Layout>
