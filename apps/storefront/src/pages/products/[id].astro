---
import Alert from '../../components/Alert.astro';
import Button from '../../components/Button.astro';
import Container from '../../components/Container.astro';
import EmptyState from '../../components/EmptyState.astro';
import Layout from '../../layouts/Layout.astro';
import { buildStoreUrl, fetchJson, getApiBase } from '../../lib/api';
import { renderMarkdown } from '../../utils/markdown';

const apiBase = getApiBase();
const { id } = Astro.params;
const encodedId = encodeURIComponent(id || '');
export const prerender = false;

let product: any = null;
let loadState: 'ready' | 'not-found' | 'unavailable' = 'ready';

try {
	const data = await fetchJson(buildStoreUrl(`/products/${encodedId}`, apiBase)) as any;
	product = data?.product ?? null;
	if (!product) {
		loadState = 'not-found';
	}
} catch (error) {
	const status = typeof error === 'object' && error ? (error as { status?: number }).status : undefined;
	loadState = status === 404 ? 'not-found' : 'unavailable';
	product = null;
}

const variant = product?.variants?.[0] ?? null;
const variantId = variant?.id ?? null;

// Format price with tax indicator
const formatPriceWithTax = (amount: number, currency: string = 'JPY') => {
	const formatted = new Intl.NumberFormat('ja-JP', {
		style: 'currency',
		currency: currency,
		minimumFractionDigits: 0,
	}).format(amount);
	return `${formatted} (税込)`;
};

const priceLabel = variant?.price
	? formatPriceWithTax(variant.price.amount, variant.price.currency)
	: 'Check Price';

const stockValue =
	typeof variant?.stock === 'number'
		? variant.stock
		: typeof variant?.inventory === 'number'
			? variant.inventory
			: null;

// Build images array from product data
const productImages = [];
if (product?.image) {
	productImages.push({ id: 1, src: product.image, alt: product?.title || 'Product image', primary: true });
}
if (product?.images && Array.isArray(product.images)) {
	product.images.forEach((img: any, index: number) => {
		if (img !== product.image) {
			productImages.push({ id: index + 2, src: img, alt: `${product?.title} - Image ${index + 2}`, primary: false });
		}
	});
}

// Breadcrumbs
const breadcrumbs = [
	{ id: 1, name: 'Products', href: '/products' },
];
if (product?.category) {
	breadcrumbs.push({ id: 2, name: product.category, href: `/products?category=${encodeURIComponent(product.category)}` });
}

// Product details/features
const productDetails = product?.details || [
	'High-quality materials',
	'Professional grade',
	'Easy installation',
	'Long-lasting performance',
];

// Policies
const shippingPolicy = stockValue !== null && stockValue > 0
	? {
		name: '国内発送',
		icon: 'globe',
		description: '2〜3日でお届け'
	}
	: {
		name: '海外発送',
		icon: 'globe',
		description: '10日程度でお届け'
	};

const policies = [
	shippingPolicy,
	{ name: 'Secure Payment', icon: 'currency', description: 'Safe checkout via Stripe' },
];
---

<Layout title={product ? `${product.title} - Led Kikaku` : 'Product Detail'}>
	{loadState === 'ready' && product ? (
		<div
			id="product-page"
			data-variant-id={variantId ?? ''}
			data-product-id={product.id}
			data-product-title={product.title}
			data-variant-title={variant?.title || 'Default'}
			data-price={variant?.price?.amount || 0}
			data-currency={variant?.price?.currency || 'JPY'}
			data-tax-rate={product.tax_rate || 0.10}
			data-product-image={product.image || ''}
			class="bg-white"
		>
			<div class="pt-6 pb-16 sm:pb-24">
				{/* Breadcrumb */}
				<nav aria-label="Breadcrumb" class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
					<ol role="list" class="flex items-center space-x-4">
						{breadcrumbs.map((breadcrumb) => (
							<li>
								<div class="flex items-center">
									<a href={breadcrumb.href} class="mr-4 text-sm font-medium text-gray-900 hover:text-gray-600">
										{breadcrumb.name}
									</a>
									<svg viewBox="0 0 6 20" aria-hidden="true" class="h-5 w-auto text-gray-300">
										<path d="M4.878 4.34H3.551L.27 16.532h1.327l3.281-12.19z" fill="currentColor" />
									</svg>
								</div>
							</li>
						))}
						<li class="text-sm">
							<span aria-current="page" class="font-medium text-gray-500">
								{product.title}
							</span>
						</li>
					</ol>
				</nav>

				<div class="mx-auto mt-8 max-w-2xl px-4 sm:px-6 lg:max-w-7xl lg:px-8">
					<div class="lg:grid lg:auto-rows-min lg:grid-cols-12 lg:gap-x-8">
						{/* Product title and price */}
						<div class="lg:col-span-5 lg:col-start-8">
							<div class="flex justify-between">
								<h1 class="text-xl font-medium text-gray-900">{product.title}</h1>
								<p class="text-xl font-medium text-gray-900">{priceLabel}</p>
							</div>

							{/* Stock status */}
							{stockValue !== null && (
								<div class="mt-4">
									<div class="flex items-center">
										{stockValue > 0 ? (
											<>
												<div class="flex items-center">
													<svg class="size-5 text-green-500" viewBox="0 0 20 20" fill="currentColor">
														<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
													</svg>
													<p class="ml-2 text-sm text-gray-700">In stock ({stockValue} available)</p>
												</div>
											</>
										) : (
											<p class="text-sm text-gray-500">Check availability</p>
										)}
									</div>
								</div>
							)}
						</div>

						{/* Image gallery */}
						<div class="mt-8 lg:col-span-7 lg:col-start-1 lg:row-span-3 lg:row-start-1 lg:mt-0">
							<h2 class="sr-only">Images</h2>

							<div class="grid grid-cols-1 lg:grid-cols-2 lg:grid-rows-3 lg:gap-8">
								{productImages.length > 0 ? (
									productImages.map((image, index) => (
										<img
											id={index === 0 ? 'main-image' : undefined}
											alt={image.alt}
											src={image.src}
											class:list={[
												'rounded-lg object-cover w-full',
												image.primary ? 'lg:col-span-2 lg:row-span-2 aspect-square' : 'hidden lg:block aspect-square',
											]}
										/>
									))
								) : (
									<div class="lg:col-span-2 lg:row-span-2 aspect-square rounded-lg bg-gray-100 flex items-center justify-center">
										<svg class="h-24 w-24 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
											<path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
										</svg>
									</div>
								)}
							</div>

							{/* Thumbnail navigation for mobile */}
							{productImages.length > 1 && (
								<div class="mt-4 flex gap-4 overflow-x-auto lg:hidden">
									{productImages.map((image, index) => (
										<button
											type="button"
											data-index={index}
											data-url={image.src}
											class:list={[
												'thumbnail shrink-0 w-20 h-20 rounded-lg overflow-hidden ring-2 ring-offset-2 transition-all',
												index === 0 ? 'ring-indigo-600' : 'ring-transparent hover:ring-gray-300',
											]}
										>
											<img src={image.src} alt={image.alt} class="w-full h-full object-cover" />
										</button>
									))}
								</div>
							)}
						</div>

						<div class="mt-8 lg:col-span-5">
							<form id="product-form">
								{/* Quantity picker */}
								<div>
									<h2 class="text-sm font-medium text-gray-900">Quantity</h2>

									<fieldset aria-label="Choose quantity" class="mt-2">
										<div class="grid grid-cols-6 gap-3">
											{[1, 2, 3, 4, 5, 6].map((qty) => (
												<label
													class="group relative flex items-center justify-center rounded-md border border-gray-300 bg-white p-3 cursor-pointer hover:bg-gray-50 has-[:checked]:border-indigo-600 has-[:checked]:bg-indigo-600 focus-within:ring-2 focus-within:ring-indigo-600 focus-within:ring-offset-2"
												>
													<input
														type="radio"
														name="quantity"
														value={qty}
														checked={qty === 1}
														class="sr-only"
													/>
													<span class="text-sm font-medium text-gray-900 group-has-[:checked]:text-white">
														{qty}
													</span>
												</label>
											))}
										</div>
									</fieldset>
								</div>

								<button
									type="button"
									id="buy-button"
									disabled={!variantId}
									class="mt-8 flex w-full items-center justify-center rounded-md border border-transparent bg-indigo-600 px-8 py-3 text-base font-medium text-white hover:bg-indigo-700 focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed"
								>
									<span id="buy-label">Add to cart</span>
									<span id="buy-spinner" class="hidden ml-2 animate-spin">
										<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none">
											<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
											<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
										</svg>
									</span>
								</button>
							</form>

							{/* Error message */}
							<div id="checkout-error" class="hidden mt-4">
								<Alert severity="critical" title="Error">
									<p id="checkout-error-message" class="text-sm"></p>
								</Alert>
							</div>

							{/* Product description */}
							{product.description && (
								<div class="mt-10">
									<h2 class="text-sm font-medium text-gray-900">Description</h2>

									<div
										class="mt-4 space-y-4 text-sm leading-6 text-gray-500 product-description"
										set:html={renderMarkdown(product.description)}
									/>
								</div>
							)}

							{/* Product details */}
							<div class="mt-8 border-t border-gray-200 pt-8">
								<h2 class="text-sm font-medium text-gray-900">Details</h2>

								<div class="mt-4">
									<ul role="list" class="list-disc space-y-1 pl-5 text-sm leading-6 text-gray-500 marker:text-gray-300">
										{productDetails.map((item: string) => (
											<li class="pl-2">{item}</li>
										))}
									</ul>
								</div>
							</div>

							{/* Policies */}
							<section aria-labelledby="policies-heading" class="mt-10">
								<h2 id="policies-heading" class="sr-only">Our Policies</h2>

								<dl class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-1 xl:grid-cols-2">
									{policies.map((policy) => (
										<div class="rounded-lg border border-gray-200 bg-gray-50 p-6 text-center">
											<dt>
												{policy.icon === 'globe' ? (
													<svg class="mx-auto size-6 shrink-0 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
														<path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418" />
													</svg>
												) : (
													<svg class="mx-auto size-6 shrink-0 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
														<path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
													</svg>
												)}
												<span class="mt-4 block text-sm font-medium text-gray-900">{policy.name}</span>
											</dt>
											<dd class="mt-1 text-sm text-gray-500">{policy.description}</dd>
										</div>
									))}
								</dl>
							</section>
						</div>
					</div>
				</div>
			</div>
		</div>
	) : loadState === 'unavailable' ? (
		<div class="mt-8">
			<EmptyState
				title="Product unavailable"
				description="We couldn't load this product. Please retry in a moment."
				ctaLabel="Retry"
				ctaHref={`/products/${encodedId}`}
			/>
		</div>
	) : (
		<div class="mt-8">
			<EmptyState
				title="Product not found"
				description="This item doesn't exist or has been removed."
				ctaLabel="Back to Products"
				ctaHref="/products"
			/>
		</div>
	)}

	<style>
		.product-description h1,
		.product-description h2,
		.product-description h3,
		.product-description h4 {
			color: #1f2937;
			font-weight: 600;
			margin-top: 1.5em;
			margin-bottom: 0.5em;
		}
		.product-description h3 { font-size: 1.125rem; }
		.product-description p { margin-bottom: 1em; }
		.product-description ul,
		.product-description ol {
			margin: 1em 0;
			padding-left: 1.5em;
		}
		.product-description li { margin-bottom: 0.5em; }
		.product-description strong { color: #1f2937; }
		.product-description a {
			color: #4f46e5;
			text-decoration: underline;
		}
	</style>

	<script>
		import { addToCart } from '../../lib/cart';

		const page = document.getElementById('product-page');
		if (page) {
			const variantId = page.dataset.variantId ? Number(page.dataset.variantId) : null;
			const productId = page.dataset.productId ? Number(page.dataset.productId) : null;
			const productTitle = page.dataset.productTitle || '';
			const variantTitle = page.dataset.variantTitle || 'Default';
			const price = page.dataset.price ? Number(page.dataset.price) : 0;
			const currency = page.dataset.currency || 'JPY';
			const taxRate = page.dataset.taxRate ? Number(page.dataset.taxRate) : 0.10;
			const imageUrl = page.dataset.productImage || '';

			const buyButton = document.getElementById('buy-button');
			const buyLabel = document.getElementById('buy-label');
			const buySpinner = document.getElementById('buy-spinner');
			const errorWrap = document.getElementById('checkout-error');
			const errorMessage = document.getElementById('checkout-error-message');
			const productForm = document.getElementById('product-form');

			const getSelectedQuantity = (): number => {
				const selectedRadio = productForm?.querySelector('input[name="quantity"]:checked') as HTMLInputElement | null;
				return selectedRadio ? Number(selectedRadio.value) : 1;
			};

			const showSuccess = () => {
				if (!buyLabel) return;
				buyLabel.textContent = 'Added to cart!';
				setTimeout(() => {
					buyLabel.textContent = 'Add to cart';
				}, 2000);
			};

			const showError = (message: string) => {
				if (!errorWrap || !errorMessage) return;
				errorMessage.textContent = message;
				errorWrap.classList.remove('hidden');
			};

			const clearError = () => {
				if (!errorWrap || !errorMessage) return;
				errorMessage.textContent = '';
				errorWrap.classList.add('hidden');
			};

			if (buyButton && variantId && productId) {
				buyButton.addEventListener('click', () => {
					clearError();

					const quantity = getSelectedQuantity();

					try {
						addToCart({
							variantId,
							productId,
							title: productTitle,
							variantTitle,
							price,
							currency,
							taxRate,
							imageUrl: imageUrl || undefined
						}, quantity);
						showSuccess();
					} catch (error) {
						showError(error instanceof Error ? error.message : 'Failed to add to cart.');
					}
				});
			}
		}

		// Thumbnail navigation
		const mainImage = document.getElementById('main-image') as HTMLImageElement | null;
		const thumbnails = document.querySelectorAll('.thumbnail');

		if (mainImage && thumbnails.length > 0) {
			thumbnails.forEach((thumbnail) => {
				thumbnail.addEventListener('click', (e) => {
					const target = e.currentTarget as HTMLButtonElement;
					const imageUrl = target.dataset.url;

					if (imageUrl && mainImage) {
						mainImage.src = imageUrl;

						thumbnails.forEach(t => {
							t.classList.remove('ring-indigo-600');
							t.classList.add('ring-transparent');
						});
						target.classList.remove('ring-transparent');
						target.classList.add('ring-indigo-600');
					}
				});
			});
		}
	</script>
</Layout>
