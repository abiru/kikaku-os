---
import Alert from '../../components/Alert.astro';
import Badge from '../../components/Badge.astro';
import Button from '../../components/Button.astro';
import Container from '../../components/Container.astro';
import EmptyState from '../../components/EmptyState.astro';
import Layout from '../../layouts/Layout.astro';
import { buildStoreUrl, fetchJson, getApiBase } from '../../lib/api';

const apiBase = getApiBase();
const { id } = Astro.params;
const encodedId = encodeURIComponent(id);
export const prerender = false;

let product: any = null;
let loadState: 'ready' | 'not-found' | 'unavailable' = 'ready';

try {
	const data = await fetchJson(buildStoreUrl(`/products/${encodedId}`, apiBase));
	product = data?.product ?? null;
	if (!product) {
		loadState = 'not-found';
	}
} catch (error) {
	const status = typeof error === 'object' && error ? (error as { status?: number }).status : undefined;
	loadState = status === 404 ? 'not-found' : 'unavailable';
	product = null;
}

const variant = product?.variants?.[0] ?? null;
const variantId = variant?.id ?? null;
const priceLabel = variant?.price
	? `${variant.price.amount} ${variant.price.currency}`
	: 'Check Price';

const stockValue =
	typeof variant?.stock === 'number'
		? variant.stock
		: typeof variant?.inventory === 'number'
			? variant.inventory
			: null;
const stockNote =
	typeof stockValue === 'number' ? (stockValue > 0 ? `In stock: ${stockValue}` : 'Check availability') : null;
---

<Layout title={product ? `${product.title} - Led Kikaku` : 'Product Detail'}>
	{loadState === 'ready' && product ? (
		<div
			id="product-page"
			data-variant-id={variantId ?? ''}
			data-product-id={product.id}
			data-product-title={product.title}
			data-variant-title={variant?.title || 'Default'}
			data-price={variant?.price?.amount || 0}
			data-currency={variant?.price?.currency || 'JPY'}
			class="bg-white min-h-screen pb-20"
		>
			
			{/* Sticky Product Header (Apple Style) */}
			<div id="sticky-header" class="sticky top-[48px] z-40 w-full border-b border-gray-200 bg-white/80 backdrop-blur-md transition-transform duration-300 -translate-y-full opacity-0">
				<Container class="flex h-14 items-center justify-between">
					<h2 class="text-sm font-semibold text-[#1d1d1f]">{product.title}</h2>
					<div class="flex items-center gap-4">
						<span class="text-xs font-medium text-[#1d1d1f]">{priceLabel}</span>
						<Button id="sticky-buy-btn" size="sm">Buy</Button>
					</div>
				</Container>
			</div>

			{/* Hero Section */}
			<section class="pt-16 pb-12 sm:pt-24 text-center">
				<Container>
					<Badge severity="new" class="mb-4">New</Badge>
					<h1 class="text-5xl font-semibold tracking-tight text-[#1d1d1f] md:text-7xl mb-6">
						{product.title}
					</h1>
					<p class="text-xl font-medium text-[#1d1d1f] md:text-2xl max-w-2xl mx-auto mb-12">
						Experience the next generation of LED technology.
					</p>
					
					{product.image ? (
					<img
						src={product.image}
						alt={product.title}
						loading="eager"
						class="mt-10 mx-auto max-h-[500px] max-w-5xl rounded-3xl object-contain shadow-sm"
					/>
				) : (
					<div
						class="mt-10 mx-auto aspect-[16/9] max-w-5xl rounded-3xl bg-[#f5f5f7] flex items-center justify-center shadow-sm"
					>
						<span class="text-9xl font-bold text-gray-200 select-none">HERO</span>
					</div>
				)}
				</Container>
			</section>

			{/* Product Description */}
			{product.description && (
				<section class="py-16 bg-white">
					<Container>
						<div class="product-description max-w-4xl mx-auto text-base leading-relaxed text-[#424245]" set:html={product.description} />
					</Container>
				</section>
			)}
			<style>
				.product-description h1,
				.product-description h2,
				.product-description h3,
				.product-description h4 {
					color: #1d1d1f;
					font-weight: 600;
					margin-top: 1.5em;
					margin-bottom: 0.5em;
				}
				.product-description h3 { font-size: 1.25rem; }
				.product-description p { margin-bottom: 1em; }
				.product-description ul,
				.product-description ol {
					margin: 1em 0;
					padding-left: 1.5em;
				}
				.product-description li { margin-bottom: 0.5em; }
				.product-description strong { color: #1d1d1f; }
				.product-description a {
					color: #0071e3;
					text-decoration: underline;
				}
			</style>

			{/* Feature Grid (Storytelling) */}
			<section class="py-24 bg-[#f5f5f7]">
				<Container>
					<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
						<div class="rounded-3xl bg-white p-12 flex flex-col items-center text-center shadow-sm">
							<h3 class="text-4xl font-semibold text-[#1d1d1f] mb-4">Pro Performance.</h3>
							<p class="text-lg text-[#86868b]">Optimized spectrum for maximum yield.</p>
							<div class="mt-10 h-64 w-full bg-[#f5f5f7] rounded-xl"></div>
						</div>
						<div class="rounded-3xl bg-white p-12 flex flex-col items-center text-center shadow-sm">
							<h3 class="text-4xl font-semibold text-[#1d1d1f] mb-4">Efficient.</h3>
							<p class="text-lg text-[#86868b]">Less energy, more growth.</p>
							<div class="mt-10 h-64 w-full bg-[#f5f5f7] rounded-xl"></div>
						</div>
					</div>
				</Container>
			</section>

			{/* Storytelling Section 1 - Full Width Image Left */}
			<section class="bg-white">
				<div class="grid min-h-[600px] grid-cols-1 lg:grid-cols-2">
					<div class="flex items-center justify-center bg-[#f5f5f7] p-12">
						<div class="aspect-square w-full max-w-md rounded-3xl bg-gray-100 flex items-center justify-center">
							<svg class="h-24 w-24 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
								<path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
							</svg>
						</div>
					</div>
					<div class="flex flex-col justify-center p-12 lg:p-20">
						<h3 class="text-3xl font-semibold text-[#1d1d1f] md:text-4xl">
							Precision spectrum control.
						</h3>
						<p class="mt-6 text-lg leading-relaxed text-[#86868b]">
							Our proprietary LED configuration delivers the exact wavelengths your plants need, from seedling to harvest. No wasted energy, just pure, targeted light.
						</p>
					</div>
				</div>
			</section>

			{/* Storytelling Section 2 - Full Width Image Right */}
			<section class="bg-[#f5f5f7]">
				<div class="grid min-h-[600px] grid-cols-1 lg:grid-cols-2">
					<div class="order-2 flex flex-col justify-center p-12 lg:order-1 lg:p-20">
						<h3 class="text-3xl font-semibold text-[#1d1d1f] md:text-4xl">
							Built to last.
						</h3>
						<p class="mt-6 text-lg leading-relaxed text-[#86868b]">
							Industrial-grade aluminum housing with passive cooling means no fans, no noise, and decades of reliable performance.
						</p>
					</div>
					<div class="order-1 flex items-center justify-center bg-white p-12 lg:order-2">
						<div class="aspect-square w-full max-w-md rounded-3xl bg-gray-100 flex items-center justify-center">
							<svg class="h-24 w-24 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
								<path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
							</svg>
						</div>
					</div>
				</div>
			</section>

			{/* Purchase Section */}
			<section id="buy-section" class="py-24 bg-white">
				<Container>
					<div class="max-w-4xl mx-auto rounded-3xl border border-gray-200 bg-white p-8 md:p-12 shadow-sm">
						<div class="flex flex-col md:flex-row gap-12">
							{/* Left: Product Recap */}
							<div class="flex-1">
								{product.mainImage || product.image ? (
									<img src={product.mainImage || product.image} alt={product.title} class="aspect-square w-full rounded-2xl object-cover mb-6" />
								) : (
									<div class="aspect-square w-full rounded-2xl bg-[#f5f5f7] mb-6"></div>
								)}
								<h2 class="text-3xl font-semibold text-[#1d1d1f]">{product.title}</h2>
								<p class="mt-2 text-xl text-[#1d1d1f]">{priceLabel}</p>
							</div>

							{/* Right: Options */}
							<div class="flex-1 space-y-8">
								<div>
									<h3 class="text-sm font-semibold text-[#1d1d1f] mb-4">Quantity</h3>
									<div class="relative">
										<select id="qty-input" class="w-full appearance-none rounded-xl border border-gray-300 py-4 pl-4 pr-10 text-base font-medium text-[#1d1d1f] focus:border-[#0071e3] focus:outline-none focus:ring-1 focus:ring-[#0071e3]">
											{Array.from({ length: 10 }).map((_, index) => (
												<option value={index + 1}>{index + 1}</option>
											))}
										</select>
										<div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
											<svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
										</div>
									</div>
								</div>

								<div>
									<h3 class="text-sm font-semibold text-[#1d1d1f] mb-4">Email Receipt</h3>
									<input
										id="email-input"
										type="email"
										placeholder="your@email.com"
										class="w-full rounded-xl border border-gray-300 p-4 text-base font-medium text-[#1d1d1f] placeholder:text-gray-400 focus:border-[#0071e3] focus:outline-none focus:ring-1 focus:ring-[#0071e3]"
									/>
								</div>

								<div class="pt-6 border-t border-gray-100">
									<Button id="buy-button" size="lg" class="w-full justify-between" disabled={!variantId}>
										<span id="buy-label">Add to Bag</span>
										<span id="buy-spinner" class="hidden animate-spin">‚ü≥</span>
									</Button>
									<p class="mt-4 text-center text-xs text-[#86868b]">
										Free shipping on all orders. <br/>
										Secure checkout via Stripe.
									</p>
								</div>
								
								<div id="checkout-error" class="hidden">
									<Alert severity="critical" title="Error">
										<p id="checkout-error-message" class="text-sm"></p>
									</Alert>
								</div>
							</div>
						</div>
					</div>
				</Container>
			</section>

		</div>
	) : loadState === 'unavailable' ? (
		<div class="mt-8">
			<EmptyState
				title="Product unavailable"
				description="We couldn't load this product. Please retry in a moment."
				ctaLabel="Retry"
				ctaHref={`/products/${encodedId}`}
			/>
		</div>
	) : (
		<div class="mt-8">
			<EmptyState
				title="Product not found"
				description="This item doesn't exist or has been removed."
				ctaLabel="Back to Products"
				ctaHref="/products"
			/>
		</div>
	)}

	<script>
		import { addToCart } from '../../lib/cart';

		const stickyHeader = document.getElementById('sticky-header');
		const buySection = document.getElementById('buy-section');
		const stickyBuyBtn = document.getElementById('sticky-buy-btn');

		// 1. Sticky Header Logic
		if (stickyHeader && buySection) {
			window.addEventListener('scroll', () => {
				const scrollY = window.scrollY;
				if (scrollY > 600) {
					stickyHeader.classList.remove('-translate-y-full', 'opacity-0');
				} else {
					stickyHeader.classList.add('-translate-y-full', 'opacity-0');
				}
			});

			stickyBuyBtn?.addEventListener('click', () => {
				buySection.scrollIntoView({ behavior: 'smooth' });
			});
		}

		// 2. Add to Cart Logic
		const page = document.getElementById('product-page');
		if (page) {
			const variantId = page.dataset.variantId ? Number(page.dataset.variantId) : null;
			const productId = page.dataset.productId ? Number(page.dataset.productId) : null;
			const productTitle = page.dataset.productTitle || '';
			const variantTitle = page.dataset.variantTitle || 'Default';
			const price = page.dataset.price ? Number(page.dataset.price) : 0;
			const currency = page.dataset.currency || 'JPY';

			const buyButton = document.getElementById('buy-button');
			const buyLabel = document.getElementById('buy-label');
			const qtyInput = document.getElementById('qty-input') as HTMLSelectElement;
			const errorWrap = document.getElementById('checkout-error');
			const errorMessage = document.getElementById('checkout-error-message');

			const showSuccess = () => {
				if (!buyLabel) return;
				buyLabel.textContent = 'Added to cart!';
				setTimeout(() => {
					buyLabel.textContent = 'Add to Bag';
				}, 2000);
			};

			const showError = (message: string) => {
				if (!errorWrap || !errorMessage) return;
				errorMessage.textContent = message;
				errorWrap.classList.remove('hidden');
			};

			const clearError = () => {
				if (!errorWrap || !errorMessage) return;
				errorMessage.textContent = '';
				errorWrap.classList.add('hidden');
			};

			if (buyButton && variantId && productId) {
				buyButton.addEventListener('click', () => {
					clearError();

					const quantity = Number(qtyInput?.value || 1);

					try {
						addToCart({
							variantId,
							productId,
							title: productTitle,
							variantTitle,
							price,
							currency
						}, quantity);
						showSuccess();
					} catch (error) {
						showError(error instanceof Error ? error.message : 'Failed to add to cart.');
					}
				});
			}
		}

		// 3. Gallery interaction
		const mainImage = document.getElementById('main-image') as HTMLImageElement | null;
		const thumbnails = document.querySelectorAll('.thumbnail');

		if (mainImage && thumbnails.length > 0) {
			// Set first thumbnail as active
			thumbnails[0]?.classList.add('ring-[#0071e3]');

			thumbnails.forEach((thumbnail) => {
				thumbnail.addEventListener('click', (e) => {
					const target = e.currentTarget as HTMLButtonElement;
					const imageUrl = target.dataset.url;
					const imageIndex = target.dataset.index;

					if (imageUrl && mainImage) {
						// Update main image
						mainImage.src = imageUrl;
						mainImage.alt = `Product - Image ${Number(imageIndex) + 1}`;

						// Update active thumbnail
						thumbnails.forEach(t => t.classList.remove('ring-[#0071e3]'));
						target.classList.add('ring-[#0071e3]');
					}
				});
			});

			// Keyboard navigation
			document.addEventListener('keydown', (e) => {
				const activeThumbnail = document.querySelector('.thumbnail.ring-\\[\\#0071e3\\]');
				if (!activeThumbnail) return;

				let nextIndex = -1;
				const currentIndex = Number((activeThumbnail as HTMLElement).dataset.index);

				if (e.key === 'ArrowRight') {
					nextIndex = (currentIndex + 1) % thumbnails.length;
				} else if (e.key === 'ArrowLeft') {
					nextIndex = (currentIndex - 1 + thumbnails.length) % thumbnails.length;
				}

				if (nextIndex >= 0) {
					(thumbnails[nextIndex] as HTMLElement).click();
				}
			});
		}
	</script>
</Layout>
